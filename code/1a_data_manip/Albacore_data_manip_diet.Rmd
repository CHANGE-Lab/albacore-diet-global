---
title: "Albacore Review Diet Data Manipulation"
author: "Natasha Hardy"
date: "03/08/2021"
output: html_document
---

## About

This document contains code for manipulating diet data sets for albacore prey species from our global meta-analysis of albacore diet composition.

```{r setup, include=FALSE, echo=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

```{r Load Workspace, message=FALSE}

#R documentation
library(pander)
# general
library(tidyverse)
library(readxl)
library(readr)
library(plyr)
library(dplyr)
library(devtools)
library(here)
"%notin%" = Negate('%in%')
here::here()

```


## Outputs needed for these manips:

- Prey species' morphometric trait information (body shape, eye diameter to body, and standard to total length): *data/output_data/prey_morph_sum.csv*

- Prey species' nutritional composition traits (energy density, percent lipid and percent protein composition): *data/output_data/prey_qual_sum.csv*

- Prey species' trait values: (i) selected priority trait columns *data/output_data/prey_trait_select.csv* and (ii) trait values for adult life stages only *data/output_data/prey_trait_adult.csv* --> for downstream data joins and analyses.

- Prey species length ratios for max and min length: *data/output_data/prey_length_wide.csv* 

- Prey species + filled in length ratios: *data/output_data/prey_length_ratiosp.csv*

- Diet data below.

## Load trait dataframes

```{r Load trait dataframes}

prey_morph_sum = read.csv(here("data/output_data/prey_morph_sum.csv"))

prey_qual_sum = read.csv(here("data/output_data/prey_qual_sum.csv"))

prey_trait_select = read.csv(here("data/output_data/prey_trait_select.csv"))

prey_trait_adult = read.csv(here("data/output_data/prey_trait_adult.csv"))

prey_length_wide = read.csv(here("data/output_data/prey_length_wide.csv"))

prey_length_ratiosp = read.csv(here("data/output_data/prey_length_ratiosp.csv"))

```


## Albacore diet review data

Here we need to load up the albacore global diet data to clean and select what we want.
Tasks performed in these chunks:

- Select prey probable life stage;

- Merge probable prey life stage with appropriate traits;

- Retain frequency of occurrence + stomach sampled information for traitglm.

```{r Albacore diet data load & manipulation}

#Load diet data spreadsheet
#need this: prey_length_ratiosp
#This contains species as rows for which we have useable species through to class-level ratio information on larval:adult and juvenile:adult lengths

#Also need prey_length_wide data for l_max for adult column
#Should be able to get this from prey_length_ratiosp

alb_global = as.data.frame(read_xlsx(here("data/input_data/albacore_diet_global.xlsx"),
                      sheet = "albacore_diet_global")) %>% #2134 rows and 77 vars
  dplyr::filter(TaxLev == "species") %>% #1107 rows and 77 vars
  #There are ~1105 observations when we filter by species
  dplyr::filter(Include %in% c("Yes", "Maybe") & !pred_life == "larvae") %>% #1028 rows
  #1028 when we remove larval albacore diet studies (there are 3)
  #dplyr::rename() %>%
  dplyr::select(StudyID, CiteAuth, CiteYear, OceanBasin, OceanBasinQ, LocatName, LocatLatitude:LocatLongitude, MonthRange, YearEnd, stomachs_used, pred_life:est_ref, stomachs_used, prey_class:prey_sp, prey_age_reported_1:prey_age_use, Include, FO, pFOuse, N, pN, `Total Mass (g)`, pM, maxl_use, maxl_type) %>%
  mutate(gape_lmax = pred_flmean*0.0823+1.758, gape_height_limit = pred_flmean*0.0246+4.603) %>% #1028 obsm 44 vars
  #calculates the gape length and height limits
  #Add reference paper for this calculation -- Menard et al. (2006) for yellowfin tuna
  left_join(prey_morph_sum, by="prey_sp") #added morph info --> 1028 obs, 44 vars

#Correct data type
alb_global$maxl_use <- as.numeric(alb_global$maxl_use)

#Cleaning metrics
alb_global = alb_global %>% 
  mutate(maxtl_use = if_else(alb_global$maxl_type %in% c("SL", "ML"), maxl_use/standard_total, maxl_use),
         prey_age_reported_1=case_when(
                             #prey_age_reported_1 == "NA" ~ "none",
                             prey_age_reported_1 == "larvae" ~ "larva",
                             prey_age_reported_1 == "juvenile" ~ "juvenile",
                             prey_age_reported_1 == "adult" ~ "adult")
         ) #%>%

#The NA's in the reported age for prey column cause problems later and need to be assigned a categorical value
alb_global$prey_age_reported_1 <- as.character(alb_global$prey_age_reported_1)
alb_global$prey_age_reported_1 <- replace_na(alb_global$prey_age_reported_1, "none")
#check this
unique(as.factor(alb_global$prey_age_reported_1))

#Change vector type for YearEnd variable
alb_global$YearEnd <- as.integer(alb_global$YearEnd)
alb_global$stomachs_used <- as.integer(alb_global$stomachs_used)
alb_global$stomachs_used <- replace_na(alb_global$stomachs_used, "none reported")
alb_global$stomachs_used <- as.character(alb_global$stomachs_used)

#Save total df version
write.csv(alb_global, here("data/output_data/alb_global_diet_total.csv"), row.names = FALSE) 
#1028 observations and 45 variables

```

The following summarises the max observed FO, N and M for each species in the dataset. This information can be useful when investigating the relative importance of species in albacore diets.

```{r Alb adult summary diet metrics}

alb_global_ad_metrics = alb_global %>%
  #unique(c(alb_global_prob$prey_sp, alb_global_prob$prey_select))
  dplyr::select(prey_class:prey_sp, pFOuse, pN, pM) %>%
  group_by(prey_sp) %>% #, life_stage , pFOuse, pN, pM
  dplyr::summarize(maxFO = max(pFOuse, na.rm=TRUE), maxN = max(pN, na.rm=TRUE), maxM = max(pM, na.rm=TRUE)) 

write.csv(alb_global_ad_metrics, here("data/output_data/alb_global_ad_metrics"), row.names = FALSE)
```

Here we want to estimate the probable life stage of the species consumed based on their size ratios and relationship to albacore tuna gape limits.

```{r Albacore diet data + probable life stage estimation}

alb_global_prob = alb_global %>%
  inner_join(prey_length_ratiosp, by=c("prey_sp", "prey_family", "prey_order", "prey_class")) %>%
  #In using an inner_join I am selecting only rows for which we have all length-based data
  mutate(prey_length = if_else(maxtl_use > 0, maxtl_use/10, gape_lmax)) %>%
  mutate(prey_frac = 100*prey_length/l_adult) %>%
  mutate(prey_proba = if_else(prey_frac < larva_adult_use, "larva", if_else(prey_frac<juve_adult_use, "juvenile", "adult"))) %>%
  mutate(life_stage = if_else(prey_age_reported_1 == "none", prey_proba, prey_age_reported_1)) #985 obs, 53 variables

#And remove troublesome NA's in dataset
#Because we need to give these a life stage, I am assigning them as "adult" because of their l_max typically was < gape limit.
#These were all small species
alb_global_prob$life_stage[is.na(alb_global_prob$life_stage)] <- "adult"

## SAVE DATA
write.csv(alb_global_prob, here("data/output_data/alb_global_diet_prob.csv"), row.names = FALSE) 
#985 observations 55 variables
#This include data for which we are able to make an assessment of probable life stage --> therefore will exclude coarse taxonomic classifications

```

The following summarises the max observed FO, N and M for each species in the dataset AND for each life stage likely consumed.

```{r Alb probable diet metrics summary}

#All combinations of life stages and species consumed
alb_global_prob_metrics = alb_global_prob %>%
  dplyr::select(prey_class:prey_sp, life_stage, pFOuse, pN, pM) %>%
  group_by(prey_sp, life_stage) %>%
  dplyr::summarize(maxFO = max(pFOuse, na.rm=TRUE), maxN = max(pN, na.rm=TRUE), maxM = max(pM, na.rm=TRUE))

## SAVE DATA BELOW
write.csv(alb_global_prob_metrics, here("data/output_data/alb_global_prob_metrics_alllife.csv"), row.names = FALSE)

```

AND we need to select the max observed --> this is also where we essentially select a single life stage that any prey could be, even though there are several occurrences of prey from different life stages being consumed in different areas of the world. There were 328 individual species and life stage combinations above, but we cannot account for all of these unless we treat these as different species. So 28 cases were simplified and merged. We can check in the file above which taxa this affected and their frequency of occurrence.

```{r Albacore prey life stages lists}
#Need to summarise prey life stages and attach trait data
#unique(as.factor(alb_global_prob_metrics$prey_sp)) #there are 303 unique species
#So we should obtain 300 species in the following code.

#The most common life stage and species consumed!!
alb_global_prob_metrics = alb_global_prob_metrics %>%
  group_by(prey_sp) %>%
  top_n(1, maxFO) %>%
  sample_n(1)

write.csv(alb_global_prob_metrics, here("data/output_data/alb_global_prob_metrics"), row.names = FALSE)

```

*Note: the maxFO, maxN or maxM are related to the study, they are typically the same between both sets of summary data for adult and probable life stage.

## Data Joins

### Traits
#### Prey traits - adult life stage

```{r Prey adult traits + morph + qual data, include=FALSE, eval = FALSE}

#Mixed categorical, and other traits

prey_adults_merge = prey_trait_adult %>% 
  left_join(prey_morph_sum, by="prey_sp") %>% 
  left_join(prey_qual_sum, by="prey_sp") %>%
  left_join(alb_global_ad_metrics, by="prey_sp")

#308 spp and ~31 traits
glimpse(prey_adults_merge)

#Save
write.csv(prey_adults_merge, here("data/output_data/prey_adults_traits.csv"), row.names = FALSE)

#Reload
#prey_adults_merge = read.csv(here("data/output_data/prey_adults_traits.csv"))

```

#### Prey traits - probable life stage

```{r Prey probable list + traits + morph + qual data, include=FALSE, eval = FALSE}

prey_probable_merge = alb_global_prob_metrics %>%
  left_join(prey_trait_select, by=c("prey_sp", "life_stage")) %>% 
  left_join(prey_morph_sum, by="prey_sp") %>% 
  left_join(prey_qual_sum, by="prey_sp") %>%
  dplyr::select(prey_class:prey_family, prey_sp:life_stage, vert_habitat:percent_lipid, maxFO:maxM)

#303 spp and ~28 traits
glimpse(prey_probable_merge)

write.csv(prey_probable_merge, here("data/output_data/prey_probable_traits.csv"), row.names = FALSE)

#prey_probable_merge = read.csv(here("data/prey_probable_traits.csv"))

```

### Covariates

```{r Covariates}

alb_covars = alb_global %>%
  dplyr::select(StudyID, CiteYear, OceanBasin, OceanBasinQ, LocatName, LocatLatitude:pred_life_est) %>% #, stomachs_used
  distinct(StudyID, CiteYear, OceanBasin, OceanBasinQ, LocatName, LocatLatitude, LocatLongitude, YearEnd, MonthRange, stomachs_used, pred_life) %>% 
  #, stomachs_used
  mutate(lat_cat = if_else(abs(LocatLatitude) > 23.43662, "temperate", "tropical"),
         pred_life_adjust=case_when(pred_life == "juvenile" ~ "juvenile",
                             pred_life == "juvenile, adult" ~ "mixed",
                             pred_life == "none" ~ "mixed",
                             pred_life == "adult" ~ "adult"))

#Merge these back to the diet df
alb_global_diet = alb_global %>%
  left_join(alb_covars)

write.csv(alb_covars, here("data/output_data/alb_covars.csv"), row.names = FALSE)

```

Could edit the Longhurst doc to separate biomes and codes as per province definitions:
https://en.wikipedia.org/wiki/Longhurst_code#:~:text=Longhurst%20code%20refers%20to%20a,unique%20set%20of%20environmental%20conditions 

```{r Covars + Longhurst}
#Covars + Longhurst

alb_covars_geog <- read.csv(here("data/output_data/alb_covars_longhurst.csv")) #%>%
#  dplyr::select(StudyID, lat_cat:code) #%>%
#  group_by(StudyID) %>%
#  sample_n(1)
#names(alb_covars_geog)

#Need to merge this with diet data first overall data then probable prey consumed
unique(alb_covars_geog$code)

#check names match
unique(sort(alb_covars_geog$StudyID)) == unique(sort(alb_global$StudyID)) #they do
unique(sort(alb_covars_geog$CiteYear)) == unique(sort(alb_global$CiteYear)) #they do
unique(sort(alb_covars_geog$YearEnd)) == unique(sort(alb_global$YearEnd)) #they do

alb_covars_use = alb_covars %>%
  left_join(alb_covars_geog) %>%
  dplyr::select(-optional)

```

```{r Covars + Longhurst + Diet data}

alb_global_diet = alb_global %>%
  left_join(alb_covars_use) #looks good #, by = "StudyID"

#Write over previous output from first data chunk
write.csv(alb_global_diet, here("data/output_data/alb_global_diet_total.csv"), row.names = FALSE)
```


**NOTE** Below we include the adult cluster number but need to use the cluster number from probable life stage if we stick to this for final analysis.

### Diet datasets

Note that there are a handful of cases where the same prey species was consumed and reported for two different life stages. Because this affects three species and for only one study, the simplest solution to be able to move forward, we need to just select the most commonly consumed species/life stage combination.

```{r Check on duplicates for prey by life stage}

View(alb_global[c(192, 226, 111, 118, 204, 247, 99, 117, 227, 248),])

#select 192, 111, 247, 117, 248
```

#### Presence/absence

Here we will join our additional covariates (inc. Longhurst province data) with the diet data, and generate a wide format df with species as columns and values for species' presence absence (PA). These data will be used for traitglms.

```{r Covars + Longhurst + cluster + Diet data PA}
#Extract %FO data --> filter for only species that we have adult traits + cluster info for --> transform to wide data for MV GLMs + trait GLMs
alb_global_dietpa = alb_global_diet %>%
  dplyr::select(StudyID:stomachs_used, lat_cat:code, pred_life_adjust, pred_flmean, prey_age_reported_1, prey_sp) %>%
  mutate(pa="1") #%>%
  #group_by(prey_sp) %>%
  #dplyr::mutate(grouped_id = row_number()) %>%
  #spread(prey_sp, pa, fill = 0, convert = FALSE)

```


#### Diet data - frequency of occurrence

Here we will join our additional covariates (inc. Longhurst province data) with the diet data, and generate a wide format df with species as columns and values for reported frequency of occurrence (FO). Because these data may be used for traitglms and converted to presence/absence, we filter for very low occurrence species (< 1%).

```{r Covars + Longhurst + cluster + Diet data FO}

#Extract %FO data --> filter for only species that we have adult traits + cluster info for --> transform to wide data for MV GLMs + trait GLMs
alb_global_dietfo = alb_global_diet %>%
  dplyr::select(StudyID:YearEnd, lat_cat:code, pred_life, pred_flmean, prey_sp, pFOuse) %>%
  filter(pFOuse >= 1) %>% #set this value to include or exclude species #goes down to 708 observations
  group_by(prey_sp) %>%
  dplyr::mutate(grouped_id = row_number()) %>%
  spread(prey_sp, pFOuse, fill = 0, convert = FALSE)

#Before spreading data - range(alb_global_dietfo$pFOuse) 
#0 to 100 need to exclude zeros as they are not true zeros --> 0.1 to 100%

#Check covariate representation
#summary(as.factor(alb_global_dietfo$lat_cat))
#summary(as.factor(alb_global_dietfo$code))
#summary(as.factor(alb_global_dietfo$OceanBasin))
#summary(as.factor(alb_global_dietfo$OceanBasinQ))

write.csv(alb_global_dietfo, here("data/output_data/alb_global_wide_dietfo.csv"))

```


#### Diet data - abundance

```{r Covars + Longhurst + Diet data N}
#Extract for %N data
alb_global_dietn = alb_global_diet %>%
  dplyr::select(StudyID:YearEnd, lat_cat:code, pred_life, pred_flmean, prey_sp, pN) %>%
  filter(pN > 0) %>%
  filter(prey_sp %in% alb_adult_traits$prey_sp) %>%
  group_by(prey_sp) %>%
  dplyr::mutate(grouped_id = row_number()) %>%
  spread(prey_sp, pN, fill = 0, convert = FALSE)

#Check covariate representation
#summary(as.factor(alb_global_dietn$lat_cat))
#summary(as.factor(alb_global_dietn$code))
#summary(as.factor(alb_global_dietn$OceanBasin))
#summary(as.factor(alb_global_dietn$OceanBasinQ))

write.csv(alb_global_dietn, here("data/output_data/alb_global_wide_dietn.csv"))
```

#### Diet data - biomass

```{r Covars + Longhurst + Diet data M}
#Extract for %M data
#range(alb_global_dietm$pM) #0 to 95.2, need to exclude zeros as not true zeros

alb_global_dietm = alb_global_diet %>%
  dplyr::select(StudyID:YearEnd, lat_cat:code, pred_life, pred_flmean, prey_sp, pM) %>%
  filter(pM > 0) %>%
  filter(prey_sp %in% alb_adult_traits$prey_sp) %>%
  group_by(prey_sp) %>%
  dplyr::mutate(grouped_id = row_number()) %>%
  spread(prey_sp, pM, fill = 0, convert = FALSE)

#Check covariate representation
#summary(as.factor(alb_global_dietm$lat_cat))
#summary(as.factor(alb_global_dietm$code))
#summary(as.factor(alb_global_dietm$OceanBasin))
#summary(as.factor(alb_global_dietm$OceanBasinQ))

write.csv(alb_global_dietm, here("data/output_data/alb_global_wide_dietm.csv"))

```


