---
title: "Albacore Review Trait Data Manipulation"
author: "Natasha Hardy"
date: "October 10, 2019"
output:
  pdf_document: default
  html_document: default
---

## About

This document contains code for manipulating trait information for 5 prey traits, and life history estimation, for albacore prey species from our global meta-analysis of albacore diet composition.

From the MS:

"2.2 Prey trait information

For each prey species and main life stage distinctions (i.e., larva, juvenile, adult), we collected trait information for four habitat use traits and one behavioural trait known to affect the likelihood of a pelagic predator encountering, attacking and capturing prey (Green et al., 2019). These were: (i) vertical and (ii) horizontal habitat association, (iii) presence of diel vertical migration, (iv) presence of seasonal migration and (v) aggregation behaviour (Supplementary Data, Table S4 & S5). For analyses, we include the phylogenetic Order verified using Open Tree of Life Data (OpenTree et al, 2020). Trait data were compiled for a broader database construction effort of traits that inform predator-prey interactions for albacore (Gleiber et al. in prep). We further describe how prey speciesâ€™ trait values were collected in Appendix B (Supporting Information)."

## Workpsace

```{r setup, include=FALSE, echo=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

```{r Load Workspace, message=FALSE}

#R documentation
library(pander)
# general
library(tidyverse)
library(readxl)
library(readr)
library(plyr)
library(dplyr)
library(devtools)
library(here)
"%notin%" = Negate('%in%')
here::here()

```

## Outputs

List of outputs created for analyses:

- Prey species' coarse trait information *data/output_data/prey_trait_select.csv*

- Albacore diet data *data/output_data/alb_global_diet_total.csv*

- Albacore diet sampling covariates *alb_covars.csv*



## Dataframes

### Albacore prey trait db

Loading in and selecting key species coarse traits: for habitat association, seasonal, vertical migration and aggregation behaviour. Note that NH overhauled our prey life stage estimation protocol in December 2021 through early 2022, and we have thoroughly curated this step.

```{r Prey trait data load, message=FALSE, results='hide', tidy=TRUE}
#Load prey trait db
prey_trait <- as.data.frame(read_xlsx(here("data/input_data/prey_trait_db.xlsx"),
                                           sheet = "prey_trait_db"))

```

Key traits selection:

```{r Prey traits selection, tidy=TRUE}

prey_trait_select = prey_trait %>%
  dplyr::select(prey_class:prey_sp, life_stage, vert_habitat, horz_habitat, diel_migrant_cat, refuge_cat, season_cat)

str(prey_trait_select)

write.csv(prey_trait_select, here::here("data/output_data/prey_trait_select.csv"), row.names = FALSE)

```

### Albacore diet raw data

Load diet data and merge with prey size trait information, and undertake necessary data selection and manipulation of variables.

```{r Albacore diet data load & manipulation, tidy=TRUE}

#Load diet data spreadsheet
alb_global = as.data.frame(read_xlsx(here("data/input_data/albacore_diet_global.xlsx"),
                      sheet = "albacore_diet_global")) %>% #2134 rows and 77 vars
  dplyr::filter(TaxLev == "species") %>% #1107 rows and 77 vars
  #There are ~1105 observations when we filter by species
  dplyr::filter(Include %in% c("Yes", "Maybe") & !pred_life == "larvae") %>% #1028 rows
  #1028 when we remove larval albacore diet studies (there are 3)
  #dplyr::rename() %>%
  dplyr::select(StudyID, CiteAuth, CiteYear, OceanBasin, OceanBasinQ, LocatName,
                LocatLatitude:LocatLongitude, MonthRange, YearEnd, stomachs_used,
                pred_life:est_ref, stomachs_used, prey_class:prey_sp,
                prey_age_reported_1:prey_age_use, Include, FO, 
                pFOuse, N, pN, `Total Mass (g)`, pM, maxl_use, maxl_type) %>%
  mutate(gape_lmax = pred_flmean*0.0823+1.758, 
         gape_height_limit = pred_flmean*0.0246+4.603,
         prey_age_reported_1=case_when(
                             #prey_age_reported_1 == "NA" ~ "none",
                             prey_age_reported_1 == "larvae" ~ "larva",
                             prey_age_reported_1 == "juvenile" ~ "juvenile",
                             prey_age_reported_1 == "adult" ~ "adult"))
  #1028 obsm 44 vars
  #calculates the gape length and height limits
  #Reference paper for this calculation -- Menard et al. (2006) for yellowfin tuna

#Correct data type
alb_global$maxl_use <- as.numeric(alb_global$maxl_use)
#The NA's in the reported age for prey column cause problems later and need 
#to be assigned a categorical value
alb_global$prey_age_reported_1 <- as.character(alb_global$prey_age_reported_1)
alb_global$prey_age_reported_1 <- replace_na(alb_global$prey_age_reported_1, "none")
#check this
unique(as.factor(alb_global$prey_age_reported_1))

#Change vector type for YearEnd variable
alb_global$YearEnd <- as.integer(alb_global$YearEnd)

#Deal with NA's in stomachs used column
alb_global$stomachs_used <- as.integer(alb_global$stomachs_used)
alb_global$stomachs_used <- as.character(alb_global$stomachs_used)
alb_global$stomachs_used <- replace_na(alb_global$stomachs_used, "not reported")
unique(alb_global$stomachs_used)

#Save total df version
write.csv(alb_global, here("data/output_data/alb_global_diet_total.csv"), 
          row.names = FALSE) 
#1028 observations and 41 variables

```


### Covariates

```{r Covariates, tidy = TRUE}

alb_covars = alb_global %>%
  dplyr::select(StudyID, CiteYear, OceanBasin, OceanBasinQ, LocatName, LocatLatitude:pred_life_est) %>% #, stomachs_used
  distinct(StudyID, CiteYear, OceanBasin, OceanBasinQ, LocatName, LocatLatitude, 
           LocatLongitude, YearEnd, MonthRange, stomachs_used, pred_life) %>% 
  #, stomachs_used
  mutate(lat_cat = if_else(abs(LocatLatitude) > 23.43662, "temperate", "tropical"),
         pred_life_adjust=case_when(pred_life == "juvenile" ~ "juvenile",
                             pred_life == "juvenile, adult" ~ "mixed",
                             pred_life == "none" ~ "mixed",
                             pred_life == "adult" ~ "adult"))

alb_covars$rep_ID = paste(alb_covars$StudyID, row.names(alb_covars), sep = "_")

#Merge these back to the diet df
alb_global_diet = alb_global %>%
  left_join(alb_covars)

write.csv(alb_covars, here("data/output_data/alb_covars.csv"), row.names = FALSE)

```

## Data checks

### Prey length info reported

```{r Reported prey size information}

alb_global_prey_lengths = alb_global %>%
  filter(maxl_use > 0) %>%
  dplyr::select(prey_class:prey_sp, pFOuse, pN, pM, maxl_use, maxl_type) %>%
  group_by(prey_sp, maxl_type) %>% #, life_stage , pFOuse, pN, pM
  dplyr::summarize(maxFO = max(pFOuse, na.rm=TRUE), 
                   maxN = max(pN, na.rm=TRUE), 
                   maxM = max(pM, na.rm=TRUE), 
                   maxL = max(maxl_use, na.rm=TRUE)) 

```

### Prey life stage reported

```{r Reported prey lifestage information}

alb_global_prey_life = alb_global %>%
  filter(prey_age_reported_1 != "none",) %>%
  dplyr::select(prey_class:prey_sp, prey_age_reported_1, pFOuse, pN, pM, maxl_use, maxl_type) %>%
  group_by(prey_sp, prey_age_reported_1, maxl_type) %>% #, life_stage , pFOuse, pN, pM
  dplyr::summarize(maxFO = max(pFOuse, na.rm=TRUE), 
                   maxN = max(pN, na.rm=TRUE), 
                   maxM = max(pM, na.rm=TRUE), 
                   maxL = max(maxl_use, na.rm=TRUE)) 

```

### Prey prevalence data reported

```{r Reported prey lifestage information}

alb_global_metrics = alb_global %>%
  #unique(c(alb_global_prob$prey_sp, alb_global_prob$prey_select))
  dplyr::select(prey_class:prey_sp, prey_age_reported_1, pFOuse, pN, pM, maxl_use, maxl_type) %>%
  group_by(prey_sp, prey_age_reported_1, maxl_type) %>% #, life_stage , pFOuse, pN, pM
  dplyr::summarize(maxFO = max(pFOuse, na.rm=TRUE), 
                   maxN = max(pN, na.rm=TRUE), 
                   maxM = max(pM, na.rm=TRUE), 
                   maxL = max(maxl_use, na.rm=TRUE)) 

```




## GO TO 'longhurst' work then back here

#### Extracting co-variates

Could edit the Longhurst doc to separate biomes and codes as per province definitions:
https://en.wikipedia.org/wiki/Longhurst_code#:~:text=Longhurst%20code%20refers%20to%20a,unique%20set%20of%20environmental%20conditions 
Note that we are having issues with this code and need to re-run it / troubleshoot.

```{r Covars + Longhurst, tidy = TRUE}
#Covars + Longhurst

alb_covars_geog <- read.csv(here("data/output_data/alb_covars_longhurst.csv")) #%>%
#  dplyr::rename(MonthRange2 = `MonthRange`)
#  dplyr::select(-MonthRange)
#  dplyr::select(StudyID, lat_cat:code) #%>%
#  group_by(StudyID) %>%
#  sample_n(1)
#names(alb_covars_geog)

str(alb_covars_geog)
str(alb_covars)

#Need to merge this with diet data first overall data then probable prey consumed
unique(alb_covars_geog$code)

#check names match
#unique(sort(alb_covars_geog$StudyID)) == unique(sort(alb_global$StudyID)) #they do
#unique(sort(alb_covars_geog$CiteYear)) == unique(sort(alb_global$CiteYear)) #they do
#unique(sort(alb_covars_geog$YearEnd)) == unique(sort(alb_global$YearEnd)) #they do
#unique(sort(alb_covars_geog$code))

#check names match
unique(sort(alb_covars_geog$StudyID)) == unique(sort(alb_covars$StudyID)) #they do
unique(sort(alb_covars_geog$CiteYear)) == unique(sort(alb_covars$CiteYear)) #they do
unique(sort(alb_covars_geog$YearEnd)) == unique(sort(alb_covars$YearEnd)) #they do
unique(sort(alb_covars_geog$MonthRange)) == unique(sort(alb_covars$MonthRange)) #they do NOT
# Potential problem with MonthRange

alb_covars_use = alb_covars_geog %>%
  dplyr::select(-optional, -MonthRange)

```

```{r Covars + Longhurst + Diet data, tidy = TRUE}

alb_global_diet = alb_global_prob %>%
  left_join(alb_covars_use) %>% #looks good #, by = "StudyID"
  dplyr::select(StudyID:YearEnd, rep_ID, province, code, lat_cat, pred_life_adjust,
                stomachs_used:est_ref, prey_class:maxtl_use, prey_length:life_stage)

#Write over previous output from first data chunk
write.csv(alb_global_diet, here("data/output_data/alb_global_diet_total.csv"), 
          row.names = FALSE)
```


**NOTE** Below we include the adult cluster number but need to use the cluster number from probable life stage if we stick to this for final analysis.

### Diet datasets

Note that there are a handful of cases where the same prey species was consumed and reported for two different life stages. Because this affects three species and for only one study, the simplest solution to be able to move forward, we need to just select the most commonly consumed species/life stage combination.

```{r Check on duplicates for prey by life stage, tidy = TRUE}

#Previous problem rows
#View(alb_global_diet[c(192, 226, 111, 118, 204, 247, 99, 117, 227, 248),])
#select 192, 111, 247, 99, 248
#alb_global_diet_use = alb_global_diet %>%
#  slice(., -c(226, 118, 117, 204, 227))

#Updated data was downloaded with different order of the data so these rows have moved
View(alb_global_diet[c(59, 71, 70, 77, 64, 81, 69, 76, 72, 82),])

#We select to keep the most common one (typically these were the same species appearing in the same study for two different life stages and this only affected the Bouxin & Legendre papers)
alb_global_diet_use = alb_global_diet %>%
  slice(., -c(71, 77, 64, 76, 72))

```

#### Presence/absence

Here we will join our additional covariates (inc. Longhurst province data) with the diet data, and generate a wide format df with species as columns and values for species' presence absence (PA). These data will be used for traitglms.

```{r Covars + Longhurst + Diet data PA, tidy = TRUE}
#Extract data --> filter for only species that we have adult traits + cluster info for 
# --> transform to wide data for MV GLMs + trait GLMs
alb_global_dietpa = alb_global_diet_use %>% #_use
  dplyr::select(#StudyID:stomachs_used, lat_cat:code, pred_life_adjust, pred_flmean, prey_age_reported_1, prey_sp
    StudyID, rep_ID, YearEnd, OceanBasin, OceanBasinQ, province, code, lat_cat, 
    pred_life_adjust, prey_sp) %>%
  mutate(pa="1") %>%
  group_by(prey_sp) %>%
  #dplyr::mutate(grouped_id = row_number()) %>%
  spread(prey_sp, pa, fill = 0, convert = FALSE)

#Check covariate representation
summary(as.factor(alb_global_dietpa$lat_cat))
summary(as.factor(alb_global_dietpa$code))
summary(as.factor(alb_global_dietpa$OceanBasin))
summary(as.factor(alb_global_dietpa$OceanBasinQ))

write.csv(alb_global_dietpa, here("data/output_data/alb_global_wide_dietpa.csv"), 
          row.names = FALSE)
```

#### Diet data - frequency of occurrence

Here we will join our additional covariates (inc. Longhurst province data) with the diet data, and generate a wide format df with species as columns and values for reported frequency of occurrence (FO). Because these data may be used for traitglms and converted to presence/absence, we filter for very low occurrence species (< 1%).

```{r Covars + Longhurst + Diet data FO, tidy = TRUE}

#Extract %FO data --> filter for only species that we have adult traits + 
# cluster info for --> transform to wide data for MV GLMs + trait GLMs

alb_global_dietfo = alb_global_diet_use %>%
  dplyr::select(StudyID, rep_ID, YearEnd, OceanBasin, OceanBasinQ, province, code, 
                lat_cat, pred_life_adjust, prey_sp, pFOuse) %>%
  filter(pFOuse >= 1) %>% #set this value to include or exclude species #goes down to 62 observations
  group_by(prey_sp) %>%
  #dplyr::mutate(grouped_id = row_number()) %>%
  spread(prey_sp, pFOuse, fill = 0, convert = FALSE)

#Check these data
which(rowSums(alb_global_dietfo[,10:ncol(alb_global_dietfo)])<1)

#Before spreading data - range(alb_global_dietfo$pFOuse) 
#0 to 100 need to exclude zeros as they are not true zeros --> 0.1 to 100%

#Check covariate representation
summary(as.factor(alb_global_dietfo$lat_cat))
summary(as.factor(alb_global_dietfo$code))
summary(as.factor(alb_global_dietfo$OceanBasin))
summary(as.factor(alb_global_dietfo$OceanBasinQ))

write.csv(alb_global_dietfo, here("data/output_data/alb_global_wide_dietfo.csv"), 
          row.names = FALSE)

```


#### Diet data - abundance

```{r Covars + Longhurst + Diet data N, tidy = TRUE}
#Extract for %N data
alb_global_dietn = alb_global_diet_use %>%
  dplyr::select(StudyID, rep_ID, YearEnd, OceanBasin, OceanBasinQ, province, code, lat_cat, pred_life_adjust, prey_sp, pN) %>%
  filter(pN > 0) %>%
  #filter(prey_sp %in% alb_adult_traits$prey_sp) %>%
  group_by(prey_sp) %>%
  spread(prey_sp, pN, fill = 0, convert = FALSE)

#Check covariate representation
summary(as.factor(alb_global_dietn$lat_cat))
summary(as.factor(alb_global_dietn$code))
summary(as.factor(alb_global_dietn$OceanBasin))
summary(as.factor(alb_global_dietn$OceanBasinQ))

write.csv(alb_global_dietn, here("data/output_data/alb_global_wide_dietn.csv"), row.names = FALSE)
```

#### Diet data - biomass

```{r Covars + Longhurst + Diet data M, tidy = TRUE}
#Extract for %M data
#range(alb_global_dietm$pM) #0 to 95.2, need to exclude zeros as not true zeros

alb_global_dietm = alb_global_diet %>%
  dplyr::select(StudyID, rep_ID, YearEnd, OceanBasin, OceanBasinQ, province, code, lat_cat, pred_life_adjust, prey_sp, pM) %>%
  filter(pM > 0) %>%
#  filter(prey_sp %in% alb_adult_traits$prey_sp) %>%
  group_by(prey_sp) %>%
  spread(prey_sp, pM, fill = 0, convert = FALSE)

#Check covariate representation
summary(as.factor(alb_global_dietm$lat_cat))
summary(as.factor(alb_global_dietm$code))
summary(as.factor(alb_global_dietm$OceanBasin))
summary(as.factor(alb_global_dietm$OceanBasinQ))

write.csv(alb_global_dietm, here("data/output_data/alb_global_wide_dietm.csv"), row.names = FALSE)

```

### Extra from older code

```{r Adding morph info for checking reported prey lengths, eval=FALSE}

#Can use prey_morph_sum for "standard_total" conversion info for SL to TL.
  #left_join(prey_morph_sum, by="prey_sp") 
  #added morph info --> 1028 obs, 44 vars
 
#Cleaning metrics
alb_global = alb_global %>% 
  mutate(maxtl_use = if_else(alb_global$maxl_type %in% c("SL", "ML"), 
                             maxl_use/standard_total, maxl_use)
         ) #%>%

```
