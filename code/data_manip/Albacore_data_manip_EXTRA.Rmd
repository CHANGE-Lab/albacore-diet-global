---
title: "Extra"
author: "Natasha Hardy & Caitlin Morgenson"
date: "26/02/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## LOAD IN CLEAN DATASETS HERE

```{r LOAD prey_morph_sum}

prey_morph_sum = read.csv(here("/data/prey_morph_sum.csv")) %>%
  dplyr::select(-X)

```



```{r LOAD prey_qual_sum}
prey_qual_sum = read.csv(here("/data/prey_qual_sum.csv")) %>%
  dplyr::select(-X)

```


### Albacore prey trait db


```{r Prey traits adults - data extract}

prey_trait_adult = prey_trait %>%
  dplyr::filter(life_stage == "adult") %>% #currently df already split by age group
  dplyr::select(prey_class:prey_sp, vert_habitat, horz_habitat, diel_migrant, diel_migrant_cat, refuge, refuge_cat, season_migrant, season_cat, body_shape, l_max, phys_defense, transparent, col_disrupt, silver, countershade, gregarious_primary, trophic_level, fisheries_status) #select traits we want to analyse
  
str(prey_trait_adult) #Extracting 308 species and 18 variables
str(prey_trait)
```


``` {r Prey size ratios graphs}
#Check the ratios out with graphs
prey_length_ratios %>% 
  dplyr::filter(prey_class %in% c("Cephalopoda")) %>% #"Actinopterygii", , "Malacostraca"
  ggplot() +
  geom_boxplot(aes(x=prey_order, y=larva_adult_o, fill=measure)) +
  #xlab("Ocean Basin") + ylab("Frequency of Occurance(%)") + 
  theme_classic() +
  scale_fill_viridis_d(option="D", begin = 1, end = 0.6, name = "Larva to adult length ratio")+
  theme(axis.title=element_text(size=20)) +
  theme(axis.text=element_text(size=20)) +
  theme(legend.text=element_text(size=20)) +
  theme(legend.title=element_text(size=20)) +
  theme(legend.position="top")
#Note significant variation in family-level mean l_max and l_min values



#This never seems to work for me
#prey_length_ratios = prey_length_wide %>% 
#  group_by(prey_class, measure) %>%
#  plyr::summarise(larva_adult_m = mean(larva_adult)) #%>%
#   group_vars(larva_adult)



```

```{r LOAD alb_global}

#Reload data
alb_global = read.csv(here("data/alb_global_diet_total.csv")) %>%
  dplyr::select(-X)
unique(alb_global$StudyID) #26 papers in analyses

```


```{r LOAD alb_global_prob}

alb_global_prob = read.csv(here("data/alb_global_diet_prob.csv")) %>%
  dplyr::select(-X)

```


```{r Alb probable diet metrics summary}

#All combinations of life stages and species consumed
alb_global_prob_list = alb_global_prob %>%
  dplyr::select(prey_class:prey_sp, life_stage, pFOuse, pN, pM) %>%
  group_by(prey_sp, life_stage) %>%
  dplyr::summarize(maxFO = max(pFOuse, na.rm=TRUE), maxN = max(pN, na.rm=TRUE), maxM = max(pM, na.rm=TRUE))

str(alb_global_prob_list)
View(alb_global_prob_list)
#Save data if needed
write.csv(alb_global_prob_list, "alb_global_prob_list.csv")

#But we need to select the main one...

```

```{r Albacore prey life stages lists}
#Need to summarise prey life stages and attach trait data
unique(as.factor(alb_global_prob_list$prey_sp)) #there are 303 unique species
#So we should obtain 303 species in the following code.

str(alb_global_prob_list$maxFO)
glimpse(alb_global_prob_list)

#The most common life stage and species consumed!!
alb_global_prob_metrics = alb_global_prob_list %>%
  group_by(prey_sp) %>%
  top_n(1, maxFO) %>% #WHY ARE THERE 304 SPECIES??? No idea but I guess one of these rows has to go, will have to do it randomly.
  sample_n(1)

write.csv(alb_global_prob_metrics, here("data/alb_global_prob_metrics"))

```

Note:
The maxFO, maxN or maxM are related to the study, they are typically the same between both sets of summary data for adult and probable life stage.


## DATA SETS

```{r Prey adult traits + morph + qual data}

prey_adults_merge = prey_trait_adult %>% 
  left_join(prey_morph_sum, by="prey_sp") %>% 
  left_join(prey_qual_sum, by="prey_sp") %>%
  left_join(alb_global_ad_metrics, by="prey_sp")

dim(prey_adults_merge) #308 spp and ~27 traits

str(prey_adults_merge)

write.csv(prey_adults_merge, here("data/prey_adults_traits.csv"))
prey_adults_merge = read.csv(here("data/prey_adults_traits.csv"))

```

```{r ORDINAL Prey adult traits + morph + qual data}

prey_adults_ord = prey_trait %>% 
  filter(prey_sp %in% prey_adults_merge$prey_sp,
         life_stage == "adult") %>%
  select(prey_class:prey_sp, life_stage, vert_primary_ordinal, horz_habitat_ordinal, diel_migrant, refuge, season_migrant, body_shape_ordinal, phys_defense, transparent, col_disrupt, silver, countershade, gregarious_ordinal)
  #left_join(prey_morph_sum, by="prey_sp") %>% 
  #left_join(prey_qual_sum, by="prey_sp") %>%
  #left_join(alb_global_ad_metrics, by="prey_sp")

dim(prey_adults_ord) #308 spp and ~17 traits

str(prey_adults_ord)

write.csv(prey_adults_ord, here("data/prey_adults_traits_ord.csv"))

```

```{r BINARY Prey adult traits + morph + qual data}

prey_adults_ord = prey_trait %>% 
  filter(prey_sp %in% prey_adults_merge$prey_sp,
         life_stage == "adult") %>%
  select(prey_class:prey_sp, life_stage, vert_primary_ordinal, horz_habitat_ordinal, diel_migrant, refuge, season_migrant, body_shape_ordinal, phys_defense, transparent, col_disrupt, silver, countershade, gregarious_ordinal)
  #left_join(prey_morph_sum, by="prey_sp") %>% 
  #left_join(prey_qual_sum, by="prey_sp") %>%
  #left_join(alb_global_ad_metrics, by="prey_sp")

dim(prey_adults_ord) #308 spp and ~17 traits

str(prey_adults_ord)

write.csv(prey_adults_ord, here("data/prey_adults_traits_ord.csv"))

```

```{r Prey probable list + traits + morph + qual data}

prey_probable_merge = alb_global_prob_metrics %>%
  left_join(prey_trait_select, by=c("prey_sp", "life_stage")) %>% 
  left_join(prey_morph_sum, by="prey_sp") %>% 
  left_join(prey_qual_sum, by="prey_sp") %>%
  dplyr::select(prey_class:prey_family, prey_sp:life_stage, vert_habitat:percent_lipid, maxFO:maxM)

dim(prey_probable_merge) #303 spp and ~28 traits
View(prey_probable_merge)

write.csv(prey_probable_merge, here("data/prey_probable_traits.csv"))

#prey_probable_merge = read.csv(here("data/prey_probable_traits.csv"))
#View(prey_probable_merge)

```


```{r ORDINAL Prey probable traits + morph + qual data}

prey_probable_merge = read.csv(here("data/prey_probable_traits.csv"))

prey_prob_ord = prey_probable_merge %>% 
  select(prey_sp:life_stage) %>%
  left_join(prey_trait, by=c("prey_sp", "life_stage")) %>%
  select(prey_class:prey_family, prey_sp, life_stage, vert_primary_ordinal, horz_habitat_ordinal, diel_migrant, refuge, season_migrant, body_shape_ordinal, phys_defense, transparent, col_disrupt, silver, countershade, gregarious_ordinal)
  #left_join(prey_morph_sum, by="prey_sp") %>% 
  #left_join(prey_qual_sum, by="prey_sp") %>%
  #left_join(alb_global_ad_metrics, by="prey_sp")

dim(prey_adults_ord) #303 spp and ~17 traits

str(prey_prob_ord)

write.csv(prey_prob_ord, here("data/prey_prob_traits_ord.csv"))

```


```{r Covariates}

alb_covars = alb_global %>%
  dplyr::select(StudyID, CiteYear, OceanBasin, OceanBasinQ, LocatLatitude:pred_life_est) %>%
  distinct(StudyID, CiteYear, OceanBasinQ, LocatLatitude, LocatLongitude, YearEnd, pred_life) %>%
  mutate(lat_cat = if_else(abs(LocatLatitude) > 23.43662, "temperate", "tropical"),
         pred_life=case_when(pred_life == "juvenile" ~ "juvenile",
                             pred_life == "juvenile, adult" ~ "mixed",
                             pred_life == "adult" ~ "adult"))

write.csv(alb_covars, here("data/alb_covars.csv"))

```

Could edit the Longhurst doc to separate biomes and codes as per province definitions:
https://en.wikipedia.org/wiki/Longhurst_code#:~:text=Longhurst%20code%20refers%20to%20a,unique%20set%20of%20environmental%20conditions 

```{r Covars + Longhurst + Diet data + Adult prey traits + metrics}

alb_covars_geog <- read.csv(here("data/alb_covar_longhurst.csv")) %>%
  dplyr::select(StudyID, lat_cat:code) %>%
  group_by(StudyID) %>%
  sample_n(1)
names(alb_covars_geog)
#Need to merge this with diet data first overall data then probable prey consumed
unique(alb_covars_geog$code)

#check names match
unique(sort(alb_covars_geog$StudyID)) == unique(sort(alb_global$StudyID)) #they do

alb_global_diet = alb_global %>%
  left_join(alb_covars_geog) #looks good #, by = "StudyID"

str(alb_global_diet)
unique(alb_global_diet$code) #Check this.
unique(alb_global_diet$Include)

#upload the cluster info:
alb_adult_traits = read.csv(here("data/adult.prey.clusternum.habgreg.aggl.k9.csv")) %>%
  dplyr::select(prey_sp:adult.clust.num)

#Extract %FO data --> filter for only species that we have adult traits + cluster info for --> transform to wide data for MV GLMs + trait GLMs
alb_global_dietfo = alb_global_diet %>%
  dplyr::select(StudyID:YearEnd, lat_cat:code, pred_life, pred_flmean, prey_sp, pFOuse) %>%
  filter(pFOuse >= 1) %>% #set this value to include or exclude species
  filter(prey_sp %in% alb_adult_traits$prey_sp) %>%
  group_by(prey_sp) %>%
  dplyr::mutate(grouped_id = row_number()) %>%
  spread(prey_sp, pFOuse, fill = 0, convert = FALSE)

#range(alb_global_dietfo$pFOuse) #0 to 100 need to exclude zeros as they are not true zeros --> 0.1 to 100%

#Check covariate representation
summary(as.factor(alb_global_dietfo$lat_cat))
summary(as.factor(alb_global_dietfo$code))
summary(as.factor(alb_global_dietfo$OceanBasin))
summary(as.factor(alb_global_dietfo$OceanBasinQ))

write.csv(alb_global_dietfo, here("data/alb_global_wide_dietfo.csv"))
#Need corresponding species and probable age
#range(alb_global_dietn$pN)

#Extract for %N data
alb_global_dietn = alb_global_diet %>%
  dplyr::select(StudyID:YearEnd, lat_cat:code, pred_life, pred_flmean, prey_sp, pN) %>%
  filter(pN > 0) %>%
  filter(prey_sp %in% alb_adult_traits$prey_sp) %>%
  group_by(prey_sp) %>%
  dplyr::mutate(grouped_id = row_number()) %>%
  spread(prey_sp, pN, fill = 0, convert = FALSE)

#Check covariate representation
summary(as.factor(alb_global_dietn$lat_cat))
summary(as.factor(alb_global_dietn$code))
summary(as.factor(alb_global_dietn$OceanBasin))
summary(as.factor(alb_global_dietn$OceanBasinQ))

write.csv(alb_global_dietn, here("data/alb_global_wide_dietn.csv"))

#Extract for %M data
#range(alb_global_dietm$pM) #0 to 95.2, need to exclude zeros as not true zeros

alb_global_dietm = alb_global_diet %>%
  dplyr::select(StudyID:YearEnd, lat_cat:code, pred_life, pred_flmean, prey_sp, pM) %>%
  filter(pM > 0) %>%
  filter(prey_sp %in% alb_adult_traits$prey_sp) %>%
  group_by(prey_sp) %>%
  dplyr::mutate(grouped_id = row_number()) %>%
  spread(prey_sp, pM, fill = 0, convert = FALSE)

#Check covariate representation
summary(as.factor(alb_global_dietm$lat_cat))
summary(as.factor(alb_global_dietm$code))
summary(as.factor(alb_global_dietm$OceanBasin))
summary(as.factor(alb_global_dietm$OceanBasinQ))

write.csv(alb_global_dietm, here("data/alb_global_wide_dietm.csv"))


#Repeat for probable age data
#alb_global_dietfo = alb_global_diet %>%
#  dplyr::select(StudyID:YearEnd, lat_cat:code, pred_life, pred_flmean, prey_sp, pFOuse) %>%

```

```{r PROBABLE COVARS}

#Do we need probable life stage covars? Or can I subset?

```


```{r PREY SIZE GRAPHS}

##Now we need cut offs for larva and juveniles maybe based either at class, order or family levels
## GRAPH THIS!

## Visualising raw values
### For larvae
prey_length_data %>% 
  filter(life_stage == "larva") %>%
  ggplot() +
  geom_boxplot(aes(x=prey_class, y=length_tl, fill=measure)) +
  #xlab("Ocean Basin") + ylab("Frequency of Occurance(%)") + 
  theme_classic() +
  scale_fill_viridis_d(option="D", begin = 1, end = 0.6, name = "Length")+
  theme(axis.title=element_text(size=20)) +
  theme(axis.text=element_text(size=20)) +
  theme(legend.text=element_text(size=20)) +
  theme(legend.title=element_text(size=20)) +
  theme(legend.position="top")

## Note:
#For crustaceans, there are very few that would be consumed as larvae, as their sizes are so small, there may be other ways to select a probable life stage.
#For cephalopods, appears to be group 1 ~ 4 cm, with median ~ 1.5-2 cm
#For fish, there is at least a group cut off < 4 cm, and 1st quartile ~ 2.5 cm, median ~ 3 cm.
## Need to calculate ratios

#Calculate mean?
### For juveniles
prey_length_data %>% 
  filter(life_stage == "juvenile") %>%
  ggplot() +
  geom_boxplot(aes(x=prey_class, y=length_tl, fill=measure)) +
  #xlab("Ocean Basin") + ylab("Frequency of Occurance(%)") + 
  theme_classic() +
  scale_fill_viridis_d(option="D", begin = 1, end = 0.6, name = "Length")+
  theme(axis.title=element_text(size=20)) +
  theme(axis.text=element_text(size=20)) +
  theme(legend.text=element_text(size=20)) +
  theme(legend.title=element_text(size=20)) +
  theme(legend.position="top")

## Note:
#For crustaceans ...
#For cephalopods ...
#For fish, where data missing use 1/3 adult size
summary(prey_length_wide$prey_class)

##Visualise using ratios
### For larvae
prey_length_wide %>% 
  dplyr::filter(prey_class %in% c("Actinopterygii", "Cephalopoda", "Malacostraca")) %>%
  ggplot() +
  geom_boxplot(aes(x=prey_class, y=larva_adult, fill=measure)) +
  #xlab("Ocean Basin") + ylab("Frequency of Occurance(%)") + 
  theme_classic() +
  scale_fill_viridis_d(option="D", begin = 1, end = 0.6, name = "Larval to adult length ratio")+
  theme(axis.title=element_text(size=20)) +
  theme(axis.text=element_text(size=20)) +
  theme(legend.text=element_text(size=20)) +
  theme(legend.title=element_text(size=20)) +
  theme(legend.position="top")
#Save output
ggsave(here("output_figures/diet_mvtraits/larva_adult_ratio.jpg"), width = 10, height = 5)

prey_length_wide %>% 
  dplyr::filter(prey_class %in% c("Actinopterygii", "Cephalopoda", "Malacostraca")) %>%
  ggplot() +
  geom_boxplot(aes(x=prey_class, y=juve_adult, fill=measure)) +
  #xlab("Ocean Basin") + ylab("Frequency of Occurance(%)") + 
  theme_classic() +
  scale_fill_viridis_d(option="D", begin = 1, end = 0.6, name = "Juvenile to adult length ratio")+
  theme(axis.title=element_text(size=20)) +
  theme(axis.text=element_text(size=20)) +
  theme(legend.text=element_text(size=20)) +
  theme(legend.title=element_text(size=20)) +
  theme(legend.position="top")

ggsave(here("output_figures/diet_mvtraits/juve_adult_ratio.jpg"), width = 10, height = 5)

```


## OLD DATASETS
### Phylograph Input files

```{r Prey traits - Phylographs draft}

#For phylo graphs
prey_traits_graphs = prey_trait_cats %>%
  select(prey_class:life_stage, vert_habitat, horz_habitat, diel_migrant, refuge, season_migrant, body_shape, phys_defense, transparent, col_disrupt, countershade, photophore_PA, gregarious_primary, trophic_level) %>% #Could add later for fisherman paper: IUCN_status, commercial, recreational
  dplyr::filter(life_stage == "adult") 
  #dplyr::filter( %in% ) %>% #c("no", "NA")
  #filter out everything but adult life_stage, filter out images that are use = "no"
  #drop_na(t_length, b_height, eye_diameter) %>% #filter out any NA's in the desired columns
  #mutate(b_shape_r = t_length/b_height, eye_body_r = eye_diameter/t_length)

str(prey_traits_graphs)
names(prey_trait_cats)
dim(prey_trait_cats) #809 rows for adult data


#FOR BASIC PHYLO TREE
my_prey = prey_traits_graphs %>%
  dplyr::select(prey_class:prey_sp)

write.csv(my_prey, "my_prey.csv")

```

```{r Prey traits - Clusters}

#Need the categorical traits for the cluster analyses
prey_traits_cats = prey_trait %>%
  dplyr::select(prey_class:prey_sp, life_stage, vert_habitat, horz_habitat, diel_migrant_cat, refuge_cat, season_cat, body_shape, defense_cat, gregarious_primary) %>% #Could add later for fisherman paper: IUCN_status, commercial, recreational
  dplyr::filter(life_stage == "adult") 
  #dplyr::filter( %in% ) %>% #c("no", "NA")
  #filter out everything but adult life_stage, filter out images that are use = "no"
  #drop_na(t_length, b_height, eye_diameter) %>% #filter out any NA's in the desired columns
  #mutate(b_shape_r = t_length/b_height, eye_body_r = eye_diameter/t_length)

write.csv(prey_traits_cats, "prey_traits_cats.csv")

glimpse(prey_traits_cats)
dim(prey_traits_cats) #809 rows for adult data
```


```{r Albacore diet data load for rarefaction curves}
getwd()

# need total unfiltered data for rarefaction curve
prey_total <- read.csv("prey_total.csv", header = TRUE)
head(prey_total)


# cleaned dataset, filtered for fish & cephalopods only, for include = yes, for FO > 0% and excluding NAs, for albacore adult diet.
prey_long <- read.csv("prey_long_clean.csv", header = TRUE)


```

## Plastics project rarefaction fig code

```{r plastics project rarefaction code}

#### RAREFACTION CURVE ----
## MAX'S RAREFACTION CURVE
## Cumulative unique entries in list of vectors

cum_unique <- function(l) {
  result <- integer(length(l))
  for (i in 1:length(l)) {
    result[i] <- length(unique(unlist(l[1:i])))
  }
  result
}

prey_rare <-  prey_total %>% 
  group_by(OceanBasinQ,YearSample) %>% 
  summarize(species = list(unique(PreySP))) #,
#            annual_N = sum(N)) %>% 
#  ungroup %>% 
#  mutate(cum_species = cum_unique(species),
#         cum_n = cumsum(annual_N),
#         cpue = cum_species / cum_n)

View(prey_rare)

d_rarefaction_ingest_only <-  d_full %>%  
  filter(prop_w_plastic > 0) %>% 
  group_by(publication_year) %>% 
  summarize(species = list(unique(binomial)),
            annual_N = sum(N)) %>% 
  ungroup %>% 
  mutate(cum_species = cum_unique(species),
         cum_n = cumsum(annual_N),
         cpue = cum_species / cum_n)

rarefaction_plot <- ggplot() +
  geom_line(data = d_rarefaction_all, aes(cum_n, cum_species), color = "dark blue") +
  geom_line(data = d_rarefaction_ingest_only, aes(cum_n, cum_species), color = "dark red") +
  geom_point(data = d_rarefaction_all, aes(cum_n, cum_species)) +
  geom_point(data = d_rarefaction_ingest_only, aes(cum_n, cum_species)) +
  geom_text_repel(data = d_rarefaction_all, 
                  aes(cum_n, cum_species, label = publication_year), 
                  nudge_x = -1500, nudge_y = 10,
                  segment.color = "black") +
  geom_text_repel(data = d_rarefaction_ingest_only, 
                  aes(cum_n, cum_species, label = publication_year), 
                  nudge_x = 1500, nudge_y = -10,
                  segment.color = "black") +
  labs(x = "Cumulative number of individuals sampled",
       y = "Cumuluative number of species sampled") + 
  theme_classic(base_size = 14)
rarefaction_plot

```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.