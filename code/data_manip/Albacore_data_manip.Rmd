---
title: "Albacore Review Data Manipulation"
author: "Natasha Hardy"
date: "October 10, 2019"
output: html_document
---

## About

This document contains code for manipulating trait and diet datasets for albacore prey species from our global meta-analysis of albacore diet composition.

```{r setup, include=FALSE, echo=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

```{r Load Workspace, message=FALSE}

#R documentation
library(pander)
# general
library(tidyverse)
library(readxl)
library(readr)
library(plyr)
library(dplyr)
library(devtools)
library(here)
"%notin%" = Negate('%in%')
here::here()
#Graphics
library(graphics)
library(ggplot2)
library(RColorBrewer)
library(Hmisc)
library(lattice)
library(gridExtra)
library(captioner)
library(unmarked)
#Analyses
library(lme4)
library(mgcv)
library(mvabund)
library(tweedie)

```

## Trait Dataframes

### Prey morphometric measurements

We first want to load in and clean the prey morphometric measurements for adult taxa only, we did not finish or find many images to work with for juveniles or larvae of most species. The following code aims to:

- Check & select relevant data,

- Calculate eye to body and body shape ratios, based on adult specimen images and morphometrics only.

- Note we have also added a conversion from standard length to total length (this can be used to convert lengths for SL/BL, ML/GL where we have them).

- Summarise to give an average value for each species for which we obtained images. We are able to obtain values for 293 species.

```{r Prey Morph Data Clean}

#Load prey morphometric measurement data

prey_morph = as.data.frame(read_xlsx(here("data/input_data/prey_morphometrics.xlsx"), 
                                                 sheet = "prey_adult_morphometrics"))

#Convert relevant columns to character/numeric values
prey_morph[,12:17] <- sapply(prey_morph[,12:17], as.numeric) #as.character

#Data cleaning
prey_morph_clean = prey_morph %>%
  dplyr::filter(use %in% c("yes", "maybe")) %>% #c("no", "NA")
  #filter out images that are use = "no"
  drop_na(t_length, b_height, eye_diameter) %>% #filter out any NA's in the desired columns
  mutate(b_shape_r = t_length/b_height, 
         eye_body_r = eye_diameter/t_length,
         standard_total = s_length/t_length) #calculate values for body_shape_r & eye_body_r

glimpse(prey_morph_clean)

```

```{r Prey Morph Summarise}

#Calculate ratios/summarise data
prey_morph_sum = prey_morph_clean %>% 
  dplyr::select(prey_class:prey_sp, b_shape_r, eye_body_r, standard_total) %>% #life_stage, 
  group_by(prey_sp) %>% #, life_stage
  dplyr::summarize(b_shape_r = mean(b_shape_r), eye_body_r = mean(eye_body_r), standard_total = mean(standard_total))

#Could calculate standard deviations if needed
#b_shape_se = sd(b_shape_r)/sqrt(length(b_shape_r)), eye_body_se = sd(eye_body_r)/sqrt(length(eye_body_r))

#Here we obtain species level ratios for body shape, eye diameter to body, and standard to total length.

glimpse(prey_morph_sum) #292 average values for 308 species (originally)

write.csv(prey_morph_sum, here("data/output_data/prey_morph_sum.csv"))

```


### Prey Quality Data

These include data obtained for prey quality nutritional information for %lipid content, %protein and energy density, typically representing an average value per study for each species of prey, and based on wet weight measured.
Note that Zach put together meta-data for this dataframe.

```{r Prey Qual Data Clean & Summarise}
#Load prey trait db
prey_qual <- read.csv(here("data/input_data/prey_quality_ww.csv"))
str(prey_qual) #Check data

#Correct data type
prey_qual$percent_lipid <- as.numeric(prey_qual$percent_lipid)

#Summarise, we want an average value for each of the three metrics - ED, %L and %P for each species.
prey_qual_sum = prey_qual %>%
  #dplyr::select(prey_class:percent_lipid) %>% #life_stage, 
  #drop_na(energy_density:percent_lipid) %>% #filter out any NA's in the desired columns
  group_by(prey_sp) %>% #, life_stage
  dplyr::summarize(energy_density = mean(energy_density, na.rm=TRUE), percent_protein = mean(percent_protein, na.rm=TRUE), percent_lipid = mean(percent_lipid, na.rm=TRUE))

glimpse(prey_qual_sum)

write.csv(prey_qual_sum, here("data/output_data/prey_qual_sum.csv"))

```

### Albacore prey trait db

Loading in and selecting key species coarse traits: for habitat association, morphological characteristics and aggregation behaviour.

```{r Prey trait data load}
#Load prey trait db
prey_trait <- as.data.frame(read_xlsx(here("data/input_data/prey_trait_db.xlsx"),
                                           sheet = "prey_trait_db"))

#Prey Trait selection

prey_trait_select = prey_trait %>%
  dplyr::select(prey_class:prey_sp, life_stage, vert_habitat, horz_habitat, diel_migrant, diel_migrant_cat, refuge, refuge_cat, season_migrant, season_cat, body_shape, l_max, phys_defense, transparent, col_disrupt, silver, countershade, gregarious_primary, trophic_level, fisheries_status)

str(prey_trait_select)
```

## Life stage size ratio calculations

In this section of code we calculate size ratios and threshold ratios for larval, juvenile and adult life stages of prey species, through the following:

- Length conversions calculated previously as 'standard_total': to convert any measurements that are not TL into TL.

- Existing lmin and lmax data for each life stage are used to calculate ratios based on exisiting data;

- Where those data are missing for a species or genus, etc, we calculate those ratios based on data for related species (from genus, family, and so on) to fill in those missing ratios.

- This therefore create useable ratios for all taxa, using ratios at higher levels of classification when needed.

### Manipulate length information

```{r Lmin & Lmax for each species}

#Now need to split the min vs. max lengths to reshape those data and merge again later.
prey_min = prey_trait %>% 
  dplyr::select(prey_class:prey_sp, life_stage, l_min:l_min_type) %>%
  tidyr::gather(key = "l_min", value = "length", l_min) %>%
  dplyr::rename(measure = l_min, l_type = l_min_type)

prey_max = prey_trait %>% 
  dplyr::select(prey_class:prey_sp, life_stage, l_max:l_max_type) %>%
  tidyr::gather(key = "l_max", value = "length", l_max) %>%
  dplyr::rename(measure = l_max, l_type = l_max_type)

#Now we want to bind this data again
#names(prey_min) #check column names are the same for both dfs
prey_length <- rbind(prey_min, prey_max)
```

```{r Cleaning L type values}

#Here we clean the 'l_type' values
prey_length = prey_length %>% #Note can use case_when() or if_ele() BUT you need to write one for each value and not try to combine them as strings using c()
  mutate(`l_type_use`=case_when(prey_length$`l_type` == "TL" ~ "TL",
                                prey_length$`l_type` == "SL" ~ "SL",
                                prey_length$`l_type` == "FL" ~ "TL", 
                                #fork length in some pelagic fishes ~ TL
                                prey_length$`l_type` == "NL" ~ "TL", 
                                #Notochord length in larvae ~ TL
                                prey_length$`l_type` == "CL" ~ "TL", 
                                #Carapace length in some crustaceans ~ TL
                                prey_length$`l_type` == "BL" ~ "TL", 
                                #Body length in larvae ~ TL
                                prey_length$`l_type` == "GL" ~ "SL", 
                                #Gladius length = Mantle length ~ standard length
                                prey_length$`l_type` == "ML" ~ "SL", 
                                #Mantle length ~ standard length
                                prey_length$`l_type` == "AN" ~ "TL", 
                                #Anterior nectophore, appears only in a gastropod, 
                                #going to take is as TL
                                prey_length$`l_type` == "PCL" ~ "SL" 
                                #Pre-claval length for sunfish
                                ) 
         )
```

### Calculate ratios

Below, we obtain a dataset where we have rows for both lmin and lmax for adult, juvenile and larval life stages in columns, as well as the juvenile:adult and larva:adult size ratios where those data exist. We have a number of NAs still, and we will fill those in in the following chunk.

```{r Merge length and morph data}
#Next we need to merge our ratios data set and our lengths datasets.
prey_length_data = prey_length %>% 
  left_join(prey_morph_sum, by="prey_sp") #%>% #c("prey_sp", "life_stage")

prey_length_data = prey_length_data %>%
  mutate(`length_tl`=if_else(prey_length_data$`l_type_use`=="SL", length/standard_total, length))

#Reshape to wide data where each species has row for max and min values, and add two columns with ratios of larval and juvenile sizes to adult by species. We can then summarise these for family, order and class to fill in info.
prey_length_wide = prey_length_data %>%
  dplyr::select(prey_class:life_stage, measure, length_tl) %>%
  spread(life_stage, length_tl, convert=TRUE) %>%
  mutate(larva_adult = 100*larva/adult, juve_adult = 100*juvenile/adult)
#we're going to want the maximum values out of this to use as cut-offs

#unique(prey_length_wide$prey_sp) #309 spp

```

```{r Prey length ratio summaries by group}
##Summarise means of larval and juvenile to adult body length ratios, by family, order and class:
#Note that mean() function returns "NaN" whereas sum()/length() returns zeros for missing data.

#By class
prey_length_class <- plyr::ddply(prey_length_wide, c("prey_class", "measure"), summarise,
                            larva_adult_c = mean(larva_adult, na.rm=TRUE),
                            juve_adult_c = mean(juve_adult, na.rm=TRUE))

#By order
prey_length_order <- plyr::ddply(prey_length_wide, c("prey_order", "measure"), summarise,
                            larva_adult_o = mean(larva_adult, na.rm=TRUE),
                            juve_adult_o = mean(juve_adult, na.rm=TRUE))

#By family
prey_length_fam <- plyr::ddply(prey_length_wide, 
                                c("prey_class", "prey_order", "prey_family", "measure"), 
                                summarise,
                                larva_adult_f = mean(larva_adult, na.rm=TRUE),
                                juve_adult_f = mean(juve_adult, na.rm=TRUE))

##Merge these data to calculate prey cut-offs for family, order and class
#--> Code such that we use first family level mean, then order, then class, to fill in missing information for prey size cut-offs

prey_length_ratios = prey_length_fam %>%
  left_join(prey_length_order, by= c("prey_order", "measure")) %>% #join prey_order info
  left_join(prey_length_class, by= c("prey_class", "measure")) %>% #join prey_class info
  mutate(larva_adult_u = if_else(larva_adult_f == "NaN", 
                                 if_else(larva_adult_o == "NaN", larva_adult_c, larva_adult_o), 
                                 larva_adult_f),
         juve_adult_u = if_else(juve_adult_f == "NaN", 
                                if_else(juve_adult_o == "NaN", juve_adult_c, juve_adult_o), 
                                juve_adult_f)) 
##Make a cut-off selection based on family > order > class level information

#And remove troublesome NA's in original dataset
prey_length_wide$larva_adult[is.na(prey_length_wide$larva_adult)] <- NaN
prey_length_wide$juve_adult[is.na(prey_length_wide$juve_adult)] <- NaN
```

### Length ratio data

Finally, the code below provides us with the following data that can be extracted:
(i) prey trait data as rows for 3x life stages as columns;
(ii) prey length, measurement and type info + average ratio metrics x3 for x3 life stages
We can use these to see what essentially fits in albacore jaws, by using gape length and width formulas for yellowfin tuna applied. These are calculated in a later chunk.

```{r Size ratios for all taxa}
##Now we need to merge this back onto species, and make selection again based on whether the species level info is there

prey_length_ratiosp = prey_length_wide %>%
  dplyr::filter(measure == "l_max") %>%
  dplyr::rename(l_larva = "larva", l_juve = "juvenile", l_adult = "adult") %>%
  left_join(prey_length_ratios, by = c("prey_family", "prey_order", "prey_class", "measure")) %>%
  #dplyr::select(prey_class:measure, larva_adult:juve_adult, larva_adult_u:juve_adult_u) %>%
  mutate(larva_adult_use = if_else(larva_adult == "NaN", larva_adult_u, larva_adult),
         juve_adult_use = if_else(juve_adult == "NaN", juve_adult_u, juve_adult)
         ) %>%
  dplyr::select(prey_class:l_larva, larva_adult_use:juve_adult_use) #%>%
  #dplyr::filter(larva_adult_use != "NaN")

#---> Here we obtain size ratios for all 309 species in trait db
##Problem with NA values
glimpse(prey_length_ratiosp)

```

## Albacore diet review data

Here we need to load up the albacore global diet data to clean and select what we want.
Tasks performed in these chunks:

- Select prey probable life stage;

- Merge probable prey life stage with appropriate traits;

- Retain frequency of occurrence + stomach sampled information for traitglm.

```{r Albacore diet data load & manipulation}

#Load diet data spreadsheet
#need this: prey_length_ratiosp
#This contains species as rows for which we have useable species through to class-level ratio information on larval:adult and juvenile:adult lengths

#Also need prey_length_wide data for l_max for adult column
#Should be able to get this from prey_length_ratiosp

alb_global = as.data.frame(read_xlsx(here("data/input_data/albacore_diet_global.xlsx"),
                      sheet = "albacore_diet_global")) %>%
  dplyr::filter(TaxLev == "species") %>% 
  #There are ~1105 observations when we filter by species
  dplyr::filter(Include %in% c("Yes", "Maybe") & !pred_life == "larvae") %>% 
  #1028 when we remove larval albacore diet studies (there are 3)
  #dplyr::rename() %>%
  dplyr::select(StudyID, CiteAuth, CiteYear, OceanBasin, OceanBasinQ, LocatLatitude:LocatLongitude, YearEnd, pred_life:est_ref, stomachs_used, prey_class:prey_sp, prey_age_reported_1:prey_age_use, Include, FO, pFOuse, N, pN, `Total Mass (g)`, pM, maxl_use, maxl_type) %>%
  mutate(gape_lmax = pred_flmean*0.0823+1.758, gape_height_limit = pred_flmean*0.0246+4.603) %>%
  #calculates the gape length and height limits
  #Add reference paper for this calculation -- Menard et al. (2006) for yellowfin tuna
  left_join(prey_morph_sum, by="prey_sp") 

#Correct data type
alb_global$maxl_use <- as.numeric(alb_global$maxl_use)

#Cleaning metrics
alb_global = alb_global %>% 
  mutate(maxtl_use = if_else(alb_global$maxl_type %in% c("SL", "ML"), maxl_use/standard_total, maxl_use),
         prey_age_reported_1=case_when(
                             #prey_age_reported_1 == "NA" ~ "none",
                             prey_age_reported_1 == "larvae" ~ "larva",
                             prey_age_reported_1 == "juvenile" ~ "juvenile",
                             prey_age_reported_1 == "adult" ~ "adult")
         ) #%>%

#The NA's in the reported age for prey column cause problems later and need to be assigned a categorical value
alb_global$prey_age_reported_1 <- as.character(alb_global$prey_age_reported_1)
alb_global$prey_age_reported_1 <- replace_na(alb_global$prey_age_reported_1, "none")

#Save total df
write.csv(alb_global, here("data/output_data/alb_global_diet_total.csv")) 
#1028 observations and 40 variables

```

The following summarises the max observed FO, N and M for each species in the dataset. This information can be useful when investigating the relative importance of species in albacore diets.

```{r Alb adult diet metrics summary}

alb_global_ad_metrics = alb_global %>%
  #unique(c(alb_global_prob$prey_sp, alb_global_prob$prey_select))
  dplyr::select(prey_class:prey_sp, pFOuse, pN, pM) %>%
  group_by(prey_sp) %>% #, life_stage , pFOuse, pN, pM
  dplyr::summarize(maxFO = max(pFOuse, na.rm=TRUE), maxN = max(pN, na.rm=TRUE), maxM = max(pM, na.rm=TRUE)) 

#write.csv(alb_global_ad_metrics, here("data/alb_global_ad_metrics"))
```

Here we want to estimate the probable life stage of the species consumed based on their size ratios and relationship to albacore tuna gape limits.

```{r Albacore diet data + probably life stage estimation}

alb_global_prob = alb_global %>%
  inner_join(prey_length_ratiosp, by=c("prey_sp", "prey_family", "prey_order", "prey_class")) %>%
  #In using an inner_join I am selecting only rows for which we have all length-based data
  mutate(prey_length = if_else(maxtl_use > 0, maxtl_use/10, gape_lmax)) %>%
  mutate(prey_frac = 100*prey_length/l_adult) %>%
  mutate(prey_proba = if_else(prey_frac < larva_adult_use, "larva", if_else(prey_frac<juve_adult_use, "juvenile", "adult"))) %>%
  mutate(life_stage = if_else(prey_age_reported_1 == "none", prey_proba, prey_age_reported_1))

#And remove troublesome NA's in dataset
#Because we need to give these a life stage, I am assigning them as "adult" because of their l_max typically was < gape limit.
alb_global_prob$life_stage[is.na(alb_global_prob$life_stage)] <- "adult"

## SAVE DATA
write.csv(alb_global_prob, here("data/output_data/alb_global_diet_prob.csv")) 
#985 observations 53 variables
#This include data for which we are able to make an assessment of probable life stage --> therefore will exclude coarse taxonomic classifications

```

The following summarises the max observed FO, N and M for each species in the dataset AND for each life stage likely consumed.

```{r Alb probable diet metrics summary}

#All combinations of life stages and species consumed
alb_global_prob_metrics = alb_global_prob %>%
  dplyr::select(prey_class:prey_sp, life_stage, pFOuse, pN, pM) %>%
  group_by(prey_sp, life_stage) %>%
  dplyr::summarize(maxFO = max(pFOuse, na.rm=TRUE), maxN = max(pN, na.rm=TRUE), maxM = max(pM, na.rm=TRUE))

```

AND we need to select the max observed.

```{r Albacore prey life stages lists}
#Need to summarise prey life stages and attach trait data
#unique(as.factor(alb_global_prob_metrics$prey_sp)) #there are 303 unique species
#So we should obtain 300 species in the following code.

#The most common life stage and species consumed!!
alb_global_prob_metrics = alb_global_prob_metrics %>%
  group_by(prey_sp) %>%
  top_n(1, maxFO) %>%
  sample_n(1)

write.csv(alb_global_prob_metrics, here("data/output_data/alb_global_prob_metrics"))

```

*Note: the maxFO, maxN or maxM are related to the study, they are typically the same between both sets of summary data for adult and probable life stage.

## DATA SETS NEEDED




