---
title: "Albacore Diet Synthesis C"
author: "Natasha Hardy"
date: "15/04/2021"
output: html_document
---

# Trait variation in albacore diet across geographies

## Blueprint for paragraphs:

1. (Results) Describe the dominant significant traits and non-sig traits in relation to albacore age and geography sampled (Fig. R3).

2. Relate to clusters (potential additional analysis/figure).

3. Discussion - Investigate how species traits may be used to explain variation in prey use by albacore tuna using a multi-matrix approach.

## Workspace

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library("rstudioapi")
setwd(dirname(getActiveDocumentContext()$path))
```

```{r Workspace, include=FALSE, echo=FALSE}
#If need to clear 'Environment'
#First view environment if you like
#ls()
#To clear your environment
#remove(list = ls())

getwd()

# general
library(tidyverse)
library(readxl)
library(plyr)
library(dplyr)
library(devtools)
library(reshape2)
library(here)
"%notin%" = Negate('%in%')
here::here()
library(pander)

# graphics
library(ggplot2)
library(lattice)
library(graphics)
library(RColorBrewer)
library(gridExtra)
library(captioner)
library(viridis)
library("grid")
library("ggplotify")


#modelling
library(Hmisc)
library(mgcv)
library(unmarked)
library(lme4)
library(mvabund)
library(tweedie)
library(vegan)

## mvabund bug source code
source("traitglm.R")
source("get_polys.R")

```

## About

This document contains code for data manipulation, refinement and conversion to presence absence, as well as conducting multivariate community analyses and traitglm on albacore diets across ocean basins, using habitat association, gregariousness traits and cluster # output from cluster analyses.

## Current Issues

- SHOULD WE EXCULDE ANYTHING WITH %fo < 1%

- This will have been done in Albacore_data_manip.Rmd at point of dataframe creation?


## Data (L)

Load frequency of occurrence data.

```{r Species %FO (L) - load data}

#Upload + manipulate Species & Covar DF
#Doesn't like the here() function now for some reason
alb_adult_fo = read.csv(paste(here("./data/output_data/alb_global_wide_dietfo.csv"),
                                   sep=""), check.names=FALSE, row.names = 1) %>%
  dplyr::select(StudyID:ncol(.), -grouped_id) #-c(, `Diplospinus multistriatus`, `Sardina pilchardus`)

print(dim(alb_adult_fo)) #225 150
```

Manipulate and subset data.
Here we obtain 137 species as columns and 225 obs.

```{r Species %FO (L) - manipulate}
#Check for empty columns
which(colSums(alb_adult_fo[,14:ncol(alb_adult_fo)])==0) #None! #Otherwise remove these
#Check for empty rows
which(rowSums(alb_adult_fo[,14:ncol(alb_adult_fo)])==0) #Remove these - this becomes a thing once we start removing outlier species
#None

#Subset species df
alb_adult_prey = alb_adult_fo[,14:ncol(alb_adult_fo)]
names(alb_adult_prey) <- str_replace_all(names(alb_adult_prey), " ", "_")

#check df
dim(alb_adult_prey) #137 species & 225 observations
#str(alb_adult_prey) #data are integers & numeric

#Round to no decimal places if needed
#alb_adult_prey[,1:ncol(alb_adult_prey)] =  round(alb_adult_prey[,1:ncol(alb_adult_prey)], digits = 1)
#Convert to integer values
#alb_adult_prey[,1:ncol(alb_adult_prey)] =  lapply(alb_adult_prey[,1:ncol(alb_adult_prey)], as.integer)
#Try numeric
alb_adult_prey[,1:ncol(alb_adult_prey)] =  lapply(alb_adult_prey[,1:ncol(alb_adult_prey)], as.numeric)

```

Convert data to presence absence & remove low occurrence species!
Here we obtain 179 observations for 103 species.

```{r Species PA (L)}

#Convert to presence/absence
alb_adult_preyPA = alb_adult_prey
alb_adult_preyPA[alb_adult_preyPA>0] = 1
alb_adult_preyPA_df = cbind(alb_adult_fo[,1:13], alb_adult_preyPA)

dim(alb_adult_preyPA) #225 obs, 137 species
```

```{r Species PA (L) - >1 occurrence -- currently not using}
#Remove low occurrence species?
#Remove columns that contain < 2 occurrences #can vary this number
alb_adult_preyPA_df2 = alb_adult_preyPA_df[,-which(colSums(alb_adult_preyPA_df[,14:ncol(alb_adult_preyPA_df)])<2)]
#Not sure why some explanatory variable columns disappear also, so adding them back in:
alb_adult_preyPA_df3 = cbind(alb_adult_preyPA_df2[,1:13], alb_adult_preyPA_df2[,12:ncol(alb_adult_preyPA_df2)])
#Then delete rows that sum to zero for the trait occurrences
alb_adult_preyPA_clean = alb_adult_preyPA_df3[-which(rowSums(alb_adult_preyPA_df3[14:ncol(alb_adult_preyPA_df3)])==0),] #209 observations of 103 spp.

dim(alb_adult_preyPA_clean) #179 103
#write.csv....

```

## Traits PROBABLE (Q)

- Using all the occurence data in 'alb_adult_preyPA' df.

- Could filter out low occurrences using 'alb_adult_preyPA_clean' df.

- Note that we obtain 135 species and their traits, so we'll need to filter the species df by the traits.

```{r Trait DF (Q) - prob clust num}

alb_prob_clust = read.csv(paste(here("./data/output_data/prob.prey.clusternum_habgreg.divis.k7.csv"), 
                                sep=""), header=T, row.names = 1) %>%
   dplyr::select(prey_sp:prob.clust.num, -refuge_cat)

dim(alb_prob_clust) #156 species,  17 traits/covariates

#Relabel to add underscore in names
alb_prob_clust$prey_sp = str_replace_all(alb_prob_clust$prey_sp, " ", "_")
#Assign speces as rownames
rownames(alb_prob_clust) <- alb_prob_clust$prey_sp
#Order species list
alb_prob_clust <- alb_prob_clust[ order(row.names(alb_prob_clust)), ]

#Ensure traits are treated as factors for now
alb_prob_clust[,2:8] <- lapply(alb_prob_clust[,2:8], factor) #to convert to factors

#Need to filter by prey species we want to use.
alb_prob_traits = alb_prob_clust %>%
  filter(prey_sp %in% names(alb_adult_preyPA)) %>%
  filter(life_stage != 'larva')
#we get 123 species and 17 trait values
  #previously filtered from this df: alb_adult_preyPA - this includes single occurrences
  #filtered out low occurrences df here: alb_adult_preyPA_clean

dim(alb_prob_traits) #123  17
str(alb_prob_traits)

write.csv(alb_prob_traits, here("./data/output_data/alb_prob_traits_k7.csv"))

alb_prob_traits = read.csv(here("./data/output_data/alb_prob_traits_k7.csv")) %>%
  select(-X)

alb_prob_traits[,1:ncol(alb_prob_traits)] =  lapply(alb_prob_traits[,1:ncol(alb_prob_traits)], as.factor)
rownames(alb_prob_traits) <- alb_prob_traits$prey_sp

```

```{r Trait values check, eval=FALSE}
summary(alb_prob_traits$life_stage)

summary(alb_prob_traits$vert_habitat) #merge bathypelagic and mesopelagic

summary(alb_prob_traits$horz_habitat) #potential merger of continental shelf/slope, and coastal/reef assoc.

summary(alb_prob_traits$diel_migrant_cat)

summary(alb_prob_traits$season_cat)

summary(alb_prob_traits$gregarious)

summary(alb_prob_traits$prob.clust.num) #low numbers in cluster #8 = 2

```

```{r Trait factor levels}

#str(alb_prob_traits)

#levels(alb_prob_traits$life_stage) #check
#alb_prob_traits$life_stage <- factor(alb_prob_traits$life_stage, 
#                                            levels = c("adult", "juvenile", "larva"),
#                                            labels = c("adult", "juvenile", "juvenile"))

#Levels vertical habitat
#levels(alb_prob_traits$vert_habitat) #check
alb_prob_traits$vert_habitat <- factor(alb_prob_traits$vert_habitat, 
                                            levels = c("benthic", "demersal", "epipelagic",
                                                       "mesopelagic", "bathypelagic"),
                                            labels = c("benthic", "demersal", "epipelagic",
                                                       "mesopelagic", "mesopelagic"))
#Too low sample size for bathypelagic, merged with mesopelagic here

#Levels horizontal habitat
#levels(alb_prob_traits$horz_habitat) #check
alb_prob_traits$horz_habitat <- factor(alb_prob_traits$horz_habitat, 
                                            levels = c("reef-associated", "coastal", 
                                                       "continental shelf", "continental slope",
                                                       "oceanic"),
                                            labels = c("coastal", "coastal", 
                                                       "continental shelf", "continental shelf",
                                                       "oceanic"))

#Levels gregarious
#levels(alb_adult_traits$gregarious) #check
alb_prob_traits$gregarious <- factor(alb_prob_traits$gregarious, 
                                            levels = c("solitary", "schooling"))

```

## UPDATE DIET DATA (L) & SELECT COVARS (R)

Here we filter our prey species (presence/absence data) by the species that were also used for cluster analysis, because we have complete trait information for these species, as well as frequency of occurrence data.

```{r FILTER PREY BY PROB TRAITS}

alb_prob_preyPA <- alb_adult_preyPA[colnames(alb_adult_preyPA) %in% rownames(alb_prob_traits)]

dim(alb_prob_preyPA) #225 123

#alternatively filter by stricter dataset
```

```{r Diet data manip}

#Need to check for empty columns and rows again
#Check for empty columns
which(colSums(alb_prob_preyPA)==0) #None! #Otherwise remove these
#Check for empty rows
which(rowSums(alb_prob_preyPA)==0) #Remove these - this becomes a thing once we start removing outlier species

#Need to remove these from the alb_prob_preyPA data and the covars data

alb_prob_preyPA = alb_prob_preyPA[-c(31, 32, 58, 64, 69, 72, 79, 81, 86, 90, 102, 119, 140, 141, 151, 156),]
#209 observations for 123 prey species
dim(alb_prob_preyPA) #209 123

alb_prob_covars = alb_adult_fo[-c(31, 32, 58, 64, 69, 72, 79, 81, 86, 90, 102, 119, 140, 141, 151, 156), 1:13]
#209 observations for 13 environmental variables

dim(alb_prob_covars) #209  13
```

```{r Not Using -- Diet data manip for >1 FO, eval=FALSE, include=FALSE}

#If filtering
#alb_prob_preyPA = alb_prob_preyPA[-c(39, 43, 47, 53, 57, 58, 64, 68, 69, 72, 76, 79, 81, 85, 86, 90, 93, 109, 119, 120,
#                                     130, 132, 135, 143, 146, 155, 156, 157, 169, 174, 177, 178, 183, 184, 185, 190, 192,
#                                     194, 200, 202),]

#alb_prob_covars = alb_adult_fo[-c(39, 43, 47, 53, 57, 58, 64, 68, 69, 72, 76, 79, 81, 85, 86, 90, 93, 109, 119, 120,
#                                     130, 132, 135, 143, 146, 155, 156, 157, 169, 174, 177, 178, 183, 184, 185, 190, 192,
#                                     194, 200, 202), 1:13]

```

## Covars (R) - MANIPS

```{r Covars (R) - summary, eval=FALSE}

#Summary stats on covars
unique(alb_prob_covars$StudyID) #22 studies
unique(alb_prob_covars$OceanBasin) #6 Ocean basins
unique(alb_adult_fo$OceanBasinQ) #10 Ocean basin quarters, but data gets thin for many
unique(alb_prob_covars$YearEnd) #~27 years (or groups of years) are represented in this study
unique(alb_prob_covars$code) #10 Longhurst provinces represented, similar to Ocean Basin Q but also gets thin
unique(alb_prob_covars$pred_life) #

```

```{r Covars (R) - clean}

#Clean covars
alb_prob_covars = alb_prob_covars %>%
  mutate(pred_life=case_when(pred_life == "juvenile" ~ "juvenile",
                             pred_life == "juvenile, adult" ~ "mixed",
                             pred_life == "adult" ~ "adult",
                             pred_life == "none" ~ "mixed")) #"none" ~ "none"
#As factors
alb_prob_covars[,1:ncol(alb_prob_covars)] =  lapply(alb_prob_covars[,1:ncol(alb_prob_covars)], as.factor)

dim(alb_prob_covars) #209  13
```

```{r Covars (R) checking, eval=FALSE}
#Check representation
#summary(alb_adult_covars)

summary(alb_prob_covars$lat_cat)
#temperate  tropical 
#   178        31 

summary(alb_prob_covars$pred_life)
#   adult juvenile    mixed 
#     54       62      93 

summary(alb_prob_covars$OceanBasin)
#           Indian Mediterranean    N Atlantic     N Pacific    S Atlantic     S Pacific 
#            15            29            78            62            8            17 

summary(alb_prob_covars$OceanBasinQ)
#Not going to use

summary(alb_prob_covars$code)
#Not going to use

dim(alb_prob_covars) #209 observations for 13 covars

#Best covars ==> pred_life, OceanBasin, lat_cat, and maybe code (Longhurst) - but need to exclude low numbered levels.

```


## DF checks

```{r Check names and df dimensions, eval=FALSE}
## Make sure species names match abund matrix
rownames(alb_prob_traits) == colnames(alb_prob_preyPA) #awesome!
# And the mvabund matrix
alb_prob_preyPA_mv = as.mvabund(alb_prob_preyPA)

dim(alb_prob_preyPA_mv) #209 123

rownames(alb_prob_traits) == colnames(alb_prob_preyPA_mv) #awesome!

dim(alb_prob_traits) #123 species and 17 traits
dim(alb_prob_preyPA_mv) #209 obs, 123 species
dim(alb_prob_covars) #209 obs, 13 variables

```

```{r Select covars + traits + levels}

#Select some covars & traits
prob_ocean = alb_prob_covars$OceanBasin
prob_ocean <- factor(prob_ocean, levels = c("Mediterranean", "N Atlantic", "S Atlantic", "N Pacific", "S Pacific", "Indian"))
levels(prob_ocean)

#Predator life stage
alb_prob_covars$pred_life <- factor(alb_prob_covars$pred_life, 
                                            levels = c("mixed", "adult", "juvenile"))
prob_pred_life = alb_prob_covars$pred_life
levels(prob_pred_life)

#Latitude
prob_lat = alb_prob_covars$lat_cat

#All traits to try -- ideally we want to use the same df here
traits_prob = alb_prob_traits[,c(2:6,13,17)] %>%
  dplyr::rename(cluster = prob.clust.num)

traits_prob$cluster <- as.factor(traits_prob$cluster)

traits_prob_try = as.data.frame(traits_prob[,1:6])

traits_prob_clust = as.data.frame(alb_prob_traits[,17]) %>%
  dplyr::rename(cluster = `alb_prob_traits[, 17]`)

traits_prob_clust$cluster <- as.factor(traits_prob_clust$cluster)

#str(traits_prob)
#str(traits_prob$cluster)
#check
#summary(traits_prob$cluster)

```


## TRAIT GLMS

ALL MODELS TALLY


**NOTE** Model Comparisons

Cluster & Trait & SPP models for Predator Life Stage and Ocean Basin

- prob_life_clusters_many

- prob_ocean_clusters_many 

- prob_life_spp

- prob_ocean_spp 

- prob_life_trait_many

- prob_ocean_trait_many


LASSO MODELS

- prob_life_cluster_LASSO

- prob_ocean_cluster_LASSO

- prob_life_trait_LASSO

- prob_ocean_trait_LASSO

### Species models

SPP Manyglm - Predator Life ss

```{r TraitGLM - SPP - life manyglm binom}

prob_life_spp <- traitglm(L = alb_prob_preyPA_mv,
                          R = prob_pred_life,
                          family=binomial(link = "logit")
                          ) #note default is "manyglm"

#Check model output - residuals TEST
#qqnorm(residuals(prob_life_clusters_spp)[which(residuals(prob_life_clusters_spp)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
#resids.full = residuals(prob_life_clusters_spp)[is.finite((residuals(prob_life_clusters_spp)))]
#plot(resids.full); abline(c(0,0),col="red")

```

Need to cut species in list in half to make the SPP models legible.

```{r Plot 4th corner - life many}

#Can cut this graph in half with matrix manipulation of prob_life_clusters_spp$fourth.corner

a        = max( abs(prob_life_spp$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(prob_life_spp$fourth.corner))

rownames(temp) = c("Adult", "Juvenile")

#colnames(temp) = c("Vert. habitat - demersal",
#                   "Vert. habitat - epipelagic",
#                   "Vert. habitat - mesopelagic",
#                   "Horz. habitat - continental shelf",
#                   "Horz. habitat - oceanic",
#                   "Diel migrant (yes)",
#                   "Seasonal migrant (yes)",
#                   "Gregarious - schooling")

prob_life_spp_graph = levelplot(temp, 
                     xlab=list("Predator Life Stage", cex=1.5),
                     ylab=list("Species", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_life_spp_graph)

```


```{r TraitGLM - SPP - ocean manyglm binom}

prob_ocean_spp <- traitglm(L = alb_prob_preyPA_mv,
                                    R = prob_ocean,
                                    family=binomial(link = "logit")
                                    ) #note default is "manyglm"

#check model output if needed
```

### Trait clusters models

#### METHOD = MANYGLM

**Predator Life Stage**

Trait (cluster) *Env - Manyglm

```{r TraitGLM - life + clusters manyglm binom}

prob_life_clusters_many <- traitglm(L = alb_prob_preyPA_mv,
                                    R = prob_pred_life,
                                    Q = traits_prob$cluster,
                                    #traits_prob_clust,
                                    family=binomial(link = "logit")
                                    ) #note default is "manyglm"

#Check model output - residuals TEST
#qqnorm(residuals(prob_life_clusters_many)[which(residuals(prob_life_clusters_many)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
#resids.full = residuals(prob_life_clusters_many)[is.finite((residuals(prob_life_clusters_many)))]
#plot(resids.full); abline(c(0,0),col="red")

```

```{r Plot 4th corner - life many}

a        = max( abs(prob_life_clusters_many$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(prob_life_clusters_many$fourth.corner))

rownames(temp) = c("Adult", "Juvenile")

#colnames(temp) = c("Vert. habitat - demersal",
#                   "Vert. habitat - epipelagic",
#                   "Vert. habitat - mesopelagic",
#                   "Horz. habitat - continental shelf",
#                   "Horz. habitat - oceanic",
#                   "Diel migrant (yes)",
#                   "Seasonal migrant (yes)",
#                   "Gregarious - schooling")

prob_life_clusters_many_graph = levelplot(temp, 
                     xlab=list("Predator Life Stage", cex=1.5),
                     ylab=list("Species cluster", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_life_clusters_many_graph)

ggsave(here("./outputs_figures/traitglms/prob_all_simple/prob_life_clusters_many_graph.pdf"), 
       plot = as.ggplot(prob_life_clusters_many_graph), width=12, height=12, dpi=300)

```

Manyglm - Ocean

```{r TraitGLM - ocean + clusters manyglm binom}
#levels(ocean)

prob_ocean_clusters_many <- traitglm(L = alb_prob_preyPA_mv,
                                     R = prob_ocean,
                                     Q = traits_prob$cluster,
                                     family=binomial(link = "logit")
                                     ) #note default is "manyglm"

#Check model output - residuals TEST
#qqnorm(residuals(prob_ocean_clusters_many)[which(residuals(prob_ocean_clusters_many)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
#resids.full = residuals(prob_ocean_clusters_many)[is.finite((residuals(prob_ocean_clusters_many)))]
#plot(resids.full); abline(c(0,0),col="red")

```

```{r Plot 4th corner - ocean many}

a        = max( abs(prob_ocean_clusters_many$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(prob_ocean_clusters_many$fourth.corner))

rownames(temp) = c(#"Mediterranean",
                   "N Atlantic",
                   "S Atlantic",
                   "N Pacific",
                   "S Pacific",
                   "Indian")


#colnames(temp) = c("Vert. habitat - demersal",
#                   "Vert. habitat - epipelagic",
#                   "Vert. habitat - mesopelagic",
#                   "Horz. habitat - continental shelf",
#                   "Horz. habitat - oceanic",
#                   "Diel migrant (yes)",
#                   "Seasonal migrant (yes)",
#                   "Gregarious - schooling")

prob_ocean_clusters_many_graph = levelplot(temp, 
                     xlab=list("Ocean Basins", cex=1.5),
                     ylab=list("Species clusters", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_ocean_clusters_many_graph)

ggsave(here("outputs_figures/traitglms/prob_all_simple/prob_ocean_clusters_many_graph.pdf"), 
       plot = as.ggplot(prob_ocean_clusters_many_graph), width=12, height=12, dpi=300)

```

#### METHOD = GLM1PATH

Predator Life Stage - Using binomial (logit link) function + glm1path LASSO model

```{r TraitGLM - life + clusters LASSO}

prob_life_cluster_LASSO <- traitglm(L = alb_prob_preyPA_mv,
                                    R = prob_pred_life,
                                    Q = traits_prob$cluster,
                                    family=binomial(link = "logit"),
                                    method="glm1path"
                                    ) #note default is "manyglm"


#Check model output - residuals TEST
#x11()
#qqnorm(residuals(prob_life_cluster_LASSO)[which(residuals(prob_life_cluster_LASSO)<10000)]); abline(c(0,1),col="red")
#dev.copy(device = x11)
#dev.copy2pdf(file="/Users/tashhardy/Documents/GitHub/albacore-diet-global/outputs_figures/traitglms/prob_life_cluster7_LASSO_QQ.pdf", width=5, height=5)

#omit non-finite residuals FULL MODEL
#resids.full = residuals(prob_life_cluster_LASSO)[is.finite((residuals(prob_life_cluster_LASSO)))]
#plot(resids.full); abline(c(0,0),col="red")
#dev.copy(device = x11)
#dev.copy2pdf(file="/Users/tashhardy/Documents/GitHub/albacore-diet-global/outputs_figures/traitglms/prob_life_cluster7_LASSO_resids.pdf", width=5, height=5)


```

```{r Plot 4th corner - life + cluster LASSO}

a        = max( abs(prob_life_cluster_LASSO$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(prob_life_cluster_LASSO$fourth.corner))

rownames(temp) = c("Mixed", "Adult", "Juvenile")

#colnames(temp) = c("Vert. habitat - benthic",
#                   "Vert. habitat - demersal",
#                   "Vert. habitat - epipelagic",
#                   "Vert. habitat - mesopelagic",
#                   "Horz. habitat - coastal",
#                   "Horz. habitat - continental shelf",
#                   "Horz. habitat - oceanic",
#                   "Diel migrant (yes)",
#                   "Seasonal migrant (yes)",
#                   "Gregarious - schooling")

prob_life_cluster_LASSO_graph = levelplot(temp,
                                          xlab=list("Predator Life Stage", cex=1.5),
                                          ylab=list("Species clusters", cex=1.5),
                                          col.regions=colort(100),
                                          at=seq(-a, a,length=100),
                                          scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)),
                                          colorkey=list(labels=list(cex=1.3)))

print(prob_life_cluster_LASSO_graph)

#trait_ocean_4th = as.ggplot(trait_ocean_4th)

ggsave(here("outputs_figures/traitglms/prob_all_simple/prob_life_cluster7_LASSO_graph.pdf"), 
       plot = as.ggplot(prob_life_cluster_LASSO_graph), width=12, height=12, dpi=300)

ggsave(here("outputs_figures/traitglms/prob_all_simple/prob_life_cluster7_LASSO_graph.jpeg"), 
       plot = as.ggplot(prob_life_cluster_LASSO_graph), width=12, height=12, dpi=300)

```

Ocean Basin - Using binomial (logit link) function + glm1path LASSO model

```{r TraitGLM - Ocean + clusters LASSO}

prob_ocean_cluster_LASSO <- traitglm(L = alb_prob_preyPA_mv,
                                     R = prob_ocean,
                                     Q = traits_prob$cluster,
                                     family=binomial(link = "logit"),
                                     method="glm1path"
                                     ) #note default is "manyglm"

#Check model output - residuals TEST
#x11()
#qqnorm(residuals(trait_ocean_binom)[which(residuals(trait_ocean_binom)<10000)]); abline(c(0,1),col="red")
#dev.copy(device = x11)
#dev.copy2pdf(file="/Users/tashhardy/Documents/GitHub/albacore-diet-global/outputs_figures/traitglms/trait_ocean_binom_QQ.pdf", width=5, height=5)

#omit non-finite residuals FULL MODEL
#resids.full = residuals(trait_ocean_binom)[is.finite((residuals(trait_ocean_binom)))]
#plot(resids.full); abline(c(0,0),col="red")
#dev.copy(device = x11)
#dev.copy2pdf(file="/Users/tashhardy/Documents/GitHub/albacore-diet-global/outputs_figures/traitglms/trait_ocean_binom_resids.pdf", width=5, height=5)
```

```{r Plot 4th corner - life + cluster LASSO}

a        = max( abs(prob_ocean_cluster_LASSO$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(prob_ocean_cluster_LASSO$fourth.corner))

rownames(temp) = c("Mediterranean",
                   "N Atlantic",
                   "S Atlantic",
                   "N Pacific",
                   "S Pacific",
                   "Indian")

#colnames(temp) = c("Vert. habitat - benthic",
#                   "Vert. habitat - demersal",
#                   "Vert. habitat - epipelagic",
#                   "Vert. habitat - mesopelagic",
#                   "Horz. habitat - coastal",
#                   "Horz. habitat - continental shelf",
#                   "Horz. habitat - oceanic",
#                   "Diel migrant (yes)",
#                   "Seasonal migrant (yes)",
#                   "Gregarious - schooling")

prob_ocean_cluster_LASSO_graph = levelplot(temp, 
                     xlab=list("Ocean Basins", cex=1.5),
                     ylab=list("Species clusters", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_ocean_cluster_LASSO_graph)

ggsave(here("outputs_figures/traitglms/prob_all_simple/prob_ocean_cluster_LASSO_graph.pdf"), 
       plot = as.ggplot(prob_ocean_cluster_LASSO_graph), width=12, height=12, dpi=300)

ggsave(here("outputs_figures/traitglms/prob_all_simple/prob_ocean_cluster_LASSO_graph.jpeg"), 
       plot = as.ggplot(prob_ocean_cluster_LASSO_graph), width=12, height=12, dpi=300)

```



### Trait models

#### Predator Life Stage

ManyGLM traitglm


```{r TraitGLM - predator age binom distribution}

prob_life_trait_many <- traitglm(L = alb_prob_preyPA_mv,
                                 R = prob_pred_life,
                                 Q = traits_prob_try,
                                 family=binomial(link = "logit")
                                    ) #note default is "manyglm"

#Check model output - residuals TEST
#qqnorm(residuals(prob_life_trait_many)[which(residuals(prob_life_trait_many)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
#resids.full = residuals(prob_life_trait_many)[is.finite((residuals(prob_life_trait_many)))]

#plot(resids.full); abline(c(0,0),col="red")

```

```{r Plot 4th corner - binom}

a        = max( abs(prob_life_trait_many$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(prob_life_trait_many$fourth.corner))

#rownames(temp) = c("Adult", "Juvenile", "Mixed")
#colnames(temp) = c("Vert. habitat - benthic",
#                   "Vert. habitat - demersal",
#                   "Vert. habitat - epipelagic",
#                   "Vert. habitat - mesopelagic",
#                   "Vert. habitat - bathypelagic",
#                   "Horz. habitat - reef-associated",
#                   "Horz. habitat - coastal",
#                   "Horz. habitat - continental shelf",
#                   "Horz. habitat - continental slope",
#                   "Horz. habitat - oceanic",
#                   "Diel migrant (yes)",
#                   "Seasonal migrant (yes)",
#                   "Gregarious - schooling")

prob_life_many_4th = levelplot(temp, 
                     xlab=list("Predator Life Stage", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_life_many_4th)

#trait_life_4th = as.ggplot(trait_life_4th)

ggsave(here("outputs_figures/traitglms/prob_all_simple/prob_life_many_4th.pdf"), plot = as.ggplot(prob_life_many_4th), width=12, height=12, dpi=300)

#dev.copy2pdf(file=here("./outputs_figures/traitglms/fourth_lifestage.png"), width=12, height=5)

```

Using binomial (logit link) function - glm1path traitglm

```{r TraitGLM - predator age glm LASSO}

prob_life_trait_LASSO <- traitglm(L = alb_prob_preyPA_mv,
                            R = prob_pred_life,
                            Q = traits_prob_try,
                            family=binomial(link = "logit"),
                            method="glm1path"
                            ) #note default is "manyglm"

```

```{r Plot 4th corner - pred age LASSO}

a        = max( abs(prob_life_trait_LASSO$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(prob_life_trait_LASSO$fourth.corner))

rownames(temp) = c("Mixed", "Adult", "Juvenile")
colnames(temp) = c("Prey life: juvenile",
                   "Vert. habitat - demersal",
                   "Vert. habitat - epipelagic",
                   "Vert. habitat - mesopelagic",
                   "Horz. habitat - coastal",
                   "Horz. habitat - continental shelf",
                   "Horz. habitat - oceanic",
                   "Diel migrant (yes)",
                   "Seasonal migrant (yes)",
                   "Gregarious - schooling")

prob_life_LASSO_graph = levelplot(temp, 
                     xlab=list("Predator Life Stage", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_life_LASSO_graph)

ggsave(here("outputs_figures/traitglms/prob_all_simple/prob_life_LASSO_graph.pdf"), 
       plot = as.ggplot(prob_life_LASSO_graph), width=12, height=12, dpi=300)

ggsave(here("outputs_figures/traitglms/prob_all_simple/prob_life_LASSO_graph.jpeg"), 
       plot = as.ggplot(prob_life_LASSO_graph), width=12, height=12, dpi=300)

```


### Ocean Basin

Manyglm

```{r TraitGLM - predator age binom distribution}

prob_ocean_trait_many <- traitglm(L = alb_prob_preyPA_mv,
                                 R = prob_ocean,
                                 Q = traits_prob_try,
                                 family=binomial(link = "logit")
                                    ) #note default is "manyglm"

#Check model output - residuals TEST
#qqnorm(residuals(prob_life_trait_many)[which(residuals(prob_life_trait_many)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
#resids.full = residuals(prob_life_trait_many)[is.finite((residuals(prob_life_trait_many)))]

#plot(resids.full); abline(c(0,0),col="red")

```


Using binomial (logit link) function.

```{r TraitGLM - ocean basin binom distribution}

prob_ocean_trait_LASSO <- traitglm(L = alb_prob_preyPA_mv,
                              R = prob_ocean,
                              Q = traits_prob_try,
                              family=binomial(link = "logit"),
                              method="glm1path"
                              ) #note default is "manyglm"

```

```{r Plot 4th corner - binom}

a        = max( abs(prob_ocean_trait_LASSO$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(prob_ocean_trait_LASSO$fourth.corner))

rownames(temp) = c("Mediterranean",
                   "N Atlantic",
                   "S Atlantic",
                   "N Pacific",
                   "S Pacific",
                   "Indian")

colnames(temp) = c("Prey life: juvenile",
                   "Vert. habitat - demersal",
                   "Vert. habitat - epipelagic",
                   "Vert. habitat - mesopelagic",
                   "Horz. habitat - coastal",
                   "Horz. habitat - continental shelf",
                   "Horz. habitat - oceanic",
                   "Diel migrant (yes)",
                   "Seasonal migrant (yes)",
                   "Gregarious - schooling")

prob_ocean_LASSO_graph = levelplot(temp, 
                     xlab=list("Ocean Basins", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_ocean_LASSO_graph)

#trait_ocean_4th = as.ggplot(trait_ocean_4th)

ggsave(here("outputs_figures/traitglms/prob_all_simple/prob_ocean_LASSO_graph.pdf"), 
       plot = as.ggplot(prob_ocean_LASSO_graph), width=12, height=12, dpi=300)

ggsave(here("outputs_figures/traitglms/prob_all_simple/prob_ocean_LASSO_graph.jpeg"), 
       plot = as.ggplot(prob_ocean_LASSO_graph), width=12, height=12, dpi=300)

```


### Temperate / Tropical

Manyglm (can do if needed)



Using binomial (logit link) function.

```{r TraitGLM - latitude binom distribution}

prob_lat_LASSO <-  traitglm(L = alb_prob_preyPA_mv,
                            R = prob_lat,
                            Q = traits_prob_try,
                            family=binomial(link = "logit"),
                            method="glm1path"
                            ) #note default is "manyglm"

```

```{r Plot 4th corner - binom}

a        = max( abs(prob_lat_LASSO$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(prob_lat_LASSO$fourth.corner))

rownames(temp) = c("Tropical")

colnames(temp) = c("Prey life: adult",
                   "Prey life: juvenile",
                   "Prey life: larva",
                   "Vert. habitat - benthic",
                   "Vert. habitat - demersal",
                   "Vert. habitat - epipelagic",
                   "Vert. habitat - mesopelagic",
                   "Horz. habitat - coastal",
                   "Horz. habitat - continental shelf",
                   "Horz. habitat - oceanic",
                   "Diel migrant (yes)",
                   "Seasonal migrant (yes)",
                   "Gregarious - schooling")


prob_lat_LASSO_graph = levelplot(temp, 
                     xlab=list("Temperate vs. Tropical", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_lat_LASSO_graph)

#trait_lat_4th = as.ggplot(trait_lat_4th)

ggsave(here("outputs_figures/traitglms/prob_all_simple/prob_lat_LASSO_graph.pdf"), 
       plot = as.ggplot(prob_lat_LASSO_graph), width=12, height=12, dpi=300)
       
ggsave(here("outputs_figures/traitglms/prob_all_simple/prob_lat_LASSO_graph.jpeg"), 
       plot = as.ggplot(prob_lat_LASSO_graph), width=12, height=12, dpi=300)

```


### MODEL COMPARISON

Cluster, trait, spp models each for (i) predator life stage and (ii) ocean basins

- prob_life_clusters_many

- prob_ocean_clusters_many 

Call:  traitglm(L = alb_prob_preyPA_mv, R = prob_ocean, Q = traits_prob$cluster,      family = binomial(link = "logit")) 
[1] "binomial(link=logit)"

Degrees of Freedom: 25706 Total (i.e. Null); 25549 Residual

                    l    
2*log-likelihood:   -3776
Residual Deviance:   3776
AIC:                 4092

- prob_life_spp

- prob_ocean_spp 

Call:  traitglm(L = alb_prob_preyPA_mv, R = prob_ocean, family = binomial(link = "logit")) 
[1] "binomial(link=logit)"

Degrees of Freedom: 25706 Total (i.e. Null); 24969 Residual

                    l    
2*log-likelihood:   -2978
Residual Deviance:   2978
AIC:                 4454

- prob_life_trait_many

- prob_ocean_trait_many

Call:  traitglm(L = alb_prob_preyPA_mv, R = prob_ocean, Q = traits_prob_try,      family = binomial(link = "logit")) 
[1] "binomial(link=logit)"

Degrees of Freedom: 25706 Total (i.e. Null); 25534 Residual

                    l    
2*log-likelihood:   -3746
Residual Deviance:   3746
AIC:                 4092

```{r Compare outputs - ocean basin}

#anova.traitglm(prob_ocean_clusters_many, prob_ocean_trait_many, prob_ocean_spp)

anova.ocean1 = anova.traitglm(prob_ocean_clusters_many, prob_ocean_trait_many)

anova.ocean2 = anova.traitglm(prob_ocean_clusters_many, prob_ocean_spp)

anova.ocean3 = anova.traitglm(prob_ocean_clusters_many, prob_ocean_trait_many, prob_ocean_spp)

#greatest residual deviance with cluster analyses

```

```{r Compare outputs - ocean basin}

anova.traitglm(prob_life_clusters_many, prob_life_trait_many, prob_life_spp)

```


## Ordination

```{r Visualise - nMDS ordinations PA}


#PA
alb_prob_nMDS_pa = metaMDS(alb_prob_preyPA, 
                         distance="bray", 
                         trymax = 10000, #1000
                         k=4) #could increase to k = 4

saveRDS(alb_prob_nMDS_pa, here("outputs_figures/traitglmsalb_prob_nMDS_pa.rds"))

#Note pb with this!! insufficient data?

pl <- ordiplot(alb_prob_nMDS_pa, type = "none")
points(pl, "sites", pch=21, col="red", bg="yellow")
text(pl, "species", col="blue", cex=0.9)

```

#### nMDS - composition

Extract NMDS coordinates and associate with co-variates/grouping factors

```{r Data scores for plotting - USE}

#Extract NMDS coordinates and associate with co-variates/grouping factors
#Using the scores function from vegan to extract the site scores and convert to a data.frame
data.scores <- as.data.frame(scores(alb_prob_nMDS_pa))  #, "species"
#create a column of site names, from the rownames of data.scores
data.scores$points <- rownames(data.scores)
#bind treatment labels and score values
treatment.scores <- cbind(alb_prob_covars, data.scores)
#Check
str(treatment.scores)  
#Awesome

```

### Predator Life Stage

Convex hull calculations
For each ordination and set of grouping variables input to data scores chunk

```{r Convex hulls - Predator Life Stage}
# Taxonomic groups (specific)
#Create convex hulls for the space occupied by each Taxonomic values
unique(treatment.scores$pred_life)
#Taxonomic group - hull loop
pred = as.character(unique(treatment.scores$pred_life))
for(i in 1:length(pred)) {
  temp = pred[i]
  df = treatment.scores[treatment.scores$pred_life == temp, ][chull(treatment.scores[treatment.scores$pred_life == temp, c("NMDS1", "NMDS2")]), ]
  assign(paste0('grp.',temp), df)
}

#combine the hull data
hull.data.pred <- rbind(grp.mixed, grp.juvenile, grp.adult)  

str(hull.data.pred)
#Just wondering how do 174 species (obs) become 46???

```

NMDS plot

```{r nMDS Pred Life, echo=TRUE}

nMDS_prob_life <- ggplot() + 
  geom_polygon(data = hull.data.pred, 
               aes(x = NMDS1, y = NMDS2, 
                   fill = pred_life, 
                   group = pred_life), 
               alpha=0.30) + # add the convex hulls
  geom_point(data = treatment.scores, 
             aes(x = NMDS1, y = NMDS2, colour = pred_life), 
             size = 2) + # add the point markers
  coord_equal() +
  theme_bw()  +
  theme(axis.text.x = element_blank(),  # remove x-axis text
        axis.text.y = element_blank(), # remove y-axis text
        axis.ticks = element_blank(),  # remove axis ticks
        axis.title.x = element_text(size=18), # remove x-axis labels
        axis.title.y = element_text(size=18), # remove y-axis labels
        legend.title = element_text(size = 18), 
        legend.text = element_text(size = 18),
        legend.justification = c(0,0.5),
        #panel.background = element_rect(fill = "lightgrey"), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_blank()) +
  scale_colour_viridis(option="magma", discrete = TRUE, begin = 0.8, end = 0.2, name = "Predator Life Stage") + 
  scale_fill_viridis(option="magma", discrete = TRUE, begin = 0.8, end = 0.2, name = "Predator Life Stage")

nMDS_prob_life

ggsave(here("outputs_figures/traitglms/prob_all_simple/nMDS_prob_life.jpeg"), plot = nMDS_prob_life, width = 8, height = 8, dpi = 300)

```

### Ocean Basin

Convex Hull calculations


```{r Convex hulls - Predator Life Stage}
# Taxonomic groups (specific)
#Create convex hulls for the space occupied by each Taxonomic values
unique(treatment.scores$OceanBasin)
#Taxonomic group - hull loop
oc = as.character(unique(treatment.scores$OceanBasin))
for(i in 1:length(oc)) {
  temp = oc[i]
  df = treatment.scores[treatment.scores$OceanBasin == temp, ][chull(treatment.scores[treatment.scores$OceanBasin == temp, c("NMDS1", "NMDS2")]), ]
  assign(paste0('grp.',temp), df)
}

#combine the hull data
hull.data.ocean <- rbind(`grp.N Atlantic`, `grp.Mediterranean`, `grp.N Pacific`, `grp.S Atlantic`, `grp.Indian`, `grp.S Pacific`)  

str(hull.data.ocean)
#Just wondering how do 174 species (obs) become 46???

```

nMDS for Ocean Basin

```{r nMDS Ocean Basin, echo=TRUE}
#nMDS plot for the assessmenet of global change (yes/no) and the drivers.
#unique(treatment.scores$OceanBasin)

nMDS_prob_ocean <- ggplot() + 
  geom_polygon(data = hull.data.ocean, 
               aes(x = NMDS1, y = NMDS2, 
                   fill = OceanBasin, 
                   group = OceanBasin), 
               alpha=0.30) + # add the convex hulls
  geom_point(data = treatment.scores, 
             aes(x = NMDS1, y = NMDS2, colour = OceanBasin), 
             size = 2) + # add the point markers
  coord_equal() +
  theme_bw()  +
  theme(axis.text.x = element_blank(),  # remove x-axis text
        axis.text.y = element_blank(), # remove y-axis text
        axis.ticks = element_blank(),  # remove axis ticks
        axis.title.x = element_text(size=18), # remove x-axis labels
        axis.title.y = element_text(size=18), # remove y-axis labels
        legend.title = element_text(size = 18), 
        legend.text = element_text(size = 18),
        legend.justification = c(0,0.5),
        #panel.background = element_rect(fill = "lightgrey"), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_blank()) +
  scale_colour_viridis(option="magma", discrete = TRUE, begin = 0.8, end = 0.2, name = "Ocean Basin") + 
  scale_fill_viridis(option="magma", discrete = TRUE, begin = 0.8, end = 0.2, name = "Ocean Basin")

nMDS_prob_ocean

ggsave(here("outputs_figures/traitglms/prob_all_simple/nMDS_prob_ocean.jpeg"), plot = nMDS_prob_ocean, width = 8, height = 8, dpi = 300)

```

## Ordination - sub outliers

