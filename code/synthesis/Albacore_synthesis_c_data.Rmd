---
title: "Albacore Diet Synthesis C"
author: "Natasha Hardy"
date: "15/04/2021"
output:
  pdf_document: default
  html_document: default
---

# Trait variation in albacore diet across geographies

## About

This document contains code for data manipulation, refinement and conversion to presence absence, as well as conducting multivariate community analyses and traitglm on albacore diets across ocean basins, using habitat association, gregariousness traits and cluster # output from cluster analyses.

## Blueprint for paragraphs:

1. (Results) Describe the dominant significant traits and non-sig traits in relation to albacore age and geography sampled (Fig. R3).

2. Relate to clusters (potential additional analysis/figure).

3. Discussion - Investigate how species traits may be used to explain variation in prey use by albacore tuna using a multi-matrix approach.

## Current Issues / Limitations to discuss in paper

- We do currently use community data that includes single occurrence species, this means species that only occurred once in albacore diets across the world. As these are also associated with trait information and we aim to use traits to explain differences in communities, we believe this isn't problematic, but worth noting. In a traditional multivariate analysis, single occurrence species would inflate differences between communities that are analysed on a species-only basis, whilst our sampling (a.k.a. tuna foraging) does not adequately pick up these rarer species.

- The data are longer (225 obs) than they are wide (137 species), but only just. There are up to 30 species that only occurred once, and that would also cost us about 30 observations. Could be worth re-running models excluding single occurrence to check results.

## Workspace

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#library("rstudioapi")
#setwd(dirname(getActiveDocumentContext()$path))
```

```{r Workspace, echo=FALSE, message=FALSE, results='hide'}
#If need to clear 'Environment'
#First view environment if you like
#ls()
#To clear your environment
#remove(list = ls())

getwd()

# general
library(tidyverse)
library(readxl)
library(plyr)
library(dplyr)
library(devtools)
library(reshape2)
library(here)
"%notin%" = Negate('%in%')
here::here()
library(pander)

# graphics
library(ggplot2)
library(lattice)
library(graphics)
library(RColorBrewer)
library(gridExtra)
library(captioner)
library(viridis)
library("grid")
library("ggplotify")


#modelling
library(Hmisc)
library(mgcv)
library(unmarked)
library(lme4)
library(mvabund)
library(tweedie)
library(vegan)

## mvabund bug source code
source("traitglm.R")
source("get_polys.R")

```


## Data (L)

Load frequency of occurrence data.

```{r Species FO (L) load data, tidy=TRUE, warning=FALSE, message=FALSE}

#Upload + manipulate Species & Covar DF
#Doesn't like the here() function now for some reason
alb_adult_fo = read.csv(paste(here("./data/output_data/alb_global_wide_dietfo.csv"),
                                   sep=""), check.names=FALSE, row.names = 1) %>%
  dplyr::select(StudyID:ncol(.), -grouped_id) #-c(, `Diplospinus multistriatus`, `Sardina pilchardus`)

print(dim(alb_adult_fo)) #225 150
```

Manipulate and subset data. Here we obtain 137 species as columns and 225 obs.

```{r Species FO (L) manipulate, tidy=TRUE, warning=FALSE, message=FALSE}
#Check for empty columns
which(colSums(alb_adult_fo[,14:ncol(alb_adult_fo)])==0) #None! #Otherwise remove these
#Check for empty rows
which(rowSums(alb_adult_fo[,14:ncol(alb_adult_fo)])==0) #Remove these - this becomes a thing once we start removing outlier species
#None

#Subset species df
alb_adult_prey = alb_adult_fo[,14:ncol(alb_adult_fo)]
names(alb_adult_prey) <- str_replace_all(names(alb_adult_prey), " ", "_")

#check df
dim(alb_adult_prey) #137 species & 225 observations
#str(alb_adult_prey) #data are integers & numeric

#Round to no decimal places if needed
#alb_adult_prey[,1:ncol(alb_adult_prey)] =  round(alb_adult_prey[,1:ncol(alb_adult_prey)], digits = 1)
#Convert to integer values
#alb_adult_prey[,1:ncol(alb_adult_prey)] =  lapply(alb_adult_prey[,1:ncol(alb_adult_prey)], as.integer)
#Try numeric
alb_adult_prey[,1:ncol(alb_adult_prey)] =  lapply(alb_adult_prey[,1:ncol(alb_adult_prey)], as.numeric)

```

Convert data to presence absence and we obtain the following observations and species:

```{r Species PA (L), tidy=TRUE, warning=FALSE, message=FALSE}

#Convert to presence/absence
alb_adult_preyPA = alb_adult_prey
alb_adult_preyPA[alb_adult_preyPA>0] = 1
alb_adult_preyPA_df = cbind(alb_adult_fo[,1:13], alb_adult_preyPA)

dim(alb_adult_preyPA) #225 obs, 137 species
```

## Traits Probable (Q)

- Using all the occurrence data in 'alb_adult_preyPA' df.

- Could filter out low occurrences using 'alb_adult_preyPA_clean' df, extra code to do this is provided in the 'Albacore_synthesis_c_extra.Rmd'.

- Note that we obtain 135 species and their traits, so we'll need to filter the species df by the traits.

```{r Trait DF (Q) inc clust num, tidy=TRUE, warning=FALSE, message=FALSE}

alb_prob_clust = read.csv(paste(here("./data/output_data/prob.prey.clusternum_habgreg.divis.k7.csv"), 
                                sep=""), header=T, row.names = 1) %>%
   dplyr::select(prey_sp:prob.clust.num, -refuge_cat)

dim(alb_prob_clust) #we obtain 156 species,  17 traits or covariates

#Relabel to add underscore in names
alb_prob_clust$prey_sp = str_replace_all(alb_prob_clust$prey_sp, " ", "_")
#Assign species as row names
rownames(alb_prob_clust) <- alb_prob_clust$prey_sp
#Order species list
alb_prob_clust <- alb_prob_clust[ order(row.names(alb_prob_clust)), ]

#Ensure traits are treated as factors for now
alb_prob_clust[,2:8] <- lapply(alb_prob_clust[,2:8], factor) #to convert to factors

#Need to filter by prey species we want to use.
alb_prob_traits = alb_prob_clust %>%
  filter(prey_sp %in% names(alb_adult_preyPA)) %>%
  filter(life_stage != 'larva')
#we get 123 species and 17 trait values
  #previously filtered from this df: alb_adult_preyPA - this includes single occurrences
  #filtered out low occurrences df here: alb_adult_preyPA_clean

dim(alb_prob_traits) #123  17
str(alb_prob_traits)

```

**Trait value checks**

Here we check the trait values for each trait, and check the distribution of values. Note we merge certain values with low occurrences of species within them, and if we have a logical reason to merge.

```{r Trait values check, warning=FALSE, message=FALSE}
summary(alb_prob_traits$life_stage) #we will remove larva as a value from the df, larval taxa didn't make it through the data cleaning and manipulation.

summary(alb_prob_traits$vert_habitat) #merge bathypelagic and mesopelagic, these prey could not have been consumed in the bathypelagic anyways.

summary(alb_prob_traits$horz_habitat) #merge of continental shelf/slope, and coastal/reef assoc, we do not have enough data to properly differentiate and represent these habitat values, so we merge and take a coarser definition of 'continental shelf & slope' and 'coastal & reef-assoc'.

summary(alb_prob_traits$diel_migrant_cat) #a lot more diel migrants than not

summary(alb_prob_traits$season_cat) #more seasonal taxa than not

summary(as.factor(alb_prob_traits$gregarious)) #still more gregarious than not, just an artefact of the pelagic prey data.

summary(as.factor(alb_prob_traits$prob.clust.num)) #good distribution of species within clusters

```

**Cleaning and preparing trait values for analyses**

```{r Trait factor levels, warning=FALSE, message=FALSE}

#levels(alb_prob_traits$life_stage) #check
#alb_prob_traits$life_stage <- factor(alb_prob_traits$life_stage, 
#                                            levels = c("adult", "juvenile", "larva"),
#                                            labels = c("adult", "juvenile", "juvenile"))

#Levels vertical habitat
#levels(alb_prob_traits$vert_habitat) #check
alb_prob_traits$vert_habitat <- factor(alb_prob_traits$vert_habitat, 
                                            levels = c("benthic", "demersal", "epipelagic",
                                                       "mesopelagic", "bathypelagic"),
                                            labels = c("benthic", "demersal", "epipelagic",
                                                       "mesopelagic", "mesopelagic"))
#Too low sample size for bathypelagic, merged with mesopelagic here

#Levels horizontal habitat
#levels(alb_prob_traits$horz_habitat) #check
alb_prob_traits$horz_habitat <- factor(alb_prob_traits$horz_habitat, 
                                            levels = c("reef-associated", "coastal", 
                                                       "continental shelf", "continental slope",
                                                       "oceanic"),
                                            labels = c("coastal", "coastal", 
                                                       "continental shelf", "continental shelf",
                                                       "oceanic"))

#Levels gregarious
#levels(alb_adult_traits$gregarious) #check
alb_prob_traits$gregarious <- factor(alb_prob_traits$gregarious, 
                                            levels = c("solitary", "schooling"))

write.csv(alb_prob_traits, here("./data/output_data/alb_prob_traits_k7.csv"))

```

## UPDATE DIET DATA (L) & SELECT COVARS (R)

Here we filter our prey species (presence/absence data) by the species that were also used for cluster analysis, because we have complete trait information for these species, as well as frequency of occurrence data.

```{r FILTER PREY BY PROB TRAITS, tidy=TRUE, warning=FALSE, message=FALSE}

alb_prob_preyPA <- alb_adult_preyPA[colnames(alb_adult_preyPA) %in% rownames(alb_prob_traits)]

dim(alb_prob_preyPA) #225 123

#alternatively filter by stricter dataset
```

Now we need to check for and remove any zero-sum columns or rows of data, and adjust the co-variate data.

```{r Diet data manip, tidy=TRUE, warning=FALSE, message=FALSE}

#Need to check for empty columns and rows again
#Check for empty columns
which(colSums(alb_prob_preyPA)==0) #None! #Otherwise remove these
#Check for empty rows
which(rowSums(alb_prob_preyPA)==0) #Remove these - this becomes a thing once we start removing outlier species

#Need to remove these from the alb_prob_preyPA data and the covars data

alb_prob_preyPA = alb_prob_preyPA[-c(31, 32, 58, 64, 69, 72, 79, 81, 86, 90, 102, 119, 140, 141, 151, 156),]
#209 observations for 123 prey species
dim(alb_prob_preyPA) #209 123

alb_prob_covars = alb_adult_fo[-c(31, 32, 58, 64, 69, 72, 79, 81, 86, 90, 102, 119, 140, 141, 151, 156), 1:13]
#209 observations for 13 environmental variables

dim(alb_prob_covars) #209  13
```

## Covars (R) - MANIPS

Checking co-variates for analyses.

```{r Covars (R) - summary, eval=FALSE}

#Summary stats on covars
unique(alb_prob_covars$StudyID) #22 studies
unique(alb_prob_covars$OceanBasin) #6 Ocean basins --> "N Atlantic"    "Mediterranean" "N Pacific"     "S Atlantic"    "Indian"        "S Pacific"
unique(alb_adult_fo$OceanBasinQ) #10 Ocean basin quarters, but data gets thin for many
unique(alb_prob_covars$YearEnd) #~27 years (or groups of years) are represented in this study
unique(alb_prob_covars$code) #10 Longhurst provinces represented, similar to Ocean Basin Q but also gets thin
unique(alb_prob_covars$pred_life) #Need to clean these up to --> adult, juvenile and mixed cohorts.

```

Cleaning and manipulating co-variates for analyses. Any study for which we weren't able to estimate albacore life stage or size, either based on location or fork length data, we will consider to be of 'mixed' cohort.

```{r Covars (R) - clean}

#Clean covars
alb_prob_covars = alb_prob_covars %>%
  mutate(pred_life=case_when(pred_life == "juvenile" ~ "juvenile",
                             pred_life == "juvenile, adult" ~ "mixed",
                             pred_life == "adult" ~ "adult",
                             pred_life == "none" ~ "mixed")) #"none" ~ "none"
#As factors
alb_prob_covars[,1:ncol(alb_prob_covars)] =  lapply(alb_prob_covars[,1:ncol(alb_prob_covars)], as.factor)

dim(alb_prob_covars) #209  13
```

Checking the level replication for each covariate. Note that our best covars ==> pred_life, OceanBasin, lat_cat, and maybe code (Longhurst) - but would need to exclude low numbered levels.

```{r Covars (R) checking, eval=FALSE}
#Check representation
#summary(alb_adult_covars)

summary(alb_prob_covars$lat_cat)
#temperate  tropical 
#   178        31 

summary(alb_prob_covars$pred_life)
#   adult juvenile    mixed 
#     54       62      93 

summary(alb_prob_covars$OceanBasin)
#           Indian Mediterranean    N Atlantic     N Pacific    S Atlantic     S Pacific 
#            15            29            78            62            8            17 

summary(alb_prob_covars$OceanBasinQ)
#Not going to use

summary(alb_prob_covars$code)
#Not going to use

dim(alb_prob_covars) #209 observations for 13 covars

```

## DF checks

```{r Check names and df dimensions, eval=FALSE}

## Make sure species names match abund matrix
#rownames(alb_prob_traits) == colnames(alb_prob_preyPA) #awesome!
# And the mvabund matrix
alb_prob_preyPA_mv = as.mvabund(alb_prob_preyPA)

dim(alb_prob_preyPA_mv) #209 123

#rownames(alb_prob_traits) == colnames(alb_prob_preyPA_mv) #awesome!

#Check all matrix dimensions
dim(alb_prob_traits) #123 species and 17 traits
dim(alb_prob_preyPA_mv) #209 obs, 123 species
dim(alb_prob_covars) #209 obs, 13 variables

```


## SAVE DFS FOR ANALYSES

```{r Saving dfs for analysis}

#L - species df
write.csv(alb_prob_preyPA, here("./data/output_data/alb_prob_preyPA_use.csv"))

#R - covars df
write.csv(alb_prob_covars, here("./data/output_data/alb_prob_covars_use.csv"))

#Q - trait df
write.csv(alb_prob_traits, here("./data/output_data/alb_prob_traits_use.csv"))

```

