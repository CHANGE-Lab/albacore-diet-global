---
title: "Albacore Diet Synthesis A"
author: "Natasha Hardy"
date: "15/04/2021"
output:
  pdf_document: default
  html_document: default
---

# Biological and trait diversity in diets of a highly migratory predator

```{r setup, include=FALSE, echo=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

```{r Load Workspace, message=FALSE}

#R documentation
library(pander)
# general
library(tidyverse)
library(readxl)
library(readr)
library(plyr)
library(dplyr)
library(devtools)
library(here)
"%notin%" = Negate('%in%')
here::here()

#Graphics
library(ggplot2)
library(viridis)
library(RColorBrewer)
library(wesanderson)

#Biodiversity
library(BiodiversityR)
library(vegan)
# From GitHub
install_github("MoBiodiv/mobr")
library(mobr)
#devtools::install_github('bbc/bbplot')
#library(bbplot)
```

## Summary Data - Methods

Below, we extract summary information for reported albacore tuna fork lengths and the maxillary lengths that we calculated based on known or estimated albacore FL (Ménard et al. 2006 paper for yellowfin tunas). 

```{r Summary - albacore size info, tidy=TRUE, message=FALSE}

alb_global_diet_total = read.csv(here("data/output_data/alb_global_diet_total.csv")) %>%
  dplyr::select(-X)

#We estimate the range in albacore fork lengths in this study to be:
range(alb_global_diet_total$pred_flmean) #47.23 101.00

#Thus based on Ménard et al. (2006) fork length calculations, the albacore maxillary lengths or gape lengths used in this study were:
range(alb_global_diet_total$gape_lmax) #5.645029 10.070300

```

Here we extract summary information for instances where prey size information were recorded in published literature or historical diet analysis reports.

```{r Summary - prey sizes recorded, tidy=TRUE, message=FALSE}

alb_prey_size_recorded = alb_global_diet_total %>%
  filter(maxtl_use > 0)

unique(alb_prey_size_recorded$StudyID)

#Note these are in mm not cm
range(alb_prey_size_recorded$maxtl_use)

#We therefore lack prey size information for
1028-51 #= 977
#This information was therefore available for only ...% of the time:
51*100/1028 #= 4.96%

```

Below we summarise how many species for which we had complete enough max length, length at maturity and larval length data and with which individual larval-adult and juvenile-adult prey length ratios could be calculated.

```{r Summary - prey lmax known, tidy=TRUE, message=FALSE}

prey_length_wide_info = read.csv(here("data/output_data/prey_length_wide.csv")) %>%
  drop_na()

length(unique(prey_length_wide_info$prey_sp)) #118

length(unique(prey_length_wide_info$prey_sp))*100/298 #(species)
#39.59% of species
```

Here we extract summary information for our calculations of prey larval-adult and juvenile-adult length ratios.

```{r Summary - morph data, tidy=TRUE, message=FALSE}

prey_length_ratiosp = read.csv(here("data/output_data/prey_length_ratiosp.csv")) %>%
  dplyr::select(-X) %>%
  filter(prey_class != "NA",
         l_adult != "Inf",
         l_juve != "Inf",
         larva_adult_use != "Inf",
         juve_adult_use != "Inf"
         )

#Summarise size info - range overall
#Note that these include some very very small taxa (e.g., amphipods as adults)
range(prey_length_ratiosp$l_adult, na.rm = TRUE) #0.1 500.0
range(prey_length_ratiosp$l_juve, na.rm = TRUE) #0.58 180.00
range(prey_length_ratiosp$l_larva, na.rm = TRUE) #0.462 14.600

#Create sub-df's by class for summary purposes
unique(prey_length_ratiosp$prey_class)
#Taxonomic group - hull loop
cl = as.character(unique(prey_length_ratiosp$prey_class))
for(i in 1:length(cl)) {
  temp = cl[i]
  df = prey_length_ratiosp[prey_length_ratiosp$prey_class == temp, ]
  assign(paste0('grp.',temp), df)
}

#By class
range(grp.Actinopterygii$l_adult, na.rm = TRUE)
range(grp.Actinopterygii$l_juve, na.rm = TRUE)
range(grp.Actinopterygii$l_larva, na.rm = TRUE)

range(grp.Actinopterygii$larva_adult_use, na.rm = TRUE) #0.2320 29.0441
range(grp.Actinopterygii$juve_adult_use, na.rm = TRUE) #10.86957 85.00000

mean(grp.Actinopterygii$juve_adult_use, na.rm = TRUE) #42.66437
mean(grp.Actinopterygii$larva_adult_use, na.rm = TRUE) #8.879331

```

Checking the number of prey species ultimately used in multivariate analyses. Note here that we only use 137 out of the 298 species, because we only obtained complete trait information for 137 species. The remainder had incomplete trait information, and we chose to exclude them for now.

```{r Summary - wide diet data, tidy=TRUE, message=FALSE}

alb_global_wide_dietfo = read.csv(here("data/output_data/alb_global_wide_dietfo.csv")) %>%
  dplyr::select(-X, -c(StudyID:grouped_id))

#The number of observations (rows) and species (columns)
dim(alb_global_wide_dietfo)
```

### Rarefaction curves for known taxa:

```{r Rarefaction curves data}
#Data -- using total diet data
alb_global = as.data.frame(read_xlsx(here("data/input_data/albacore_diet_global.xlsx"),
                      sheet = "albacore_diet_global")) %>%
  dplyr::filter(TaxLev %in% c("species", "genus")) %>% 
  #There are ~1105 observations when we filter by species
  dplyr::filter(Include %in% c("Yes", "Maybe") & !pred_life == "larvae") %>% 
  mutate(presence = 1) %>%
#Note there are duplicates
#View(alb_global[c(953,954,112,119,686,687),])
#Delete the second of each of these
  slice(., -c(954,119,687)) %>%
  dplyr::select(StudyID:YearEnd, pred_life, pred_flmean, prey_sp, pFOuse, presence) %>%
  #pivot_wider(names_from = prey_sp, 
  #            values_from = presence, 
  #            values_fill = list(presence = 0))
  tidyr::spread(prey_sp, presence, fill = 0, convert = FALSE)

## Albacore prey species P/A data
# data
PreyPAdata = alb_global[,21:ncol(alb_global)]
PreyPAsite = alb_global %>%
  select(StudyID, OceanBasin, YearEnd)
Ocean <- alb_global$OceanBasin

```

```{r Rarefaction curves 2}

# number of species and the factor that I want to group them by
SpO <- specnumber(PreyPAdata, Ocean)
SpO

# Acummresult function

#Produces average species accumulation curve
Alb.accum <- accumresult(PreyPAdata, y=Ocean, #PreyPAsite, 
                         method='exact', conditioned=TRUE)
str(Alb.accum)
accumplot(Alb.accum)

#Produces cumulative species curves
Alb.accum2 <- accumresult(PreyPAdata, y=Ocean, method='collector', conditioned=TRUE)
str(Alb.accum2)
accumplot(Alb.accum2)


#Produces average species accumulation curve
Plot <- accumcomp(PreyPAdata, y=PreyPAsite, factor='OceanBasin', method='exact', legend=FALSE, conditioned=TRUE)
str(Plot)
Plot.long <- accumcomp.long(Plot)
str(Plot.long)

#Plot.long.covar = Plot.long %>%
#  rename(OceanBasin = Grouping) %>%
#  left_join(PreyPAsite, by = "OceanBasin")

#Produces cumulative species curves
Plot2 <- accumcomp(PreyPAdata, y=PreyPAsite, factor='OceanBasin', method='collector', legend=FALSE, conditioned=TRUE)
str(Plot2)

# save and export the accumcomp data in order to add SW back in with just the one point

# Did this for first and second Plot output for accumcomp function.
plot_temp = as.data.frame(Plot)
write.csv(Plot, here("data/output_data/accum_plot.csv"))
accum.data <- read.csv(here("data/output_data/accum_plot.csv"))
View(accum.data)


#write.csv(Plot2, "Accum_plot2.csv")

#accum.data2 <- read.csv("Accum_plot2.csv", header=TRUE)

#View(accum.data2)
```

```{r rarefaction graphs}

View(accum.data)

levels(as.factor(accum.data$Ocean))

accum.data$Ocean <- factor(accum.data$Ocean, levels = c("Mediterranean", "N Atlantic", "S Atlantic",
                                                        "N Pacific", "S Pacific", "Indian"))

Accum.plot <- ggplot(data = Alb.accum, aes(y=Richness, x=Study, colour=OceanBasin)) +
  geom_point(size=2) +
  geom_line(size=1.5) + 
  theme_classic() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15))+
  theme(axis.title=element_text(size=18)) +
  theme(axis.text=element_text(size=18)) +
  theme(legend.text=element_text(size=18)) +
  theme(legend.title=element_text(size=18)) +
  labs(x="Years sampled", y="Species cumulative richness")+
  scale_colour_manual(values=wes_palette("Zissou1", 7, type="continuous"), name="Ocean Basin")+
  geom_errorbar(data = accum.data, aes(ymin=Richness-sd, ymax=Richness+sd), width=.2)
Accum.plot


accum.data2$Ocean <- factor(accum.data2$Ocean, levels = c("Mediterranean", "NE Atlantic",
                                                        "NW Atlantic", "SW Atlantic",
                                                        "NE Indian", "NE Pacific", 
                                                        "SW Pacific"))

Accum.plot <- ggplot(data = accum.data2, aes(y=Richness, x=Year, colour=Ocean)) +
  geom_point(size=2) +
  geom_line(size=1.5) + 
  theme_classic() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  #scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15))+
  #geom_text(aes(x=Year, label=Stomachs), size=4, hjust=0.5, col="black") +
  geom_text_repel(data = accum.data2, aes(x=Year, label=Stomachs),
                  nudge_x = -10, nudge_y = 10) +
  theme(axis.title=element_text(size=18)) +
  theme(axis.text=element_text(size=18)) +
  theme(legend.text=element_text(size=18)) +
  theme(legend.title=element_text(size=18)) +
  labs(x="Years sampled", y="Species cumulative richness")+
  scale_colour_manual(values=wes_palette("Zissou1", 7, type="continuous"), name="Ocean Basin")
Accum.plot

#Note no error bar for pure accumulation plot

```


## Summary - Results

**Results text** -- Through a historical and global synthesis of albacore tuna diets using reported stomach content data from the 1880’s–2010’s, we report a large biodiversity in the diets of albacore tunas. A total of 550 individual taxa identified in the diets of juvenile and adult albacore tuna across the world’s oceans, representing 203 families of prey taxa, mainly of ray-finned fishes (n = 108 families of prey), cephalopods (n = 29), and crustaceans (Malacostraca n = 45, Hexanauplia n = 6), but also several taxa of pelagic gastropods (n = 6), salps (n = 2) and hydrozoans (n = 1), and one elasmobranch (n = 1) (ESM data).

```{r Summary stats for all diet taxa by class and family, tidy=TRUE, message=FALSE}

diet_all = as.data.frame(read_xlsx(here("data/input_data/albacore_diet_global.xlsx"),
                      sheet = "albacore_diet_global"))

diet_class_sum = diet_all %>%
  filter(prey_class != "NA") %>%
  filter(Include != "No", prey_class != "Other") %>%
  group_by(prey_class, prey_family, na.rm=TRUE) %>%
  tally() 

diet_fam_sum = diet_class_sum %>%
  group_by(prey_class) %>%
  tally()

print(diet_fam_sum)
```

Of these, 312 taxa were reported to species level. In addition to consumption data, we obtained reliable trait information, at the appropriate life stage likely consumed by albacore tuna for 298 individual species. 

```{r Summary stats for species level taxa consumed, tidy=TRUE, message=FALSE}

diet_species_sum = diet_all %>%
  filter(Include != "No") %>%
  group_by(prey_class, prey_sp) %>% #, life_stage
  tally() 

diet_species_level = diet_all %>%
  filter(Include != "No", TaxLev == "species") %>%
  group_by(prey_class, prey_sp) %>% #, life_stage
  tally() 

print(nrow(diet_species_level))

```

```{r Summary stats for probable prey traits, tidy=TRUE, message=FALSE}

prey_probable_traits = read.csv(here("data/output_data/prey_probable_traits.csv")) %>%
  dplyr::select(-X) %>%
  filter(prey_class != "NA")

print(nrow(prey_probable_traits))

```


We obtain quantitative data in the form of (i) percent frequency of occurrence for 137 species, (ii) percent numerical abundance for 100 species, and (iii) percent of biomass consumed for only 82 species.

```{r Summary stats for quantitative diet data, tidy=TRUE, tidy=true, message=FALSE}

# % FO data

diet_fo = read.csv(here("data/output_data/alb_global_wide_dietfo.csv")) %>%
  dplyr::select(-X)
  
print(paste0("(i) percent frequency of occurrence for", ncol(diet_fo[,15:ncol(diet_fo)])))

# % Numerical data

diet_num = read.csv(here("data/output_data/alb_global_wide_dietn.csv")) %>%
  dplyr::select(-X)

print(ncol(diet_fo[,15:ncol(diet_num)]))

# % Biomass data

diet_mass = read.csv(here("data/output_data/alb_global_wide_dietm.csv")) %>%
  dplyr::select(-X)

print(ncol(diet_fo[,15:ncol(diet_mass)]))
```

## Phylogenetic and Traits Final Graphs

Of these, 298 species parsed to phylogenetic trees (Fig. 2a, will work on cleaning phylo code later). Notably, only a subset of species are frequently observed in their diets: 26 species occur in > 50% of samples within studies across the world’s oceans (+ESM), a further 44 species are relatively common, reported  in > 25% of samples (Fig. 2c). Uncommon prey species are often excluded from further analyses due to insufficient data and therefore difficulties in diet modelling. However, we posit that they contribute to diet variability in sharing consumable traits with more common prey species. # Report trait diversity observed and that recur in prey species, hotspots and traits that were most common - for habitat use, morphological and aggregation traits.

## Discussion paragraphs

(Discussion) We discuss the loss of information when we exclude species that are uncommonly consumed - these species share traits with more common species, and convey information about predator-prey interactions. → Trait-based analyses aim to capture information about predator-prey interactions as a result of generalisable traits shared by multiple prey species.

(Discussion) Whilst, broad diets are expected of generalist predators, and cumulatively we would expect several hundred taxa to be represented in a global list of prey consumed, there was no published summary of the taxonomic diversity identified within albacore diets. Additionally, no data from the north Pacific were used in previous syntheses of albacore and other tunas (Young et al. 2015, Duffy et al. 2017, Pethybridge et al. 2018). 

