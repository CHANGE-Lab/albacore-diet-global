---
title: "Albacore Diet Synthesis C Trait Modelling"
author: "Natasha Hardy"
date: "15/04/2021"
output:
  pdf_document: default
  html_document: default
---

# Trait variation in albacore diet across geographies

## About

This document contains code for loading mostly manipulated data for global albacore prey communities consumed and for conducting multivariate community analyses and traitglm on albacore diets across ocean basins, using habitat association, gregariousness traits and cluster # output from cluster analyses.

## Workspace

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#library("rstudioapi")
#setwd(dirname(getActiveDocumentContext()$path))
```

```{r Workspace, echo=FALSE, message=FALSE, results='hide'}
#If need to clear 'Environment'
#First view environment if you like
#ls()
#To clear your environment
#remove(list = ls())

getwd()

# general
library(tidyverse)
library(readxl)
library(plyr)
library(dplyr)
library(devtools)
library(reshape2)
library(here)
"%notin%" = Negate('%in%')
here::here()
library(pander)

# graphics
library(ggplot2)
library(lattice)
library(graphics)
library(RColorBrewer)
library(gridExtra)
library(captioner)
library(viridis)
library("grid")
library("ggplotify")


#modelling
library(Hmisc)
library(mgcv)
library(unmarked)
library(lme4)
library(mvabund)
library(tweedie)
library(vegan)

## mvabund bug source code
source("code/2a_synthesis/traitglm.R")
source("code/2a_synthesis/get_polys.R")

```



## Data needs

- Species (L): alb_prob_preyPA ==> "./data/output_data/alb_prob_preyPA_use.csv"

- Env/Site (R): alb_prob_covars ==> "./data/output_data/alb_prob_covars_use.csv"

- Traits (Q): alb_prob_traits ==> "./data/output_data/alb_prob_traits_use.csv"

### Load DFs for analyses

```{r Load Prey data (L)}

#L - species df
alb_prob_preyPA = read.csv(here("./data/output_data/alb_prob_preyPA_use.csv")) %>%
  dplyr::select(-X)
#Currently imported with sites as rows
#Data are integers, could be numeric if modelling issues

#Example code
#alb_adult_prey[,1:ncol(alb_adult_prey)] =  lapply(alb_adult_prey[,1:ncol(alb_adult_prey)], as.numeric)

dim(alb_prob_preyPA) #74 obs, 156 species
```

```{r Load Covar data (R)}

#R - covars df
alb_prob_covars = read.csv(here("./data/output_data/alb_prob_covars_use.csv")) %>%
  dplyr::select(-X)
#Currently imported with sites as rows

#As factors
alb_prob_covars[,1:ncol(alb_prob_covars)] =  lapply(alb_prob_covars[,1:ncol(alb_prob_covars)], as.factor)

```

```{r Load Trait data (Q)}

#Q - trait df
alb_prob_traits = read.csv(here("./data/output_data/alb_prob_traits_use.csv"))%>%
  dplyr::select(-X)

#Needs species as rows
#Assign speces as rownames
rownames(alb_prob_traits) <- alb_prob_traits$prey_sp
#Order species list if needed
alb_prob_traits <- alb_prob_traits[ order(row.names(alb_prob_traits)), ]
#Traits as factors for analyses
alb_prob_traits[,1:ncol(alb_prob_traits)] =  lapply(alb_prob_traits[,1:ncol(alb_prob_traits)], as.factor)

dim(alb_prob_traits) #156  8

```

## DF Checks

**Traits**

Check trait values distribution if needed.

```{r Trait values check, eval=FALSE, warning=FALSE, message=FALSE}
summary(alb_prob_traits$life_stage)

summary(alb_prob_traits$vert_habitat) #merge bathypelagic and mesopelagic #done

summary(alb_prob_traits$horz_habitat) #potential merger of continental shelf/slope, and coastal/reef assoc. #done

summary(alb_prob_traits$diel_migrant_cat)

summary(alb_prob_traits$season_cat)

summary(alb_prob_traits$gregarious)

summary(alb_prob_traits$prob.clust.num) 

```

Trait variable levels look good.

```{r Trait factor levels, warning=FALSE, message=FALSE}

levels(alb_prob_traits$vert_habitat) #check

levels(alb_prob_traits$horz_habitat) #check

levels(alb_prob_traits$gregarious) #check

```

**Covars**

```{r Covars values check, eval=FALSE}

#Summary stats on covars
unique(alb_prob_covars$StudyID) #26 studies
unique(alb_prob_covars$OceanBasin) #6 Ocean basins
unique(alb_prob_covars$OceanBasinUse) #5 Ocean basins
unique(alb_prob_covars$pred_life) #3
unique(alb_prob_covars$pred_life_adjust) #3

```

We'll be using the best covars based on balance and replication ==> pred_life, OceanBasin, lat_cat.

```{r Covar factor levels, eval=FALSE}
#Check representation
#summary(alb_adult_covars)

summary(alb_prob_covars$lat_cat)
#temperate  tropical 
#   68        6 

summary(alb_prob_covars$pred_life_adjust)
#   adult juvenile    mixed 
#     8       29        37 
#Predator life stage
alb_prob_covars$pred_life_adjust <- factor(alb_prob_covars$pred_life_adjust, 
                                            levels = c("mixed", "adult", "juvenile"))

summary(alb_prob_covars$OceanBasinUse)
#Indian & S Atlantic       Mediterranean          N Atlantic           N Pacific           S Pacific 
#           5                   9                  24                  28                   8

#Select some covars & traits
alb_prob_covars$OceanBasinUse <- factor(alb_prob_covars$OceanBasinUse, levels = c("Mediterranean", "N Atlantic", "Indian & S Atlantic", "N Pacific", "S Pacific"))
#Check
#levels(alb_prob_covars$OceanBasin)

```

## DF manips for multivariate analyses

```{r Check names and df dimensions}

## Make sure species names match abund matrix
#rownames(alb_prob_traits) == colnames(alb_prob_preyPA) #awesome!

# Then create the mvabund matrix
alb_prob_preyPA_mv = as.mvabund(alb_prob_preyPA)

#Check again that species names match trait values
#rownames(alb_prob_traits) == colnames(alb_prob_preyPA_mv) #awesome!

#Check all matrix dimensions
dim(alb_prob_traits) #123 species and 17 traits
dim(alb_prob_preyPA_mv) #209 obs, 123 species
dim(alb_prob_covars) #209 obs, 13 variables

```

```{r Select covars traits and levels}

#Species df is ready --> alb_prob_preyPA_mv

#Covars --> want to use 
#alb_prob_covars$OceanBasin
#alb_prob_covars$pred_life
#alb_prob_covars$lat_cat

#Traits - select and manipulate that df - ideally we want to use the same df here
traits_use = alb_prob_traits[,c(2:8)] %>%
  dplyr::rename(cluster = prob.clust.num) 

#Predator life stage
traits_use$gregarious <- factor(traits_use$gregarious, 
                                            levels = c("solitary", "schooling"))
levels(traits_use$gregarious)
#All still factors
#Using all traits 
#traits_use[,1:6] 
#and just clusters
str(traits_use)
```


## TRAIT GLMS

### MODEL TALLY

**Manyglms for model comparisons**

- prob_life_spp (redone)

- prob_ocean_spp (redone)

- prob_lat_spp (redone)

- prob_life_clusters_many (redone)

- prob_ocean_clusters_many (redone)

- prob_life_trait_many

- prob_ocean_trait_many


**LASSO glm1path models for significance testing**

- prob_life_cluster_LASSO (redone)

- prob_ocean_cluster_LASSO (redone)

- prob_life_trait_LASSO

- prob_ocean_trait_LASSO

- prob_lat_trait_LASSO


### Species models

**SPP Manyglm - Predator Life Stage**
add:, eval=FALSE

```{r SPP life stage manyglm}

prob_life_spp <- traitglm(L = alb_prob_preyPA_mv,
                          R = alb_prob_covars$pred_life_adjust,
                          family=binomial(link = "logit")
                          ) #note default is "manyglm"

```

**SPP Manyglm - Ocean Basin**

```{r SPP ocean manyglm}

prob_ocean_spp <- traitglm(L = alb_prob_preyPA_mv,
                                    R = alb_prob_covars$OceanBasinUse,
                                    family=binomial(link = "logit")
                                    ) #note default is "manyglm"

#check model output if needed
```

**SPP Manyglm - Latitude**

```{r SPP climate manyglm}

prob_lat_spp <- traitglm(L = alb_prob_preyPA_mv,
                         R = alb_prob_covars$lat_cat,
                         family=binomial(link = "logit")
                         ) #note default is "manyglm"

#check model output if needed
```

**SPP Manyglm - Life Stage - Check multivariate model outputs**

Note that multivariate residuals look good and we have a pretty good fit.

```{r SPP life stage model eval, tidy=TRUE, message=FALSE, warning=FALSE}

#Check model output - residuals TEST
qqnorm(residuals(prob_life_spp)[which(residuals(prob_life_spp)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(prob_life_spp)[is.finite((residuals(prob_life_spp)))]
plot(resids.full); abline(c(0,0),col="red")
```

SAVE OUTPUTS SO FAR

```{r SAVE SPP MODELS}
#/Users/tashhardy/Documents/GitHub/albacore-diet-global/outputs_figures/traitglms/prob_models_sep2021

saveRDS(prob_life_spp, file = here("outputs_figures/traitglms/prob_models_sep2021/prob_life_spp.rds")) 
saveRDS(prob_ocean_spp, file = here("outputs_figures/traitglms/prob_models_sep2021/prob_ocean_spp.rds"))
saveRDS(prob_lat_spp, file = here("outputs_figures/traitglms/prob_models_sep2021/prob_lat_spp.rds"))

```


### Trait clusters models

#### Predator Life Stage

**MANYGLM Clusters - Predator Life Stage**

Trait (cluster)*Env (life stage) - Manyglm

```{r Clusters life stage manyglm}

prob_life_clusters_many <- traitglm(L = alb_prob_preyPA_mv,
                                    R = alb_prob_covars$pred_life_adjust,
                                    Q = traits_use$cluster,
                                    family=binomial(link = "logit")
                                    ) #note default is "manyglm"

```

Note that outputs for all models look the same because residuals are the same, as we fit models to the same species and covariate datasets.

```{r Check clusters life stage manyglm output, tidy=TRUE, message=FALSE, warning=FALSE}
#Check model output - residuals TEST
qqnorm(residuals(prob_life_clusters_many)[which(residuals(prob_life_clusters_many)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(prob_life_clusters_many)[is.finite((residuals(prob_life_clusters_many)))]
plot(resids.full); abline(c(0,0),col="red")
```

Visualise results of traitglm fit with manyglm routine, reference levels are the first cluster group and the mixed albacore life stage group.

```{r Plot clusters life manyglm, tidy=TRUE, message=FALSE, warning=FALSE}

a        = max( abs(prob_life_clusters_many$fourth.corner) )
colort   = colorRampPalette(c("blue","grey","red")) #can replace "grey" with "white"
temp = t(as.matrix(prob_life_clusters_many$fourth.corner))

rownames(temp) = c("Adult", "Juvenile")

prob_life_clusters_many_graph = levelplot(temp, 
                     xlab=list("Predator Life Stage", cex=1.5),
                     ylab=list("Species cluster", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_life_clusters_many_graph)

ggsave(here("./outputs_figures/traitglms/prob_models_sep2021/prob_life_clusters_many_graph.pdf"), 
       plot = as.ggplot(prob_life_clusters_many_graph), width=12, height=12, dpi=300)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_life_clusters_many_graph.jpeg"), 
       plot = as.ggplot(prob_life_clusters_many_graph), width=12, height=12, dpi=300)

```

**GLM1PATH Clusters - Predator Life Stage**

Using method = glm1path == LASSO model.

```{r Clusters life  LASSO}

prob_life_cluster_LASSO <- traitglm(L = alb_prob_preyPA_mv,
                                    R = alb_prob_covars$pred_life_adjust,
                                    Q = traits_use$cluster,
                                    family=binomial(link = "logit"),
                                    method="glm1path"
                                    ) #note default is "manyglm"

```

**NOTE:** We do not get a lot of significant values for the clusters as a trait.

```{r Plot cluster life LASSO, tidy=TRUE, message=FALSE, warning=FALSE}

a        = max( abs(prob_life_cluster_LASSO$fourth.corner) )
colort   = colorRampPalette(c("blue","grey","red")) #can replace "grey" with "white"
temp = t(as.matrix(prob_life_cluster_LASSO$fourth.corner))

rownames(temp) = c("Mixed", "Adult", "Juvenile")

prob_life_cluster_LASSO_graph = levelplot(temp,
                                          xlab=list("Predator Life Stage", cex=1.5),
                                          ylab=list("Species clusters", cex=1.5),
                                          col.regions=colort(100),
                                          at=seq(-a, a,length=100),
                                          scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)),
                                          colorkey=list(labels=list(cex=1.3)))

print(prob_life_cluster_LASSO_graph)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_life_cluster_LASSO_graph.pdf"), 
       plot = as.ggplot(prob_life_cluster_LASSO_graph), width=12, height=12, dpi=300)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_life_cluster_LASSO_graph.jpeg"), 
       plot = as.ggplot(prob_life_cluster_LASSO_graph), width=12, height=12, dpi=300)

```

#### Ocean Basin

**MANYGLM Clusters - Ocean Basin**

Trait (cluster)*Env (ocean basin) - Manyglm

```{r Clusters ocean manyglm}

prob_ocean_clusters_many <- traitglm(L = alb_prob_preyPA_mv,
                                     R = alb_prob_covars$OceanBasinUse,
                                     Q = traits_use$cluster,
                                     family=binomial(link = "logit")
                                     ) #note default is "manyglm"

```

```{r Plot clusters ocean manyglm, tidy=TRUE, message=FALSE, warning=FALSE}

a        = max( abs(prob_ocean_clusters_many$fourth.corner) )
colort   = colorRampPalette(c("blue","grey","red")) #can replace "grey" with "white"
temp = t(as.matrix(prob_ocean_clusters_many$fourth.corner))

rownames(temp) = c(#"Mediterranean",
                   "N Atlantic",
                   "Idian & S Atlantic",
                   "N Pacific",
                   "S Pacific"#,
                   #"Indian"
                   )

prob_ocean_clusters_many_graph = levelplot(temp, 
                     xlab=list("Ocean Basins", cex=1.5),
                     ylab=list("Species clusters", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_ocean_clusters_many_graph)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_ocean_clusters_many_graph.pdf"), 
       plot = as.ggplot(prob_ocean_clusters_many_graph), width=12, height=12, dpi=300)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_ocean_clusters_many_graph.jpeg"), 
       plot = as.ggplot(prob_ocean_clusters_many_graph), width=12, height=12, dpi=300)

```

**GLM1PATH Clusters - Ocean Basin**

Using method = glm1path == LASSO model.

```{r Clusters ocean LASSO}

prob_ocean_cluster_LASSO <- traitglm(L = alb_prob_preyPA_mv,
                                     R = alb_prob_covars$OceanBasinUse,
                                     Q = traits_use$cluster,
                                     family=binomial(link = "logit"),
                                     method="glm1path"
                                     ) #note default is "manyglm"

```

```{r Plot clusters ocean LASSO, tidy=TRUE, message=FALSE, warning=FALSE}

a        = max( abs(prob_ocean_cluster_LASSO$fourth.corner) )
colort   = colorRampPalette(c("blue","grey","red")) #can replace "grey" with "white"
temp = t(as.matrix(prob_ocean_cluster_LASSO$fourth.corner))

rownames(temp) = c("Mediterranean",
                   "N Atlantic",
                   "Indian & S Atlantic",
                   "N Pacific",
                   "S Pacific")

prob_ocean_cluster_LASSO_graph = levelplot(temp, 
                     xlab=list("Ocean Basins", cex=1.5),
                     ylab=list("Species clusters", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_ocean_cluster_LASSO_graph)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_ocean_cluster_LASSO_graph.pdf"), 
       plot = as.ggplot(prob_ocean_cluster_LASSO_graph), width=12, height=12, dpi=300)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_ocean_cluster_LASSO_graph.jpeg"), 
       plot = as.ggplot(prob_ocean_cluster_LASSO_graph), width=12, height=12, dpi=300)

```


#### Climate

**MANYGLM Clusters - Climate**

Trait (cluster)*Env (climate) - Manyglm

```{r Clusters latitude manyglm}

prob_lat_clusters_many <- traitglm(L = alb_prob_preyPA_mv,
                                     R = alb_prob_covars$lat_cat,
                                     Q = traits_use$cluster,
                                     family=binomial(link = "logit")
                                     ) #note default is "manyglm"

```

```{r Plot clusters latitude manyglm, tidy=TRUE, message=FALSE, warning=FALSE}

a        = max( abs(prob_lat_clusters_many$fourth.corner) )
colort   = colorRampPalette(c("blue","grey","red")) #can replace "grey" with "white"
temp = t(as.matrix(prob_lat_clusters_many$fourth.corner))

rownames(temp) = c("Tropical")

prob_lat_clusters_many_graph = levelplot(temp, 
                     xlab=list("Climate", cex=1.5),
                     ylab=list("Species clusters", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_lat_clusters_many_graph)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_lat_clusters_many_graph.pdf"), 
       plot = as.ggplot(prob_lat_clusters_many_graph), width=12, height=12, dpi=300)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_lat_clusters_many_graph.jpeg"), 
       plot = as.ggplot(prob_lat_clusters_many_graph), width=12, height=12, dpi=300)

```

**GLM1PATH Clusters - Climate**

Using method = glm1path == LASSO model.

```{r Clusters latitude LASSO}

prob_lat_cluster_LASSO <- traitglm(L = alb_prob_preyPA_mv,
                                     R = alb_prob_covars$lat_cat,
                                     Q = traits_use$cluster,
                                     family=binomial(link = "logit"),
                                     method="glm1path"
                                     ) #note default is "manyglm"

```

```{r Plot clusters latitude LASSO, tidy=TRUE, message=FALSE, warning=FALSE}

a        = max( abs(prob_lat_cluster_LASSO$fourth.corner) )
colort   = colorRampPalette(c("blue","grey","red")) #can replace "grey" with "white"
temp = t(as.matrix(prob_lat_cluster_LASSO$fourth.corner))

rownames(temp) = c("Tropical")

prob_lat_cluster_LASSO_graph = levelplot(temp, 
                     xlab=list("Climate", cex=1.5),
                     ylab=list("Species clusters", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_lat_cluster_LASSO_graph)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_lat_cluster_LASSO_graph.pdf"), 
       plot = as.ggplot(prob_lat_cluster_LASSO_graph), width=12, height=12, dpi=300)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_lat_cluster_LASSO_graph.jpeg"), 
       plot = as.ggplot(prob_lat_cluster_LASSO_graph), width=12, height=12, dpi=300)

```

#### SAVE CLUSTER OUTPUTS

```{r SAVE CLUSTER MODELS}
#/Users/tashhardy/Documents/GitHub/albacore-diet-global/outputs_figures/traitglms/prob_models

#Manyglms
saveRDS(prob_life_clusters_many, 
        file = here("outputs_figures/traitglms/prob_models_sep2021/prob_life_clusters_many.rds")) 
saveRDS(prob_ocean_clusters_many, 
        file = here("outputs_figures/traitglms/prob_models_sep2021/prob_ocean_clusters_many.rds"))
saveRDS(prob_lat_clusters_many, 
        file = here("outputs_figures/traitglms/prob_models_sep2021/prob_lat_clusters_many.rds"))

#LASSO glms
saveRDS(prob_life_cluster_LASSO, 
        file = here("outputs_figures/traitglms/prob_models_sep2021/prob_life_cluster_LASSO.rds"))
saveRDS(prob_ocean_cluster_LASSO, 
        file = here("outputs_figures/traitglms/prob_models_sep2021/prob_ocean_cluster_LASSO.rds"))
saveRDS(prob_lat_cluster_LASSO, 
        file = here("outputs_figures/traitglms/prob_models_sep2021/prob_lat_cluster_LASSO.rds"))

```

### Trait models

#### Predator Life Stage

**MANYGLM Trait values - Predator Life Stage**

Trait (trait matrix)*Env (life stage) - Manyglm

```{r Traits life stage manyglm}

prob_life_trait_many <- traitglm(L = alb_prob_preyPA_mv,
                                 R = alb_prob_covars$pred_life_adjust,
                                 Q = traits_use[,1:6],
                                    #traits_use_try,
                                 family=binomial(link = "logit")
                                    ) #note default is "manyglm"

```

```{r Plot traits life stage manyglm, tidy=TRUE, message=FALSE, warning=FALSE}

a        = max( abs(prob_life_trait_many$fourth.corner) )
colort   = colorRampPalette(c("blue","grey","red")) #can replace "grey" with "white"
temp = t(as.matrix(prob_life_trait_many$fourth.corner))

#rownames(temp) = c("Adult", "Juvenile", "Mixed")
#colnames(temp) = c("Vert. habitat - benthic",
#                   "Vert. habitat - demersal",
#                   "Vert. habitat - epipelagic",
#                   "Vert. habitat - mesopelagic",
#                   "Vert. habitat - bathypelagic",
#                   "Horz. habitat - reef-associated",
#                   "Horz. habitat - coastal",
#                   "Horz. habitat - continental shelf",
#                   "Horz. habitat - continental slope",
#                   "Horz. habitat - oceanic",
#                   "Diel migrant (yes)",
#                   "Seasonal migrant (yes)",
#                   "Gregarious - schooling")

prob_life_many_4th = levelplot(temp, 
                     xlab=list("Predator Life Stage", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_life_many_4th)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_life_trait_many_graph.pdf"), plot = as.ggplot(prob_life_many_4th), width=12, height=12, dpi=300)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_life_trait_many_graph.jpeg"), plot = as.ggplot(prob_ocean_cluster_LASSO_graph), width=12, height=12, dpi=300)

#dev.copy2pdf(file=here("./outputs_figures/traitglms/fourth_lifestage.png"), width=12, height=5)

```

**GLM1PATH Trait values - Predator Life Stage**

Using method = glm1path == LASSO model.

```{r Traits life stage LASSO}

prob_life_trait_LASSO <- traitglm(L = alb_prob_preyPA_mv,
                                 R = alb_prob_covars$pred_life_adjust,
                                 Q = traits_use[,1:6],
                                 family=binomial(link = "logit"),
                                 method="glm1path"
                                 ) #note default is "manyglm"

```

```{r Plot traits life LASSO, tidy=TRUE, message=FALSE, warning=FALSE}

a        = max( abs(prob_life_trait_LASSO$fourth.corner) )
colort   = colorRampPalette(c("blue","grey","red")) #can replace "grey" with "white"
temp = t(as.matrix(prob_life_trait_LASSO$fourth.corner))

rownames(temp) = c("Mixed", "Adult", "Juvenile")
colnames(temp) = c("Prey life: juvenile",
                   "Vert. habitat - benthic",
                   "Vert. habitat - demersal",
                   "Vert. habitat - epipelagic",
                   "Vert. habitat - mesopelagic",
                   "Horz. habitat - coastal",
                   "Horz. habitat - continental shelf",
                   "Horz. habitat - oceanic",
                   "Diel migrant (yes)",
                   "Seasonal migrant (yes)",
                   "Gregarious - schooling")

prob_life_LASSO_graph = levelplot(temp, 
                     xlab=list("Predator Life Stage", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_life_LASSO_graph)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_life_trait_LASSO_graph.pdf"), 
       plot = as.ggplot(prob_life_LASSO_graph), width=12, height=12, dpi=300)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_life_trait_LASSO_graph.jpeg"), 
       plot = as.ggplot(prob_life_LASSO_graph), width=12, height=12, dpi=300)

```

#### Ocean Basin

**MANYGLM Trait values - Ocean Basin**

Trait (trait matrix)*Env (ocean basin) - Manyglm

```{r Traits ocean manyglm}

prob_ocean_trait_many <- traitglm(L = alb_prob_preyPA_mv,
                                 R = alb_prob_covars$OceanBasinUse,
                                 Q = traits_use[,1:6],
                                 family=binomial(link = "logit")
                                    ) #note default is "manyglm"

```

```{r Plot traits ocean manyglm, tidy=TRUE, message=FALSE, warning=FALSE}

a        = max( abs(prob_ocean_trait_many$fourth.corner) )
colort   = colorRampPalette(c("blue","grey","red")) #can replace "grey" with "white"
temp = t(as.matrix(prob_ocean_trait_many$fourth.corner))

rownames(temp) = c(#"Mediterranean",
                   "N Atlantic",
                   "Indian & S Atlantic",
                   #"S Atlantic",
                   "N Pacific",
                   "S Pacific"#,
                   #"Indian"
                   )

prob_ocean_trait_many_graph = levelplot(temp, 
                     xlab=list("Ocean Basins", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_ocean_trait_many_graph)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_ocean_trait_many_graph.pdf"), 
       plot = as.ggplot(prob_ocean_trait_many_graph), width=12, height=12, dpi=300)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_ocean_trait_many_graph.jpeg"), 
       plot = as.ggplot(prob_ocean_trait_many_graph), width=12, height=12, dpi=300)

```

*GLM1PATH Trait values - Ocean Basin**

Using method = glm1path == LASSO model.

```{r Traits ocean LASSO}

prob_ocean_trait_LASSO <- traitglm(L = alb_prob_preyPA_mv,
                                 R = alb_prob_covars$OceanBasinUse,
                                 Q = traits_use[,1:6],
                                 family=binomial(link = "logit"),
                                 method="glm1path"
                                 ) #note default is "manyglm"

```

```{r Plot traits ocean LASSO, tidy=TRUE, message=FALSE, warning=FALSE}

a        = max( abs(prob_ocean_trait_LASSO$fourth.corner) )
colort   = colorRampPalette(c("blue","grey","red")) #can replace "grey" with "white"
temp = t(as.matrix(prob_ocean_trait_LASSO$fourth.corner))

rownames(temp) = c("Mediterranean",
                   "N Atlantic",
                   "Indian & S Atlantic",
                   "N Pacific",
                   "S Pacific")

colnames(temp) = c("Prey life: juvenile",
                   "Vert. habitat - benthic",
                   "Vert. habitat - demersal",
                   "Vert. habitat - epipelagic",
                   "Vert. habitat - mesopelagic",
                   "Horz. habitat - coastal",
                   "Horz. habitat - continental shelf",
                   "Horz. habitat - oceanic",
                   "Diel migrant (yes)",
                   "Seasonal migrant (yes)",
                   "Gregarious - schooling")

prob_ocean_LASSO_graph = levelplot(temp, 
                     xlab=list("Ocean Basins", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_ocean_LASSO_graph)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_ocean_traits_LASSO_graph.pdf"), 
       plot = as.ggplot(prob_ocean_LASSO_graph), width=12, height=12, dpi=300)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_ocean_traits_LASSO_graph.jpeg"), 
       plot = as.ggplot(prob_ocean_LASSO_graph), width=12, height=12, dpi=300)

```

#### Climate

**MANYGLM Trait values - Latitude**

Trait (trait matrix)*Env (latitude) - Manyglm

```{r Traits latitude manyglm}

prob_lat_trait_many <-  traitglm(L = alb_prob_preyPA_mv,
                            R = alb_prob_covars$lat_cat,
                            Q = traits_use[,1:6],
                            family=binomial(link = "logit")
                            ) #note default is "manyglm"

```

```{r Plot traits latitude manyglm, tidy=TRUE, message=FALSE, warning=FALSE}

a        = max( abs(prob_lat_trait_many$fourth.corner) )
colort   = colorRampPalette(c("blue","grey","red")) #can replace "grey" with "white"
temp = t(as.matrix(prob_lat_trait_many$fourth.corner))

rownames(temp) = c("Tropical")

prob_lat_trait_many_graph = levelplot(temp, 
                     xlab=list("Temperate vs. Tropical", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_lat_trait_many_graph)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_lat_trait_many_graph.pdf"), 
       plot = as.ggplot(prob_lat_trait_many_graph), width=12, height=12, dpi=300)
       
ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_lat_trait_many_graph.jpeg"), 
       plot = as.ggplot(prob_lat_trait_many_graph), width=12, height=12, dpi=300)

```

**GLM1PATH Trait values - Latitude**

Using method = glm1path == LASSO model.

```{r Traits latitude LASSO}
#levels(alb_prob_covars$lat_cat)

#alb_prob_covars$lat_cat <- factor(alb_prob_covars$lat_cat, levels = c("tropical", "temperate"))

prob_lat_trait_LASSO <-  traitglm(L = alb_prob_preyPA_mv,
                            R = alb_prob_covars$lat_cat,
                            Q = traits_use[,1:6],
                            family=binomial(link = "logit"),
                            method="glm1path"
                            ) #note default is "manyglm"

```

```{r Plot traits latitude LASSO, tidy=TRUE, message=FALSE, warning=FALSE}

a        = max( abs(prob_lat_trait_LASSO$fourth.corner) )
colort   = colorRampPalette(c("blue","grey","red")) #can replace "grey" with "white"
temp = t(as.matrix(prob_lat_trait_LASSO$fourth.corner))

rownames(temp) = c("Temperate")

colnames(temp) = c("Prey life: juvenile",
                   "Vert. habitat - benthic",
                   "Vert. habitat - demersal",
                   "Vert. habitat - epipelagic",
                   "Vert. habitat - mesopelagic",
                   "Horz. habitat - coastal",
                   "Horz. habitat - continental shelf",
                   "Horz. habitat - oceanic",
                   "Diel migrant (yes)",
                   "Seasonal migrant (yes)",
                   "Gregarious - schooling")


prob_lat_trait_LASSO_graph = levelplot(temp, 
                     xlab=list("Temperate vs. Tropical", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_lat_trait_LASSO_graph)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_lat_trait_LASSO_temp_graph.pdf"), 
       plot = as.ggplot(prob_lat_trait_LASSO_graph), width=12, height=12, dpi=300)
       
ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_lat_trait_LASSO_emp_graph.jpeg"), 
       plot = as.ggplot(prob_lat_trait_LASSO_graph), width=12, height=12, dpi=300)

```

#### SAVE TRAITS OUTPUTS

```{r SAVE TRAIT MODELS}

# Manyglms
saveRDS(prob_life_trait_many, file = here("outputs_figures/traitglms/prob_models_sep2021/prob_life_trait_many.rds")) 
saveRDS(prob_ocean_trait_many, file = here("outputs_figures/traitglms/prob_models_sep2021/prob_ocean_trait_many.rds"))
saveRDS(prob_lat_trait_many, file = here("outputs_figures/traitglms/prob_models_sep2021/prob_lat_trait_many.rds"))

#LASSO glms
saveRDS(prob_life_trait_LASSO, file = here("outputs_figures/traitglms/prob_models_sep2021/prob_life_trait_LASSO.rds"))
saveRDS(prob_ocean_trait_LASSO, file = here("outputs_figures/traitglms/prob_models_sep2021/prob_ocean_trait_LASSO.rds"))
saveRDS(prob_lat_trait_LASSO, file = here("outputs_figures/traitglms/prob_models_sep2021/prob_lat_trait_LASSO.rds"))

```


### Interactions

#### Ocean Basin + Predator Life stage

**MANYGLM Interaction Model**

```{r Traits interactions manyglm}

prob_inter_trait_many <- traitglm(L = alb_prob_preyPA_mv,
                                  R = alb_prob_covars[,c("pred_life_adjust", "OceanBasinUse")],
                                  Q = traits_use[,1:6],
                                  family=binomial(link = "logit")
                                    ) #note default is "manyglm"

#prob_inter_trait_many$deviance

```


```{r Plot interactions manyglm, tidy=TRUE, message=FALSE, warning=FALSE}

a        = max( abs(prob_inter_trait_many$fourth.corner) )
colort   = colorRampPalette(c("blue","grey","red")) #can replace "grey" with "white"
temp = t(as.matrix(prob_inter_trait_many$fourth.corner))

prob_inter_trait_many_graph = levelplot(temp, 
                     xlab=list("Predator Life Stage + Ocean Basins", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_inter_trait_many_graph)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_inter_trait_many_graph.pdf"), 
       plot = as.ggplot(prob_inter_trait_many_graph), width=12, height=12, dpi=300)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_inter_trait_many_graph.jpeg"), 
       plot = as.ggplot(prob_inter_trait_many_graph), width=12, height=12, dpi=300)

```

**GLM1PATH Interaction Model**

```{r Traits interactions LASSO}

prob_inter_trait_LASSO <- traitglm(L = alb_prob_preyPA_mv,
                                  R = alb_prob_covars[,c("pred_life_adjust", "OceanBasinUse")],
                                  Q = traits_use[,1:6],
                                  family=binomial(link = "logit"),
                                  method="glm1path"
                                    ) #note default is "manyglm"

```

```{r Plot interactions LASSO, tidy=TRUE, message=FALSE, warning=FALSE}

a        = max( abs(prob_inter_trait_LASSO$fourth.corner) )
colort   = colorRampPalette(c("blue","grey","red")) #can replace "grey" with "white"
temp = t(as.matrix(prob_inter_trait_LASSO$fourth.corner))

prob_inter_trait_LASSO_graph = levelplot(temp, 
                     xlab=list("Predator Life Stage + Ocean Basins", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_inter_trait_LASSO_graph)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_inter_trait_LASSO_graph.pdf"), 
       plot = as.ggplot(prob_inter_trait_LASSO_graph), width=12, height=12, dpi=300)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_inter_trait_LASSO_graph.jpeg"), 
       plot = as.ggplot(prob_inter_trait_LASSO_graph), width=12, height=12, dpi=300)

```

#### Ocean Basin + Climate

**MANYGLM Interaction Model**

```{r Traits interactions manyglm 2}

prob_inter_trait_many2 <- traitglm(L = alb_prob_preyPA_mv,
                                  R = alb_prob_covars[,c("OceanBasinUse", "lat_cat")],
                                  Q = traits_use[,1:6],
                                  family=binomial(link = "logit")
                                    ) #note default is "manyglm"

#prob_inter_trait_many$deviance

```


```{r Plot interactions manyglm 2, tidy=TRUE, message=FALSE, warning=FALSE}

a        = max( abs(prob_inter_trait_many2$fourth.corner) )
colort   = colorRampPalette(c("blue","grey","red")) #can replace "grey" with "white"
temp = t(as.matrix(prob_inter_trait_many2$fourth.corner))

prob_inter_trait_many2_graph = levelplot(temp, 
                     xlab=list("Ocean Basin + Climate", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_inter_trait_many2_graph)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_inter_trait_many2_graph.pdf"), 
       plot = as.ggplot(prob_inter_trait_many2_graph), width=12, height=12, dpi=300)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_inter_trait_many2_graph.jpeg"), 
       plot = as.ggplot(prob_inter_trait_many2_graph), width=12, height=12, dpi=300)

```

**GLM1PATH Interaction Model**

```{r Traits interactions LASSO 2}

prob_inter_trait_LASSO2 <- traitglm(L = alb_prob_preyPA_mv,
                                  R = alb_prob_covars[,c("OceanBasinUse", "lat_cat")],
                                  Q = traits_use[,1:6],
                                  family=binomial(link = "logit"),
                                  method="glm1path"
                                    ) #note default is "manyglm"

```

```{r Plot interactions LASSO 2, tidy=TRUE, message=FALSE, warning=FALSE}

a        = max( abs(prob_inter_trait_LASSO2$fourth.corner) )
colort   = colorRampPalette(c("blue","grey","red")) #can replace "grey" with "white"
temp = t(as.matrix(prob_inter_trait_LASSO2$fourth.corner))

prob_inter_trait_LASSO2_graph = levelplot(temp, 
                     xlab=list("Ocean Basin + Climate", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_inter_trait_LASSO2_graph)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_inter_trait_LASSO2_graph.pdf"), 
       plot = as.ggplot(prob_inter_trait_LASSO2_graph), width=12, height=12, dpi=300)

ggsave(here("outputs_figures/traitglms/prob_models_sep2021/prob_inter_trait_LASSO2_graph.jpeg"), 
       plot = as.ggplot(prob_inter_trait_LASSO2_graph), width=12, height=12, dpi=300)

```

#### SAVE THESE

```{r Save interaction models}

#Manyglm
saveRDS(prob_inter_trait_many, file = here("outputs_figures/traitglms/prob_models_sep2021/prob_inter_trait_many.rds"))
saveRDS(prob_inter_trait_many2, file = here("outputs_figures/traitglms/prob_models_sep2021/prob_inter_trait_many2.rds"))

#LASSO glms
saveRDS(prob_inter_trait_LASSO, file = here("outputs_figures/traitglms/prob_models_sep2021/prob_inter_trait_LASSO.rds"))
saveRDS(prob_inter_trait_LASSO2, file = here("outputs_figures/traitglms/prob_models_sep2021/prob_inter_trait_LASSO2.rds"))

```


