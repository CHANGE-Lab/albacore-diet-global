---
title: "Albacore Diet Synthesis C"
author: "Natasha Hardy"
date: "15/04/2021"
output:
  pdf_document: default
  html_document: default
---

# Trait variation in albacore diet across geographies

## About

This document contains code for data manipulation, refinement and conversion to presence absence, as well as conducting multivariate community analyses and traitglm on albacore diets across ocean basins, using habitat association, gregariousness traits and cluster # output from cluster analyses.

## Blueprint for paragraphs:

1. (Results) Describe the dominant significant traits and non-sig traits in relation to albacore age and geography sampled (Fig. R3).

2. Relate to clusters (potential additional analysis/figure).

3. Discussion - Investigate how species traits may be used to explain variation in prey use by albacore tuna using a multi-matrix approach.

## Current Issues / Limitations to discuss in paper

- We do currently use community data that includes single occurrence species, this means species that only occurred once in albacore diets across the world. As these are also associated with trait information and we aim to use traits to explain differences in communities, we believe this isn't problematic, but worth noting. In a traditional multivariate analysis, single occurrence species would inflate differences between communities that are analysed on a species-only basis, whilst our sampling (a.k.a. tuna foraging) does not adequately pick up these rarer species.

- The data are longer (225 obs) than they are wide (137 species), but only just. There are up to 30 species that only occurred once, and that would also cost us about 30 observations. Could be worth re-running models excluding single occurrence to check results.

## Workspace

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#library("rstudioapi")
#setwd(dirname(getActiveDocumentContext()$path))
```

```{r Workspace, echo=FALSE, message=FALSE, results='hide'}
#If need to clear 'Environment'
#First view environment if you like
#ls()
#To clear your environment
#remove(list = ls())

getwd()

# general
library(readxl)
library(plyr)
library(dplyr)
library(devtools)
library(reshape2)
library(here)
"%notin%" = Negate('%in%')
here::here()
library(pander)
library(stringr)

# graphics
library(ggplot2)
library(lattice)
library(graphics)
library(RColorBrewer)
library(gridExtra)
library(captioner)
library(viridis)
library("grid")
library("ggplotify")


#modelling
library(Hmisc)
library(mgcv)
library(unmarked)
library(lme4)
library(mvabund)
library(tweedie)
library(vegan)

## mvabund bug source code
source("code/2a_synthesis/traitglm.R")
source("code/2a_synthesis/get_polys.R")

```


## Data (L)

Load frequency of occurrence data.

```{r Species PA (L) load data, tidy=TRUE, warning=FALSE, message=FALSE}

#Upload + manipulate Species & Covar DF
#Doesn't like the here() function now for some reason
alb_pa = read.csv(paste(here("data/output_data/alb_global_wide_dietpa.csv"),
                                   sep=""), check.names=FALSE) %>%
  dplyr::select(StudyID:ncol(.)) #-c(, `Diplospinus multistriatus`, `Sardina pilchardus`)

print(dim(alb_pa)) #75 316
```

Manipulate and subset data. Here we obtain 137 species as columns and 225 obs.

```{r Species PA (L) manipulate, tidy=TRUE, warning=FALSE, message=FALSE}
#Check for empty columns
which(colSums(alb_pa[,10:ncol(alb_pa)])==0) #None! #Otherwise remove these
#Check for empty rows
which(rowSums(alb_pa[,10:ncol(alb_pa)])==0) #None! #Otherwise remove these

#Subset species df
alb_pa_prey = alb_pa[,10:ncol(alb_pa)]
names(alb_pa_prey) <- str_replace_all(names(alb_pa_prey), " ", "_")

#Check df
dim(alb_pa_prey) #308 species & 75 observations
#str(alb_adult_prey) #data are integers & numeric

#Check it is all binomial
range(alb_pa_prey)

```

Note that we could simplify data at this point, but we will be truncating the data in relation to species for which we have complete trait information.

```{r Check for single occurrence data}
#Check for empty columns
str(which(colSums(alb_pa[,10:ncol(alb_pa)])==1)) #None! #Otherwise remove these
#There are 129 taxa that only occur once. There is statistical discussion 

#Check for empty rows
str(which(rowSums(alb_pa[,10:ncol(alb_pa)])==1)) #None! #Otherwise remove these
#There are ten rows that sum to a single species occurrence
```

## Traits Probable (Q)

- Using all the occurrence data in 'alb_adult_preyPA' df.

- Could filter out low occurrences using 'alb_adult_preyPA_clean' df, extra code to do this is provided in the 'Albacore_synthesis_c_extra.Rmd'.

- Note that we obtain 135 species and their traits, so we'll need to filter the species df by the traits.

```{r Trait DF (Q) inc clust num, tidy=TRUE, warning=FALSE, message=FALSE}

alb_prob_clust = read.csv(paste(here("./data/output_data/prob.prey.clusternum_aggl.k7.csv"), 
                                sep=""), header=T, row.names = 1) %>%
  dplyr::select(prey_class, prey_order, prey_sp:prob.clust.num, -prey_age_reported_1)

dim(alb_prob_clust) #we obtain 156 species,  9 traits or covariates

#Relabel to add underscore in names
alb_prob_clust$prey_sp = str_replace_all(alb_prob_clust$prey_sp, " ", "_")
#Assign species as row names
rownames(alb_prob_clust) <- alb_prob_clust$prey_sp
#Order species list
alb_prob_clust <- alb_prob_clust[ order(row.names(alb_prob_clust)), ]

#Ensure traits are treated as factors for now
#alb_prob_clust[,1:2] <- lapply(alb_prob_clust[,1:2], character) 
alb_prob_clust$prey_class = as.character(alb_prob_clust$prey_class)
alb_prob_clust$prey_order = as.character(alb_prob_clust$prey_order)
alb_prob_clust[,4:10] <- lapply(alb_prob_clust[,4:10], factor) #to convert to factors

test_phylo_df = data.frame(summary(alb_prob_traits$prey_order)) %>%
  dplyr::rename(prey_order_sum = summary.alb_prob_traits.prey_order.) %>%
  mutate(prey_order = row.names(test_phylo_df))

alb_prob_clust_phylo = alb_prob_clust %>%
  left_join(test_phylo_df) %>%
  dplyr::mutate(prey_order_test = if_else(prey_order_sum > 2, prey_order, prey_class))

#Assign species as row names
rownames(alb_prob_clust_phylo) <- alb_prob_clust_phylo$prey_sp
#Order species list
alb_prob_clust_phylo <- alb_prob_clust_phylo[ order(row.names(alb_prob_clust_phylo)), ]

alb_prob_clust_phylo$prey_order_test = as.factor(alb_prob_clust_phylo$prey_order_test)

#Need to filter by prey species we want to use.
alb_prob_traits = alb_prob_clust_phylo %>% #alb_prob_clust
  filter(prey_sp %in% names(alb_pa_prey)) %>%
  filter(life_stage != 'larva')
#Assign species as row names
rownames(alb_prob_traits) <- alb_prob_traits$prey_sp
#Order species list
alb_prob_traits <- alb_prob_traits[ order(row.names(alb_prob_traits)), ]
#we get 156 species and 7 trait values
  #Currently still have low occurence species in here
  #previously filtered from this df: alb_adult_preyPA - this includes single occurrences
  #filtered out low occurrences df here: alb_adult_preyPA_clean

dim(alb_prob_traits) #156 spp without filtering for low occurrence #123  17
str(alb_prob_traits)

##NOTE we added a phylogenetic information columns
```

**Trait value checks**

Here we check the trait values for each trait, and check the distribution of values. Note we merge certain values with low occurrences of species within them, and if we have a logical reason to merge.

```{r Trait values check, warning=FALSE, message=FALSE}
summary(alb_prob_traits$life_stage) #we will remove larva as a value from the df, larval taxa didn't make it through the data cleaning and manipulation.

summary(alb_prob_traits$vert_habitat) #merge bathypelagic and mesopelagic, these prey could not have been consumed in the bathypelagic anyways.

summary(alb_prob_traits$horz_habitat) #merge of continental shelf/slope, and coastal/reef assoc, we do not have enough data to properly differentiate and represent these habitat values, so we merge and take a coarser definition of 'continental shelf & slope' and 'coastal & reef-assoc'.

summary(alb_prob_traits$diel_migrant_cat) #a lot more diel migrants than not

summary(alb_prob_traits$season_cat) #more seasonal taxa than not

summary(alb_prob_traits$gregarious) #still more gregarious than not, just an artefact of the pelagic prey data.

summary(alb_prob_traits$prob.clust.num) #good distribution of species within clusters

summary(alb_prob_traits$prey_order_test) #good distribution of species within clusters

```

**Cleaning and preparing trait values for analyses**
Note that we address this earlier in the trait clustering workflow, we therefore do not need to address this now.

## UPDATE DIET DATA (L) & SELECT COVARS (R)

Here we filter our prey species (presence/absence data) by the species that were also used for cluster analysis, because we have complete trait information for these species, as well as frequency of occurrence data.

```{r FILTER PREY BY PROB TRAITS, tidy=TRUE, warning=FALSE, message=FALSE}

alb_prob_prey <- alb_pa_prey[colnames(alb_pa_prey) %in% rownames(alb_prob_traits)]

dim(alb_prob_prey) #75 obs 156 spp

#These are all lining up
#alternatively filter by stricter dataset
```

Now we need to check for and remove any zero-sum columns or rows of data, and adjust the co-variate data.

```{r Diet data manip, tidy=TRUE, warning=FALSE, message=FALSE}

#Need to check for empty columns and rows again
#Check for empty columns
which(colSums(alb_prob_prey)==0) #None! #Otherwise remove these
#Check for empty rows
which(rowSums(alb_prob_prey)==0) #Remove these - this becomes a thing once we start removing outlier species

#Need to remove these from the alb_prob_preyPA data and the covars data

alb_prob_prey = alb_prob_prey[-c(5),]
#74 observations for 156 prey species
dim(alb_prob_prey) #74 156
```

## Covars (R) - MANIPS

Cleaning and manipulating co-variates for analyses. Any study for which we weren't able to estimate albacore life stage or size, either based on location or fork length data, we will consider to be of 'mixed' cohort.

```{r Covars (R) - clean}

#Clean covars
alb_prob_covars = alb_pa %>%
  slice(., -c(5)) %>%
  dplyr::select(StudyID:pred_life_adjust)

#As factors
alb_prob_covars[,1:ncol(alb_prob_covars)] =  lapply(alb_prob_covars[,1:ncol(alb_prob_covars)], as.factor)

#unique(alb_prob_covars$pred_life_adjust)

dim(alb_prob_covars) #74 sites and 9 covars
```

Checking co-variates for analyses.

```{r Covars (R) - summary, eval=FALSE}

#Summary stats on covars
unique(alb_prob_covars$StudyID) #26 studies
unique(alb_prob_covars$OceanBasin) #6 Ocean basins --> "N Atlantic"    "Mediterranean" "N Pacific"     "S Atlantic"    "Indian"        "S Pacific"
unique(alb_prob_covars$OceanBasinQ) #10 Ocean basin quarters, but data gets thin for many
unique(alb_prob_covars$YearEnd) #~35 years (or groups of years) are represented in this study
unique(alb_prob_covars$code) #10 Longhurst provinces represented, similar to Ocean Basin Q but also gets thin
unique(alb_prob_covars$pred_life_adjust) #3 predator life stages

```

Checking the level replication for each covariate. Note that our best covars ==> pred_life, OceanBasin, lat_cat, and maybe code (Longhurst) - but would need to exclude low numbered levels.

```{r Covars (R) checking, eval=FALSE}
#Check representation
#summary(alb_adult_covars)

summary(alb_prob_covars$lat_cat)
#temperate  tropical 
#   68        6 

summary(alb_prob_covars$pred_life_adjust)
#   adult juvenile    mixed 
#     8       29      37 

summary(alb_prob_covars$OceanBasin)
#           Indian Mediterranean    N Atlantic     N Pacific    S Atlantic     S Pacific 
#            3            9            24            28            2            8 

alb_prob_covars$OceanBasinUse = factor(alb_prob_covars$OceanBasin, 
                                       levels = c("Indian", "Mediterranean", "N Atlantic", 
                                                  "N Pacific", "S Atlantic", "S Pacific"),
                                       labels = c("Indian & S Atlantic", "Mediterranean", "N Atlantic", 
                                                  "N Pacific", "Indian & S Atlantic", "S Pacific"))
summary(alb_prob_covars$OceanBasinUse)

```

## DF checks

```{r Check names and df dimensions, eval=FALSE}

## Make sure species names match abund matrix
#rownames(alb_prob_traits) == colnames(alb_prob_preyPA) #awesome!
# And the mvabund matrix
alb_prob_prey_mv = as.mvabund(alb_prob_prey)

dim(alb_prob_prey_mv) #75 sites, 156 species

#rownames(alb_prob_traits) == colnames(alb_prob_preyPA_mv) #awesome!

#Check all matrix dimensions
dim(alb_prob_traits) #156 species and 8 traits
dim(alb_prob_prey_mv) #74 obs, 156 species
dim(alb_prob_covars) #74 sites, 10 variables

```


## SAVE DFS FOR ANALYSES

```{r Saving dfs for analysis}

#L - species df
write.csv(alb_prob_prey, here("./data/output_data/alb_prob_preyPA_use.csv"), row.names = FALSE)

#R - covars df
write.csv(alb_prob_covars, here("./data/output_data/alb_prob_covars_use.csv"), row.names = FALSE)

#Q - trait df
write.csv(alb_prob_traits, here("./data/output_data/alb_prob_traits_use.csv"), row.names = FALSE)

```

