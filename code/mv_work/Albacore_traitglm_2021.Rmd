---
title: "Albacore traitglms"
author: "Natasha Hardy with some simplifications from David"
date: "7/29/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Workspace Setup

```{r Workspace}

# general
library(tidyverse)
library(here)
"%notin%" = Negate('%in%')
here::here()

library(mvabund)

```

## Dataframes & Prep for mv work

### Frequency of Occurrence Data (L)

```{r Species %FO 4 (L)}

alb_adult_prey4 = read.csv(paste(here("data/alb_adult_prey4.csv"),
                                   sep=""), check.names=FALSE, row.names = 1)[,1:20]
# changed to first 10 columns to get it running faster for diagnostic purposes

alb_adult_prey4_mv <- as.mvabund(alb_adult_prey4) #make mvabund object #sometimes some fiddling required [,1:ncol(alb_adult_prey)], check.names = FALSE

#All species names have to match up for both dfs
colnames(alb_adult_prey4_mv) == names(alb_adult_prey4) #hell yes


```

### Covars (R)

```{r Covars manip #4 (R)}

alb_adult_covars4 = read.csv(here("data/alb_adult_covars4.csv")) %>%
  dplyr::select(-X)

#Can check summary stats on covars

#We merged the "none" with "mixed" group for now.
#Do it for the treatment scores
#REMEMBER to Clean life stage covar
#treatment.scores4 = treatment.scores4 %>%
#  mutate(pred_life=case_when(pred_life == "juvenile" ~ "juvenile",
#                             pred_life == "juvenile, adult" ~ "mixed",
#                             pred_life == "adult" ~ "adult",
#                             pred_life == "none" ~ "mixed")) #"none" ~ "none"
#treatment.scores4$pred_life =  as.factor(treatment.scores4$pred_life)

#Best covars for traitglm ==> pred_life, OceanBasin, OceanBasinQ code (Longhurst) - but need to exclude low numbered levels.
```

### Traits (Q)

```{r Trait DF manip #4 (Q)}

#Trait DF

alb_adult_traits4 = read.csv(here("data/alb_adult_traits4.csv"),stringsAsFactors = TRUE) %>%
  select(-X) 
  #filter(prey_sp %in% names(alb_adult_prey4)) #need trait values for 107 spp.

rownames(alb_adult_traits4) <- alb_adult_traits4$prey_sp

alb_adult_traits4 <- alb_adult_traits4[ order(row.names(alb_adult_traits4)), ]

#Ensure traits are treated as factors for now
str(alb_adult_traits4)

## Make sure species names match abund matrix
rownames(alb_adult_traits4) == colnames(alb_adult_prey4) #awesome!
# And the mvabund matrix
rownames(alb_adult_traits4) == colnames(alb_adult_prey4_mv) #awesome!

```


### DF checks

```{r Subsets + check covars & df dims for data #4}
#Check df dims
dim(alb_adult_prey4_mv) #169 observations for 10 species
dim(alb_adult_traits4[,2:7]) #107 species and 6 traits
dim(alb_adult_covars4) #169 observations and 13 co-variates
#ALL DF'S LINE UP

#Check df str
str(alb_adult_traits4) #all factors?
#str(alb_adult_prey_mv) #107 species, 169 obs
str(alb_adult_covars4) #all factors

#All traits to try
traits_try4 = alb_adult_traits4[1:20,4:5]
str(traits_try4) #107 species and subset of 2 traits

#Select some covars & traits
ocean4 = alb_adult_covars4$OceanBasin
longhurst4 = alb_adult_covars4$code
pred_life4 = alb_adult_covars4$pred_life
lat4 = alb_adult_covars4$lat_cat

levels(alb_adult_covars4$OceanBasin)
#[1] "Indian"        "Mediterranean" "N Atlantic"    "N Pacific"     "S Atlantic"    "S Pacific"
levels(alb_adult_covars4$pred_life)
#[1] "adult"    "juvenile" "mixed"
alb_adult_covars4$pred_life <- factor(alb_adult_covars4$pred_life, levels = c("mixed", "juvenile", "adult"))
#[1] "mixed"    "juvenile" "adult"

#str(alb_adult_covars4)
```



## Trait GLM

### Data#4

(i) First check manyglm routine
(It works! Now we can play with traitglm)
```{r ManyGLM #4}

#Fit ManyGLM to ensure the matrix works
## Run trial manyglm() to check for problems
adult_prey_m4 <- manyglm(alb_adult_prey4_mv ~ ocean4, family="negative.binomial")
plot(adult_prey_m4) #check model residuals

#adult_prey_m4_anova <- anova.manyglm(adult_prey_m4)
# Get anova result
#adult_prey_m4_anova
#Multivariate test:
#            Res.Df Df.diff  Dev Pr(>Dev)    
#(Intercept)    252                          
#ocean          247       5 1248    0.001 ***

#summary(adult_prey_m4)
#Test statistics:
#                   wald value Pr(>wald)    
#(Intercept)            11.501  0.000999 ***
#oceanMediterranean      1.686  0.213786    
#oceanN Atlantic         4.292  0.001998 ** 
#oceanN Pacific          3.551  0.002997 ** 
#oceanS Atlantic         3.400  0.034965 *  
#oceanS Pacific          1.077  0.646354   

```

(ii) Second fit a traitglm to just species + covars excluding the traits
(This also worked)
```{r TraitGLM - predator age test1}
#Double check dfs
dim(alb_adult_prey4_mv) #169 observations for 107 species
dim(alb_adult_traits4[,2:7]) #107 species and 6 traits
#dim(pred_life4)
dim(alb_adult_covars4) #169 observations and 13 co-variates

# load correction to traitglm:

source("traitglm.R")
source("get_polys.R")

trait_life4 <- traitglm(L = alb_adult_prey4_mv,
                      R =  alb_adult_covars4$pred_life, #pred_life4,
                      method="manyglm"
                      )

#Check model output - residuals TEST
qqnorm(residuals(trait_life4)[which(residuals(trait_life4)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(trait_life4)[is.finite((residuals(trait_life4)))]
plot(resids.full)
abline(c(0,0),col="red")

```

(iii) Try adding traits

```{r TraitGLM - predator age test2}

trait_life4 <- traitglm(L = alb_adult_prey4_mv,
                      R =  data.frame(pred_life=alb_adult_covars4$pred_life),                       Q = traits_try4, method="glm1path") #note default is "manyglm"

#Check model output - residuals TEST
qqnorm(residuals(trait_life4)[which(residuals(trait_life4)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(trait_life4)[is.finite((residuals(trait_life4)))]
plot(resids.full)
abline(c(0,0),col="red")

```

(iv) Adding method="glm1path"
This is where it breaks...
```{r TraitGLM - predator age test3}

alb_adult_prey4_mvRound=round(alb_adult_prey4_mv)

trait_life4 <- traitglm(L = alb_adult_prey4_mvRound,
                      R =  alb_adult_covars4$pred_life, #pred_life4,
                      Q = traits_try4,method="glm1path"
                      )

#Check model output - residuals TEST
qqnorm(residuals(trait_life4)[which(residuals(trait_life4)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(trait_life4)[is.finite((residuals(trait_life4)))]
plot(resids.full)
abline(c(0,0),col="red")

```

```{r Plot 4th corner}

a        = max( abs(trait_life4$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(trait_life4$fourth.corner))

#rownames(temp) = c("Region: Ocean Basin")
#colnames(temp) = c("Trophic group: Benthic Invertivore",
#                   "Trophic group: Browsing Herbivore",
#                   "Trophic group: Mesopredator",
#                   "Trophic group: Planktivore",
#                   "Solitary",
#                   "Schooling",
#                   "Pairs/groups",
#                   "Known prey",
#                   "Potential prey",
#                   "Bathypelagic")
plot.4th = levelplot(temp, 
                     xlab=list("Environmental Variables", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(plot.4th)

#ggsave(here("output_figures/diet_mvtraits/fourth_lifestage.png"), plot.4th, width=8, height=8, dpi=300)

```


## TUTORIAL
Mvabund tutorial for traitglm to check on any df formatting requirements
Just checking this again.
--> NOTE: The glm1path method works in the code below but not with the data above.

```{r mvabund traitglm tute}

data(antTraits)
#Abund matrix --> integers
str(antTraits$abund) #30 obs and 41 species
#Env matrix --> all numeric info 
str(antTraits$env) #30 observations and 5 variables 
#Traits matrix --> mixed character, factor, numeric and integers!!
str(antTraits$traits) #41 species and 5 traits

ft = traitglm(antTraits$abund,
            antTraits$env,
            antTraits$traits,
            method="manyglm")
ft$fourth #print fourth corner terms

# for a pretty picture of fourth corner coefficients, uncomment the following lines:
# library(lattice)
a        = max( abs(ft$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
plot.4th = levelplot(t(as.matrix(ft$fourth.corner)), xlab="Environmental Variables",
  ylab="Species traits", col.regions=colort(100), at=seq(-a, a, length=100),
  scales = list( x= list(rot = 45)))
print(plot.4th)

plot(ft) # for a Dunn-smyth residual plot
qqnorm(residuals(ft)); abline(c(0,1),col="red") # for a normal quantile plot.

# predict to the first five sites
predict(ft,newR=antTraits$env[1:5,])

# refit using LASSO and less variables, including row effects and only two interaction terms:
ft1=traitglm(antTraits$abund,antTraits$env[,3:4],antTraits$traits[,c(1,3)],
      formula=~Shrub.cover:Femur.length+Shrub.cover:Pilosity,composition=TRUE,method="glm1path")
ft1$fourth #notice LASSO penalty has one interaction to zero


```

