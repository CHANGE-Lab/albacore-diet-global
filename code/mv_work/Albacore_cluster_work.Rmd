---
title: "Albacore_mvwork"
author: "Natasha Hardy"
date: "April 27, 2020"
output: html_document
---

This document is for cluster analyses and multivariate analyses of the global albacore diet contents and review.

```{r Setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/Helder/Documents/GitHub/Tuna_postdoc")

```

```{r Worspace}

#Workspace setup
getwd()

#The code used Friday 8th Nov mainly involved the vegan and klaR packages. So you should only need
#to load those out of the list below.

#install what needs to be installed
#install.packages("fpc")
#install.packages("labdsv")
#install.packages("MVPARTwrap") #notice that this didn't work
library(devtools)
install_github('kassambara/factoextra')
install.packages("ggdendro")
install.packages("circlize")

#some packages are on GitHub and not on the CRAN project yet
#install.packages("devtools") 
#library(devtools)
#install_github("cran/mvpart")
#install_github("cran/MVPARTwrap")

devtools::install_github("jakelawlor/PNWColors") 

#load all packages required
library(plyr)
library(tidyverse)
library(klaR)
library(dplyr)
library(fpc)
library(ggplot2)
library(ggrepel)
library(reshape2)
library(purrr)
library(viridis)
library(vegan)
library(here)
"%notin%" = Negate('%in%')
here::here()

library(cluster)
library("dendextend")
library("PNWColors")
library(factoextra)
library(ggdendro)
library(circlize)

#Not required, parking lot here
#library(ade4)
#library(gclus)
#library(RColorBrewer)
#library(labdsv)
#library(mvpart)
#library(MVPARTwrap)

```

## Cluster Analyses

Useful resource for this and where a lot of the code came from:

### Hierarchical clustering tutorial by Anastasia Reusova ----
Tutorial notes & code found here: 
https://towardsdatascience.com/hierarchical-clustering-on-categorical-data-in-r-a27e578f2995

## ADULT prey traits

### Prey & traits for cluster ----

Uploading the species consumed and their traits based on adult life stage.
Use this to manipulate which variables to use for cluster analysis.

```{r Load & manip data for cluster analyses}

#Need to run this bit by bit, does not run as a whole chunk.
prey_adult_load = read.csv(here("data/prey_adults_traits.csv"), header=TRUE) %>% #row.names = 1, #spe_traitord #./data/
  dplyr::select(-c(X, diel_migrant, season_migrant, refuge, l_max, trophic_level:standard_total, energy_density:percent_lipid)) %>% #, gregarious_primary, refuge_cat, body_shape,phys_defense)
  dplyr::rename(`vertical habitat` = `vert_habitat`, 
                `horizontal habitat` = `horz_habitat`,
                `diel migrant` = `diel_migrant_cat`, 
                `refuge use` = `refuge_cat`,
                `seasonal migrant` = `season_cat`, 
                `body shape` = `body_shape`,
                `physical defense` = `phys_defense`,
                `gregarious` = `gregarious_primary` #,
                #`energy density` = energy_density,
                #`percent protein` = `percent_protein`,
                #`percent lipid` = `percent_lipid`
                ) 

prey_adult_manip = prey_adult_load %>% #Relabel variables
  mutate(`physical defense`=if_else(`physical defense`>0, "defended", "undefended"), 
         `diel migrant`=case_when(`diel migrant` == "diel_no" ~ "diel (no)",
                                  `diel migrant` == "diel_UN" ~ "diel (unknown)",
                                  `diel migrant` == "diel_yes" ~ "diel (yes)"),
         `refuge use`=case_when(`refuge use` == "refuge_no" ~ "refuge (no)",
                                `refuge use` == "refuge_NA" ~ "refuge (unknown)",
                                `refuge use` == "refuge_yes" ~ "refuge (yes)"),
         `gregarious`=case_when(`gregarious` == "solitary" ~ "solitary",
                                `gregarious` == "pairing" ~ "solitary",
                                `gregarious` == "shoaling" ~ "schooling",
                                `gregarious` == "schooling" ~ "schooling"),
         `seasonal migrant`=case_when(`seasonal migrant` == "season_no" ~ "season (no)",
                                      `seasonal migrant` == "season_NA" ~ "season (unknown)",
                                      `seasonal migrant` == "season_yes" ~ "season (yes)")
         )

summary(prey_adult_load)
unique(prey_adult_manip$`diel migrant`)

prey_adult = prey_adult_manip %>%
  filter(`diel migrant` != "diel (unknown)", 
         `refuge use` != "refuge (unknown)", 
         `seasonal migrant` != "season (unknown)"
         ) %>%
  drop_na() 

#reduced from ~308 taxa to ~267 and filtering further reduced to ~174 species

str(prey_adult)

```

Need to make sure that the original row numbers are preserved and added as a column in order to pair species names with their original row number in dendrograms. If not this causes problems later.

```{r Data manip for cluster analyses & dendrogram}

## Row name as column datasets
#For adult traits
prey_adult_row <- prey_adult
dendlabs <- rownames(prey_adult_row)
prey_adult <- cbind(dendlabs, prey_adult_row)

#Adult trait df subsets
adult_species = prey_adult$prey_sp
prey_adult[,6:12] = lapply(prey_adult[,6:12], as.factor) #excluded refuge use [,6:13]
adult_traits = as.data.frame(prey_adult[,c(6:10, 12)])

str(adult_traits) 
#6 habitat use traits and 179 species when we leave out refuge use and gregariousness

```

### Compare cluster techniques ----

Performing both divisive and agglomerative clustering in order to find the most parsimonious species clustering based on their habitat use traits, primarily.

To do
(i) ADD NOTE ON AVE VS. COMPLETE LINKAGE
(ii) We should also consider producing an nMDS that displays the species and colours according to cluster#

```{r Ordination & Cluster analyses}

#### Distance matrices ----

#select just the traits you want to contribute to ordination
adult.gower.dist <- daisy(adult_traits, metric = "gower")

#### Divisive cluster ----
adult.divisive.clust <- diana(as.matrix(adult.gower.dist), 
                            diss = TRUE, keep.diss = TRUE)
plot(adult.divisive.clust, main = "Divisive")


#### Agglomerative cluster ----
#Use "average" or "complete" linkage

adult.aggl.clustc <- hclust(adult.gower.dist, method = "complete")
plot(adult.aggl.clustc, main = "Agglomerative, complete linkages")

adult.aggl.clusta <- hclust(adult.gower.dist, method = "average")
plot(adult.aggl.clusta, main = "Agglomerative, average linkages")

#### nMDS for dissimilarity
trait_NMDS <- metaMDS(adult.gower.dist, trymax = 100)
trait_NMDS[["stress"]] #stress = 0.09647227

#Plot --> 
plot(trait_NMDS) #plots species as black dots, traits as red crosses 
#Note that the ordination looks good!
#Need to revisit this and plot in relation to clusters!

```


## Cluster technique & variables selection

Some notes on clustering techniques selection:
(i) Select for balanced cluster sizes wherever possible, cluster sizes that are too small are problematic.
(ii) Maximisive average between distance and minimise average within (see cluster stat tables)
(iii) Elbow method: start with it when the compactness of clusters, or similarities within groups are most important for your analysis.
(iv) Silhouette method: as a measure of data consistency, the silhouette plot displays a measure of how close each point in one cluster is to points in the neighboring clusters.

Previous notes
--> Note that body shape was really messing things aroung, we got very poor balance of taxa in clusters when that was included. Also refuge use is excluded because it is redundant.
--> 22/07/2020 On balance, assessing the statistical table, 7 clusters using habitat association + gregarious traits. The elbow and silhouette techniques recommend closer to 10 clusters.
--> 23/07/2020 On balance, assessing the statistical table, 7 clusters using habitat association + gregarious traits. The elbow and silhouette techniques recommend closer to 10 clusters.
--> Thinking of adding refuge use back in. It appears that the binary traits seem to most strongly affect the clustering, most of the time. Except occasionally big groups like the epi's and mesopelagic's.
--> Adding body shape back into it on 25/07/20

```{r Cluster stat table function}

# Cluster stats comes out as list while it is more convenient to look at it as a table
# This code below will produce a dataframe with observations in columns and variables in row
# Not quite tidy data, which will require a tweak for plotting, but I prefer this view as an output here as I find it more comprehensive 
library(fpc)
cstats.table <- function(dist, tree, k) {
  clust.assess <- c("cluster.number","n","within.cluster.ss","average.within","average.between",
                    "wb.ratio","dunn2","avg.silwidth")
  clust.size <- c("cluster.size")
  stats.names <- c()
  row.clust <- c()
  output.stats <- matrix(ncol = k, nrow = length(clust.assess))
  cluster.sizes <- matrix(ncol = k, nrow = k)
  for(i in c(1:k)){
    row.clust[i] <- paste("Cluster-", i, " size")
  }
  for(i in c(2:k)){
    stats.names[i] <- paste("Test", i-1)
    
    for(j in seq_along(clust.assess)){
      output.stats[j, i] <- unlist(cluster.stats(d = dist, clustering = cutree(tree, k = i))[clust.assess])[j]
      
    }
    
    for(d in 1:k) {
      cluster.sizes[d, i] <- unlist(cluster.stats(d = dist, clustering = cutree(tree, k = i))[clust.size])[d]
      dim(cluster.sizes[d, i]) <- c(length(cluster.sizes[i]), 1)
      cluster.sizes[d, i]
      
    }
  }
  output.stats.df <- data.frame(output.stats)
  cluster.sizes <- data.frame(cluster.sizes)
  cluster.sizes[is.na(cluster.sizes)] <- 0
  rows.all <- c(clust.assess, row.clust)
  # rownames(output.stats.df) <- clust.assess
  output <- rbind(output.stats.df, cluster.sizes)[ ,-1]
  colnames(output) <- stats.names[2:k]
  rownames(output) <- rows.all
  is.num <- sapply(output, is.numeric)
  output[is.num] <- lapply(output[is.num], round, 2)
  output
}

```

### Cluster Assessment Output Table

20-24/07/2020
Ultimately we are aiming for distinct clusters of species, such that the difference within clusters is minimal and between is maximised. Assessing cluster statistical tables, we are consistently observing lower average.within cluster differences using divisive compared to agglomerative clustering algorithms. Additionally, cluster sizes and balance are consistently more even using divisive vs. agglomerative.

24/07/2020 - 22/08/2020
Using habitat only traits (excl. refuge use), hierarchical divisive clustering performed best over agglomerative clustering (either complete or average linkage) algorithms. These are my cluster size selection by method and I will perform the following dendrograms to check how species parsed to groups:
(i) Divisive - cluster #8 (highest avg.silwidth value, balance of cluster size and composition).
(ii) Agglomerative (complete) - cluster #7 (mostly due to balance of cluster size and composition, after this smaller clusters start getting split up whilst the larger clusters remain grouped, highest avg.silwidth value)
(iii) Agglomerative (average) - cluster #7 (same as for complete, but even a little more balanced)

Using habitat only traits (incl. refuge use), hierarchical agglomerative clustering (with complete linkage) performed best over agglomerative clustering (average linkage) or divisive algorithms. These are my cluster size selection by method and I will perform the following dendrograms to check how species parsed to groups:
(i) Divisive - cluster #7 (highest avg.silwidth value, balance of cluster size and composition).
(ii) Agglomerative (complete) - cluster #7 or 8 (mostly due to balance of cluster size and composition, after this smaller clusters start getting split up whilst the larger clusters remain grouped, highest avg.silwidth value was for #9 clusters)
(iii) Agglomerative (average) - cluster #7-9 (same as for complete)

Using habitat use + gregarious, things start to look messy again. Would select divisive only --> 8 clusters.

Using habitat use + binary for gregarious, selecting agglomerative (complete) --> 9-10 clusters (9 would be better on silwidth value).
UPDATE - Using these traits and some corrected errors. I would suggest the same.

After fixing an issue with refuge use traits (errors in DB), using just habitat + refuge use + gregarious (binary) traits --> 
(i) Divisive #8 optimal (most balanced + optimal avg.silwidth) BUT not very balanced compared to Agglomerative algorithm
(ii) Agglomerative (complete) #9 optimal (most balanced + optimal avg.silwidth) --> SELECT AGGL COMPLETE ~9 clusters
(iii) Agglomerative (average) -- not good, not balanced.

Adding body shape back in + habitat use + gregarious:
(i) Divisive #8 (most balanced + optimal avg.silwidth)
(ii) Agglomerative not very balanced - Do not select.

Using all traits
(i) Divisive #9
(ii) Agglomerative - DO NOT USE

I will ultimately select the classification that made the most sense.

```{r Cluster Assessment Tables}

#Stats table for divisive method
adult.stats.df.divisive <- cstats.table(adult.gower.dist, adult.divisive.clust, 20)
adult.stats.df.divisive
write.csv(adult.stats.df.divisive, "adult.stats.df.divisive.csv") #save stats table

#Stats table for agglomerative method
adult.stats.df.aggl <-cstats.table(adult.gower.dist, adult.aggl.clustc, 20) 
#complete linkages looks like the most balanced approach
adult.stats.df.aggl
write.csv(adult.stats.df.aggl, "adult.stats.df.aggl.csv") #save stats table

#Stats table for agglomerative method with average linkage
adult.stats.df.aggl.ave <-cstats.table(adult.gower.dist, adult.aggl.clusta, 20) 
#complete linkages looks like the most balanced approach
adult.stats.df.aggl.ave
write.csv(adult.stats.df.aggl.ave, "adult.stats.df.aggl.ave.csv") #save stats table

```

How to select:
Using "Elbow" and "Silhouette" methods to identify the best number of clusters, this displays the following information:
(i) Elbow: I want to choose a reasonable number, based on which I will be able to see basic differences between groups, this means selecting the inflection point at which the within clusters sum of squares do not decrease sharply as you increase the cluster number.
(ii) Silhouette: the rule is you should choose the number that maximizes the silhouette coefficient because you want clusters that are distinctive (far) enough to be considered separate.
However, note that we won't select beyond 15 clusters, even if the values for up to 20 are plotted.

### Divisive - cluster number assessment

Previous notes on divisive clustering number selection:
Elbow method:
20/07/2020 6 clusters was potentially enough, but even went up to ~15
22/07/2020 6-10 clusters
22/07/2020 excluding gregarioussness & refuge use - inflection points = 7 & 10 clusters
22/07/2020 using gregarioussness - inflection point at 11 clusters
23/07/2020 using just habitat use traits, inflection point at 7-8 clusters (this was most balanced also)
24/07/2020 using just habitat use traits, inflection point at 6, 8 and 10 clusters --> 8 was most balanced also
24/07/2020 using just habitat +refuge use traits, inflection point at 7-8 clusters --> 7 was most balanced also
24/07/2020 using just habitat + refuge use + gregarious traits, inflection point at 8 clusters --> 8 was most balanced also
25/07/2020 added body shape back in, inflection point at 8 clusters + was most balanced
25/07/2020 using all traits --> 8

Silhouette
20/07/2020 Looks like ~12 clusters are optimal
22/07/2020 6 clusters
22/07/2020 excluding gregarioussness & refuge use - 6 & 10 maximised silhouette coeff
22/07/2020 using gregarioussness - optimal at 11 clusters
23/07/2020 using just habitat use traits, optimum at 8-9
24/07/2020 using just habitat use traits, optimum at 8 and 10 --> note 8 was most balanced also
24/07/2020 using just habitat +refuge use traits, optimal at 4-8 clusters --> 7 was most balanced also
24/07/2020 using just habitat + refuge use + gregarious traits, inflection point at 8 clusters --> 8 was most balanced also
25/07/2020 added body shape back in, optimal at 8 clusters + was most balanced
25/07/2020 using all traits --> 8

--> Selecting 8 clusters for hierarchical divisive clustering

```{r Cluster Selection - Divisive}

### Elbow method
#Divisive clustering
ggplot(data = data.frame(t(cstats.table(adult.gower.dist, adult.divisive.clust, 15))), 
       aes(x=cluster.number, y=within.cluster.ss)) + 
  geom_point()+
  geom_line()+
  ggtitle("Divisive clustering") +
  labs(x = "Num.of clusters", y = "Within clusters sum of squares (SS)") +
  theme(plot.title = element_text(hjust = 0.5))

### Silhouette
#Divisive
ggplot(data = data.frame(t(cstats.table(adult.gower.dist, adult.divisive.clust, 15))), 
       aes(x=cluster.number, y=avg.silwidth)) + 
  geom_point()+
  geom_line()+
  ggtitle("Divisive clustering") +
  labs(x = "Num.of clusters", y = "Average silhouette width") +
  theme(plot.title = element_text(hjust = 0.5))

```

### Agglomerative (complete) - cluster number assessment

Elbow:
20/07/2020 Less clear, but 3 and 8 were separate inflection points
22/07/2020 Inflection points = 7, 13 and 15
22/07/2020 excluding gregarioussness & refuge use - 7 & 13 were main points
22/07/2020 using gregarioussness - inflection point at 9 clusters
22/07/2020 excl. body shape - inflections @ 7 & 10
23/07/2020 using just habitat use traits - inflection at 8 clusters
24/07/2020 using just habitat use traits - inflection at 7 clusters
24/07/2020 using just habitat +refuge use traits, inflection point at 7-9 clusters --> 7-9 was most balanced also
24/07/2020 using just habitat + refuge use + gregarious (binary) traits, inflection point at 9 clusters --> 9 was most balanced also
After fixing an issue with refuge use traits
24/07/2020 using just habitat + refuge use + gregarious traits, inflection point at 6 & 9 clusters --> 9 was most balanced also

Silhouette
20/07/2020 13 would be my selection. Between 10-15 clusters optimal
22/07/2020 Optimal silhouette coeff = 7 (+ 8 + 9) and 15
22/07/2020 excluding gregarioussness & refuge use - 7 & 15 clusters ideal
22/07/2020 using gregarioussness - seeing 8-12 clusters are ideal
22/07/2020 excl. body shape - optimal @ 10
23/07/2020 using just habitat use traits, optimum at 8-9
20/07/2020 selected 10 because it was the median number for agglomerative clustering method between the elbow and the silhouette assessments
24/07/2020 using just habitat use traits - inflection at 7 clusters
24/07/2020 using just habitat +refuge use traits, inflection point at 7-9 clusters, optimal at 9
24/07/2020 using just habitat + refuge use + gregarious (binary) traits, inflection point at 9 clusters --> 9 was most balanced also
After fixing an issue with refuge use traits
24/07/2020 using just habitat + refuge use + gregarious traits, optimal point at 9-10 clusters --> 9 was most balanced also

```{r Cluster Selection - Agglomerative - complete}

### Elbow
#Agglomerative clustering
ggplot(data = data.frame(t(cstats.table(adult.gower.dist, adult.aggl.clustc, 20))), 
       aes(x=cluster.number, y=within.cluster.ss)) + 
  geom_point()+
  geom_line()+
  ggtitle("Agglomerative clustering (complete linkage)") +
  labs(x = "Num.of clusters", y = "Within clusters sum of squares (SS)") +
  theme(plot.title = element_text(hjust = 0.5))

## Silhouette
# Agglomerative
ggplot(data = data.frame(t(cstats.table(adult.gower.dist, adult.aggl.clustc, 20))), 
       aes(x=cluster.number, y=avg.silwidth)) + 
  geom_point()+
  geom_line()+
  ggtitle("Agglomerative clustering (complete linkage)") +
  labs(x = "Num.of clusters", y = "Average silhouette width") +
  theme(plot.title = element_text(hjust = 0.5))

```

### Agglomerative (average) - cluster number assessment

Elbow:
23/07/2020 using just habitat use traits, inflection points at 7 and 10
24/07/2020 using just habitat use traits, inflection points at 6 and 10
24/07/2020 using just habitat +refuge use traits, inflection point at 6 & 9 clusters

Silhouette
23/07/2020 using just habitat use traits, optimum at 10 clusters
24/07/2020 using just habitat use traits, optimal at 6-7
24/07/2020 using just habitat +refuge use traits, optimal at 6-10 clusters

```{r Cluster Selection - Agglomerative - average}

### Using "Elbow" and "Silhouette" methods to identify the best number of clusters

#Agglomerative clustering
ggplot(data = data.frame(t(cstats.table(adult.gower.dist, adult.aggl.clusta, 20))), 
       aes(x=cluster.number, y=within.cluster.ss)) + 
  geom_point()+
  geom_line()+
  ggtitle("Agglomerative clustering (average linkage)") +
  labs(x = "Num.of clusters", y = "Within clusters sum of squares (SS)") +
  theme(plot.title = element_text(hjust = 0.5))

## Silhouette
# Agglomerative
ggplot(data = data.frame(t(cstats.table(adult.gower.dist, adult.aggl.clusta, 20))), 
       aes(x=cluster.number, y=avg.silwidth)) + 
  geom_point()+
  geom_line()+
  ggtitle("Agglomerative clustering (average linkage)") +
  labs(x = "Num.of clusters", y = "Average silhouette width") +
  theme(plot.title = element_text(hjust = 0.5))

```


## ADULT Agglomerative (complete) k = 9

### Cluster Dendrograms ---

```{r Horizontal dendrogram}

#Using agglomerative hierarchical clustering, k = 7
PNW.pal9 <- pnw_palette(9, name = "Bay", type = "continuous")
str(PNW.pal9)

adult.dendro <- as.dendrogram(adult.aggl.clustc) #188 species

###Horizontal dendrogram - Adult traits

#Horizontal cluster illustration version
adult.dendro.col <- adult.dendro %>%
  #set("branches_k_color", k = 10, value = PNW.pal) %>%
  set("branches_k_color", k = 9, value = PNW.pal9) %>%
  set("branches_lwd", 0.8) %>%
  set("labels", adult_species) %>% #NOT VERY LEGIBLE...
  set("labels_colors", 
      value = c("darkslategray")) %>% 
  set("labels_cex", 0.5)
adult.ggd1 <- as.ggdend(adult.dendro.col)
adult.dendro.graph <- ggplot(adult.ggd1, theme = theme_minimal()) +
  labs(x = "Num. observations", y = "Height", title = "Dendrogram, k = 9")
adult.dendro.graph
ggsave(here('output_figures/diet_clusters/adult.dendro.horz.habgreg.aggl.k9.png'), plot=adult.dendro.graph, width=8, height=8, dpi=300)

```

```{r Radial dendrogram}

###Radial plot - Adult traits

# Radial plot looks less cluttered (and cooler)
adult.dendro.rad <- ggplot(adult.ggd1, labels = FALSE) + 
  scale_y_reverse(expand = c(0.2, 0)) +
  coord_polar(theta="x")
adult.dendro.rad 
#No labels on this one, labels were too cluttered/problems
#Save radial dendrogram for chat
ggsave(here('output_figures/diet_clusters/aadult.dendro.rad.habgreg.aggl.k9.png'), plot=adult.dendro.rad, width=8, height=8, dpi=300)

```

```{r Vertical dendrogram}

###Vertical dendrogram version

#similar to https://stackoverflow.com/questions/38034663/rotate-labels-for-ggplot-dendrogram 

# This is a different way to compute hierarchical clustering and cut the tree
#clus <- hcut(mydist, k = 6, hc_func = 'hclust', hc_method = 'ward.D2', graph = FALSE, isdiss = TRUE)

## For a horizontal version below
#dend <- as.dendrogram(alb.aggl.clustc)
#Use alb.dendro

#Below is problematic0
#labels(dend) <- paste0(paste0(rep('', 3), collapse = ''), speciesO)
#dend <- sort(dend, decreasing = FALSE)
#View(labels(dend))

#Creating df for the dend labels so that we can accurately line them up with the species
dendlabs <- labels(adult.dendro) #Need to create strings of labels to manipulate
dendlabs2 <- as.data.frame(dendlabs) #turn in df

#Join these data so we can relabel the dendrogram
#Use plyr function because it conserves the row order of the left df, which matters for assigning labels here
library(plyr)
dfdend <- join(dendlabs2, prey_adult)

ggd1 <- ggplot(adult.dendro %>%
                 set("branches_k_color", k = 9, value = PNW.pal9) %>%
                 set("branches_lwd", 0.8) %>%
                 set("labels", dfdend$prey_sp) %>% #NOT VERY LEGIBLE...
                 set("labels_colors", 
                     value = c("darkslategray")) %>% 
                 set("labels_cex", 0.5), 
               theme = theme_minimal(),
               horiz = TRUE)

ggd1 <- ggd1 + theme(panel.grid.major = element_blank(),
                     axis.text = element_blank(),
                     axis.title = element_blank())
ggd1 <- ggd1 + ylim(max(get_branches_heights(adult.dendro)), -1)
ggd1

ggsave(here('output_figures/diet_clusters/adult.vertlabs.habgreg.aggl.k9.pdf'), plot=ggd1, width=5, height=20, dpi=300)

#With labels removed!!!

adult.dendro.vert <- ggplot(adult.ggd1, horiz = TRUE, labels = FALSE) + 
  scale_y_reverse(expand = c(0.2, 0)) #+
#coord_polar(theta="x")
adult.dendro.vert 

#Export as .png

ggsave(here('output_figures/diet_clusters/adult.dendro.vert.habgreg.aggl.k9.pdf'), plot=adult.dendro.vert, width=5, height=20, dpi=300)

```

### Albacore Cluster Heatmap ----

```{r Extract cluster number to trait matrix}

#Extract cluster number to trait matrix
adult.clust.num <- cutree(adult.aggl.clustc, k = 9)

#we want to bind the original dataset with the cluster numbers such that each species is assigned a cluster
#can use whole data or just traits use to just look at unique species clusters in relation to traits
#alb.cl <- cbind(ctraitsO, alb.clust.num)
#OR
adult.prey.cl <- cbind(prey_adult, adult.clust.num)
str(adult.prey.cl)

write.csv(adult.prey.cl, here("output_figures/diet_clusters/adult.prey.clusternum.habgreg.aggl.k9.csv"))

```

```{r Cluster heatmap}
# Time for the heatmap
# the 1st step here is to have 1 variable per row
# factors have to be converted to characters in order not to be dropped

#Note plyr can mess with this!!
detach("package:plyr", unload=TRUE)

#Create dfs for graphs
adult.clust.long = adult.prey.cl %>%
  dplyr::select(prey_sp, `vertical habitat`:`seasonal migrant`, `physical defense`, `gregarious`, `adult.clust.num`) %>%
  reshape2::melt(id.vars = c("prey_sp", "adult.clust.num"), variable.name = "trait", value.name = "level") %>%
  group_by(adult.clust.num, trait, level) %>%
  mutate(count = n_distinct(prey_sp)) %>%
  distinct(adult.clust.num, trait, level, count) %>% #, percent
  group_by(adult.clust.num, trait) %>%
  mutate(percent = count / sum(count)*100) %>%
  arrange(adult.clust.num)

str(adult.clust.long)

#heatmap.c will be suitable in case you want to go for absolute counts - but it doesn't tell much to my taste
#problem below involves the values of our data being ordinal, therefore they are not unique
levels(adult.clust.long$trait)

#Our data above comes truncated, you would need to truncate the data and re-label clusters depending on which dfs you melt/merge/reshape.
#Example: View(alb.cust.long.q[96:nrow(alb.cust.long.q),])
heatmap.c <- ggplot(adult.clust.long, aes(x = factor(adult.clust.num), y = level)) +
  geom_tile(aes(fill = count))+
  labs(title = "Distribution of characteristics across clusters", x = "Cluster number", y = NULL) +
  scale_fill_viridis(option="magma", begin = 0.2, end = 0.95)+
  facet_grid(trait~. , scales="free_y")
heatmap.c

ggsave(here('output_figures/diet_clusters/adult_dendro_heatcounts.habgreg.aggl.k9.pdf'), plot=heatmap.c, width=8, height=12, dpi=300)


heatmap.p <- ggplot(adult.clust.long, aes(x = factor(adult.clust.num), y = factor(level, ordered = T))) +
  geom_tile(aes(fill = percent), alpha = 0.85)+
  labs(title = "Distribution of characteristics across clusters", x = "Cluster number", y = NULL) +
  #scale_fill_gradient2(low = "darkslategray1", mid = "yellow", high = "turquoise4") +
  scale_fill_viridis(option="magma", begin = 0.2, end = 0.95)+
  facet_grid(trait~., scales="free_y")
heatmap.p

ggsave(here('output_figures/diet_clusters/adult_dendro_heatpercent.habgreg.aggl.k9.pdf'), plot=heatmap.p, width=8, height=12, dpi=300)

```





## ADULT Agglomerative (average) k = 10

### Cluster Dendrograms ---

```{r Horizontal dendrogram}

#Using agglomerative hierarchical clustering, k = 7
PNW.pal10 <- pnw_palette(10, name = "Bay", type = "continuous")
str(PNW.pal9)

adult.dendro <- as.dendrogram(adult.aggl.clusta) #188 species

###Horizontal dendrogram - Adult traits

#Horizontal cluster illustration version
adult.dendro.col <- adult.dendro %>%
  set("branches_k_color", k = 10, value = PNW.pal10) %>%
  set("branches_lwd", 0.8) %>%
  set("labels", adult_species) %>% #NOT VERY LEGIBLE...
  set("labels_colors", 
      value = c("darkslategray")) %>% 
  set("labels_cex", 0.5)
adult.ggd1 <- as.ggdend(adult.dendro.col)
adult.dendro.graph <- ggplot(adult.ggd1, theme = theme_minimal()) +
  labs(x = "Num. observations", y = "Height", title = "Dendrogram, k = 9")
adult.dendro.graph
ggsave('adult.dendro.horz.hab.aggla.k10.png', plot=adult.dendro.graph, width=8, height=8, dpi=300)

```

```{r Radial dendrogram}

###Radial plot - Adult traits

# Radial plot looks less cluttered (and cooler)
adult.dendro.rad <- ggplot(adult.ggd1, labels = FALSE) + 
  scale_y_reverse(expand = c(0.2, 0)) +
  coord_polar(theta="x")
adult.dendro.rad 
#No labels on this one, labels were too cluttered/problems
#Save radial dendrogram for chat
ggsave('adult.dendro.rad.hab.aggla.k10.png', plot=adult.dendro.rad, width=8, height=8, dpi=300)


```

```{r Vertical dendrogram}

###Vertical dendrogram version

#similar to https://stackoverflow.com/questions/38034663/rotate-labels-for-ggplot-dendrogram 

# This is a different way to compute hierarchical clustering and cut the tree
#clus <- hcut(mydist, k = 6, hc_func = 'hclust', hc_method = 'ward.D2', graph = FALSE, isdiss = TRUE)

## For a horizontal version below
#dend <- as.dendrogram(alb.aggl.clustc)
#Use alb.dendro

#Below is problematic0
#labels(dend) <- paste0(paste0(rep('', 3), collapse = ''), speciesO)
#dend <- sort(dend, decreasing = FALSE)
#View(labels(dend))

#Creating df for the dend labels so that we can accurately line them up with the species
dendlabs <- labels(adult.dendro) #Need to create strings of labels to manipulate
dendlabs2 <- as.data.frame(dendlabs) #turn in df

#Join these data so we can relabel the dendrogram
#Use plyr function because it conserves the row order of the left df, which matters for assigning labels here
library(plyr)
dfdend <- join(dendlabs2, prey_adult)

ggd1 <- ggplot(adult.dendro %>%
                 set("branches_k_color", k = 10, value = PNW.pal10) %>%
                 set("branches_lwd", 0.8) %>%
                 set("labels", dfdend$prey_sp) %>% #NOT VERY LEGIBLE...
                 set("labels_colors", 
                     value = c("darkslategray")) %>% 
                 set("labels_cex", 0.5), 
               theme = theme_minimal(),
               horiz = TRUE)

ggd1 <- ggd1 + theme(panel.grid.major = element_blank(),
                     axis.text = element_blank(),
                     axis.title = element_blank())
ggd1 <- ggd1 + ylim(max(get_branches_heights(adult.dendro)), -1)
ggd1

ggsave('adult_dendro_vertlabs.hab.aggla.k10.pdf', plot=ggd1, width=5, height=20, dpi=300)

#With labels removed!!!

adult.dendro.vert <- ggplot(adult.ggd1, horiz = TRUE, labels = FALSE) + 
  scale_y_reverse(expand = c(0.2, 0)) #+
#coord_polar(theta="x")
adult.dendro.vert 
#Export as .png
ggsave('adult.dendro.vert2.hab.aggla.k10.png', plot=adult.dendro.vert, width=5, height=12, dpi=300)

```

### Albacore Cluster Heatmap ----

```{r Extract cluster number to trait matrix}

#Extract cluster number to trait matrix
adult.clust.num <- cutree(adult.aggl.clusta, k = 10)

#we want to bind the original dataset with the cluster numbers such that each species is assigned a cluster
#can use whole data or just traits use to just look at unique species clusters in relation to traits
#alb.cl <- cbind(ctraitsO, alb.clust.num)
#OR
adult.prey.cl <- cbind(prey_adult, adult.clust.num)
View(adult.prey.cl)

write.csv(adult.prey.cl, "adult.prey.clusternum.hab.aggla.k10.csv")

```

```{r Cluster heatmap}
# Time for the heatmap
# the 1st step here is to have 1 variable per row
# factors have to be converted to characters in order not to be dropped

#Note plyr can mess with this!!
detach("package:plyr", unload=TRUE)

#Create dfs for graphs
adult.clust.long = adult.prey.cl %>%
  dplyr::select(prey_sp, `vertical habitat`:`adult.clust.num`) %>%
  reshape2::melt(id.vars = c("prey_sp", "adult.clust.num"), variable.name = "trait", value.name = "level") %>%
  group_by(adult.clust.num, trait, level) %>%
  mutate(count = n_distinct(prey_sp)) %>%
  distinct(adult.clust.num, trait, level, count) %>% #, percent
  group_by(adult.clust.num, trait) %>%
  mutate(percent = count / sum(count)*100) %>%
  arrange(adult.clust.num)

str(adult.clust.long)

#heatmap.c will be suitable in case you want to go for absolute counts - but it doesn't tell much to my taste
#problem below involves the values of our data being ordinal, therefore they are not unique
levels(adult.clust.long$trait)

#Our data above comes truncated, you would need to truncate the data and re-label clusters depending on which dfs you melt/merge/reshape.
#Example: View(alb.cust.long.q[96:nrow(alb.cust.long.q),])
heatmap.c <- ggplot(adult.clust.long, aes(x = factor(adult.clust.num), y = level)) +
  geom_tile(aes(fill = count))+
  labs(title = "Distribution of characteristics across clusters", x = "Cluster number", y = NULL) +
  scale_fill_viridis(option="magma", begin = 0.2, end = 0.95)+
  facet_grid(trait~. , scales="free_y")
heatmap.c

ggsave('adult_dendro_heatcounts.hab.aggla.k10.pdf', plot=heatmap.c, width=8, height=12, dpi=300)


heatmap.p <- ggplot(adult.clust.long, aes(x = factor(adult.clust.num), y = factor(level, ordered = T))) +
  geom_tile(aes(fill = percent), alpha = 0.85)+
  labs(title = "Distribution of characteristics across clusters", x = "Cluster number", y = NULL) +
  #scale_fill_gradient2(low = "darkslategray1", mid = "yellow", high = "turquoise4") +
  scale_fill_viridis(option="magma", begin = 0.2, end = 0.95)+
  facet_grid(trait~., scales="free_y")
heatmap.p

ggsave('adult_dendro_heatpercent.hab.aggla.k10.pdf', plot=heatmap.p, width=8, height=12, dpi=300)

```




## ADULT divisve clustering k = 8

22/07/2020
Checking the output for divisive clustering routine, with an optimal cluster number of 11.
The output is a little funky in that there are multiple small groups, but much better balance of each cluster size. May not mean it is ultimately meaningful though.

23/07/2020
Using just habitat use traits, the optimal balance of the stats table values, the number of taxa per cluster and the graphics (elbow and silhouette) is between 7-9 clusters. I am selecting 8.

24/07/2020
Trying Divisive 8 clusters.

### Cluster Dendrograms ---

```{r Horizontal dendrogram}

#Using agglomerative hierarchical clustering, k = 7
PNW.pal8 <- pnw_palette(8, name = "Bay", type = "continuous")
str(PNW.pal)

adult.dendro <- as.dendrogram(adult.divisive.clust) #241 species

###Horizontal dendrogram - Adult traits

#Horizontal cluster illustration version
adult.dendro.col <- adult.dendro %>%
  set("branches_k_color", k = 8, value = PNW.pal8) %>%
  set("branches_lwd", 0.8) %>%
  set("labels", adult_species) %>% #NOT VERY LEGIBLE...
  set("labels_colors", 
      value = c("darkslategray")) %>% 
  set("labels_cex", 0.5)
adult.ggd1 <- as.ggdend(adult.dendro.col)
adult.dendro.graph <- ggplot(adult.ggd1, theme = theme_minimal()) +
  labs(x = "Num. observations", y = "Height", title = "Dendrogram, k = 8")
adult.dendro.graph
ggsave('adult.dendro.horz.habgregbody.k8.div.png', plot=adult.dendro.graph, width=8, height=8, dpi=300)

```

```{r Radial dendrogram}
#Radial plot - Adult traits
#Radial plot looks less cluttered (and cooler)
adult.dendro.rad <- ggplot(adult.ggd1, labels = FALSE) + 
  scale_y_reverse(expand = c(0.2, 0)) +
  coord_polar(theta="x")
adult.dendro.rad 
#No labels on this one, labels were too cluttered/problems
#Save radial dendrogram
ggsave('adult.dendro.rad.habgregbody.k8.div.png', plot=adult.dendro.rad, width=8, height=8, dpi=300)

```

```{r Vertical dendrogram}

###Vertical dendrogram version

#similar to https://stackoverflow.com/questions/38034663/rotate-labels-for-ggplot-dendrogram 

# This is a different way to compute hierarchical clustering and cut the tree
#clus <- hcut(mydist, k = 6, hc_func = 'hclust', hc_method = 'ward.D2', graph = FALSE, isdiss = TRUE)

## For a horizontal version below
#dend <- as.dendrogram(alb.aggl.clustc)
#Use alb.dendro

#Below is problematic0
#labels(dend) <- paste0(paste0(rep('', 3), collapse = ''), speciesO)
#dend <- sort(dend, decreasing = FALSE)
#View(labels(dend))

#Creating df for the dend labels so that we can accurately line them up with the species
dendlabs <- labels(adult.dendro) #Need to create strings of labels to manipulate
dendlabs2 <- as.data.frame(dendlabs) #turn in df

#Join these data so we can relabel the dendrogram
#Use plyr function because it conserves the row order of the left df, which matters for assigning labels here
library(plyr)
dfdend <- join(dendlabs2, prey_adult)

ggd1 <- ggplot(adult.dendro %>%
                 set("branches_k_color", k = 8, value = PNW.pal8) %>%
                 set("branches_lwd", 0.8) %>%
                 set("labels", dfdend$prey_sp) %>% #NOT VERY LEGIBLE...
                 set("labels_colors", 
                     value = c("darkslategray")) %>% 
                 set("labels_cex", 0.5), 
               theme = theme_minimal(),
               horiz = TRUE)

ggd1 <- ggd1 + theme(panel.grid.major = element_blank(),
                     axis.text = element_blank(),
                     axis.title = element_blank())
ggd1 <- ggd1 + ylim(max(get_branches_heights(adult.dendro)), -1)
ggd1

ggsave('adult_dendro_vertlabs.habgregbody.k8.div.pdf', plot=ggd1, width=5, height=20, dpi=300)

#With labels removed!!!

adult.dendro.vert <- ggplot(adult.ggd1, horiz = TRUE, labels = FALSE) + 
  scale_y_reverse(expand = c(0.2, 0)) #+
#coord_polar(theta="x")
adult.dendro.vert 
#Export as .png
ggsave('adult.dendro.vert2.habgregbody.k8.div.png', plot=adult.dendro.vert, width=5, height=12, dpi=300)

```

### Albacore Cluster Heatmap ----

```{r Extract cluster number to trait matrix}

#Extract cluster number to trait matrix
adult.clust.num <- cutree(adult.divisive.clust, k = 8)

#we want to bind the original dataset with the cluster numbers such that each species is assigned a cluster
#can use whole data or just traits use to just look at unique species clusters in relation to traits
#alb.cl <- cbind(ctraitsO, alb.clust.num)
#OR
adult.prey.cl <- cbind(prey_adult, adult.clust.num)
str(adult.prey.cl)

write.csv(adult.prey.cl, "adult.prey.clusternum.habgregbody.k8.div.csv")

```

```{r Cluster heatmap}
# Time for the heatmap
# the 1st step here is to have 1 variable per row
# factors have to be converted to characters in order not to be dropped

#Note plyr can mess with this!!
detach("package:plyr", unload=TRUE)

#Create dfs for graphs
adult.clust.long = adult.prey.cl %>%
  dplyr::select(prey_sp, `vertical habitat`:`adult.clust.num`) %>%
  reshape2::melt(id.vars = c("prey_sp", "adult.clust.num"), variable.name = "trait", value.name = "level") %>%
  group_by(adult.clust.num, trait, level) %>%
  mutate(count = n_distinct(prey_sp)) %>%
  distinct(adult.clust.num, trait, level, count) %>% #, percent
  group_by(adult.clust.num, trait) %>%
  mutate(percent = count / sum(count)*100) %>%
  arrange(adult.clust.num)

str(adult.clust.long)

#heatmap.c will be suitable in case you want to go for absolute counts - but it doesn't tell much to my taste
#problem below involves the values of our data being ordinal, therefore they are not unique
levels(adult.clust.long$trait)

#Our data above comes truncated, you would need to truncate the data and re-label clusters depending on which dfs you melt/merge/reshape.
#Example: View(alb.cust.long.q[96:nrow(alb.cust.long.q),])
heatmap.c <- ggplot(adult.clust.long, aes(x = factor(adult.clust.num), y = level)) +
  geom_tile(aes(fill = count))+
  labs(title = "Distribution of characteristics across clusters", x = "Cluster number", y = NULL) +
  scale_fill_viridis(option="magma", begin = 0.2, end = 0.95)+
  facet_grid(trait~. , scales="free_y")
heatmap.c

ggsave('adult_dendro_heatcounts.habgregbody.k8.div.pdf', plot=heatmap.c, width=8, height=12, dpi=300)


heatmap.p <- ggplot(adult.clust.long, aes(x = factor(adult.clust.num), y = factor(level, ordered = T))) +
  geom_tile(aes(fill = percent), alpha = 0.85)+
  labs(title = "Distribution of characteristics across clusters", x = "Cluster number", y = NULL) +
  #scale_fill_gradient2(low = "darkslategray1", mid = "yellow", high = "turquoise4") +
  scale_fill_viridis(option="magma", begin = 0.2, end = 0.95)+
  facet_grid(trait~., scales="free_y")
heatmap.p

ggsave('adult_dendro_heatpercent.habgregbody.k8.div.pdf', plot=heatmap.p, width=8, height=12, dpi=300)

```


## ADULT Agglomerative (complete) k = 7

24/07/2020
Note that after checking the output .csv for the clusters and their taxa, I already don't really like the look of this. Seemingly huge clusters, and some smaller not hugely sensical clusters.

### Cluster Dendrograms ---

```{r Horizontal dendrogram}

#Using agglomerative hierarchical clustering, k = 7
PNW.pal7 <- pnw_palette(7, name = "Bay", type = "continuous")

adult.dendro <- as.dendrogram(adult.aggl.clustc) #189 species

###Horizontal dendrogram - Adult traits

#Horizontal cluster illustration version
adult.dendro.col <- adult.dendro %>%
  #set("branches_k_color", k = 10, value = PNW.pal) %>%
  set("branches_k_color", k = 7, value = PNW.pal7) %>%
  set("branches_lwd", 0.8) %>%
  set("labels", adult_species) %>% #NOT VERY LEGIBLE...
  set("labels_colors", 
      value = c("darkslategray")) %>% 
  set("labels_cex", 0.5)
adult.ggd1 <- as.ggdend(adult.dendro.col)
adult.dendro.graph <- ggplot(adult.ggd1, theme = theme_minimal()) +
  labs(x = "Num. observations", y = "Height", title = "Dendrogram, k = 7")
adult.dendro.graph
ggsave('adult.dendro.horz.agglc.k7.png', plot=adult.dendro.graph, width=8, height=8, dpi=300)

```

```{r Radial dendrogram}

#Radial plot - Adult traits
#Radial plot looks less cluttered (and cooler)
adult.dendro.rad <- ggplot(adult.ggd1, labels = FALSE) + 
  scale_y_reverse(expand = c(0.2, 0)) +
  coord_polar(theta="x")
adult.dendro.rad 
#No labels on this one, labels were too cluttered/problems
#Save radial dendrogram
ggsave('adult.dendro.rad.agglc.k7.png', plot=adult.dendro.rad, width=8, height=8, dpi=300)

```

```{r Vertical dendrogram}

###Vertical dendrogram version

#similar to https://stackoverflow.com/questions/38034663/rotate-labels-for-ggplot-dendrogram 

# This is a different way to compute hierarchical clustering and cut the tree
#clus <- hcut(mydist, k = 6, hc_func = 'hclust', hc_method = 'ward.D2', graph = FALSE, isdiss = TRUE)

## For a horizontal version below
#dend <- as.dendrogram(alb.aggl.clustc)
#Use alb.dendro

#Below is problematic0
#labels(dend) <- paste0(paste0(rep('', 3), collapse = ''), speciesO)
#dend <- sort(dend, decreasing = FALSE)
#View(labels(dend))

#Creating df for the dend labels so that we can accurately line them up with the species
dendlabs <- labels(adult.dendro) #Need to create strings of labels to manipulate
dendlabs2 <- as.data.frame(dendlabs) #turn in df

#Join these data so we can relabel the dendrogram
#Use plyr function because it conserves the row order of the left df, which matters for assigning labels here
library(plyr)
dfdend <- join(dendlabs2, prey_adult)

ggd1 <- ggplot(adult.dendro %>%
                 set("branches_k_color", k = 7, value = PNW.pal7) %>%
                 set("branches_lwd", 0.8) %>%
                 set("labels", dfdend$prey_sp) %>% #NOT VERY LEGIBLE...
                 set("labels_colors", 
                     value = c("darkslategray")) %>% 
                 set("labels_cex", 0.5), 
               theme = theme_minimal(),
               horiz = TRUE)

ggd1 <- ggd1 + theme(panel.grid.major = element_blank(),
                     axis.text = element_blank(),
                     axis.title = element_blank())
ggd1 <- ggd1 + ylim(max(get_branches_heights(adult.dendro)), -1)
ggd1

ggsave('adult_dendro_vertlabs.hab.agglc.k7.pdf', plot=ggd1, width=5, height=20, dpi=300)

#With labels removed!!!

adult.dendro.vert <- ggplot(adult.ggd1, horiz = TRUE, labels = FALSE) + 
  scale_y_reverse(expand = c(0.2, 0)) #+
#coord_polar(theta="x")
adult.dendro.vert 
#Export as .png
ggsave('adult.dendro.vert2.hab.agglc.k7.png', plot=adult.dendro.vert, width=5, height=12, dpi=300)

```

### Albacore Cluster Heatmap ----

```{r Extract cluster number to trait matrix}

#Extract cluster number to trait matrix
adult.clust.num <- cutree(adult.aggl.clustc, k = 7)

#we want to bind the original dataset with the cluster numbers such that each species is assigned a cluster
#can use whole data or just traits use to just look at unique species clusters in relation to traits
#alb.cl <- cbind(ctraitsO, alb.clust.num)
#OR
adult.prey.cl <- cbind(prey_adult, adult.clust.num)
View(adult.prey.cl)

write.csv(adult.prey.cl, "adult.prey.clusternum.hab.agglc.k7.csv")

```

```{r Cluster heatmap}
# Time for the heatmap
# the 1st step here is to have 1 variable per row
# factors have to be converted to characters in order not to be dropped

#Note plyr can mess with this!!
detach("package:plyr", unload=TRUE)

#Create dfs for graphs
adult.clust.long = adult.prey.cl %>%
  dplyr::select(prey_sp, `vertical habitat`:`adult.clust.num`) %>%
  reshape2::melt(id.vars = c("prey_sp", "adult.clust.num"), variable.name = "trait", value.name = "level") %>%
  group_by(adult.clust.num, trait, level) %>%
  mutate(count = n_distinct(prey_sp)) %>%
  distinct(adult.clust.num, trait, level, count) %>% #, percent
  group_by(adult.clust.num, trait) %>%
  mutate(percent = count / sum(count)*100) %>%
  arrange(adult.clust.num)

str(adult.clust.long)

#heatmap.c will be suitable in case you want to go for absolute counts - but it doesn't tell much to my taste
#problem below involves the values of our data being ordinal, therefore they are not unique
levels(adult.clust.long$trait)

#Our data above comes truncated, you would need to truncate the data and re-label clusters depending on which dfs you melt/merge/reshape.
#Example: View(alb.cust.long.q[96:nrow(alb.cust.long.q),])
heatmap.c <- ggplot(adult.clust.long, aes(x = factor(adult.clust.num), y = level)) +
  geom_tile(aes(fill = count))+
  labs(title = "Distribution of characteristics across clusters", x = "Cluster number", y = NULL) +
  scale_fill_viridis(option="magma", begin = 0.2, end = 0.95)+
  facet_grid(trait~. , scales="free_y")
heatmap.c

ggsave('adult_dendro_heatcounts.hab.agglc.k7.pdf', plot=heatmap.c, width=8, height=12, dpi=300)


heatmap.p <- ggplot(adult.clust.long, aes(x = factor(adult.clust.num), y = factor(level, ordered = T))) +
  geom_tile(aes(fill = percent), alpha = 0.85)+
  labs(title = "Distribution of characteristics across clusters", x = "Cluster number", y = NULL) +
  #scale_fill_gradient2(low = "darkslategray1", mid = "yellow", high = "turquoise4") +
  scale_fill_viridis(option="magma", begin = 0.2, end = 0.95)+
  facet_grid(trait~., scales="free_y")
heatmap.p

ggsave('adult_dendro_heatpercent.hab.agglc.k7.pdf', plot=heatmap.p, width=8, height=12, dpi=300)

```




## ADULT Agglomerative (average) k = 7

24/07/2020
Note that after checking the output .csv for the clusters and their taxa, I already don't really like the look of this. Seemingly huge clusters, and some smaller not hugely sensical clusters. A little bit better than for complete linkage agglomerative clustering.

### Cluster Dendrograms ---

```{r Horizontal dendrogram}

#Using agglomerative hierarchical clustering, k = 7
PNW.pal7 <- pnw_palette(7, name = "Bay", type = "continuous")

adult.dendro <- as.dendrogram(adult.aggl.clusta) #189 species

###Horizontal dendrogram - Adult traits

#Horizontal cluster illustration version
adult.dendro.col <- adult.dendro %>%
  #set("branches_k_color", k = 10, value = PNW.pal) %>%
  set("branches_k_color", k = 7, value = PNW.pal7) %>%
  set("branches_lwd", 0.8) %>%
  set("labels", adult_species) %>% #NOT VERY LEGIBLE...
  set("labels_colors", 
      value = c("darkslategray")) %>% 
  set("labels_cex", 0.5)
adult.ggd1 <- as.ggdend(adult.dendro.col)
adult.dendro.graph <- ggplot(adult.ggd1, theme = theme_minimal()) +
  labs(x = "Num. observations", y = "Height", title = "Dendrogram, k = 7")
adult.dendro.graph
ggsave('adult.dendro.horz.aggla.k7.png', plot=adult.dendro.graph, width=8, height=8, dpi=300)

```

```{r Radial dendrogram}

#Radial plot - Adult traits
#Radial plot looks less cluttered (and cooler)
adult.dendro.rad <- ggplot(adult.ggd1, labels = FALSE) + 
  scale_y_reverse(expand = c(0.2, 0)) +
  coord_polar(theta="x")
adult.dendro.rad 
#No labels on this one, labels were too cluttered/problems
#Save radial dendrogram
ggsave('adult.dendro.rad.hab.aggla.k7.png', plot=adult.dendro.rad, width=8, height=8, dpi=300)


```

```{r Vertical dendrogram}

###Vertical dendrogram version

#similar to https://stackoverflow.com/questions/38034663/rotate-labels-for-ggplot-dendrogram 

# This is a different way to compute hierarchical clustering and cut the tree
#clus <- hcut(mydist, k = 6, hc_func = 'hclust', hc_method = 'ward.D2', graph = FALSE, isdiss = TRUE)

## For a horizontal version below
#dend <- as.dendrogram(alb.aggl.clustc)
#Use alb.dendro

#Below is problematic0
#labels(dend) <- paste0(paste0(rep('', 3), collapse = ''), speciesO)
#dend <- sort(dend, decreasing = FALSE)
#View(labels(dend))

#Creating df for the dend labels so that we can accurately line them up with the species
dendlabs <- labels(adult.dendro) #Need to create strings of labels to manipulate
dendlabs2 <- as.data.frame(dendlabs) #turn in df

#Join these data so we can relabel the dendrogram
#Use plyr function because it conserves the row order of the left df, which matters for assigning labels here
library(plyr)
dfdend <- join(dendlabs2, prey_adult)

ggd1 <- ggplot(adult.dendro %>%
                 set("branches_k_color", k = 7, value = PNW.pal7) %>%
                 set("branches_lwd", 0.8) %>%
                 set("labels", dfdend$prey_sp) %>% #NOT VERY LEGIBLE...
                 set("labels_colors", 
                     value = c("darkslategray")) %>% 
                 set("labels_cex", 0.5), 
               theme = theme_minimal(),
               horiz = TRUE)

ggd1 <- ggd1 + theme(panel.grid.major = element_blank(),
                     axis.text = element_blank(),
                     axis.title = element_blank())
ggd1 <- ggd1 + ylim(max(get_branches_heights(adult.dendro)), -1)
ggd1

ggsave('adult_dendro_vertlabs.hab.aggla.k7.pdf', plot=ggd1, width=5, height=20, dpi=300)

#With labels removed!!!

adult.dendro.vert <- ggplot(adult.ggd1, horiz = TRUE, labels = FALSE) + 
  scale_y_reverse(expand = c(0.2, 0)) #+
#coord_polar(theta="x")
adult.dendro.vert 
#Export as .png
ggsave('adult.dendro.vert2.hab.aggla.k7.png', plot=adult.dendro.vert, width=5, height=12, dpi=300)

```

### Albacore Cluster Heatmap ----

```{r Extract cluster number to trait matrix}

#Extract cluster number to trait matrix
adult.clust.num <- cutree(adult.aggl.clusta, k = 7)

#we want to bind the original dataset with the cluster numbers such that each species is assigned a cluster
#can use whole data or just traits use to just look at unique species clusters in relation to traits
#alb.cl <- cbind(ctraitsO, alb.clust.num)
#OR
adult.prey.cl <- cbind(prey_adult, adult.clust.num)
View(adult.prey.cl)

write.csv(adult.prey.cl, "adult.prey.clusternum.hab.aggla.k7.csv")

```

```{r Cluster heatmap}
# Time for the heatmap
# the 1st step here is to have 1 variable per row
# factors have to be converted to characters in order not to be dropped

#Note plyr can mess with this!!
detach("package:plyr", unload=TRUE)

#Create dfs for graphs
adult.clust.long = adult.prey.cl %>%
  dplyr::select(prey_sp, `vertical habitat`:`adult.clust.num`) %>%
  reshape2::melt(id.vars = c("prey_sp", "adult.clust.num"), variable.name = "trait", value.name = "level") %>%
  group_by(adult.clust.num, trait, level) %>%
  mutate(count = n_distinct(prey_sp)) %>%
  distinct(adult.clust.num, trait, level, count) %>% #, percent
  group_by(adult.clust.num, trait) %>%
  mutate(percent = count / sum(count)*100) %>%
  arrange(adult.clust.num)

str(adult.clust.long)

#heatmap.c will be suitable in case you want to go for absolute counts - but it doesn't tell much to my taste
#problem below involves the values of our data being ordinal, therefore they are not unique
levels(adult.clust.long$trait)

#Our data above comes truncated, you would need to truncate the data and re-label clusters depending on which dfs you melt/merge/reshape.
#Example: View(alb.cust.long.q[96:nrow(alb.cust.long.q),])
heatmap.c <- ggplot(adult.clust.long, aes(x = factor(adult.clust.num), y = level)) +
  geom_tile(aes(fill = count))+
  labs(title = "Distribution of characteristics across clusters", x = "Cluster number", y = NULL) +
  scale_fill_viridis(option="magma", begin = 0.2, end = 0.95)+
  facet_grid(trait~. , scales="free_y")
heatmap.c

ggsave('adult_dendro_heatcounts.hab.aggla.k7.pdf', plot=heatmap.c, width=8, height=12, dpi=300)


heatmap.p <- ggplot(adult.clust.long, aes(x = factor(adult.clust.num), y = factor(level, ordered = T))) +
  geom_tile(aes(fill = percent), alpha = 0.85)+
  labs(title = "Distribution of characteristics across clusters", x = "Cluster number", y = NULL) +
  #scale_fill_gradient2(low = "darkslategray1", mid = "yellow", high = "turquoise4") +
  scale_fill_viridis(option="magma", begin = 0.2, end = 0.95)+
  facet_grid(trait~., scales="free_y")
heatmap.p

ggsave('adult_dendro_heatpercent.hab.aggla..k7.pdf', plot=heatmap.p, width=8, height=12, dpi=300)

```



## ADULT Agglomerative k = 8

### Cluster Dendrograms ---

```{r Horizontal dendrogram}

#Using agglomerative hierarchical clustering, k = 7
PNW.pal9 <- pnw_palette(9, name = "Bay", type = "continuous")
str(PNW.pal9)

adult.dendro <- as.dendrogram(adult.aggl.clustc) #241 species

###Horizontal dendrogram - Adult traits

#Horizontal cluster illustration version
adult.dendro.col <- adult.dendro %>%
  #set("branches_k_color", k = 10, value = PNW.pal) %>%
  set("branches_k_color", k = 9, value = PNW.pal9) %>%
  set("branches_lwd", 0.8) %>%
  set("labels", adult_species) %>% #NOT VERY LEGIBLE...
  set("labels_colors", 
      value = c("darkslategray")) %>% 
  set("labels_cex", 0.5)
adult.ggd1 <- as.ggdend(adult.dendro.col)
adult.dendro.graph <- ggplot(adult.ggd1, theme = theme_minimal()) +
  labs(x = "Num. observations", y = "Height", title = "Dendrogram, k = 9")
adult.dendro.graph
ggsave('adult.dendro.horz.k9.png', plot=adult.dendro.graph, width=8, height=8, dpi=300)

```

```{r Radial dendrogram}

###Radial plot - Adult traits

# Radial plot looks less cluttered (and cooler)
adult.dendro.rad <- ggplot(adult.ggd1, labels = FALSE) + 
  scale_y_reverse(expand = c(0.2, 0)) +
  coord_polar(theta="x")
adult.dendro.rad 
#No labels on this one, labels were too cluttered/problems
#Save radial dendrogram for chat
ggsave('adult.dendro.rad.k9.png', plot=adult.dendro.rad, width=8, height=8, dpi=300)


```

```{r Vertical dendrogram}

###Vertical dendrogram version

#similar to https://stackoverflow.com/questions/38034663/rotate-labels-for-ggplot-dendrogram 

# This is a different way to compute hierarchical clustering and cut the tree
#clus <- hcut(mydist, k = 6, hc_func = 'hclust', hc_method = 'ward.D2', graph = FALSE, isdiss = TRUE)

## For a horizontal version below
#dend <- as.dendrogram(alb.aggl.clustc)
#Use alb.dendro

#Below is problematic0
#labels(dend) <- paste0(paste0(rep('', 3), collapse = ''), speciesO)
#dend <- sort(dend, decreasing = FALSE)
#View(labels(dend))

#Creating df for the dend labels so that we can accurately line them up with the species
dendlabs <- labels(adult.dendro) #Need to create strings of labels to manipulate
dendlabs2 <- as.data.frame(dendlabs) #turn in df

#Join these data so we can relabel the dendrogram
#Use plyr function because it conserves the row order of the left df, which matters for assigning labels here
library(plyr)
dfdend <- join(dendlabs2, prey_adult)

ggd1 <- ggplot(adult.dendro %>%
                 set("branches_k_color", k = 9, value = PNW.pal9) %>%
                 set("branches_lwd", 0.8) %>%
                 set("labels", dfdend$prey_sp) %>% #NOT VERY LEGIBLE...
                 set("labels_colors", 
                     value = c("darkslategray")) %>% 
                 set("labels_cex", 0.5), 
               theme = theme_minimal(),
               horiz = TRUE)

ggd1 <- ggd1 + theme(panel.grid.major = element_blank(),
                     axis.text = element_blank(),
                     axis.title = element_blank())
ggd1 <- ggd1 + ylim(max(get_branches_heights(adult.dendro)), -1)
ggd1

ggsave('adult_dendro_vertlabs.k9.pdf', plot=ggd1, width=5, height=20, dpi=300)

#With labels removed!!!

adult.dendro.vert <- ggplot(adult.ggd1, horiz = TRUE, labels = FALSE) + 
  scale_y_reverse(expand = c(0.2, 0)) #+
#coord_polar(theta="x")
adult.dendro.vert 
#Export as .png
ggsave('adult.dendro.vert2.k9.png', plot=adult.dendro.vert, width=5, height=12, dpi=300)

```

### Albacore Cluster Heatmap ----

```{r Extract cluster number to trait matrix}

#Extract cluster number to trait matrix
adult.clust.num <- cutree(adult.aggl.clustc, k = 9)

#we want to bind the original dataset with the cluster numbers such that each species is assigned a cluster
#can use whole data or just traits use to just look at unique species clusters in relation to traits
#alb.cl <- cbind(ctraitsO, alb.clust.num)
#OR
adult.prey.cl <- cbind(prey_adult, adult.clust.num)
View(adult.prey.cl)

write.csv(adult.prey.cl, "adult.prey.clusternum.k7.csv")

```

```{r Cluster heatmap}
# Time for the heatmap
# the 1st step here is to have 1 variable per row
# factors have to be converted to characters in order not to be dropped

#Note plyr can mess with this!!
detach("package:plyr", unload=TRUE)

#Create dfs for graphs
adult.clust.long = adult.prey.cl %>%
  dplyr::select(prey_sp, `vertical habitat`:`adult.clust.num`) %>%
  reshape2::melt(id.vars = c("prey_sp", "adult.clust.num"), variable.name = "trait", value.name = "level") %>%
  group_by(adult.clust.num, trait, level) %>%
  mutate(count = n_distinct(prey_sp)) %>%
  distinct(adult.clust.num, trait, level, count) %>% #, percent
  group_by(adult.clust.num, trait) %>%
  mutate(percent = count / sum(count)*100) %>%
  arrange(adult.clust.num)

str(adult.clust.long)

#heatmap.c will be suitable in case you want to go for absolute counts - but it doesn't tell much to my taste
#problem below involves the values of our data being ordinal, therefore they are not unique
levels(adult.clust.long$trait)

#Our data above comes truncated, you would need to truncate the data and re-label clusters depending on which dfs you melt/merge/reshape.
#Example: View(alb.cust.long.q[96:nrow(alb.cust.long.q),])
heatmap.c <- ggplot(adult.clust.long, aes(x = factor(adult.clust.num), y = level)) +
  geom_tile(aes(fill = count))+
  labs(title = "Distribution of characteristics across clusters", x = "Cluster number", y = NULL) +
  scale_fill_viridis(option="magma", begin = 0.2, end = 0.95)+
  facet_grid(trait~. , scales="free_y")
heatmap.c

ggsave('adult_dendro_heatcounts.k9.pdf', plot=heatmap.c, width=8, height=12, dpi=300)


heatmap.p <- ggplot(adult.clust.long, aes(x = factor(adult.clust.num), y = factor(level, ordered = T))) +
  geom_tile(aes(fill = percent), alpha = 0.85)+
  labs(title = "Distribution of characteristics across clusters", x = "Cluster number", y = NULL) +
  #scale_fill_gradient2(low = "darkslategray1", mid = "yellow", high = "turquoise4") +
  scale_fill_viridis(option="magma", begin = 0.2, end = 0.95)+
  facet_grid(trait~., scales="free_y")
heatmap.p

ggsave('adult_dendro_heatpercent.k9.pdf', plot=heatmap.p, width=8, height=12, dpi=300)

```


### Cluster Dendrograms ---

```{r Horizontal dendrogram}

#Using agglomerative hierarchical clustering, k = 7
PNW.pal3 <- pnw_palette(13, name = "Bay", type = "continuous")
#PNW.pal3 <- pnw_palette(13, name = "Starfish", type = "continuous") #for v2
#View(PNW.pal3)

adult.dendro <- as.dendrogram(adult.aggl.clustc) #241 species

###Horizontal dendrogram - Adult traits

#Horizontal cluster illustration version
adult.dendro.col <- adult.dendro %>%
  #set("branches_k_color", k = 10, value = PNW.pal) %>%
  set("branches_k_color", k = 13, value = PNW.pal3) %>%
  set("branches_lwd", 0.6) %>%
  set("labels", adult_species) %>% #NOT VERY LEGIBLE...
  set("labels_colors", 
      value = c("darkslategray")) %>% 
  set("labels_cex", 0.5)
adult.ggd1 <- as.ggdend(adult.dendro.col)
adult.dendro.graph <- ggplot(adult.ggd1, theme = theme_minimal()) +
  labs(x = "Num. observations", y = "Height", title = "Dendrogram, k = 13")
adult.dendro.graph
ggsave('adult.dendro.horz.k13.png', plot=adult.dendro.graph, width=8, height=8, dpi=300)

```

```{r Radial dendrogram}

###Radial plot - Adult traits

# Radial plot looks less cluttered (and cooler)
adult.dendro.rad <- ggplot(adult.ggd1, labels = FALSE) + 
  scale_y_reverse(expand = c(0.2, 0)) +
  coord_polar(theta="x")
adult.dendro.rad 
#No labels on this one, labels were too cluttered/problems
#Save radial dendrogram for chat
ggsave('adult.dendro.rad.k13.png', plot=adult.dendro.rad, width=8, height=8, dpi=300)


```

```{r Vertical dendrogram}

###Vertical dendrogram version

#similar to https://stackoverflow.com/questions/38034663/rotate-labels-for-ggplot-dendrogram 

# This is a different way to compute hierarchical clustering and cut the tree
#clus <- hcut(mydist, k = 6, hc_func = 'hclust', hc_method = 'ward.D2', graph = FALSE, isdiss = TRUE)

## For a horizontal version below
#dend <- as.dendrogram(alb.aggl.clustc)
#Use alb.dendro

#Below is problematic0
#labels(dend) <- paste0(paste0(rep('', 3), collapse = ''), speciesO)
#dend <- sort(dend, decreasing = FALSE)
#View(labels(dend))

#Creating df for the dend labels so that we can accurately line them up with the species
dendlabs <- labels(adult.dendro) #Need to create strings of labels to manipulate
dendlabs2 <- as.data.frame(dendlabs) #turn in df

#Join these data so we can relabel the dendrogram
#Use plyr function because it conserves the row order of the left df, which matters for assigning labels here
library(plyr)
dfdend <- join(dendlabs2, prey_adult)

ggd1 <- ggplot(adult.dendro %>%
                 set("branches_k_color", k = 13, value = PNW.pal3) %>%
                 set("branches_lwd", 0.6) %>%
                 set("labels", dfdend$prey_sp) %>% #NOT VERY LEGIBLE...
                 set("labels_colors", 
                     value = c("darkslategray")) %>% 
                 set("labels_cex", 0.5), 
               theme = theme_minimal(),
               horiz = TRUE)

ggd1 <- ggd1 + theme(panel.grid.major = element_blank(),
                     axis.text = element_blank(),
                     axis.title = element_blank())
ggd1 <- ggd1 + ylim(max(get_branches_heights(adult.dendro)), -1)
ggd1

ggsave('adult_dendro_vertlabs.k13.pdf', plot=ggd1, width=5, height=20, dpi=300)

#With labels removed!!!

adult.dendro.vert <- ggplot(adult.ggd1, horiz = TRUE, labels = FALSE) + 
  scale_y_reverse(expand = c(0.2, 0)) #+
#coord_polar(theta="x")
adult.dendro.vert 
#Export as .png
ggsave('adult.dendro.vert2.k13.png', plot=adult.dendro.vert, width=5, height=12, dpi=300)

```

### Albacore Cluster Heatmap ----

```{r Extract cluster number to trait matrix}

#Extract cluster number to trait matrix
adult.clust.num <- cutree(adult.aggl.clustc, k = 13)

#we want to bind the original dataset with the cluster numbers such that each species is assigned a cluster
#can use whole data or just traits use to just look at unique species clusters in relation to traits
#alb.cl <- cbind(ctraitsO, alb.clust.num)
#OR
adult.prey.cl <- cbind(prey_adult, adult.clust.num)
View(adult.prey.cl)

write.csv(adult.prey.cl, "adult.prey.clusternum.k13.csv")

```

```{r Cluster heatmap}
# Time for the heatmap
# the 1st step here is to have 1 variable per row
# factors have to be converted to characters in order not to be dropped

#Note plyr can mess with this!!
detach("package:plyr", unload=TRUE)

#Create dfs for graphs
adult.clust.long = adult.prey.cl %>%
  dplyr::select(prey_sp, `vertical habitat`:`adult.clust.num`) %>%
  reshape2::melt(id.vars = c("prey_sp", "adult.clust.num"), variable.name = "trait", value.name = "level") %>%
  group_by(adult.clust.num, trait, level) %>%
  mutate(count = n_distinct(prey_sp)) %>%
  distinct(adult.clust.num, trait, level, count) %>% #, percent
  group_by(adult.clust.num, trait) %>%
  mutate(percent = count / sum(count)*100) %>%
  arrange(adult.clust.num)

str(adult.clust.long)

#heatmap.c will be suitable in case you want to go for absolute counts - but it doesn't tell much to my taste
#problem below involves the values of our data being ordinal, therefore they are not unique
levels(adult.clust.long$trait)

#Our data above comes truncated, you would need to truncate the data and re-label clusters depending on which dfs you melt/merge/reshape.
#Example: View(alb.cust.long.q[96:nrow(alb.cust.long.q),])
heatmap.c <- ggplot(adult.clust.long, aes(x = factor(adult.clust.num), y = level)) +
  geom_tile(aes(fill = count))+
  labs(title = "Distribution of characteristics across clusters", x = "Cluster number", y = NULL) +
  scale_fill_viridis(option="magma", begin = 0.2, end = 0.95)+
  facet_grid(trait~. , scales="free_y")
heatmap.c

ggsave('adult_dendro_heatcounts.k13.pdf', plot=heatmap.c, width=8, height=12, dpi=300)


heatmap.p <- ggplot(adult.clust.long, aes(x = factor(adult.clust.num), y = factor(level, ordered = T))) +
  geom_tile(aes(fill = percent), alpha = 0.85)+
  labs(title = "Distribution of characteristics across clusters", x = "Cluster number", y = NULL) +
  #scale_fill_gradient2(low = "darkslategray1", mid = "yellow", high = "turquoise4") +
  scale_fill_viridis(option="magma", begin = 0.2, end = 0.95)+
  facet_grid(trait~., scales="free_y")
heatmap.p

ggsave('adult_dendro_heatpercent.k13.pdf', plot=heatmap.p, width=8, height=12, dpi=300)

```




## NMDS for checking on our ordination

```{r NMDS & Clusters ~ Species}
#### nMDS for dissimilarity
trait_NMDS_adult <- metaMDS(adult.gower.dist, trymax = 100)
trait_NMDS_adult[["stress"]] #stress = 0.1188079 #reasonable

#Simple Plot --> 
#plot(trait_NMDS) #plots species as black dots, traits as red crosses 
#Note that the ordination looks good!
#Need to revisit this and plot in relation to clusters!

```

### Extract NMDS coordinates and associate with co-variates/grouping factors

```{r Data scores for plotting - USE}

#Extract NMDS coordinates and associate with co-variates/grouping factors

#Using the scores function from vegan to extract the site scores and convert to a data.frame
data.scores <- as.data.frame(scores(trait_NMDS_adult))  #, "species"

#create a column of site names, from the rownames of data.scores
data.scores$points <- rownames(data.scores)

#bind treatment labels and score values
treatment.scores <- cbind(adult.prey.cl, data.scores)

#Check
str(treatment.scores)  
#Awesome

#ALSO
#OR for species scores
#This code isn't working
#species.scores <- as.data.frame(vegan::scores(trait_NMDS_adult, display = "species"))
#create a column of species names:
#species.scores$species <- rownames(species.scores)

```

### Convex hull calculations
For each ordination and set of grouping variables input to data scores chunk


```{r Convex hulls - Taxonomic specific}
# Taxonomic groups (specific)
#Create convex hulls for the space occupied by each Taxonomic values
unique(treatment.scores$adult.clust.num)
length(treatment.scores$adult.clust.num) #174

#Taxonomic group - hull loop
clust = as.character(unique(treatment.scores$adult.clust.num))
for(i in 1:length(clust)) {
  temp = clust[i]
  df = treatment.scores[treatment.scores$adult.clust.num == temp, ][chull(treatment.scores[treatment.scores$adult.clust.num == temp, c("NMDS1", "NMDS2")]), ]
  assign(paste0('grp.',temp), df)
}

#combine the hull data
hull.data <- rbind(grp.1, grp.2, grp.3, grp.4, grp.5, grp.6, grp.7, grp.8, grp.9)  

str(hull.data)
#Just wondering how do 174 species (obs) become 46???

```


### NMDS plot

```{r nMDS Cluster #, echo=TRUE}
#nMDS plot for the assessmenet of global change (yes/no) and the drivers.
#as.integer(unique(treatment.scores$adult.clust.num))

trait_nMDS_adult_fig <- ggplot() + 
  geom_polygon(data=hull.data, 
               aes(x=NMDS1, y=NMDS2, 
                   fill= adult.clust.num, 
                   group=adult.clust.num), 
               alpha=0.30) + # add the convex hulls
  geom_point(data=treatment.scores, 
             aes(x=NMDS1, y=NMDS2, colour= adult.clust.num), 
             size=2) + # add the point markers
  coord_equal() +
  theme_bw()  +
  theme(axis.text.x = element_blank(),  # remove x-axis text
        axis.text.y = element_blank(), # remove y-axis text
        axis.ticks = element_blank(),  # remove axis ticks
        axis.title.x = element_text(size=18), # remove x-axis labels
        axis.title.y = element_text(size=18), # remove y-axis labels
        legend.title = element_text(size = 18), 
        legend.text = element_text(size = 18),
        legend.justification = c(0,0.5),
        #panel.background = element_rect(fill = "lightgrey"), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_blank()) +
  #guides(fill = FALSE, colour = FALSE) +
  #guides(fill = guide_legend(order = 1), colour = guide_legend(order = 2)) +
  scale_colour_viridis(option="magma", begin = 0.8, end = 0.2, name = "Cluster Number") + 
  scale_fill_viridis(option="magma", begin = 0.8, end = 0.2, name = "Cluster Number") #+
  #geom_text_repel(data = species.scores,
  #                aes(x = NMDS1, y = NMDS2, label = species#, alpha = 0.8, size = 5
  #                    ))

trait_nMDS_adult_fig
##Not perfect, some issues to troubleshoot

ggsave(here("output_figures/diet_clusters/trait_nMDS_cluasters.jpeg"), plot = trait_nMDS_adult_fig, width = 8, height = 8, dpi = 300)

```
```{r nMDS Vertical Habitat, echo=TRUE}
#nMDS plot for the assessmenet of global change (yes/no) and the drivers.
unique(treatment.scores$`vertical habitat`)

trait_nMDS_adult_fig <- ggplot() + 
  #geom_polygon(data=treatment.scores, 
  #             aes(x=NMDS1, y=NMDS2, 
  #                 fill= adult.clust.num, 
  #                 group=adult.clust.num), 
  #             alpha=0.30) + # add the convex hulls
  geom_point(data=treatment.scores, 
             aes(x=NMDS1, y=NMDS2, 
                 colour = fct_relevel(`vertical habitat`, "benthic", "demersal", "epipelagic", "mesopelagic", "bathypelagic")
                 ), 
             size=2) + # add the point markers
  coord_equal() +
  theme_bw()  +
  theme(axis.text.x = element_blank(),  # remove x-axis text
        axis.text.y = element_blank(), # remove y-axis text
        axis.ticks = element_blank(),  # remove axis ticks
        axis.title.x = element_text(size=18), # remove x-axis labels
        axis.title.y = element_text(size=18), # remove y-axis labels
        legend.title = element_text(size = 18), 
        legend.text = element_text(size = 18),
        legend.justification = c(0,0.5),
        #panel.background = element_rect(fill = "lightgrey"), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_blank()) +
  #guides(fill = FALSE, colour = FALSE) +
  #guides(fill = guide_legend(order = 1), colour = guide_legend(order = 2)) +
  scale_colour_viridis(option="magma", discrete = TRUE, begin = 0.8, end = 0.2, name = "Vertical Habitat") #+ #name = "Global Change Assessed"
  #scale_colour_viridis(option="magma", discrete = TRUE, begin = 0.8, end = 0.2, name = "Driver of change") #+ #name = "Global Change Assessed"
  #geom_text_repel(data = species.scores,
  #                aes(x = NMDS1, y = NMDS2, label = species#, alpha = 0.8, size = 5
  #                    ))

trait_nMDS_adult_fig

ggsave("trait_nMDS_clim.jpeg", plot = trait_nMDS_clim, width = 8, height = 8, dpi = 300)

```

## PROBABLE prey traits

### Prey & traits for cluster ----


```{r Load & manip data for cluster analyses}

prey_probable_load = read.csv(here("data/prey_probable_traits.csv"), header=TRUE) %>% #./data/
  dplyr::select(-c(X, diel_migrant, refuge, season_migrant, l_max, trophic_level:standard_total, energy_density:percent_lipid)) %>% #refuge_cat, body_shape, phys_defense, 
  dplyr::rename(`vertical habitat` = `vert_habitat`, 
                `horizontal habitat` = `horz_habitat`,
                `diel migrant` = `diel_migrant_cat`, 
                `refuge use` = `refuge_cat`,
                `seasonal migrant` = `season_cat`, 
                `body shape` = `body_shape`,
                `physical defense` = `phys_defense`,
                `gregarious` = `gregarious_primary`#,
                #`energy density` = energy_density,
                #`percent protein` = `percent_protein`,
                #`percent lipid` = `percent_lipid`
  ) #Relabel variables

prey_prob_manip = prey_probable_load%>% 
  mutate(`physical defense`=if_else(`physical defense`>0, "defended", "undefended"), 
         `diel migrant`=case_when(`diel migrant` == "diel_no" ~ "diel (no)",
                                  `diel migrant` == "diel_UN" ~ "diel (unknown)",
                                  `diel migrant` == "diel_yes" ~ "diel (yes)"),
         `refuge use`=case_when(`refuge use` == "refuge_no" ~ "refuge (no)",
                                `refuge use` == "refuge_NA" ~ "refuge (unknown)",
                                `refuge use` == "refuge_yes" ~ "refuge (yes)"),
         `gregarious`=case_when(`gregarious` == "solitary" ~ "solitary",
                                `gregarious` == "pairing" ~ "solitary",
                                `gregarious` == "shoaling" ~ "schooling",
                                `gregarious` == "schooling" ~ "schooling"),
         `seasonal migrant`=case_when(`seasonal migrant` == "season_no" ~ "season (no)",
                                      `seasonal migrant` == "season_NA" ~ "season (unknown)",
                                      `seasonal migrant` == "season_yes" ~ "season (yes)")
         ) 

prey_probable = prey_adult_manip %>%
  filter(`diel migrant` != "diel (unknown)", 
         `refuge use` != "refuge (unknown)", 
         `seasonal migrant` != "season (unknown)"
         ) %>%
  drop_na() 
#reduced from ~299 taxa to ~250 and filtering further reduced to ~148 #exclude `refuge use` != "refuge (unknown)",

levels(as.factor(prey_probable$gregarious))

str(prey_probable)
#148 taxa and 11 variables

```

```{r Data manip for cluster analyses & dendrogram}

## Row name as column datasets
#For probable prey traits
prey_probable_row <- prey_probable
dendlabs <- rownames(prey_probable_row)
prey_probable <- cbind(dendlabs, prey_probable_row)

#Probable trait df subsets
probable_species = prey_probable$prey_sp
prey_probable[,6:17] = lapply(prey_probable[,6:17] , as.factor)
probable_traits = as.data.frame(prey_probable[,c(6:10,11,12)])

str(probable_traits)
```


### Cluster techniques ----

```{r Cluster & Dissimilarity Matrix}

#### Distance measure ----
#select just the traits you want to contribute to ordination
prob.gower.dist <- daisy(probable_traits, metric = c("gower"))

#### Divisive cluster ----
prob.divisive.clust <- diana(as.matrix(prob.gower.dist), 
                              diss = TRUE, keep.diss = TRUE)
plot(prob.divisive.clust, main = "Divisive")

#### Agglomerative cluster ----
#Use "average" or "complete" linkage
#ADD NOTE ON AVE VS. COMPLETE LINKAGE
prob.aggl.clustc <- hclust(prob.gower.dist, method = "complete")
plot(prob.aggl.clustc, main = "Agglomerative, complete linkages")

#### nMDS for dissimilarity
trait_NMDS_prob <- metaMDS(prob.gower.dist, trymax = 100)
trait_NMDS_prob[["stress"]] #stress = 0.1411261

#Plot --> 
plot(trait_NMDS_prob) #plots species as black dots, traits as red crosses 

#####Why are species scores not available?

#Note that the ordination looks good!
#Need to revisit this and plot in relation to clusters!

```

### Cluster Assessment Output

24/07/2020
Using habitat use + gregarious (mixed) traits, selecting:
(i) Divisive #9 clusters (based on balanced clusters +optimal avg.silwidth value)
(ii) Agglomerative (complete) #10 clusters (based on balanced clusters +optimal avg.silwidth value)

Using habitat use + gregarious (binary) traits, selecting:
(i) Divisive DONT USE
(ii) Agglomerative (complete) #8 clusters (based on balanced clusters +optimal avg.silwidth value)

Using all traits (habitat use, gregarious, body shape and physical defenses)
(i) Divisive - DO NOT USE
(ii) Agglomerative - 10-11 clusters (based on balanced clusters + optimal avg.silwidth value)

```{r Cluster Assessment Tables}

#Stats table for divisive method
prob.stats.df.divisive <- cstats.table(prob.gower.dist, prob.divisive.clust, 15)
prob.stats.df.divisive

#Stats table for agglomerative method
prob.stats.df.aggl <- cstats.table(prob.gower.dist, prob.aggl.clustc, 15) 
#complete linkages looks like the most balanced approach
prob.stats.df.aggl
write.csv(prob.stats.df.aggl, "prob.stats.df.aggl.csv")
#As per text for adult, average within cluster metric is minimised for ~7-10 clusters, and the average between for about the same. The agglomerative clustering appears more balanced.

```


```{r Cluster Selection - Divisive}

### Using "Elbow" and "Silhouette" methods to identify the best number of clusters

#Assessment of clustering analyses reveals the minimum optimal clusters = 7, and up to 15.
#Selected --> 10 because of cluster evenness
#I want to choose a reasonable number, based on which I will be able to see basic 
#differences between customer groups as a result

### Elbow method
# Divisive clustering
ggplot(data = data.frame(t(cstats.table(prob.gower.dist, prob.divisive.clust, 20))), 
       aes(x=cluster.number, y=within.cluster.ss)) + 
  geom_point()+
  geom_line()+
  ggtitle("Divisive clustering") +
  labs(x = "Num.of clusters", y = "Within clusters sum of squares (SS)") +
  theme(plot.title = element_text(hjust = 0.5))
# but > 10 captured complexity well enough
#22/07/2020 excl. body shape and refugia ~ 10 clusters
#24/07/2020 using habitat use + gregarious (binary) inflection at 9-10

### Silhouette
#When it comes to silhouette assessment, the rule is you should choose the number that maximizes the silhouette coefficient because you want clusters that are distinctive (far) enough to be considered separate.

# Divisive
ggplot(data = data.frame(t(cstats.table(prob.gower.dist, prob.divisive.clust, 20))), 
       aes(x=cluster.number, y=avg.silwidth)) + 
  geom_point()+
  geom_line()+
  ggtitle("Divisive clustering") +
  labs(x = "Num.of clusters", y = "Average silhouette width") +
  theme(plot.title = element_text(hjust = 0.5))
## Looks like ~11 clusters are optimal
#22/07/2020 excl. body shape and refugia ~ 10 clusters
#24/07/2020 using habitat use + gregarious (binary) optimal at 9-11

```

Elbow method
Less that 7 captured complexity well enough
22/07/2020 excl. body shape and refugia ~ 7-10 clusters
24/07/2020 using habitat use + gregarious (full) inflection at 10
24/07/2020 using habitat use + gregarious (binary) inflection at 8
25/07/2020 using all traits inflection at 11

Silhouette
Messy > 7-10
22/07/2020 excl. body shape and refugia ~ 7-11 clusters
24/07/2020 using habitat use + gregarious (full) optimal 10
24/07/2020 using habitat use + gregarious (binary) inflection at 8
25/07/2020 using all traits optimal at 10-11

```{r Cluster Selection - Agglomerative}

### Using "Elbow" and "Silhouette" methods to identify the best number of clusters

# Elbow method

# Agglomerative clustering,provides a more ambiguous picture
ggplot(data = data.frame(t(cstats.table(prob.gower.dist, prob.aggl.clustc, 20))), 
       aes(x=cluster.number, y=within.cluster.ss)) + 
  geom_point()+
  geom_line()+
  ggtitle("Agglomerative clustering") +
  labs(x = "Num.of clusters", y = "Within clusters sum of squares (SS)") +
  theme(plot.title = element_text(hjust = 0.5))

## Silhouette
#When it comes to silhouette assessment, the rule is you should choose the number that maximizes the 
#silhouette coefficient because you want clusters that are distinctive (far) enough to be considered separate.

# Agglomerative
ggplot(data = data.frame(t(cstats.table(prob.gower.dist, prob.aggl.clustc, 20))), 
       aes(x=cluster.number, y=avg.silwidth)) + 
  geom_point()+
  geom_line()+
  ggtitle("Agglomerative clustering") +
  labs(x = "Num.of clusters", y = "Average silhouette width") +
  theme(plot.title = element_text(hjust = 0.5))

```


## PROBABLE Agglomerative (complete) k = 9

### Cluster Dendrograms ---

Going to use k = 10 Agglomerative (complete) for the probable life stage traits

```{r Horizontal dendrogram}

#Using agglomerative hierarchical clustering, k = 7

prob.dendro <- as.dendrogram(prob.aggl.clustc) #241 species

###Horizontal dendrogram - Probable traits

#Horizontal cluster illustration version
prob.dendro.col <- prob.dendro %>%
  #set("branches_k_color", k = 10, value = PNW.pal) %>%
  set("branches_k_color", k = 10, value =  PNW.pal10) %>%
  set("branches_lwd", 0.8) %>%
  set("labels", probable_species) %>% #NOT VERY LEGIBLE...
  set("labels_colors", 
      value = c("darkslategray")) %>% 
  set("labels_cex", 0.5)
prob.ggd1 <- as.ggdend(prob.dendro.col)
prob.dendro.graph <- ggplot(prob.ggd1, theme = theme_minimal()) +
  labs(x = "Num. observations", y = "Height", title = "Dendrogram, k = 10")
prob.dendro.graph
ggsave('prob.dendro.horz.all.aggl.k10.png', plot=prob.dendro.graph, width=8, height=8, dpi=300)

```

```{r Radial dendrogram}

###Radial plot - Probable traits

# Radial plot looks less cluttered (and cooler)
prob.dendro.rad <- ggplot(prob.ggd1, labels = FALSE) + 
  scale_y_reverse(expand = c(0.2, 0)) +
  coord_polar(theta="x")
prob.dendro.rad 
#No labels on this one, labels were too cluttered/problems
#Save radial dendrogram for chat
ggsave('prob.dendro.rad.all.aggl.k10.png', plot=prob.dendro.rad, width=8, height=8, dpi=300)

```

```{r Vertical dendrogram}

###Vertical dendrogram version

#similar to https://stackoverflow.com/questions/38034663/rotate-labels-for-ggplot-dendrogram 

# This is a different way to compute hierarchical clustering and cut the tree
#clus <- hcut(mydist, k = 6, hc_func = 'hclust', hc_method = 'ward.D2', graph = FALSE, isdiss = TRUE)

## For a horizontal version below
#dend <- as.dendrogram(alb.aggl.clustc)
#Use alb.dendro

#Below is problematic0
#labels(dend) <- paste0(paste0(rep('', 3), collapse = ''), speciesO)
#dend <- sort(dend, decreasing = FALSE)
#View(labels(dend))

#Creating df for the dend labels so that we can accurately line them up with the species
dendlabs <- labels(prob.dendro) #Need to create strings of labels to manipulate
dendlabs2 <- as.data.frame(dendlabs) #turn in df

#Join these data so we can relabel the dendrogram
#Use plyr function because it conserves the row order of the left df, which matters for assigning labels here
library(plyr)
dfdend <- join(dendlabs2, prey_probable)

ggd1 <- ggplot(prob.dendro %>%
                 set("branches_k_color", k = 10, value = PNW.pal10) %>%
                 set("branches_lwd", 0.8) %>%
                 set("labels", dfdend$prey_sp) %>% #NOT VERY LEGIBLE...
                 set("labels_colors", 
                     value = c("darkslategray")) %>% 
                 set("labels_cex", 0.5), 
               theme = theme_minimal(),
               horiz = TRUE)

ggd1 <- ggd1 + theme(panel.grid.major = element_blank(),
                     axis.text = element_blank(),
                     axis.title = element_blank())
ggd1 <- ggd1 + ylim(max(get_branches_heights(prob.dendro)), -1)
ggd1

ggsave('prob_dendro_vertlabs.all.aggl.k10.pdf', plot=ggd1, width=5, height=20, dpi=300)

#With labels removed!!!

prob.dendro.vert <- ggplot(prob.ggd1, horiz = TRUE, labels = FALSE) + 
  scale_y_reverse(expand = c(0.2, 0)) #+
#coord_polar(theta="x")
prob.dendro.vert 
#Export as .png
ggsave('prob.dendro.vert2.all.aggl.k10.png', plot=prob.dendro.vert, width=5, height=12, dpi=300)

```

### Albacore Cluster Heatmap ----

```{r Extract cluster number to trait matrix}

#Extract cluster number to trait matrix
prob.clust.num <- cutree(prob.aggl.clustc, k = 10)

#we want to bind the original dataset with the cluster numbers such that each species is assigned a cluster
#can use whole data or just traits use to just look at unique species clusters in relation to traits
#alb.cl <- cbind(ctraitsO, alb.clust.num)
#OR
prob.prey.cl <- cbind(prey_probable, prob.clust.num)
View(prob.prey.cl)

write.csv(prob.prey.cl, "prob.prey.clusternum_all.aggl.k10.csv")

```

```{r Cluster heatmap}
# Time for the heatmap
# the 1st step here is to have 1 variable per row
# factors have to be converted to characters in order not to be dropped

#Note plyr can mess with this!!
detach("package:plyr", unload=TRUE)

#Create dfs for graphs
prob.clust.long = prob.prey.cl %>%
  dplyr::select(prey_sp, `vertical habitat`:`prob.clust.num`) %>%
  reshape2::melt(id.vars = c("prey_sp", "prob.clust.num"), variable.name = "trait", value.name = "level") %>%
  group_by(prob.clust.num, trait, level) %>%
  mutate(count = n_distinct(prey_sp)) %>%
  distinct(prob.clust.num, trait, level, count) %>% #, percent
  group_by(prob.clust.num, trait) %>%
  mutate(percent = count / sum(count)*100) %>%
  arrange(prob.clust.num)

str(prob.clust.long)

#heatmap.c will be suitable in case you want to go for absolute counts - but it doesn't tell much to my taste
#problem below involves the values of our data being ordinal, therefore they are not unique
levels(prob.clust.long$trait)

#Our data above comes truncated, you would need to truncate the data and re-label clusters depending on which dfs you melt/merge/reshape.
#Example: View(alb.cust.long.q[96:nrow(alb.cust.long.q),])
heatmap.c <- ggplot(prob.clust.long, aes(x = factor(prob.clust.num), y = level)) +
  geom_tile(aes(fill = count))+
  labs(title = "Distribution of characteristics across clusters", x = "Cluster number", y = NULL) +
  scale_fill_viridis(option="magma", begin = 0.2, end = 0.95)+
  facet_grid(trait~. , scales="free_y")
heatmap.c

ggsave('prob_dendro_heatcounts_all.aggl.k10.pdf', plot=heatmap.c, width=8, height=12, dpi=300)


heatmap.p <- ggplot(prob.clust.long, aes(x = factor(prob.clust.num), y = factor(level, ordered = T))) +
  geom_tile(aes(fill = percent), alpha = 0.85)+
  labs(title = "Distribution of characteristics across clusters", x = "Cluster number", y = NULL) +
  #scale_fill_gradient2(low = "darkslategray1", mid = "yellow", high = "turquoise4") +
  scale_fill_viridis(option="magma", begin = 0.2, end = 0.95)+
  facet_grid(trait~., scales="free_y")
heatmap.p

ggsave('prob_dendro_heatpercent_all.aggl.k10.pdf', plot=heatmap.p, width=8, height=12, dpi=300)

```

## PROBABLE Agglomerative (complete) k = 8

### Cluster Dendrograms ---

Going to use k = 8 for the probable life stage traits

```{r Horizontal dendrogram}

#Using agglomerative hierarchical clustering, k = 8
prob.dendro <- as.dendrogram(prob.aggl.clustc) #148 species
PNW.pal8 <- pnw_palette(8, name = "Bay", type = "continuous")
###Horizontal dendrogram - Probable traits

#Horizontal cluster illustration version
prob.dendro.col <- prob.dendro %>%
  set("branches_k_color", k = 8, value = PNW.pal8) %>%
  set("branches_lwd", 0.8) %>%
  set("labels", probable_species) %>% #NOT VERY LEGIBLE...
  set("labels_colors", 
      value = c("darkslategray")) %>% 
  set("labels_cex", 0.5)
prob.ggd1 <- as.ggdend(prob.dendro.col)
prob.dendro.graph <- ggplot(prob.ggd1, theme = theme_minimal()) +
  labs(x = "Num. observations", y = "Height", title = "Dendrogram, k = 8")
prob.dendro.graph

ggsave(here('output_figures/diet_clusters/prob.dendro.horz.habgreg.aggl.k8.png'), plot=prob.dendro.graph, width=8, height=8, dpi=300)

```

```{r Radial dendrogram}

###Radial plot - Probable traits

# Radial plot looks less cluttered (and cooler)
prob.dendro.rad <- ggplot(prob.ggd1, labels = FALSE) + 
  scale_y_reverse(expand = c(0.2, 0)) +
  coord_polar(theta="x")
prob.dendro.rad 
#No labels on this one, labels were too cluttered/problems
#Save radial dendrogram for chat

ggsave(here('output_figures/diet_clusters/prob.dendro.rad.habgreg.aggl.k8.png'), plot=prob.dendro.rad, width=8, height=8, dpi=300)

```

```{r Vertical dendrogram}

###Vertical dendrogram version

#similar to https://stackoverflow.com/questions/38034663/rotate-labels-for-ggplot-dendrogram 

# This is a different way to compute hierarchical clustering and cut the tree
#clus <- hcut(mydist, k = 6, hc_func = 'hclust', hc_method = 'ward.D2', graph = FALSE, isdiss = TRUE)

## For a horizontal version below
#dend <- as.dendrogram(alb.aggl.clustc)
#Use alb.dendro

#Below is problematic0
#labels(dend) <- paste0(paste0(rep('', 3), collapse = ''), speciesO)
#dend <- sort(dend, decreasing = FALSE)
#View(labels(dend))

#Creating df for the dend labels so that we can accurately line them up with the species
dendlabs <- labels(prob.dendro) #Need to create strings of labels to manipulate
dendlabs2 <- as.data.frame(dendlabs) #turn in df

#Join these data so we can relabel the dendrogram
#Use plyr function because it conserves the row order of the left df, which matters for assigning labels here
library(plyr)
dfdend <- join(dendlabs2, prey_probable)

ggd1 <- ggplot(prob.dendro %>%
                 set("branches_k_color", k = 8, value = PNW.pal8) %>%
                 set("branches_lwd", 0.8) %>%
                 set("labels", dfdend$prey_sp) %>% #NOT VERY LEGIBLE...
                 set("labels_colors", 
                     value = c("darkslategray")) %>% 
                 set("labels_cex", 0.5), 
               theme = theme_minimal(),
               horiz = TRUE)

ggd1 <- ggd1 + theme(panel.grid.major = element_blank(),
                     axis.text = element_blank(),
                     axis.title = element_blank())
ggd1 <- ggd1 + ylim(max(get_branches_heights(prob.dendro)), -1)
ggd1

ggsave(here('output_figures/diet_clusters/prob_dendro_vertlabs.habgreg.aggl.k8.pdf'), plot=ggd1, width=5, height=20, dpi=300)

#With labels removed!!!

prob.dendro.vert <- ggplot(prob.ggd1, horiz = TRUE, labels = FALSE) + 
  scale_y_reverse(expand = c(0.2, 0)) #+
#coord_polar(theta="x")
prob.dendro.vert 
#Export as .png
ggsave(here('output_figures/diet_clusters/prob.dendro.vert2.habgreg.aggl.k8.png'), plot=prob.dendro.vert, width=5, height=12, dpi=300)


```

### Albacore Cluster Heatmap ----

```{r Extract cluster number to trait matrix}

#Extract cluster number to trait matrix
prob.clust.num <- cutree(prob.aggl.clustc, k = 8)

#we want to bind the original dataset with the cluster numbers such that each species is assigned a cluster
#can use whole data or just traits use to just look at unique species clusters in relation to traits
#alb.cl <- cbind(ctraitsO, alb.clust.num)
#OR
prob.prey.cl <- cbind(prey_probable, prob.clust.num)
View(prob.prey.cl)

write.csv(prob.prey.cl, here("data/prob.prey.clusternum_habgreg.aggl.k8.csv"))

```

```{r Cluster heatmap}
# Time for the heatmap
# the 1st step here is to have 1 variable per row
# factors have to be converted to characters in order not to be dropped

#Note plyr can mess with this!!
detach("package:plyr", unload=TRUE)

#Create dfs for graphs
prob.clust.long = prob.prey.cl %>%
  dplyr::select(prey_sp, `vertical habitat`:`seasonal migrant`, `physical defense`, `gregarious`, `prob.clust.num`) %>%
  reshape2::melt(id.vars = c("prey_sp", "prob.clust.num"), variable.name = "trait", value.name = "level") %>%
  group_by(prob.clust.num, trait, level) %>%
  mutate(count = n_distinct(prey_sp)) %>%
  distinct(prob.clust.num, trait, level, count) %>% #, percent
  group_by(prob.clust.num, trait) %>%
  mutate(percent = count / sum(count)*100) %>%
  arrange(prob.clust.num)

str(prob.clust.long)

#heatmap.c will be suitable in case you want to go for absolute counts - but it doesn't tell much to my taste
#problem below involves the values of our data being ordinal, therefore they are not unique
levels(prob.clust.long$trait)

#Our data above comes truncated, you would need to truncate the data and re-label clusters depending on which dfs you melt/merge/reshape.
#Example: View(alb.cust.long.q[96:nrow(alb.cust.long.q),])
heatmap.c <- ggplot(prob.clust.long, aes(x = factor(prob.clust.num), y = level)) +
  geom_tile(aes(fill = count))+
  labs(title = "Distribution of characteristics across clusters", x = "Cluster number", y = NULL) +
  scale_fill_viridis(option="magma", begin = 0.2, end = 0.95)+
  facet_grid(trait~. , scales="free_y")
heatmap.c

ggsave(here('output_figures/diet_clusters/prob_dendro_heatcounts_habgreg.aggl.k8.pdf'), plot=heatmap.c, width=8, height=12, dpi=300)


heatmap.p <- ggplot(prob.clust.long, aes(x = factor(prob.clust.num), y = factor(level, ordered = T))) +
  geom_tile(aes(fill = percent), alpha = 0.85)+
  labs(title = "Distribution of characteristics across clusters", x = "Cluster number", y = NULL) +
  #scale_fill_gradient2(low = "darkslategray1", mid = "yellow", high = "turquoise4") +
  scale_fill_viridis(option="magma", begin = 0.2, end = 0.95)+
  facet_grid(trait~., scales="free_y")
heatmap.p

ggsave(here('output_figures/diet_clusters/prob_dendro_heatpercent_habgreg.aggl.k8.pdf'), plot=heatmap.p, width=8, height=12, dpi=300)

```


## NMDS for checking on our ordination

```{r NMDS & Clusters ~ Species}
#### nMDS for dissimilarity
trait_NMDS_prob <- metaMDS(adult.gower.dist, trymax = 100)
trait_NMDS_prob[["stress"]] #stress = 0.14 #reasonable

#Simple Plot --> 
#plot(trait_NMDS) #plots species as black dots, traits as red crosses 
#Note that the ordination looks good!
#Need to revisit this and plot in relation to clusters!

```

### Extract NMDS coordinates and associate with co-variates/grouping factors

```{r Data scores for plotting - USE}

#Extract NMDS coordinates and associate with co-variates/grouping factors

#Using the scores function from vegan to extract the site scores and convert to a data.frame
data.scores <- as.data.frame(scores(trait_NMDS_prob))  #, "species"

#create a column of site names, from the rownames of data.scores
data.scores$points <- rownames(data.scores)

#bind treatment labels and score values
treatment.scores <- cbind(prob.prey.cl, data.scores)

#Check
str(treatment.scores)  
#Awesome

#ALSO
#OR for species scores
#This code isn't working
#species.scores <- as.data.frame(vegan::scores(trait_NMDS_adult, display = "species"))
#create a column of species names:
#species.scores$species <- rownames(species.scores)

```

### Convex hull calculations
For each ordination and set of grouping variables input to data scores chunk


```{r Convex hulls - Taxonomic specific}
# Taxonomic groups (specific)
#Create convex hulls for the space occupied by each Taxonomic values
unique(treatment.scores$prob.clust.num)
length(treatment.scores$prob.clust.num) #174

#Taxonomic group - hull loop
clust = as.character(unique(treatment.scores$prob.clust.num))
for(i in 1:length(clust)) {
  temp = clust[i]
  df = treatment.scores[treatment.scores$prob.clust.num == temp, ][chull(treatment.scores[treatment.scores$prob.clust.num == temp, c("NMDS1", "NMDS2")]), ]
  assign(paste0('grp.',temp), df)
}

#combine the hull data
hull.data <- rbind(grp.1, grp.2, grp.3, grp.4, grp.5, grp.6, grp.7, grp.8)  

str(hull.data)
#Just wondering how do 174 species (obs) become 46???

```


### NMDS plot

```{r nMDS Cluster #, echo=TRUE}
#nMDS plot for the assessmenet of global change (yes/no) and the drivers.
#as.integer(unique(treatment.scores$adult.clust.num))

trait_nMDS_prob_fig <- ggplot() + 
  geom_polygon(data=hull.data, 
               aes(x=NMDS1, y=NMDS2, 
                   fill= prob.clust.num, 
                   group= prob.clust.num), 
               alpha=0.30) + # add the convex hulls
  geom_point(data=treatment.scores, 
             aes(x=NMDS1, y=NMDS2, colour= prob.clust.num), 
             size=2) + # add the point markers
  coord_equal() +
  theme_bw()  +
  theme(axis.text.x = element_blank(),  # remove x-axis text
        axis.text.y = element_blank(), # remove y-axis text
        axis.ticks = element_blank(),  # remove axis ticks
        axis.title.x = element_text(size=18), # remove x-axis labels
        axis.title.y = element_text(size=18), # remove y-axis labels
        legend.title = element_text(size = 18), 
        legend.text = element_text(size = 18),
        legend.justification = c(0,0.5),
        #panel.background = element_rect(fill = "lightgrey"), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_blank()) +
  #guides(fill = FALSE, colour = FALSE) +
  #guides(fill = guide_legend(order = 1), colour = guide_legend(order = 2)) +
  scale_colour_viridis(option="magma", begin = 0.8, end = 0.2, name = "Cluster Number") + 
  scale_fill_viridis(option="magma", begin = 0.8, end = 0.2, name = "Cluster Number") #+
  
trait_nMDS_prob_fig
##Not perfect, some issues to troubleshoot

ggsave(here("output_figures/diet_clusters/trait_nMDS_prob_clusters.png"), 
       plot = trait_nMDS_prob_fig, width = 8, height = 8, dpi = 300)

```

```{r nMDS Vertical Habitat, echo=TRUE}
#nMDS plot for the assessmenet of global change (yes/no) and the drivers.
unique(treatment.scores$`vertical habitat`)

trait_nMDS_adult_fig <- ggplot() + 
  #geom_polygon(data=treatment.scores, 
  #             aes(x=NMDS1, y=NMDS2, 
  #                 fill= adult.clust.num, 
  #                 group=adult.clust.num), 
  #             alpha=0.30) + # add the convex hulls
  geom_point(data=treatment.scores, 
             aes(x=NMDS1, y=NMDS2, 
                 colour = fct_relevel(`vertical habitat`, "benthic", "demersal", "epipelagic", "mesopelagic", "bathypelagic")
                 ), 
             size=2) + # add the point markers
  coord_equal() +
  theme_bw()  +
  theme(axis.text.x = element_blank(),  # remove x-axis text
        axis.text.y = element_blank(), # remove y-axis text
        axis.ticks = element_blank(),  # remove axis ticks
        axis.title.x = element_text(size=18), # remove x-axis labels
        axis.title.y = element_text(size=18), # remove y-axis labels
        legend.title = element_text(size = 18), 
        legend.text = element_text(size = 18),
        legend.justification = c(0,0.5),
        #panel.background = element_rect(fill = "lightgrey"), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_blank()) +
  #guides(fill = FALSE, colour = FALSE) +
  #guides(fill = guide_legend(order = 1), colour = guide_legend(order = 2)) +
  scale_colour_viridis(option="magma", discrete = TRUE, begin = 0.8, end = 0.2, name = "Vertical Habitat") #+ #name = "Global Change Assessed"
  #scale_colour_viridis(option="magma", discrete = TRUE, begin = 0.8, end = 0.2, name = "Driver of change") #+ #name = "Global Change Assessed"
  #geom_text_repel(data = species.scores,
  #                aes(x = NMDS1, y = NMDS2, label = species#, alpha = 0.8, size = 5
  #                    ))

trait_nMDS_adult_fig

ggsave("trait_nMDS_clim.jpeg", plot = trait_nMDS_clim, width = 8, height = 8, dpi = 300)

```

## PROBABLE Agglomerative (complete) k = 8 -- April 2021

### Cluster Dendrograms ---

Going to use k = 8 for the probable life stage traits

**Horizontal dendrogram**

```{r Horizontal dendrogram}

#Using agglomerative hierarchical clustering, k = 8
prob.dendro <- as.dendrogram(prob.aggl.clustc) #156 species
PNW.pal8 <- pnw_palette(8, name = "Bay", type = "continuous")
###Horizontal dendrogram - Probable traits

#Horizontal cluster illustration version
prob.dendro.col <- prob.dendro %>%
  set("branches_k_color", k = 8, value = PNW.pal8) %>%
  set("branches_lwd", 0.8) %>%
  set("labels", probable_species) %>% #NOT VERY LEGIBLE...
  set("labels_colors", 
      value = c("darkslategray")) %>% 
  set("labels_cex", 0.5)
prob.ggd1 <- as.ggdend(prob.dendro.col)
prob.dendro.graph <- ggplot(prob.ggd1, theme = theme_minimal()) +
  labs(x = "Num. observations", y = "Height", title = "Dendrogram, k = 8")
prob.dendro.graph

ggsave(here('outputs_figures/clusters/prob.dendro.horz.k8.png'), plot=prob.dendro.graph, width=8, height=8, dpi=300)

```

**Radial dendrogram**

```{r Radial dendrogram}

# Radial plot looks less cluttered (and cooler)
prob.dendro.rad <- ggplot(prob.ggd1, labels = FALSE) + 
  scale_y_reverse(expand = c(0.2, 0)) +
  coord_polar(theta="x")
prob.dendro.rad 
#No labels on this one, labels were too cluttered/problems
#Save radial dendrogram for chat

ggsave(here('outputs_figures/clusters/prob.dendro.rad.k8.png'), plot=prob.dendro.rad, width=8, height=8, dpi=300)
#probable_agglo/
```

**Vertical dendrogram**

Similar to https://stackoverflow.com/questions/38034663/rotate-labels-for-ggplot-dendrogram 

```{r Vertical dendrogram}

# This is a different way to compute hierarchical clustering and cut the tree
#clus <- hcut(mydist, k = 6, hc_func = 'hclust', hc_method = 'ward.D2', graph = FALSE, isdiss = TRUE)

#Below is problematic0
#labels(dend) <- paste0(paste0(rep('', 3), collapse = ''), speciesO)
#dend <- sort(dend, decreasing = FALSE)
#View(labels(dend))

#Creating df for the dend labels so that we can accurately line them up with the species
dendlabs <- labels(prob.dendro) #Need to create strings of labels to manipulate
dendlabs2 <- as.data.frame(dendlabs) #turn in df

#Join these data so we can relabel the dendrogram
#Use plyr function because it conserves the row order of the left df, which matters for assigning labels here
dfdend <- join(dendlabs2, prey_probable)

ggd1 <- ggplot(prob.dendro %>%
                 set("branches_k_color", k = 8, value = PNW.pal8) %>%
                 set("branches_lwd", 0.8) %>%
                 set("labels", dfdend$prey_sp) %>% #NOT VERY LEGIBLE...
                 set("labels_colors", 
                     value = c("darkslategray")) %>% 
                 set("labels_cex", 0.5), 
               theme = theme_minimal(),
               horiz = TRUE)

ggd1 <- ggd1 + theme(panel.grid.major = element_blank(),
                     axis.text = element_blank(),
                     axis.title = element_blank())
ggd1 <- ggd1 + ylim(max(get_branches_heights(prob.dendro)), -1)
ggd1

ggsave(here('outputs_figures/clusters/prob.dendro.vertlabs.k8.pdf'), plot=ggd1, width=5, height=20, dpi=300) #probable_agglo/

#With labels removed!!!

prob.dendro.vert <- ggplot(prob.ggd1, horiz = TRUE, labels = FALSE) + 
  scale_y_reverse(expand = c(0.2, 0)) #+
#coord_polar(theta="x")
prob.dendro.vert 
#Export as .png
ggsave(here('outputs_figures/clusters/prob.dendro.vert2.k8.png'), plot=prob.dendro.vert, width=5, height=12, dpi=300) #probable_agglo/


```


**Vertical dendro with traits**

The rows are ordered based on the order of the hierarchical clustering (using the complete method). The colored bar indicates the species category each row belongs to. The color in the heatmap indicates the length of each measurement (from light yellow to dark red).

In the heatmap we also see how the Setosa species has low petal values (in light yellow), but it is very difficult to see any clear distinction between the other two species.
         
```{r Vertical dendro with traits, eval=FALSE}
some_col_func <- function(n) rev(colorspace::heat_hcl(n, c = c(80, 30), l = c(30, 90), power = c(1/5, 1.5)))

# scaled_iris2 <- iris2 %>% as.matrix %>% scale
# library(gplots)
gplots::heatmap.2(as.matrix(prob.aggl.clustc), 
          main = "Heatmap for the Iris data set",
          srtCol = 20,
          dendrogram = "row",
          Rowv = prob.dendro,
          Colv = "NA", # this to make sure the columns are not ordered
          trace="none",          
          margins =c(5,0.1),      
          key.xlab = "Cm",
          denscol = "grey",
          density.info = "density",
          RowSideColors = rev(labels_colors(prob.dendro)), # to add nice colored strips        
          col = some_col_func
         )
```


### Albacore Cluster Heatmap ----

```{r Extract cluster number to trait matrix}

#Extract cluster number to trait matrix
prob.clust.num <- cutree(prob.aggl.clustc, k = 8)

#we want to bind the original dataset with the cluster numbers such that each species is assigned a cluster
#can use whole data or just traits use to just look at unique species clusters in relation to traits
#alb.cl <- cbind(ctraitsO, alb.clust.num)
#OR
prob.prey.cl <- cbind(prey_probable, prob.clust.num)

#View(prob.prey.cl)

write.csv(prob.prey.cl, here("data/output_data/prob.prey.clusternum_habgreg.aggl.k8.csv"))
write.csv(prob.prey.cl, here("outputs_figures/clusters/prob.prey.clusternum_habgreg.aggl.k8.csv")) #probable_agglo/

```

```{r Cluster heatmap}
# Time for the heatmap
# the 1st step here is to have 1 variable per row
# factors have to be converted to characters in order not to be dropped

#Note plyr can mess with this!!
detach("package:plyr", unload=TRUE)

#Create dfs for graphs
prob.clust.long = prob.prey.cl %>%
  dplyr::select(prey_sp, life_stage:season_cat, `gregarious`, `prob.clust.num`) %>% #maxFO:maxM, 
  reshape2::melt(id.vars = c("prey_sp", "prob.clust.num"), variable.name = "trait", value.name = "level") %>%
  group_by(prob.clust.num, trait, level) %>%
  mutate(count = n_distinct(prey_sp)) %>%
  distinct(prob.clust.num, trait, level, count) %>% #, percent
  group_by(prob.clust.num, trait) %>%
  mutate(percent = count / sum(count)*100) %>%
  arrange(prob.clust.num)

str(prob.clust.long)

#heatmap.c will be suitable in case you want to go for absolute counts - but it doesn't tell much to my taste
#problem below involves the values of our data being ordinal, therefore they are not unique
levels(prob.clust.long$trait)

#Our data above comes truncated, you would need to truncate the data and re-label clusters depending on which dfs you melt/merge/reshape.
#Example: View(alb.cust.long.q[96:nrow(alb.cust.long.q),])
heatmap.c <- ggplot(prob.clust.long, aes(x = factor(prob.clust.num), y = level)) +
  geom_tile(aes(fill = count))+
  labs(title = "Distribution of characteristics across clusters", x = "Cluster number", y = NULL) +
  scale_fill_viridis(option="magma", begin = 0.2, end = 0.95)+
  facet_grid(trait~. , scales="free_y")
heatmap.c

ggsave(here('outputs_figures/clusters/prob.dendro.heatcounts.k8.life.pdf'), plot=heatmap.c, width=8, height=12, dpi=300) #probable_agglo/


heatmap.p <- ggplot(prob.clust.long, aes(x = factor(prob.clust.num), y = factor(level, ordered = T))) +
  geom_tile(aes(fill = percent), alpha = 0.85)+
  labs(title = "Distribution of characteristics across clusters", x = "Cluster number", y = NULL) +
  #scale_fill_gradient2(low = "darkslategray1", mid = "yellow", high = "turquoise4") +
  scale_fill_viridis(option="magma", begin = 0.2, end = 0.95)+
  facet_grid(trait~., scales="free_y")
heatmap.p

ggsave(here('outputs_figures/clusters/prob.dendro.heatpercent.aggl.k8.life.pdf'), plot=heatmap.p, width=8, height=12, dpi=300) #probable_agglo/

```



## NMDS for checking on our ordination - agglomerative -- April 2021

### Ordination

```{r NMDS & Clusters ~ Species, echo=FALSE}
#### nMDS for dissimilarity
trait_NMDS_prob <- metaMDS(prob.gower.dist, trymax = 1000) #solution after 541 iterations
trait_NMDS_prob[["stress"]] #stress = 0.1544764 #reasonable

```

### Extract NMDS coordinates and associate with co-variates/grouping factors

```{r Data scores for plotting - USE}

#Extract NMDS coordinates and associate with co-variates/grouping factors

#Using the scores function from vegan to extract the site scores and convert to a data.frame
data.scores <- as.data.frame(scores(trait_NMDS_prob))  #, "species"

#create a column of site names, from the rownames of data.scores
data.scores$points <- rownames(data.scores)

#bind treatment labels and score values
treatment.scores <- cbind(prob.prey.cl, data.scores)

#Check
str(treatment.scores)  
#Awesome

```

### Convex hull calculations
For each ordination and set of grouping variables input to data scores chunk


```{r Convex hulls - Taxonomic specific}
# Taxonomic groups (specific)
#Create convex hulls for the space occupied by each Taxonomic values
unique(treatment.scores$prob.clust.num)
length(treatment.scores$prob.clust.num) #174

#Taxonomic group - hull loop
clust = as.character(unique(treatment.scores$prob.clust.num))
for(i in 1:length(clust)) {
  temp = clust[i]
  df = treatment.scores[treatment.scores$prob.clust.num == temp, ][chull(treatment.scores[treatment.scores$prob.clust.num == temp, c("NMDS1", "NMDS2")]), ]
  assign(paste0('grp.',temp), df)
}

#combine the hull data
hull.data <- rbind(grp.1, grp.2, grp.3, grp.4, grp.5, grp.6, grp.7, grp.8)  

str(hull.data)
#Just wondering how do 174 species (obs) become 46???

```


### NMDS plot

```{r nMDS Cluster #, echo=TRUE}
#nMDS plot for the assessmenet of global change (yes/no) and the drivers.
#as.integer(unique(treatment.scores$adult.clust.num))

trait_nMDS_prob_fig <- ggplot() + 
  geom_polygon(data=hull.data, 
               aes(x=NMDS1, y=NMDS2, 
                   fill= prob.clust.num, 
                   group= prob.clust.num), 
               alpha=0.30) + # add the convex hulls
  geom_point(data=treatment.scores, 
             aes(x=NMDS1, y=NMDS2, colour= prob.clust.num), 
             size=2) + # add the point markers
  coord_equal() +
  theme_bw()  +
  theme(axis.text.x = element_blank(),  # remove x-axis text
        axis.text.y = element_blank(), # remove y-axis text
        axis.ticks = element_blank(),  # remove axis ticks
        axis.title.x = element_text(size=18), # remove x-axis labels
        axis.title.y = element_text(size=18), # remove y-axis labels
        legend.title = element_text(size = 18), 
        legend.text = element_text(size = 18),
        legend.justification = c(0,0.5),
        #panel.background = element_rect(fill = "lightgrey"), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_blank()) +
  #guides(fill = FALSE, colour = FALSE) +
  #guides(fill = guide_legend(order = 1), colour = guide_legend(order = 2)) +
  scale_colour_viridis(option="magma", begin = 0.8, end = 0.2, name = "Cluster Number") + 
  scale_fill_viridis(option="magma", begin = 0.8, end = 0.2, name = "Cluster Number") #+
  
trait_nMDS_prob_fig
##Not perfect, some issues to troubleshoot

ggsave(here("outputs_figures/clusters/probable_agglo/trait_nMDS_prob_clusters.png"), 
       plot = trait_nMDS_prob_fig, width = 8, height = 8, dpi = 300)

```

```{r nMDS Cluster + FO}

trait_nMDS_prob_fo <- ggplot() + 
  geom_polygon(data=hull.data, 
               aes(x=NMDS1, y=NMDS2, 
                   fill= prob.clust.num, 
                   group= prob.clust.num), 
               alpha=0.30) + # add the convex hulls
  geom_point(data=treatment.scores, 
             aes(x=NMDS1, y=NMDS2, colour= maxFO), 
             size=2) + # add the point markers
  coord_equal() +
  theme_bw()  +
  theme(axis.text.x = element_blank(),  # remove x-axis text
        axis.text.y = element_blank(), # remove y-axis text
        axis.ticks = element_blank(),  # remove axis ticks
        axis.title.x = element_text(size=18), # remove x-axis labels
        axis.title.y = element_text(size=18), # remove y-axis labels
        legend.title = element_text(size = 18), 
        legend.text = element_text(size = 18),
        legend.justification = c(0,0.5),
        #panel.background = element_rect(fill = "lightgrey"), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_blank()) +
  #guides(fill = FALSE, colour = FALSE) +
  #guides(fill = guide_legend(order = 1), colour = guide_legend(order = 2)) +
  scale_colour_viridis(option="A", begin = 0.2, end = 0.8, name = "Frequency of Occurrence (%)") + 
  scale_fill_viridis(option="magma", begin = 0.8, end = 0.2, name = "Cluster Number") #+
  
trait_nMDS_prob_fo


#ggsave(here("outputs_figures/clusters/trait_nMDS_prob_fo.png"), 
#       plot = trait_nMDS_prob_fo, width = 8, height = 8, dpi = 300)

```

```{r nMDS Cluster + %N}

trait_nMDS_prob_no <- ggplot() + 
  geom_polygon(data=hull.data, 
               aes(x=NMDS1, y=NMDS2, 
                   fill= prob.clust.num, 
                   group= prob.clust.num), 
               alpha=0.30) + # add the convex hulls
  geom_point(data=treatment.scores, 
             aes(x=NMDS1, y=NMDS2, colour= maxN), 
             size=2) + # add the point markers
  coord_equal() +
  theme_bw()  +
  theme(axis.text.x = element_blank(),  # remove x-axis text
        axis.text.y = element_blank(), # remove y-axis text
        axis.ticks = element_blank(),  # remove axis ticks
        axis.title.x = element_text(size=18), # remove x-axis labels
        axis.title.y = element_text(size=18), # remove y-axis labels
        legend.title = element_text(size = 18), 
        legend.text = element_text(size = 18),
        legend.justification = c(0,0.5),
        #panel.background = element_rect(fill = "lightgrey"), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_blank()) +
  #guides(fill = FALSE, colour = FALSE) +
  #guides(fill = guide_legend(order = 1), colour = guide_legend(order = 2)) +
  scale_colour_viridis(option="A", begin = 0.2, end = 0.8, name = "Numerical Abundance (%)") + 
  scale_fill_viridis(option="magma", begin = 0.8, end = 0.2, name = "Cluster Number") #+
  
trait_nMDS_prob_no


#ggsave(here("outputs_figures/clusters/trait_nMDS_prob_fo.png"), 
#       plot = trait_nMDS_prob_fo, width = 8, height = 8, dpi = 300)

```

 
## ALL TRAITS COMPARE
```{r Compare traits heatmap}
#Note plyr can mess with this!!
detach("package:plyr", unload=TRUE)

str(prob.clust.long)
str(adult.clust.long)

#Create dfs for graphs
prob = prob.prey.cl %>%
  dplyr::select(prey_sp, `vertical habitat`:`gregarious`) %>%
  reshape2::melt(id.vars = c("prey_sp"), variable.name = "trait", value.name = "level") %>%
  group_by(trait, level) %>%
  mutate(count = n_distinct(prey_sp)) %>%
  distinct(trait, level, count) %>% #, percent
  group_by(trait) %>%
  mutate(percent = count / sum(count)*100) %>%
  #arrange(prob.clust.num)
  mutate(life_stage = "probable")

adult = adult.prey.cl %>%
  dplyr::select(prey_sp, `vertical habitat`:`gregarious`) %>%
  reshape2::melt(id.vars = c("prey_sp", "adult.clust.num"), variable.name = "trait", value.name = "level") %>%
  group_by(trait, level) %>%
  mutate(count = n_distinct(prey_sp)) %>%
  distinct(trait, level, count) %>% #, percent
  group_by(trait) %>%
  mutate(percent = count / sum(count)*100) %>%
  #arrange(prob.clust.num)
  mutate(life_stage = "adult")

compare.long = rbind(adult, prob)
compare.long[,c(2,5)] =  lapply(compare.long[,c(2,5)], as.factor)
levels(compare.long$life_stage)

#Our data above comes truncated, you would need to truncate the data and re-label clusters depending on which dfs you melt/merge/reshape.
#Example: View(alb.cust.long.q[96:nrow(alb.cust.long.q),])
heatmap.c <- ggplot(compare.long, aes(x = life_stage, y = level)) +
  geom_tile(aes(fill = count))+
  labs(title = "Distribution of characteristics across clusters", x = "Cluster number", y = NULL) +
  scale_fill_viridis(option="magma", begin = 0.2, end = 0.95)+
  facet_grid(trait~. , scales="free_y")
heatmap.c

ggsave('alltraits_heatcounts_compare.pdf', plot=heatmap.c, width=8, height=12, dpi=300)


heatmap.p <- ggplot(compare.long, aes(x = life_stage, y = level)) +
  geom_tile(aes(fill = percent), alpha = 0.85)+
  labs(title = "Distribution of characteristics across clusters", x = "Cluster number", y = NULL) +
  #scale_fill_gradient2(low = "darkslategray1", mid = "yellow", high = "turquoise4") +
  scale_fill_viridis(option="magma", begin = 0.2, end = 0.95)+
  facet_grid(trait~., scales="free_y")
heatmap.p

ggsave('alltraits_dendro_heatpercent_compare_.pdf', plot=heatmap.p, width=8, height=12, dpi=300)

```




### Checked other dissimilarities
```{r Upload & manip ordinal dfs to nMDS}

#Need ordinal data for this one
#For adult traits
#prey_adults_ord = read.csv(here("data/prey_adults_ord.csv"))

prey_adults_ord[,6:ncol(prey_adults_ord)] = lapply(prey_adults_ord[,6:ncol(prey_adults_ord)], as.numeric)

prey_adults_ord_use = prey_adults_ord[,6:ncol(prey_adults_ord)] %>%
  drop_na()
str(prey_adults_ord_use)
#Make species vector for labels

species_adult = prey_adults_ord %>%
  drop_na() %>%
  select(prey_sp)

#Probable traits
#prey_prob_ord = read.csv(here("data/prey_prob_ord.csv"))
prey_prob_ord[,6:ncol(prey_prob_ord)] = lapply(prey_prob_ord[,6:ncol(prey_prob_ord)], as.numeric)

prey_prob_ord_use = prey_prob_ord[,6:ncol(prey_prob_ord)]  %>%
  drop_na()

#Make species vector for labels
species_prob = prey_prob_ord %>%
  drop_na() %>%
  select(prey_sp)

```

```{r NMDS check ordination - ADULT}
#Adult prey
#Bray Curtis Dissim
trait_adult_bray = metaMDS(prey_adults_ord_use, 
                     distance = "bray", 
                     k=3,
                     trymax = 100) #, distance = "gower", k=3
plot(trait_adult_bray)

trait_adult_gower = metaMDS(prey_adults_ord_use, 
                     distance = "gower", 
                     k=3,
                     trymax = 100) #, distance = "gower", k=3
plot(trait_adult_gower)

```
