---
title: "Albacore Diet TraitGLM P/A"
author: "Natasha Hardy"
date: "02/03/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Workspace}

# general
library(tidyverse)
library(readxl)
library(plyr)
library(dplyr)
library(devtools)
library(reshape2)
library(here)
"%notin%" = Negate('%in%')
here::here()
library(pander)

# graphics
library(ggplot2)
library(lattice)
library(graphics)
library(RColorBrewer)
library(gridExtra)
library(captioner)
library(viridis)
library("grid")
library("ggplotify")


#modelling
library(Hmisc)
library(mgcv)
library(unmarked)
library(lme4)
library(mvabund)
library(tweedie)
library(vegan)

## mvabund bug source code??

```

## About

This document contains code for data manipulation, refinement and conversion to presence absence, as well as conducting multivariate community analyses and traitglm on albacore diets across ocean basins.

**Issues**

- nMDS ordination reporting extremely low stress, so underdispersed data.

- Maybe exclude species with < 1% occurrence?

## Data (L)

Load frequency of occurrence data.

```{r Species %FO (L) - load data}

#Upload + manipulate Species & Covar DF
#Doesn't like the here() function now for some reason
alb_adult_fo = read.csv(paste(here("data/output_data/alb_global_wide_dietfo.csv"),
                                   sep=""), check.names=FALSE, row.names = 1) %>%
  dplyr::select(StudyID:ncol(.), -grouped_id) #-c(, `Diplospinus multistriatus`, `Sardina pilchardus`)

#SHOULD EXCULDE ANYTHING WITH %fo < 1%
#This will have been done in Albacore_data_manip.Rmd at point of dataframe creation

#Main DF
head(alb_adult_fo)
```

Manipulate and subset data.

```{r Species %FO (L) - manipulate}
#Check for empty columns
which(colSums(alb_adult_fo[,14:ncol(alb_adult_fo)])==0) #None! #Otherwise remove these
#Check for empty rows
which(rowSums(alb_adult_fo[,14:ncol(alb_adult_fo)])==0) #Remove these - this becomes a thing once we start removing outlier species
#None

#Subset species df
#If removing species
alb_adult_prey = alb_adult_fo[,14:ncol(alb_adult_fo)]
names(alb_adult_prey) <- str_replace_all(names(alb_adult_prey), " ", "_")

#check df
#dim(alb_adult_prey) #137 species & 225 observations
#str(alb_adult_prey) #data are integers & numeric

#Round to no decimal places if needed
#alb_adult_prey[,1:ncol(alb_adult_prey)] =  round(alb_adult_prey[,1:ncol(alb_adult_prey)], digits = 1)
#Convert to integer values
#alb_adult_prey[,1:ncol(alb_adult_prey)] =  lapply(alb_adult_prey[,1:ncol(alb_adult_prey)], as.integer)
#Try numeric
alb_adult_prey[,1:ncol(alb_adult_prey)] =  lapply(alb_adult_prey[,1:ncol(alb_adult_prey)], as.numeric)

#make mvabund object #sometimes some fiddling required [,1:ncol(alb_adult_prey)], check.names = FALSE
alb_adult_prey_mv <- as.mvabund(alb_adult_prey) 

#All species names have to match up for both dfs
colnames(alb_adult_prey_mv) == names(alb_adult_prey) #hell yes

```

Convert data to presence absence.

```{r Species PA (L)}

#Convert to presence/absence
alb_adult_preyPA = alb_adult_prey
alb_adult_preyPA[alb_adult_preyPA>0] = 1
alb_adult_preyPA_df = cbind(alb_adult_fo[,1:13], alb_adult_preyPA)

alb_adult_preyPA_mv = as.mvabund(alb_adult_preyPA)

#Remove low occurrence species?
#Remove columns that contain < 2 occurrences #can vary this number
alb_adult_preyPA_df2 = alb_adult_preyPA_df[,-which(colSums(alb_adult_preyPA_df[,14:ncol(alb_adult_preyPA_df)])<2)]
#Not sure why some explanatory variable columns disappear also, so adding them back in:
alb_adult_preyPA_df3 = cbind(alb_adult_preyPA_df2[,1:13], alb_adult_preyPA_df2[,12:ncol(alb_adult_preyPA_df2)])
#Then delete rows that sum to zero for the trait occurrences
alb_adult_preyPA_df2.0 = alb_adult_preyPA_df3[-which(rowSums(alb_adult_preyPA_df3[14:ncol(alb_adult_preyPA_df3)])==0),] #209 observations of 144 traits

alb_adult_site_PA <- as.data.frame(alb_adult_preyPA_df2.0[,1:13])
alb_adult_spp_PA <- alb_adult_preyPA_df2.0[,14:ncol(alb_adult_preyPA_df2.0)] #144 trait columns

#write.csv(review_traits_mv, "review_traits_mv.csv")
#review_traits_mv <- read_csv("review_traits4.0V.scsv")

```

## Visualise data - nMDS

```{r Visualise - nMDS ordinations PA}


#PA
alb_adult_nMDS_pa = metaMDS(alb_adult_spp_PA, 
                         distance="bray", 
                         trymax = 100, #1000
                         k=3) #could increase to k = 4

#Note pb with this!! insufficient data?

pl <- ordiplot(alb_adult_nMDS_pa, type = "none")
points(pl, "sites", pch=21, col="red", bg="yellow")
text(pl, "species", col="blue", cex=0.9)

```

## Covars (R)

```{r Covars (R) - summary}

#Summary stats on covars
#unique(alb_adult_fo$StudyID) #22 studies
#unique(alb_adult_fo$OceanBasin) #6 Ocean basins
#unique(alb_adult_fo$OceanBasinQ) #10 Ocean basin quarters, but data gets thin for many
#unique(alb_adult_fo$YearEnd) #12 years (or groups of years) are represented in this study
#unique(alb_adult_fo$code) #10 Longhurst provinces represented, similar to Ocean Basin Q but also gets thin
#unique(alb_adult_fo$pred_life) #
```

```{r Covars (R) - select}

#Clean covars
alb_adult_covars = alb_adult_fo[,1:13] %>%
  mutate(pred_life=case_when(pred_life == "juvenile" ~ "juvenile",
                             pred_life == "juvenile, adult" ~ "mixed",
                             pred_life == "adult" ~ "adult",
                             pred_life == "none" ~ "mixed")) #"none" ~ "none"
alb_adult_covars[,1:ncol(alb_adult_covars)] =  lapply(alb_adult_covars[,1:ncol(alb_adult_covars)], as.factor)
```

```{r Covars (R) checking, eval=FALSE}
#Check representation
#summary(alb_adult_covars)

summary(alb_adult_covars$lat_cat)
#temperate  tropical 
#    193        32 

summary(alb_adult_covars$pred_life)
#   adult juvenile    mixed 
#     54       64      107 
#Going to simply merge the "none" with "mixed" group for now.



summary(alb_adult_covars$OceanBasin)
#           Indian Mediterranean    N Atlantic     N Pacific    S Atlantic     S Pacific 
#            15            29            88            66            10            17 

summary(alb_adult_covars$OceanBasinQ)
#Mediterranean   NE Atlantic    NE Pacific   NW Atlantic    NW Indian     NW Pacific   SE Atlantic   SW Atlantic    SW Indian  
#           29            84            52             4             3            14             7             3            12 
#   SW Pacific 
#           17 
summary(alb_adult_covars$code)
#ARCH CCAL ISSG MEDI NADR NASW NECS NPPF NPTG SATL 
#  17   50   22   16   92    4    5   14    2    3
#Need to exclude NASW, NECS, NPTG, SATL

str(alb_adult_covars)
dim(alb_adult_covars) #225 observations for 13 covars
#Best covars ==> pred_life, OceanBasin, lat_cat, and maybe code (Longhurst) - but need to exclude low numbered levels.

```

```{r Covars (R) levels}
str(alb_adult_covars)

#Levels predator life stage
levels(alb_adult_covars$pred_life)
alb_adult_covars$pred_life <- factor(alb_adult_covars$pred_life, 
                                            levels = c("mixed", "adult", "juvenile"))

#Levels OceanBasin
levels(alb_adult_covars$OceanBasin)
alb_adult_covars$pred_life <- factor(alb_adult_covars$pred_life, 
                                            levels = c("mixed", "adult", "juvenile"))

```


## Traits ADULTS (Q)

```{r Trait DF manip (Q)}

#Trait DF
alb_adult_traits = read.csv(paste(here("data/output_data/adult.prey.clusternum.habgreg.aggl.k9.csv"), sep=""), header=T, row.names = 1) %>%
  dplyr::select(prey_sp:adult.clust.num) 

alb_adult_traits$prey_sp = str_replace_all(alb_adult_traits$prey_sp, " ", "_")

alb_adult_traits = alb_adult_traits %>%
  filter(prey_sp %in% names(alb_adult_prey)) #need trait values for 158 spp.

rownames(alb_adult_traits) <- alb_adult_traits$prey_sp

alb_adult_traits <- alb_adult_traits[ order(row.names(alb_adult_traits)), ]

#Ensure traits are treated as factors for now
alb_adult_traits[,1:8] <- lapply(alb_adult_traits[,1:8] , factor) #to convert to factors
str(alb_adult_traits)

## Make sure species names match abund matrix
rownames(alb_adult_traits) == colnames(alb_adult_prey) #awesome!
# And the mvabund matrix
rownames(alb_adult_traits) == colnames(alb_adult_prey_mv) #awesome!


```

```{r Trait values check}

summary(alb_adult_traits$vertical.habitat) #merge bathypelagic and mesopelagic

summary(alb_adult_traits$horizontal.habitat) #potential merger of continental shelf/slope, and coastal/reef assoc.

summary(alb_adult_traits$diel.migrant)

summary(alb_adult_traits$refuge.use)

summary(alb_adult_traits$seasonal.migrant)

summary(alb_adult_traits$gregarious)

summary(alb_adult_traits$adult.clust.num)

```

```{r Trait factor levels}

str(alb_adult_traits)

#Levels vertical habitat
levels(alb_adult_traits$vertical.habitat)
alb_adult_traits$vertical.habitat <- factor(alb_adult_traits$vertical.habitat, 
                                            levels = c("benthic", "demersal", "epipelagic",
                                                       "mesopelagic", "bathypelagic"),
                                            labels = c("benthic", "demersal", "epipelagic",
                                                       "mesopelagic", "mesopelagic"))
#Too low sample size for bathypelagic, merged with mesopelagic here

#Levels horizontal habitat
levels(alb_adult_traits$horizontal.habitat)
alb_adult_traits$horizontal.habitat <- factor(alb_adult_traits$horizontal.habitat, 
                                            levels = c("reef-associated", "coastal", 
                                                       "continental shelf", "continental slope",
                                                       "oceanic"),
                                            labels = c("coastal", "coastal", 
                                                       "continental shelf", "continental shelf",
                                                       "oceanic"))

#Levels diel migrant
#levels(alb_adult_traits$diel.migrant)
#Great don't change this

#Levels seasonal migrant
#levels(alb_adult_traits$seasonal.migrant)
#Great don't change this

#Levels gregarious
#levels(alb_adult_traits$gregarious)
alb_adult_traits$gregarious <- factor(alb_adult_traits$gregarious, 
                                            levels = c("solitary", "schooling"))

```


## DF checks

```{r Subsets + check covars & df dims for data #4}
#Check df dims
#dim(alb_adult_prey_mv) #225 observations for 137 species
#dim(alb_adult_traits[,2:7]) #137 species and 6 traits
#dim(alb_adult_covars) #225 observations and 13 co-variates
#ALL DF'S LINE UP

```

```{r Select covars + traits}

#Select some covars & traits
ocean = alb_adult_covars$OceanBasin
ocean_b = alb_adult_covars$OceanBasinQ
longhurst = alb_adult_covars$code
pred_life = alb_adult_covars$pred_life
lat = alb_adult_covars$lat_cat

#All traits to try
traits_try = alb_adult_traits[,c(2:4,6:7)]
str(traits_try) #107 species and subset of 2 traits

trait_clust = as.data.frame(alb_adult_traits[,8])
  
```


## TRAIT GLM
### Presence/Absence Data

(i) First check manyglm routine
(It works! Now we can play with traitglm)
**NOTE** These data do not look good.

```{r ManyGLM #4}

#Fit ManyGLM to ensure the matrix works
## Run trial manyglm() to check for problems
adult_prey_many <- manyglm(alb_adult_prey_mv ~ ocean, family="negative.binomial")
plot(adult_prey_many) #check model residuals

#adult_prey_m4_anova <- anova.manyglm(adult_prey_m4)


```

(ii) Second fit a traitglm to just species + one or two covars excluding the traits
(This also worked)
```{r TraitGLM - predator age test1}

# load correction to traitglm:
source("traitglm.R")
source("get_polys.R")

trait_life <- traitglm(L = alb_adult_prey_mv,
                      R =  pred_life, #pred_life4,
                      method="manyglm"
                      )

#Check model output - residuals TEST
qqnorm(residuals(trait_life)[which(residuals(trait_life)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(trait_life)[is.finite((residuals(trait_life)))]
plot(resids.full)
abline(c(0,0),col="red")

```

(iii) Try adding traits

```{r TraitGLM - predator age test2}

trait_life <- traitglm(L = alb_adult_preyPA_mv,
                      R =  pred_life,                       
                      Q = traits_try
                      ) #note default is "manyglm"

#Check model output - residuals TEST
qqnorm(residuals(trait_life)[which(residuals(trait_life)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(trait_life)[is.finite((residuals(trait_life)))]
plot(resids.full)
abline(c(0,0),col="red")

```

(iv) Adding method="glm1path"
This is where it breaks if using frequency of occurrence data...

```{r TraitGLM - predator age test3}

trait_life <- traitglm(L = alb_adult_preyPA_mv,
                      R =  pred_life,                       
                      Q = traits_try,
                      #family=binomial(link = "logit")
                      method="glm1path"
                      ) #note default is "manyglm"

#Check model output - residuals TEST
qqnorm(residuals(trait_life)[which(residuals(trait_life)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(trait_life)[is.finite((residuals(trait_life)))]
plot(resids.full)
abline(c(0,0),col="red")

```

```{r Plot 4th corner}

a        = max( abs(trait_life$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(trait_life$fourth.corner))

#rownames(temp) = c("Region: Ocean Basin")
#colnames(temp) = c("Trophic group: Benthic Invertivore",
#                   "Trophic group: Browsing Herbivore",
#                   "Trophic group: Mesopredator",
#                   "Trophic group: Planktivore",
#                   "Solitary",
#                   "Schooling",
#                   "Pairs/groups",
#                   "Known prey",
#                   "Potential prey",
#                   "Bathypelagic")
plot.4th = levelplot(temp, 
                     xlab=list("Environmental Variables", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(plot.4th)

#ggsave(here("output_figures/diet_mvtraits/fourth_lifestage.png"), plot.4th, width=8, height=8, dpi=300)

```
(v) Adding method="glm1path"

### Predator Life Stage

ManyGLM traitglm


```{r TraitGLM - predator age binom distribution}
#Change levels of predator life stage

trait_life_many <- traitglm(L = alb_adult_preyPA_mv,
                      R =  pred_life,                       
                      Q = traits_try,
                      family=binomial(link = "logit")#,
                      #method="glm1path"
                      ) #note default is "manyglm"

#Check model output - residuals TEST
qqnorm(residuals(trait_life_many)[which(residuals(trait_life_many)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(trait_life_many)[is.finite((residuals(trait_life_many)))]
plot(resids.full); abline(c(0,0),col="red")

```

```{r Plot 4th corner - binom}

a        = max( abs(trait_life_many$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(trait_life_many$fourth.corner))

rownames(temp) = c("Adult", "Juvenile") #, "Mixed"
colnames(temp) = c("Vert. habitat - demersal",
                   "Vert. habitat - epipelagic",
                   "Vert. habitat - mesopelagic",
                   "Horz. habitat - continental shelf",
                   "Horz. habitat - oceanic",
                   "Diel migrant (yes)",
                   "Seasonal migrant (yes)",
                   "Gregarious - schooling")

trait_life_many_4th = levelplot(temp, 
                     xlab=list("Predator Life Stage", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(trait_life_many_4th)

#trait_life_4th = as.ggplot(trait_life_4th)

ggsave(here("outputs_figures/traitglms/trait_life_4th_v2.pdf"), plot = as.ggplot(trait_life_many_4th), width=12, height=12, dpi=300)

#dev.copy2pdf(file=here("./outputs_figures/traitglms/fourth_lifestage.png"), width=12, height=5)

```

Using binomial (logit link) function - glm1path traitglm with LASSO penalty.

```{r TraitGLM - predator age binom distribution}

trait_life_binom <- traitglm(L = alb_adult_preyPA_mv,
                      R =  pred_life,                       
                      Q = traits_try,
                      family=binomial(link = "logit"),
                      method="glm1path"
                      ) #note default is "manyglm"

#Check model output - residuals TEST
x11()

qqnorm(residuals(trait_life_binom)[which(residuals(trait_life_binom)<10000)]); abline(c(0,1),col="red")

dev.copy(device = x11)

dev.copy2pdf(file="/Users/tashhardy/Documents/GitHub/albacore-diet-global/outputs_figures/traitglms/trait_life_binom_QQ.pdf", width=5, height=5)

#omit non-finite residuals FULL MODEL
resids.full = residuals(trait_life_binom)[is.finite((residuals(trait_life_binom)))]
plot(resids.full); abline(c(0,0),col="red")
dev.copy(device = x11)
dev.copy2pdf(file="/Users/tashhardy/Documents/GitHub/albacore-diet-global/outputs_figures/traitglms/trait_life_binom_resids.pdf", width=5, height=5)

```

```{r Plot 4th corner - binom}

a        = max( abs(trait_life_binom$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(trait_life_binom$fourth.corner))

rownames(temp) = c("Mixed", "Adult", "Juvenile")
colnames(temp) = c("Vert. habitat - benthic",
                   "Vert. habitat - demersal",
                   "Vert. habitat - epipelagic",
                   "Vert. habitat - mesopelagic",
                   "Horz. habitat - coastal",
                   "Horz. habitat - continental shelf",
                   "Horz. habitat - oceanic",
                   "Diel migrant (yes)",
                   "Seasonal migrant (yes)",
                   "Gregarious - schooling")

trait_life_4th_LASSO = levelplot(temp, 
                     xlab=list("Predator Life Stage", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(trait_life_4th_LASSO)


ggsave(here("outputs_figures/traitglms/trait_life_4th_LASSO.pdf"), plot = as.ggplot(trait_life_4th_LASSO), width=12, height=12, dpi=300)

#dev.copy2pdf(file=here("./outputs_figures/traitglms/fourth_lifestage.png"), width=12, height=5)

```

Using negative binomial function - data are overdispersed.

```{r TraitGLM - predator age neg bin distribution}

trait_life_negbin <- traitglm(L = alb_adult_preyPA_mv,
                      R =  pred_life,                       
                      Q = traits_try,
                      #family=binomial(link = "logit"),
                      method="glm1path"
                      ) #note default is "manyglm"

#Check model output - residuals TEST
qqnorm(residuals(trait_life_negbin)[which(residuals(trait_life_negbin)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(trait_life_negbin)[is.finite((residuals(trait_life_negbin)))]
plot(resids.full)
abline(c(0,0),col="red")

```

```{r Plot 4th corner - neg bin}

a        = max( abs(trait_life_negbin$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(trait_life_negbin$fourth.corner))

#rownames(temp) = c("Region: Ocean Basin")
#colnames(temp) = c("Trophic group: Benthic Invertivore",
#                   "Trophic group: Browsing Herbivore",
#                   "Trophic group: Mesopredator",
#                   "Trophic group: Planktivore",
#                   "Solitary",
#                   "Schooling",
#                   "Pairs/groups",
#                   "Known prey",
#                   "Potential prey",
#                   "Bathypelagic")
plot.4th = levelplot(temp, 
                     xlab=list("Environmental Variables", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(plot.4th)

#ggsave(here("output_figures/diet_mvtraits/fourth_lifestage.png"), plot.4th, width=8, height=8, dpi=300)

```

### Ocean Basin

Manyglm

```{r TraitGLM - ocean manyglm binom}
#levels(ocean)

#ocean <- factor(ocean, levels = c("Mediterranean", "N Atlantic", "S Atlantic", "N Pacific", "S Pacific", "Indian"))

trait_ocean_binom_many <- traitglm(L = alb_adult_preyPA_mv,
                      R =  ocean,                       
                      Q = traits_try,
                      family=binomial(link = "logit")
                      ) #note default is "manyglm"

#Check model output - residuals TEST
qqnorm(residuals(trait_ocean_binom_many)[which(residuals(trait_ocean_binom_many)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(trait_ocean_binom_many)[is.finite((residuals(trait_ocean_binom_many)))]
plot(resids.full); abline(c(0,0),col="red")

```

```{r Plot 4th corner - ocean many}

a        = max( abs(trait_ocean_binom_many$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(trait_ocean_binom_many$fourth.corner))

rownames(temp) = c(#"Mediterranean",
                   "N Atlantic",
                   "S Atlantic",
                   "N Pacific",
                   "S Pacific",
                   "Indian")

colnames(temp) = c("Vert. habitat - demersal",
                   "Vert. habitat - epipelagic",
                   "Vert. habitat - mesopelagic",
                   "Horz. habitat - continental shelf",
                   "Horz. habitat - oceanic",
                   "Diel migrant (yes)",
                   "Seasonal migrant (yes)",
                   "Gregarious - schooling")

trait_ocean_4th_many = levelplot(temp, 
                     xlab=list("Ocean Basins", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(trait_ocean_4th_many)

ggsave(here("outputs_figures/traitglms/trait_ocean_4th_many.pdf"), plot = as.ggplot(trait_ocean_4th_many), width=12, height=12, dpi=300)

```

Using binomial (logit link) function + glm1path LASSO model

```{r TraitGLM - ocean LASSO binom distribution}
levels(ocean)

ocean <- factor(ocean, levels = c("Mediterranean", "N Atlantic", "S Atlantic", "N Pacific", "S Pacific", "Indian"))

trait_ocean_binom <- traitglm(L = alb_adult_preyPA_mv,
                      R =  ocean,                       
                      Q = traits_try,
                      family=binomial(link = "logit"),
                      method="glm1path"
                      ) #note default is "manyglm"

#Check model output - residuals TEST
x11()
qqnorm(residuals(trait_ocean_binom)[which(residuals(trait_ocean_binom)<10000)]); abline(c(0,1),col="red")
dev.copy(device = x11)
dev.copy2pdf(file="/Users/tashhardy/Documents/GitHub/albacore-diet-global/outputs_figures/traitglms/trait_ocean_binom_QQ.pdf", width=5, height=5)

#omit non-finite residuals FULL MODEL
resids.full = residuals(trait_ocean_binom)[is.finite((residuals(trait_ocean_binom)))]
plot(resids.full); abline(c(0,0),col="red")
dev.copy(device = x11)
dev.copy2pdf(file="/Users/tashhardy/Documents/GitHub/albacore-diet-global/outputs_figures/traitglms/trait_ocean_binom_resids.pdf", width=5, height=5)
```

```{r Plot 4th corner - ocean LASSO}

a        = max( abs(trait_ocean_binom$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(trait_ocean_binom$fourth.corner))

rownames(temp) = c("Mediterranean",
                   "N Atlantic",
                   "S Atlantic",
                   "N Pacific",
                   "S Pacific",
                   "Indian")

colnames(temp) = c("Vert. habitat - benthic",
                   "Vert. habitat - demersal",
                   "Vert. habitat - epipelagic",
                   "Vert. habitat - mesopelagic",
                   "Horz. habitat - coastal",
                   "Horz. habitat - continental shelf",
                   "Horz. habitat - oceanic",
                   "Diel migrant (yes)",
                   "Seasonal migrant (yes)",
                   "Gregarious - schooling")

trait_ocean_4th_LASSO = levelplot(temp, 
                     xlab=list("Ocean Basins", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(trait_ocean_4th_LASSO)

#trait_ocean_4th = as.ggplot(trait_ocean_4th)

ggsave(here("outputs_figures/traitglms/trait_ocean_4th_LASSO.pdf"), plot = as.ggplot(trait_ocean_4th_LASSO), width=12, height=12, dpi=300)

```

```{r Plot 2nd corner - ocean LASSO}

```


### Ocean Basin Q - DON'T USE

Note that there isn't enough replication of studies to use this factor.

Using binomial (logit link) function.

```{r TraitGLM - predator age binom distribution}
summary(ocean_b)

trait_ocean_b_binom <- traitglm(L = alb_adult_preyPA_mv,
                      R =  ocean_b,                       
                      Q = traits_try,
                      family=binomial(link = "logit"),
                      method="glm1path"
                      ) #note default is "manyglm"

#Check model output - residuals TEST
qqnorm(residuals(trait_ocean_b_binom)[which(residuals(trait_ocean_b_binom)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(trait_ocean_b_binom)[is.finite((residuals(trait_ocean_b_binom)))]
plot(resids.full); abline(c(0,0),col="red")

```

```{r Plot 4th corner - binom}

a        = max( abs(trait_ocean_b_binom $fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(trait_ocean_b_binom $fourth.corner))

rownames(temp) = c("Mediterranean",
                   "NE Atlantic",
                   "NE Pacific",
                   "NW Atlantic",
                   "NW Indian",
                   "NW Pacific",
                   "SE Atlantic",
                   "SW Atlantic",
                   "SW Indian",
                   "SW Pacific")

colnames(temp) = c("Vert. habitat - benthic",
                   "Vert. habitat - demersal",
                   "Vert. habitat - epipelagic",
                   "Vert. habitat - mesopelagic",
                   "Vert. habitat - bathypelagic",
                   "Horz. habitat - reef-associated",
                   "Horz. habitat - coastal",
                   "Horz. habitat - continental shelf",
                   "Horz. habitat - continental slope",
                   "Horz. habitat - oceanic",
                   "Diel migrant (yes)",
                   "Seasonal migrant (yes)",
                   "Gregarious - schooling")

trait_ocean_b_4th = levelplot(temp, 
                     xlab=list("Ocean Basin (Quaters)", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(trait_ocean_b_4th)

#trait_ocean_b_4th = as.ggplot(trait_ocean_b_4th)

ggsave(here("outputs_figures/traitglms/trait_ocean_b_4th.pdf"), plot = as.ggplot(trait_ocean_b_4th), width=12, height=12, dpi=300)

```

### Temperate / Tropical

Using binomial (logit link) function.

```{r TraitGLM - predator age binom distribution}

trait_lat_binom <- traitglm(L = alb_adult_preyPA_mv,
                      R =  lat,                       
                      Q = traits_try,
                      family=binomial(link = "logit"),
                      method="glm1path"
                      ) #note default is "manyglm"

#Check model output - residuals TEST
x11()
qqnorm(residuals(trait_lat_binom)[which(residuals(trait_lat_binom)<10000)]); abline(c(0,1),col="red")
dev.copy(device = x11)
dev.copy2pdf(file="/Users/tashhardy/Documents/GitHub/albacore-diet-global/outputs_figures/traitglms/trait_lat_binom_QQ.pdf", width=5, height=5)

#omit non-finite residuals FULL MODEL
resids.full = residuals(trait_lat_binom)[is.finite((residuals(trait_lat_binom)))]
plot(resids.full); abline(c(0,0),col="red")
dev.copy(device = x11)
dev.copy2pdf(file="/Users/tashhardy/Documents/GitHub/albacore-diet-global/outputs_figures/traitglms/trait_lat_binom_resids.pdf", width=5, height=5)
```

```{r Plot 4th corner - binom}

a        = max( abs(trait_lat_binom$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(trait_lat_binom$fourth.corner))

rownames(temp) = c("Tropical")

colnames(temp) = c("Vert. habitat - benthic",
                   "Vert. habitat - demersal",
                   "Vert. habitat - epipelagic",
                   "Vert. habitat - mesopelagic",
                   "Horz. habitat - coastal",
                   "Horz. habitat - continental shelf",
                   "Horz. habitat - oceanic",
                   "Diel migrant (yes)",
                   "Seasonal migrant (yes)",
                   "Gregarious - schooling")

trait_lat_4th_LASSO = levelplot(temp, 
                     xlab=list("Temperate vs. Tropical", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(trait_lat_4th_LASSO)

ggsave(here("outputs_figures/traitglms/trait_lat_4th_LASSO.pdf"), plot = as.ggplot(trait_lat_4th_LASSO), width=12, height=12, dpi=300)

```

### Longhurst Province - DON'T USE

**NOTE:** Traitglm for Longhurst provinces provides mostly non-significant relationships, likely too few data for each longhurst province sampled.

Using binomial (logit link) function.

```{r TraitGLM - predator age binom distribution, eval = FALSE, include = FALSE}

trait_longhurst_binom <- traitglm(L = alb_adult_preyPA_mv,
                      R =  longhurst,                       
                      Q = traits_try,
                      family=binomial(link = "logit"),
                      method="glm1path"
                      ) #note default is "manyglm"

#Check model output - residuals TEST
qqnorm(residuals(trait_longhurst_binom)[which(residuals(trait_longhurst_binom)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(trait_longhurst_binom)[is.finite((residuals(trait_longhurst_binom)))]
plot(resids.full); abline(c(0,0),col="red")

```

```{r Plot 4th corner - binom, eval = FALSE, include = FALSE}

a        = max( abs(trait_longhurst_binom$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(trait_longhurst_binom$fourth.corner))

#rownames(temp) = c("Region: Ocean Basin")
#colnames(temp) = c("Trophic group: Benthic Invertivore",
#                   "Trophic group: Browsing Herbivore",
#                   "Trophic group: Mesopredator",
#                   "Trophic group: Planktivore",
#                   "Solitary",
#                   "Schooling",
#                   "Pairs/groups",
#                   "Known prey",
#                   "Potential prey",
#                   "Bathypelagic")
plot.4th = levelplot(temp, 
                     xlab=list("Environmental Variables", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(plot.4th)

#ggsave(here("output_figures/diet_mvtraits/fourth_lifestage.png"), plot.4th, width=8, height=8, dpi=300)

```
