---
title: "Albacore Diet TraitGLM P/A"
author: "Natasha Hardy"
date: "02/03/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Workspace}

# general
library(tidyverse)
library(readxl)
library(plyr)
library(dplyr)
library(devtools)
library(reshape2)
library(here)
"%notin%" = Negate('%in%')
here::here()
library(pander)

# graphics
library(ggplot2)
library(lattice)
library(graphics)
library(RColorBrewer)
library(gridExtra)
library(captioner)
library(viridis)
library("grid")
library("ggplotify")


#modelling
library(Hmisc)
library(mgcv)
library(unmarked)
library(lme4)
library(mvabund)
library(tweedie)
library(vegan)

## mvabund bug source code??

```

## About

This document contains code for data manipulation, refinement and conversion to presence absence, as well as conducting multivariate community analyses and traitglm on albacore diets across ocean basins.

**Issues**

- nMDS ordination reporting extremely low stress, so underdispersed data.

- Maybe exclude species with < 1% occurrence?

## Data (L)

Load frequency of occurrence data.

```{r Species %FO (L) - load data}

#Upload + manipulate Species & Covar DF
#Doesn't like the here() function now for some reason
alb_prob_fo = read.csv(paste(here("data/output_data/alb_global_wide_dietfo.csv"),
                                   sep=""), check.names=FALSE, row.names = 1) %>%
  dplyr::select(StudyID:ncol(.), -grouped_id) #-c(, `Diplospinus multistriatus`, `Sardina pilchardus`)

#SHOULD EXCULDE ANYTHING WITH %fo < 1%
#This will have been done in Albacore_data_manip.Rmd at point of dataframe creation

#Main DF
#head(alb_adult_fo)
#names(alb_prob_fo)

```

Manipulate and subset data.
Here we obtain 137 species as columns and 225 obs.

```{r Species %FO (L) - manipulate}
#Check for empty columns
which(colSums(alb_adult_fo[,14:ncol(alb_adult_fo)])==0) #None! #Otherwise remove these
#Check for empty rows
which(rowSums(alb_adult_fo[,14:ncol(alb_adult_fo)])==0) #Remove these - this becomes a thing once we start removing outlier species
#None

#Subset species df
#If removing species
alb_adult_prey = alb_adult_fo[,14:ncol(alb_adult_fo)]
names(alb_adult_prey) <- str_replace_all(names(alb_adult_prey), " ", "_")

#check df
#dim(alb_adult_prey) #137 species & 225 observations
#str(alb_adult_prey) #data are integers & numeric

#Round to no decimal places if needed
#alb_adult_prey[,1:ncol(alb_adult_prey)] =  round(alb_adult_prey[,1:ncol(alb_adult_prey)], digits = 1)
#Convert to integer values
#alb_adult_prey[,1:ncol(alb_adult_prey)] =  lapply(alb_adult_prey[,1:ncol(alb_adult_prey)], as.integer)
#Try numeric
alb_adult_prey[,1:ncol(alb_adult_prey)] =  lapply(alb_adult_prey[,1:ncol(alb_adult_prey)], as.numeric)

#make mvabund object #sometimes some fiddling required [,1:ncol(alb_adult_prey)], check.names = FALSE
alb_adult_prey_mv <- as.mvabund(alb_adult_prey) 

#All species names have to match up for both dfs
colnames(alb_adult_prey_mv) == names(alb_adult_prey) #hell yes

```

Convert data to presence absence.

```{r Species PA (L)}

#Convert to presence/absence
alb_adult_preyPA = alb_adult_prey
alb_adult_preyPA[alb_adult_preyPA>0] = 1
alb_adult_preyPA_df = cbind(alb_adult_fo[,1:13], alb_adult_preyPA)

alb_adult_preyPA_mv = as.mvabund(alb_adult_preyPA)

#Remove low occurrence species?
#Remove columns that contain < 2 occurrences #can vary this number
alb_adult_preyPA_df2 = alb_adult_preyPA_df[,-which(colSums(alb_adult_preyPA_df[,14:ncol(alb_adult_preyPA_df)])<2)]
#Not sure why some explanatory variable columns disappear also, so adding them back in:
alb_adult_preyPA_df3 = cbind(alb_adult_preyPA_df2[,1:13], alb_adult_preyPA_df2[,12:ncol(alb_adult_preyPA_df2)])
#Then delete rows that sum to zero for the trait occurrences
alb_adult_preyPA_df2.0 = alb_adult_preyPA_df3[-which(rowSums(alb_adult_preyPA_df3[14:ncol(alb_adult_preyPA_df3)])==0),] #209 observations of 144 traits

alb_adult_site_PA <- as.data.frame(alb_adult_preyPA_df2.0[,1:13])
alb_adult_spp_PA <- alb_adult_preyPA_df2.0[,14:ncol(alb_adult_preyPA_df2.0)] #144 trait columns

#write.csv(review_traits_mv, "review_traits_mv.csv")
#review_traits_mv <- read_csv("review_traits4.0V.scsv")

```

## Visualise data - nMDS

```{r Visualise - nMDS ordinations PA}


#PA
alb_adult_nMDS_pa = metaMDS(alb_adult_spp_PA, 
                         distance="bray", 
                         trymax = 100, #1000
                         k=3) #could increase to k = 4

#Note pb with this!! insufficient data?

pl <- ordiplot(alb_adult_nMDS_pa, type = "none")
points(pl, "sites", pch=21, col="red", bg="yellow")
text(pl, "species", col="blue", cex=0.9)

```


## Traits PROBABLE (Q)

Note that we obtain 135 species and their traits, so we'll need to filter the species df by the traits.

```{r Trait DF manip (Q)}

#Trait DF
alb_prob_traits = read.csv(paste(here("data/output_data/prey_probable_traits.csv"), sep=""), header=T, row.names = 1) %>%
  dplyr::select(prey_sp:diel_migrant_cat, refuge_cat, season_cat, body_shape, gregarious_primary, -diel_migrant) 

#Relabel to add underscore in names
alb_prob_traits$prey_sp = str_replace_all(alb_prob_traits$prey_sp, " ", "_")
#Assign speces as rownames
rownames(alb_prob_traits) <- alb_prob_traits$prey_sp
#Order species list
alb_prob_traits <- alb_prob_traits[ order(row.names(alb_prob_traits)), ]

#Ensure traits are treated as factors for now
alb_prob_traits[,2:9] <- lapply(alb_prob_traits[,2:9], factor) #to convert to factors
str(alb_prob_traits)

```

```{r ALB PROB PREY FILTER}

alb_prob_prey = alb_adult_prey %>%
  dplyr::filter(names(alb_adult_prey) %in% alb_prob_traits$prey_sp)

```


```{r TRAIT SELECT & CLEAN}
alb_prob_traits = alb_prob_traits %>%
  filter(prey_sp %in% names(alb_adult_prey)) %>%
  #need trait values for 137 spp. but we obtain 135, so that means there are 2 species in the diet df that we don't have traits for.
  filter(diel_migrant_cat != "diel_UN",
         season_cat != "season_NA",
         vert_habitat != "bathypelagic",
         horz_habitat != "reef-associated",
         body_shape %notin% c("eel-like", "unique")) %>%
  mutate(gregarious_primary = case_when(gregarious_primary == "pairing" ~ "solitary",
                                        gregarious_primary == "schooling" ~ "schooling",
                                        gregarious_primary == "shoaling" ~ "shoaling",
                                        gregarious_primary == "solitary" ~ "solitary"
                                        )
         ) %>%
  dplyr::select(-body_shape)

alb_prob_traits[,2:8] <- lapply(alb_prob_traits[,2:8], factor) #to convert to factors

summary(alb_prob_traits)

```

```{r Trait - prob clust num}

alb_prob_clust = read.csv(paste(here("data/output_data/prob.prey.clusternum_habgreg.aggl.k8.csv"), 
                                sep=""), header=T, row.names = 1) #%>%
  #dplyr::filter(prey_sp %in% names(alb_adult_prey)) #note need to probably filter the prey list first, then this one to make sure there are not species in the prey list that are not in the trait list...
  #dplyr::select(prey_sp:pro.clust.num) 

```

## Covars (R)

```{r Covars (R) - summary}

#Summary stats on covars
#unique(alb_adult_fo$StudyID) #22 studies
#unique(alb_adult_fo$OceanBasin) #6 Ocean basins
#unique(alb_adult_fo$OceanBasinQ) #10 Ocean basin quarters, but data gets thin for many
#unique(alb_adult_fo$YearEnd) #12 years (or groups of years) are represented in this study
#unique(alb_adult_fo$code) #10 Longhurst provinces represented, similar to Ocean Basin Q but also gets thin
#unique(alb_adult_fo$pred_life) #
```

```{r Covars (R) - select}

#Clean covars
alb_adult_covars = alb_adult_fo[,1:13] %>%
  mutate(pred_life=case_when(pred_life == "juvenile" ~ "juvenile",
                             pred_life == "juvenile, adult" ~ "mixed",
                             pred_life == "adult" ~ "adult",
                             pred_life == "none" ~ "mixed")) #"none" ~ "none"
alb_adult_covars[,1:ncol(alb_adult_covars)] =  lapply(alb_adult_covars[,1:ncol(alb_adult_covars)], as.factor)

```

```{r Covars (R) checking, eval=FALSE}
#Check representation
#summary(alb_adult_covars)

summary(alb_adult_covars$lat_cat)
#temperate  tropical 
#    193        32 

summary(alb_adult_covars$pred_life)
#   adult juvenile    mixed 
#     54       64      107 
#Going to simply merge the "none" with "mixed" group for now.

summary(alb_adult_covars$OceanBasin)
#           Indian Mediterranean    N Atlantic     N Pacific    S Atlantic     S Pacific 
#            15            29            88            66            10            17 

summary(alb_adult_covars$OceanBasinQ)
#Mediterranean   NE Atlantic    NE Pacific   NW Atlantic    NW Indian     NW Pacific   SE Atlantic   SW Atlantic    SW Indian  
#           29            84            52             4             3            14             7             3            12 
#   SW Pacific 
#           17 
summary(alb_adult_covars$code)
#ARCH CCAL ISSG MEDI NADR NASW NECS NPPF NPTG SATL 
#  17   50   22   16   92    4    5   14    2    3
#Need to exclude NASW, NECS, NPTG, SATL

str(alb_adult_covars)
dim(alb_adult_covars) #225 observations for 13 covars
#Best covars ==> pred_life, OceanBasin, lat_cat, and maybe code (Longhurst) - but need to exclude low numbered levels.

```

## Species, Env and Trait manips

```{r Ensuring dataframe coherence}
str(alb_prob_traits)
str(alb_adult_preyPA)

#alb_adult_prey


alb_species_use <- alb_adult_preyPA[colnames(alb_adult_preyPA) %in% rownames(alb_prob_traits)]

which(colSums(alb_species_use) == 0)
which(rowSums(alb_species_use) == 0) #Need to remove from both the species and environment dfs

alb_species_use_final = alb_species_use[-c(31, 32, 58, 64, 69, 72, 79, 81, 86, 90, 102, 119, 140,
                                     141, 151, 156),]
#alb_adult_covars

alb_covars_use = alb_adult_covars[-c(31, 32, 58, 64, 69, 72, 79, 81, 86, 90, 102, 119, 140,
                                     141, 151, 156),]

#alb_probs_traits

```


## CHECK VARIABLES

```{r Trait factor levels}

str(alb_prob_traits)

#Q traits factors
alb_prob_traits[,2:ncol(alb_prob_traits)] <- lapply(alb_prob_traits[,2:ncol(alb_prob_traits)], as.factor) 

#Levels vertical habitat
levels(alb_prob_traits$vert_habitat)
summary(alb_prob_traits$vert_habitat)
#alb_prob_traits$vert_habitat <- factor(alb_prob_traits$vert_habitat,
#                                       levels = c("benthic", "demersal", "epipelagic",
#                                                  "mesopelagic"))
#Levels horizontal habitat
levels(alb_prob_traits$horz_habitat)
summary(alb_prob_traits$horz_habitat)
alb_prob_traits$horz_habitat<- factor(alb_prob_traits$horz_habitat,
                                      levels = c("coastal", "continental shelf",
                                                 "continental slope", "oceanic"),
                                      labels = c("coastal", "continental shelf",
                                                 "continental shelf", "oceanic"))

#Levels diel migrant
levels(alb_prob_traits$diel_migrant_cat)
summary(alb_prob_traits$diel_migrant_cat)
#Great don't change this

#Levels seasonal migrant
levels(alb_prob_traits$season_cat)
summary(alb_prob_traits$season_cat)
#Great don't change this

#Levels gregarious
levels(alb_prob_traits$gregarious_primary)
summary(alb_prob_traits$gregarious_primary)
alb_prob_traits$gregarious_primary <- factor(alb_prob_traits$gregarious_primary,
                                             levels = c("solitary", "shoaling", "schooling"))

```


## DF checks

```{r Check names and df dimensions}
## Make sure species names match abund matrix
rownames(alb_prob_traits) == colnames(alb_species_use_final) #awesome!
# And the mvabund matrix
alb_species_use_final_MV = as.mvabund(alb_species_use_final)

rownames(alb_prob_traits) == colnames(alb_species_use_final_MV) #awesome!

dim(alb_prob_traits) #117 species and 8 traits
dim(alb_species_use_final_MV) #209 obs, 117 species
dim(alb_covars_use) #209 obs, 13 variables

```

```{r Select covars + traits}

#Select some covars & traits
ocean = alb_covars_use$OceanBasin
ocean_b = alb_covars_use$OceanBasinQ
longhurst = alb_covars_use$code
pred_life = alb_covars_use$pred_life
lat = alb_covars_use$lat_cat

#All traits to try
traits_try = alb_prob_traits[,c(3:5,7:8)]
str(traits_try) #107 species and subset of 2 traits
```


## TRAIT GLM

### Presence/Absence Data

(i) First check manyglm routine
(It works! Now we can play with traitglm)
**NOTE** These data do not look good.

```{r ManyGLM #4}

#Fit ManyGLM to ensure the matrix works
## Run trial manyglm() to check for problems
adult_prob_many <- manyglm(alb_species_use_final_MV ~ ocean, family="negative.binomial")
plot(adult_prey_many) #check model residuals

#adult_prey_m4_anova <- anova.manyglm(adult_prey_m4)


```

(ii) Second fit a traitglm to just species + one or two covars excluding the traits
(This also worked)
```{r TraitGLM - predator age test1}

# load correction to traitglm:
source("traitglm.R")
source("get_polys.R")

trait_life <- traitglm(L = alb_species_use_final_MV,
                       R = ocean, #or pred_life
                       method="manyglm"
                       )

#Check model output - residuals TEST
qqnorm(residuals(trait_life)[which(residuals(trait_life)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(trait_life)[is.finite((residuals(trait_life)))]
plot(resids.full)
abline(c(0,0),col="red")

```

(iii) Try adding traits

```{r TraitGLM - predator age test2}

trait_life <- traitglm(L = alb_species_use_final_MV,
                       R =  pred_life,
                       Q = traits_try
                       ) #note default is "manyglm"

#Check model output - residuals TEST
qqnorm(residuals(trait_life)[which(residuals(trait_life)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(trait_life)[is.finite((residuals(trait_life)))]
plot(resids.full)
abline(c(0,0),col="red")

```

(iv) Adding method="glm1path"
This is where it breaks if using frequency of occurrence data...

```{r TraitGLM - predator age test3}

trait_life <- traitglm(L = alb_adult_preyPA_mv,
                      R =  pred_life,                       
                      Q = traits_try,
                      #family=binomial(link = "logit")
                      method="glm1path"
                      ) #note default is "manyglm"

#Check model output - residuals TEST
qqnorm(residuals(trait_life)[which(residuals(trait_life)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(trait_life)[is.finite((residuals(trait_life)))]
plot(resids.full)
abline(c(0,0),col="red")

```


```{r Plot 4th corner}

a        = max( abs(trait_life$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(trait_life$fourth.corner))

#rownames(temp) = c("Region: Ocean Basin")
#colnames(temp) = c("Trophic group: Benthic Invertivore",
#                   "Trophic group: Browsing Herbivore",
#                   "Trophic group: Mesopredator",
#                   "Trophic group: Planktivore",
#                   "Solitary",
#                   "Schooling",
#                   "Pairs/groups",
#                   "Known prey",
#                   "Potential prey",
#                   "Bathypelagic")
plot.4th = levelplot(temp, 
                     xlab=list("Environmental Variables", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(plot.4th)

#ggsave(here("output_figures/diet_mvtraits/fourth_lifestage.png"), plot.4th, width=8, height=8, dpi=300)

```
(v) Adding method="glm1path"

### Predator Life Stage

ManyGLM traitglm


```{r TraitGLM - predator age binom distribution}

trait_life_many <- traitglm(L = alb_species_use_final_MV,
                       R =  pred_life,
                       Q = traits_try
                       family=binomial(link = "logit")#,
                       #method="glm1path"
                       ) #note default is "manyglm"

#Check model output - residuals TEST
qqnorm(residuals(trait_life_many)[which(residuals(trait_life_many)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(trait_life_many)[is.finite((residuals(trait_life_many)))]
plot(resids.full); abline(c(0,0),col="red")

```

```{r Plot 4th corner - binom}

a        = max( abs(trait_life_many$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(trait_life_many$fourth.corner))

#rownames(temp) = c("Adult", "Juvenile", "Mixed")
#colnames(temp) = c("Vert. habitat - benthic",
#                   "Vert. habitat - demersal",
#                   "Vert. habitat - epipelagic",
#                   "Vert. habitat - mesopelagic",
#                   "Vert. habitat - bathypelagic",
#                   "Horz. habitat - reef-associated",
#                   "Horz. habitat - coastal",
#                   "Horz. habitat - continental shelf",
#                   "Horz. habitat - continental slope",
#                   "Horz. habitat - oceanic",
#                   "Diel migrant (yes)",
#                   "Seasonal migrant (yes)",
#                   "Gregarious - schooling")

trait_life_many_4th = levelplot(temp, 
                     xlab=list("Predator Life Stage", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(trait_life_many_4th)

#trait_life_4th = as.ggplot(trait_life_4th)

ggsave(here("outputs_figures/traitglms/trait_life_4th.pdf"), plot = as.ggplot(trait_life_many_4th), width=12, height=12, dpi=300)

#dev.copy2pdf(file=here("./outputs_figures/traitglms/fourth_lifestage.png"), width=12, height=5)

```

glm1path traitglm


Using binomial (logit link) function.

```{r TraitGLM - predator age binom distribution}

trait_life_binom <- traitglm(L = alb_species_use_final_MV,
                       R =  pred_life,
                       Q = traits_try,
                      family=binomial(link = "logit"),
                      method="glm1path"
                      ) #note default is "manyglm"

#Check model output - residuals TEST
qqnorm(residuals(trait_life_binom)[which(residuals(trait_life_binom)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(trait_life_binom)[is.finite((residuals(trait_life_binom)))]
plot(resids.full); abline(c(0,0),col="red")

```

```{r Plot 4th corner - binom}

a        = max( abs(trait_life_binom$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(trait_life_binom$fourth.corner))

rownames(temp) = c("Adult", "Juvenile", "Mixed")
colnames(temp) = c("Vert. habitat - benthic",
                   "Vert. habitat - demersal",
                   "Vert. habitat - epipelagic",
                   "Vert. habitat - mesopelagic",
                   "Horz. habitat - coastal",
                   "Horz. habitat - continental shelf",
                   "Horz. habitat - continental slope",
                   "Horz. habitat - oceanic",
                   "Diel migrant (yes)",
                   "Seasonal migrant (yes)",
                   "Gregarious - solitary",
                   "Gregarious - shoaling",
                   "Gregarious - schooling")

trait_life_4th = levelplot(temp, 
                     xlab=list("Predator Life Stage", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(trait_life_4th)
#trait_life_4th = as.ggplot(trait_life_4th)

ggsave(here("outputs_figures/traitglms/prob_trait_life_4th.pdf"), 
       plot = as.ggplot(trait_life_4th), width=12, height=12, dpi=300)

#dev.copy2pdf(file=here("./outputs_figures/traitglms/fourth_lifestage.png"), width=12, height=5)

```

Using negative binomial function - data are overdispersed.

```{r TraitGLM - predator age neg bin distribution}

trait_life_negbin <- traitglm(L = alb_species_use_final_MV,
                      R =  pred_life,                       
                      Q = traits_try,
                      #family=binomial(link = "logit"),
                      method="glm1path"
                      ) #note default is "manyglm"

#Check model output - residuals TEST
qqnorm(residuals(trait_life_negbin)[which(residuals(trait_life_negbin)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(trait_life_negbin)[is.finite((residuals(trait_life_negbin)))]
plot(resids.full)
abline(c(0,0),col="red")

```

```{r Plot 4th corner - neg bin}

a        = max( abs(trait_life_negbin$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(trait_life_negbin$fourth.corner))

rownames(temp) = c("Adult", "Juvenile", "Mixed")
colnames(temp) = c("Vert. habitat - benthic",
                   "Vert. habitat - demersal",
                   "Vert. habitat - epipelagic",
                   "Vert. habitat - mesopelagic",
                   "Horz. habitat - coastal",
                   "Horz. habitat - continental shelf",
                   "Horz. habitat - continental slope",
                   "Horz. habitat - oceanic",
                   "Diel migrant (yes)",
                   "Seasonal migrant (yes)",
                   "Gregarious - solitary",
                   "Gregarious - shoaling",
                   "Gregarious - schooling")

plot.4th = levelplot(temp, 
                     xlab=list("Environmental Variables", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(plot.4th)

#ggsave(here("output_figures/diet_mvtraits/fourth_lifestage.png"), plot.4th, width=8, height=8, dpi=300)

```

### Ocean Basin

Using binomial (logit link) function.

```{r TraitGLM - ocean basin binom distribution}

trait_ocean_binom <- traitglm(L = alb_species_use_final_MV,
                      R =  ocean,                       
                      Q = traits_try,
                      family=binomial(link = "logit"),
                      method="glm1path"
                      ) #note default is "manyglm"

#Check model output - residuals TEST
qqnorm(residuals(trait_ocean_binom)[which(residuals(trait_ocean_binom)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(trait_ocean_binom)[is.finite((residuals(trait_ocean_binom)))]
plot(resids.full); abline(c(0,0),col="red")

```

```{r Plot 4th corner - binom}

a        = max( abs(trait_ocean_binom$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(trait_ocean_binom$fourth.corner))

rownames(temp) = c("Indian",
                   "Mediterranean",
                   "N Atlantic",
                   "N Pacific",
                   "S Atlantic",
                   "S Pacific")

colnames(temp) = c("Vert. habitat - benthic",
                   "Vert. habitat - demersal",
                   "Vert. habitat - epipelagic",
                   "Vert. habitat - mesopelagic",
                   "Horz. habitat - coastal",
                   "Horz. habitat - continental shelf",
                   "Horz. habitat - continental slope",
                   "Horz. habitat - oceanic",
                   "Diel migrant (yes)",
                   "Seasonal migrant (yes)",
                   "Gregarious - solitary",
                   "Gregarious - shoaling",
                   "Gregarious - schooling")

trait_ocean_4th = levelplot(temp, 
                     xlab=list("Ocean Basins", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(trait_ocean_4th)

#trait_ocean_4th = as.ggplot(trait_ocean_4th)

ggsave(here("outputs_figures/traitglms/prob_trait_ocean_4th.pdf"), 
       plot = as.ggplot(trait_ocean_4th), width=12, height=12, dpi=300)

```


### Ocean Basin Q 

Using binomial (logit link) function.

```{r TraitGLM - ocean basin q binom distribution}

trait_ocean_b_binom <- traitglm(L = alb_species_use_final_MV,
                      R =  ocean_b,                       
                      Q = traits_try,
                      family=binomial(link = "logit"),
                      method="glm1path"
                      ) #note default is "manyglm"

#Check model output - residuals TEST
qqnorm(residuals(trait_ocean_b_binom)[which(residuals(trait_ocean_b_binom)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(trait_ocean_b_binom)[is.finite((residuals(trait_ocean_b_binom)))]
plot(resids.full); abline(c(0,0),col="red")

```

```{r Plot 4th corner - binom}

a        = max( abs(trait_ocean_b_binom $fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(trait_ocean_b_binom $fourth.corner))

rownames(temp) = c("Mediterranean",
                   "NE Atlantic",
                   "NE Pacific",
                   "NW Atlantic",
                   "NW Indian",
                   "NW Pacific",
                   "SE Atlantic",
                   "SW Atlantic",
                   "SW Indian",
                   "SW Pacific")

colnames(temp) = c("Vert. habitat - benthic",
                   "Vert. habitat - demersal",
                   "Vert. habitat - epipelagic",
                   "Vert. habitat - mesopelagic",
                   "Horz. habitat - coastal",
                   "Horz. habitat - continental shelf",
                   "Horz. habitat - continental slope",
                   "Horz. habitat - oceanic",
                   "Diel migrant (yes)",
                   "Seasonal migrant (yes)",
                   "Gregarious - solitary",
                   "Gregarious - shoaling",
                   "Gregarious - schooling")

trait_ocean_b_4th = levelplot(temp, 
                     xlab=list("Ocean Basin (Quaters)", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(trait_ocean_b_4th)

#trait_ocean_b_4th = as.ggplot(trait_ocean_b_4th)

ggsave(here("outputs_figures/traitglms/prob_trait_ocean_b_4th.pdf"), 
       plot = as.ggplot(trait_ocean_b_4th), width=12, height=12, dpi=300)

```

### Temperate / Tropical

Using binomial (logit link) function.

```{r TraitGLM - latitude binom distribution}

trait_lat_binom <- traitglm(L = alb_species_use_final_MV,
                      R =  lat,                       
                      Q = traits_try,
                      family=binomial(link = "logit"),
                      method="glm1path"
                      ) #note default is "manyglm"

#Check model output - residuals TEST
qqnorm(residuals(trait_lat_binom)[which(residuals(trait_lat_binom)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(trait_lat_binom)[is.finite((residuals(trait_lat_binom)))]
plot(resids.full); abline(c(0,0),col="red")

```

```{r Plot 4th corner - binom}

a        = max( abs(trait_lat_binom$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(trait_lat_binom$fourth.corner))

rownames(temp) = c("Tropical")

colnames(temp) = c("Vert. habitat - benthic",
                   "Vert. habitat - demersal",
                   "Vert. habitat - epipelagic",
                   "Vert. habitat - mesopelagic",
                   "Horz. habitat - coastal",
                   "Horz. habitat - continental shelf",
                   "Horz. habitat - continental slope",
                   "Horz. habitat - oceanic",
                   "Diel migrant (yes)",
                   "Seasonal migrant (yes)",
                   "Gregarious - solitary",
                   "Gregarious - shoaling",
                   "Gregarious - schooling")

trait_lat_4th = levelplot(temp, 
                     xlab=list("Temperate vs. Tropical", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(trait_lat_4th)

#trait_lat_4th = as.ggplot(trait_lat_4th)

ggsave(here("outputs_figures/traitglms/prob_trait_lat_4th.pdf"), 
       plot = as.ggplot(trait_lat_4th), width=12, height=12, dpi=300)

```

### Longhurst Province - DONT USE

**NOTE:** Traitglm for Longhurst provinces provides mostly non-significant relationships, likely too few data for each longhurst province sampled.

Using binomial (logit link) function.

```{r TraitGLM - predator age binom distribution, eval = FALSE, include = FALSE}

trait_longhurst_binom <- traitglm(L = alb_species_use_final_MV,
                      R =  longhurst,                       
                      Q = traits_try,
                      family=binomial(link = "logit"),
                      method="glm1path"
                      ) #note default is "manyglm"

#Check model output - residuals TEST
qqnorm(residuals(trait_longhurst_binom)[which(residuals(trait_longhurst_binom)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(trait_longhurst_binom)[is.finite((residuals(trait_longhurst_binom)))]
plot(resids.full); abline(c(0,0),col="red")

```

```{r Plot 4th corner - binom, eval = FALSE, include = FALSE}

a        = max( abs(trait_longhurst_binom$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(trait_longhurst_binom$fourth.corner))

#rownames(temp) = c("Region: Ocean Basin")

colnames(temp) = c("Vert. habitat - benthic",
                   "Vert. habitat - demersal",
                   "Vert. habitat - epipelagic",
                   "Vert. habitat - mesopelagic",
                   "Horz. habitat - coastal",
                   "Horz. habitat - continental shelf",
                   "Horz. habitat - continental slope",
                   "Horz. habitat - oceanic",
                   "Diel migrant (yes)",
                   "Seasonal migrant (yes)",
                   "Gregarious - solitary",
                   "Gregarious - shoaling",
                   "Gregarious - schooling")

trait_code.4th = levelplot(temp, 
                     xlab=list("Environmental Variables", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(trait_code.4th)


ggsave(here("outputs_figures/traitglms/prob_trait_longcode_4th.pdf"), 
       plot = as.ggplot(trait_code.4th), width=12, height=12, dpi=300)

```
