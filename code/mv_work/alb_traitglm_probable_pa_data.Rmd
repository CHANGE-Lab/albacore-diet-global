---
title: "Albacore Diet TraitGLM P/A"
author: "Natasha Hardy"
date: "02/03/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Workspace}

# general
library(tidyverse)
library(readxl)
library(plyr)
library(dplyr)
library(devtools)
library(reshape2)
library(here)
"%notin%" = Negate('%in%')
here::here()
library(pander)

# graphics
library(ggplot2)
library(lattice)
library(graphics)
library(RColorBrewer)
library(gridExtra)
library(captioner)
library(viridis)
library("grid")
library("ggplotify")


#modelling
library(Hmisc)
library(mgcv)
library(unmarked)
library(lme4)
library(mvabund)
library(tweedie)
library(vegan)

```

## About

This document contains code for data manipulation, refinement and conversion to presence absence, as well as conducting multivariate community analyses and traitglm on albacore diets across ocean basins.

**Issues**

- nMDS ordination reporting extremely low stress, so underdispersed data.

- Maybe exclude species with < 1% occurrence?

## Data (L)

Load frequency of occurrence data.

```{r Species %FO (L) - load data}

#Upload + manipulate Species & Covar DF
#Doesn't like the here() function now for some reason
alb_prob_fo = read.csv(paste(here("data/output_data/alb_global_wide_dietfo.csv"),
                                   sep=""), check.names=FALSE, row.names = 1) %>%
  dplyr::select(StudyID:ncol(.), -grouped_id) #-c(, `Diplospinus multistriatus`, `Sardina pilchardus`)

#SHOULD EXCULDE ANYTHING WITH %fo < 1%
#This will have been done in Albacore_data_manip.Rmd at point of dataframe creation

#Main DF
#head(alb_adult_fo)
#names(alb_prob_fo)

```

Manipulate and subset data.
Here we obtain 137 species as columns and 225 obs.

```{r Species %FO (L) - manipulate}
#Check for empty columns
which(colSums(alb_adult_fo[,14:ncol(alb_adult_fo)])==0) #None! #Otherwise remove these
#Check for empty rows
which(rowSums(alb_adult_fo[,14:ncol(alb_adult_fo)])==0) #Remove these - this becomes a thing once we start removing outlier species
#None

#Subset species df
#If removing species
alb_adult_prey = alb_adult_fo[,14:ncol(alb_adult_fo)]
names(alb_adult_prey) <- str_replace_all(names(alb_adult_prey), " ", "_")

#check df
#dim(alb_adult_prey) #137 species & 225 observations
#str(alb_adult_prey) #data are integers & numeric

#Round to no decimal places if needed
#alb_adult_prey[,1:ncol(alb_adult_prey)] =  round(alb_adult_prey[,1:ncol(alb_adult_prey)], digits = 1)
#Convert to integer values
#alb_adult_prey[,1:ncol(alb_adult_prey)] =  lapply(alb_adult_prey[,1:ncol(alb_adult_prey)], as.integer)
#Try numeric
alb_adult_prey[,1:ncol(alb_adult_prey)] =  lapply(alb_adult_prey[,1:ncol(alb_adult_prey)], as.numeric)

#make mvabund object #sometimes some fiddling required [,1:ncol(alb_adult_prey)], check.names = FALSE
alb_adult_prey_mv <- as.mvabund(alb_adult_prey) 

#All species names have to match up for both dfs
colnames(alb_adult_prey_mv) == names(alb_adult_prey) #hell yes

```

Convert data to presence absence.

```{r Species PA (L)}

#Convert to presence/absence
alb_adult_preyPA = alb_adult_prey
alb_adult_preyPA[alb_adult_preyPA>0] = 1
alb_adult_preyPA_df = cbind(alb_adult_fo[,1:13], alb_adult_preyPA)

alb_adult_preyPA_mv = as.mvabund(alb_adult_preyPA)

#Remove low occurrence species?
#Remove columns that contain < 2 occurrences #can vary this number
alb_adult_preyPA_df2 = alb_adult_preyPA_df[,-which(colSums(alb_adult_preyPA_df[,14:ncol(alb_adult_preyPA_df)])<2)]
#Not sure why some explanatory variable columns disappear also, so adding them back in:
alb_adult_preyPA_df3 = cbind(alb_adult_preyPA_df2[,1:13], alb_adult_preyPA_df2[,12:ncol(alb_adult_preyPA_df2)])
#Then delete rows that sum to zero for the trait occurrences
alb_adult_preyPA_df2.0 = alb_adult_preyPA_df3[-which(rowSums(alb_adult_preyPA_df3[14:ncol(alb_adult_preyPA_df3)])==0),] #209 observations of 103 spp.

alb_adult_site_PA <- as.data.frame(alb_adult_preyPA_df2.0[,1:13])
alb_adult_spp_PA <- alb_adult_preyPA_df2.0[,14:ncol(alb_adult_preyPA_df2.0)] #144 trait columns

#write.csv(review_traits_mv, "review_traits_mv.csv")
#review_traits_mv <- read_csv("review_traits4.0V.scsv")

```

## Visualise data - nMDS

```{r Visualise - nMDS ordinations PA}


#PA
alb_adult_nMDS_pa = metaMDS(alb_adult_spp_PA, 
                         distance="bray", 
                         trymax = 100, #1000
                         k=3) #could increase to k = 4

#Note pb with this!! insufficient data?

pl <- ordiplot(alb_adult_nMDS_pa, type = "none")
points(pl, "sites", pch=21, col="red", bg="yellow")
text(pl, "species", col="blue", cex=0.9)

```

## Traits PROBABLE (Q)

Note that we obtain 135 species and their traits, so we'll need to filter the species df by the traits.

```{r Trait DF (Q) - prob clust num}

alb_prob_clust = read.csv(paste(here("data/output_data/prob.prey.clusternum_habgreg.aggl.k8.csv"), 
                                sep=""), header=T, row.names = 1) %>%
   dplyr::select(prey_sp:prob.clust.num, -refuge.use)
  
#Relabel to add underscore in names
alb_prob_clust$prey_sp = str_replace_all(alb_prob_clust$prey_sp, " ", "_")
#Assign speces as rownames
rownames(alb_prob_clust) <- alb_prob_clust$prey_sp
#Order species list
alb_prob_clust <- alb_prob_clust[ order(row.names(alb_prob_clust)), ]

#Ensure traits are treated as factors for now
alb_prob_clust[,2:8] <- lapply(alb_prob_clust[,2:8], factor) #to convert to factors

#Need to filter by prey species we want to use.
alb_prob_traits = alb_prob_clust %>%
  filter(prey_sp %in% names(alb_adult_preyPA)) #we get 118 species and trait values

```

```{r Trait values check}

summary(alb_prob_traits$vertical.habitat) #merge bathypelagic and mesopelagic

summary(alb_prob_traits$horizontal.habitat) #potential merger of continental shelf/slope, and coastal/reef assoc.

summary(alb_prob_traits$diel.migrant)

summary(alb_prob_traits$seasonal.migrant)

summary(alb_prob_traits$gregarious)

summary(alb_prob_traits$prob.clust.num) #low numbers in cluster #8 = 2

```

```{r Trait factor levels}

str(alb_prob_traits)

#Levels vertical habitat
levels(alb_prob_traits$vertical.habitat)
alb_prob_traits$vertical.habitat <- factor(alb_prob_traits$vertical.habitat, 
                                            levels = c("benthic", "demersal", "epipelagic",
                                                       "mesopelagic", "bathypelagic"),
                                            labels = c("benthic", "demersal", "epipelagic",
                                                       "mesopelagic", "mesopelagic"))
#Too low sample size for bathypelagic, merged with mesopelagic here

#Levels horizontal habitat
levels(alb_prob_traits$horizontal.habitat)
alb_prob_traits$horizontal.habitat <- factor(alb_prob_traits$horizontal.habitat, 
                                            levels = c("reef-associated", "coastal", 
                                                       "continental shelf", "continental slope",
                                                       "oceanic"),
                                            labels = c("coastal", "coastal", 
                                                       "continental shelf", "continental shelf",
                                                       "oceanic"))

#Levels gregarious
#levels(alb_adult_traits$gregarious)
alb_prob_traits$gregarious <- factor(alb_prob_traits$gregarious, 
                                            levels = c("solitary", "schooling"))

```

## UPDATE DIET DATA (L) & SELECT COVARS (R)

```{r FILTER PREY BY PROB TRAITS}

alb_prob_preyPA <- alb_adult_preyPA[colnames(alb_adult_preyPA) %in% rownames(alb_prob_clust)]

```

```{r Diet data manip}

#Need to check for empty columns and rows again
#Check for empty columns
which(colSums(alb_prob_preyPA)==0) #None! #Otherwise remove these
#Check for empty rows
which(rowSums(alb_prob_preyPA)==0) #Remove these - this becomes a thing once we start removing outlier species
#31  32 102 140 141 151 194 
#Need to remove these from the alb_prob_preyPA data and the covars data

alb_prob_preyPA = alb_prob_preyPA[-c(31, 32, 102, 140, 141, 151, 194),]

alb_prob_covars = alb_adult_fo[-c(31, 32, 102, 140, 141, 151, 194),1:13]

```

## Covars (R) - MANIPS

```{r Covars (R) - summary}

#Summary stats on covars
unique(alb_prob_covars$StudyID) #22 studies
unique(alb_prob_covars$OceanBasin) #6 Ocean basins
unique(alb_adult_fo$OceanBasinQ) #10 Ocean basin quarters, but data gets thin for many
unique(alb_prob_covars$YearEnd) #12 years (or groups of years) are represented in this study
unique(alb_prob_covars$code) #10 Longhurst provinces represented, similar to Ocean Basin Q but also gets thin
unique(alb_prob_covars$pred_life) #

```

```{r Covars (R) - select}

#Clean covars
alb_prob_covars = alb_prob_covars %>%
  mutate(pred_life=case_when(pred_life == "juvenile" ~ "juvenile",
                             pred_life == "juvenile, adult" ~ "mixed",
                             pred_life == "adult" ~ "adult",
                             pred_life == "none" ~ "mixed")) #"none" ~ "none"
#As factors
alb_prob_covars[,1:ncol(alb_prob_covars)] =  lapply(alb_prob_covars[,1:ncol(alb_prob_covars)], as.factor)

```

```{r Covars (R) checking, eval=FALSE}
#Check representation
#summary(alb_adult_covars)

summary(alb_prob_covars$lat_cat)
#temperate  tropical 
#   187        31 

summary(alb_prob_covars$pred_life)
#   adult juvenile    mixed 
#     54       64      102 
#Going to simply merge the "none" with "mixed" group for now.

summary(alb_prob_covars$OceanBasin)
#           Indian Mediterranean    N Atlantic     N Pacific    S Atlantic     S Pacific 
#            15            28            88            62            8            17 

summary(alb_prob_covars$OceanBasinQ)
#Mediterranean   NE Atlantic    NE Pacific   NW Atlantic     NW Indian    NW Pacific   SE Atlantic   SW Atlantic 
#        28            84            48             4             3            14             7             1 
#    SW Indian    SW Pacific 
#       12            17 
#   SW Pacific 
#           17 

summary(alb_prob_covars$code)
#ARCH CCAL MEDI MONS NADR NASW NECS NPPF NPTG SATL SPSG 
# 9   47   15   22   92    4    5   14    1    1    8
#Need to exclude NASW, NECS, NPTG, SATL

dim(alb_prob_covars) #218 observations for 13 covars

#Best covars ==> pred_life, OceanBasin, lat_cat, and maybe code (Longhurst) - but need to exclude low numbered levels.

```


## DF checks

```{r Check names and df dimensions}
## Make sure species names match abund matrix
rownames(alb_prob_traits) == colnames(alb_prob_preyPA) #awesome!
# And the mvabund matrix
alb_prob_preyPA_mv = as.mvabund(alb_prob_preyPA)

rownames(alb_prob_traits) == colnames(alb_prob_preyPA_mv) #awesome!

dim(alb_prob_traits) #118 species and 8 traits
dim(alb_prob_preyPA_mv) #218 obs, 118 species
dim(alb_prob_covars) #218 obs, 13 variables

```

```{r Select covars + traits + levels}

#Select some covars & traits
prob_ocean = alb_prob_covars$OceanBasin
prob_ocean <- factor(prob_ocean, levels = c("Mediterranean", "N Atlantic", "S Atlantic", "N Pacific", "S Pacific", "Indian"))
levels(prob_ocean)

#Predator life stage
alb_prob_covars$pred_life<- factor(alb_prob_covars$pred_life, 
                                            levels = c("mixed", "adult", "juvenile"))
prob_pred_life = alb_prob_covars$pred_life
levels(prob_pred_life)

#Latitude
prob_lat = alb_prob_covars$lat_cat

#All traits to try
traits_prob = alb_prob_traits[,2:7]
traits_prob_clust = as.data.frame(alb_prob_traits[,8]) %>%
  dplyr::rename(cluster = `alb_prob_traits[, 8]`)
```


## TRAIT GLM

### Presence/Absence Data

(i) First check manyglm routine
(It works! Now we can play with traitglm)
**NOTE** These data do not look good.

```{r ManyGLM #4}

#Fit ManyGLM to ensure the matrix works
## Run trial manyglm() to check for problems
alb_prob_many <- manyglm(alb_prob_preyPA_mv ~ prob_ocean, family="negative.binomial")
alb_prob_many <- manyglm(alb_prob_preyPA_mv ~ prob_ocean, family="binomial")
plot(alb_prob_many) #check model residuals

```

(ii) Second fit a traitglm to just species + one or two covars excluding the traits
(This also worked)
```{r TraitGLM - predator age test1}

# load correction to traitglm:
#source("traitglm.R")
#source("get_polys.R")

prob_life_test <- traitglm(L = alb_prob_preyPA_mv,
                           R = prob_pred_life, #or pred_life
                           method="manyglm"
                           )

#Check model output - residuals TEST
qqnorm(residuals(prob_life_test)[which(residuals(prob_life_test)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(prob_life_test)[is.finite((residuals(prob_life_test)))]
plot(resids.full)
abline(c(0,0),col="red")

```

(iii) Try adding traits

```{r TraitGLM - predator age test2}

prob_life_test <- traitglm(L = alb_prob_preyPA_mv,
                       R = prob_pred_life,
                       Q = traits_prob
                       ) #note default is "manyglm"

#Check model output - residuals TEST
qqnorm(residuals(prob_life_test)[which(residuals(prob_life_test)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(prob_life_test)[is.finite((residuals(prob_life_test)))]
plot(resids.full)
abline(c(0,0),col="red")

```

(iv) Adding method="glm1path"
This is where it breaks if using frequency of occurrence data...

```{r TraitGLM - predator age test3}

prob_life_test <- traitglm(L = alb_prob_preyPA_mv,
                           R = prob_pred_life,
                           Q = traits_prob,
                           family=binomial(link = "logit"),
                           ) #note default is "manyglm"

#Check model output - residuals TEST
qqnorm(residuals(prob_life_test)[which(residuals(prob_life_test)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(prob_life_test)[is.finite((residuals(prob_life_test)))]
plot(resids.full)
abline(c(0,0),col="red")

```

```{r Plot 4th corner}

a        = max( abs(prob_life_test$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(prob_life_test$fourth.corner))

#rownames(temp) = c("Region: Ocean Basin")
#colnames(temp) = c("Trophic group: Benthic Invertivore",
#                   "Trophic group: Browsing Herbivore",
#                   "Trophic group: Mesopredator",
#                   "Trophic group: Planktivore",
#                   "Solitary",
#                   "Schooling",
#                   "Pairs/groups",
#                   "Known prey",
#                   "Potential prey",
#                   "Bathypelagic")
plot.4th = levelplot(temp, 
                     xlab=list("Environmental Variables", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(plot.4th)

#ggsave(here("output_figures/diet_mvtraits/fourth_lifestage.png"), plot.4th, width=8, height=8, dpi=300)

```

### Trait clusters

Traitglm - clusters 
Manyglm - Life Stage

```{r TraitGLM - life + clusters manyglm binom}
#levels(ocean)
#summary(traits_prob_clust)
#levels()


prob_life_clusters_many <- traitglm(L = alb_prob_preyPA_mv,
                                    R = prob_pred_life,
                                    Q = traits_prob_clust,
                                    family=binomial(link = "logit")
                                    ) #note default is "manyglm"

#Check model output - residuals TEST
qqnorm(residuals(prob_life_clusters_many)[which(residuals(prob_life_clusters_many)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(prob_life_clusters_many)[is.finite((residuals(prob_life_clusters_many)))]
plot(resids.full); abline(c(0,0),col="red")

```

```{r Plot 4th corner - life many}

a        = max( abs(prob_life_clusters_many$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(prob_life_clusters_many$fourth.corner))

rownames(temp) = c("Adult", "Juvenile")

#colnames(temp) = c("Vert. habitat - demersal",
#                   "Vert. habitat - epipelagic",
#                   "Vert. habitat - mesopelagic",
#                   "Horz. habitat - continental shelf",
#                   "Horz. habitat - oceanic",
#                   "Diel migrant (yes)",
#                   "Seasonal migrant (yes)",
#                   "Gregarious - schooling")

prob_life_clusters_many_graph = levelplot(temp, 
                     xlab=list("Predator Life Stage", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_life_clusters_many_graph)

ggsave(here("outputs_figures/traitglms/prob_life_clusters_many_graph.pdf"), 
       plot = as.ggplot(prob_life_clusters_many_graph), width=12, height=12, dpi=300)

```

Manyglm - Ocean

```{r TraitGLM - ocean + clusters manyglm binom}
#levels(ocean)

#ocean <- factor(ocean, levels = c("Mediterranean", "N Atlantic", "S Atlantic", "N Pacific", "S Pacific", "Indian"))

prob_ocean_clusters_many <- traitglm(L = alb_prob_preyPA_mv,
                                     R = prob_ocean,
                                     Q = traits_prob_clust,
                                     family=binomial(link = "logit")
                                     ) #note default is "manyglm"

#Check model output - residuals TEST
qqnorm(residuals(prob_ocean_clusters_many)[which(residuals(prob_ocean_clusters_many)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(prob_ocean_clusters_many)[is.finite((residuals(prob_ocean_clusters_many)))]
plot(resids.full); abline(c(0,0),col="red")

```

```{r Plot 4th corner - ocean many}

a        = max( abs(prob_ocean_clusters_many$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(prob_ocean_clusters_many$fourth.corner))

rownames(temp) = c(#"Mediterranean",
                   "N Atlantic",
                   "S Atlantic",
                   "N Pacific",
                   "S Pacific",
                   "Indian")


#colnames(temp) = c("Vert. habitat - demersal",
#                   "Vert. habitat - epipelagic",
#                   "Vert. habitat - mesopelagic",
#                   "Horz. habitat - continental shelf",
#                   "Horz. habitat - oceanic",
#                   "Diel migrant (yes)",
#                   "Seasonal migrant (yes)",
#                   "Gregarious - schooling")

prob_ocean_clusters_many_graph = levelplot(temp, 
                     xlab=list("Ocean Basins", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_ocean_clusters_many_graph)

ggsave(here("outputs_figures/traitglms/prob_ocean_clusters_many_graph.pdf"), 
       plot = as.ggplot(prob_ocean_clusters_many_graph), width=12, height=12, dpi=300)

```

Predator Life Stage - Using binomial (logit link) function + glm1path LASSO model

```{r TraitGLM - life + clusters LASSO}

prob_life_cluster_LASSO <- traitglm(L = alb_prob_preyPA_mv,
                                    R = prob_pred_life,
                                    Q = traits_prob_clust,
                                    family=binomial(link = "logit"),
                                    method="glm1path"
                                    ) #note default is "manyglm"


#Check model output - residuals TEST
x11()
qqnorm(residuals(prob_life_cluster_LASSO)[which(residuals(prob_life_cluster_LASSO)<10000)]); abline(c(0,1),col="red")
dev.copy(device = x11)
dev.copy2pdf(file="/Users/tashhardy/Documents/GitHub/albacore-diet-global/outputs_figures/traitglms/prob_life_cluster_LASSO_QQ.pdf", width=5, height=5)

#omit non-finite residuals FULL MODEL
resids.full = residuals(prob_life_cluster_LASSO)[is.finite((residuals(prob_life_cluster_LASSO)))]
plot(resids.full); abline(c(0,0),col="red")
dev.copy(device = x11)
dev.copy2pdf(file="/Users/tashhardy/Documents/GitHub/albacore-diet-global/outputs_figures/traitglms/prob_life_cluster_LASSO_resids.pdf", width=5, height=5)
```

```{r Plot 4th corner - life + cluster LASSO}

a        = max( abs(prob_life_cluster_LASSO$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(prob_life_cluster_LASSO$fourth.corner))

rownames(temp) = c("Mixed", "Adult", "Juvenile")

#colnames(temp) = c("Vert. habitat - benthic",
#                   "Vert. habitat - demersal",
#                   "Vert. habitat - epipelagic",
#                   "Vert. habitat - mesopelagic",
#                   "Horz. habitat - coastal",
#                   "Horz. habitat - continental shelf",
#                   "Horz. habitat - oceanic",
#                   "Diel migrant (yes)",
#                   "Seasonal migrant (yes)",
#                   "Gregarious - schooling")

prob_life_cluster_LASSO_graph = levelplot(temp,
                                          xlab=list("Predator Life Stage", cex=1.5),
                                          ylab=list("Species traits", cex=1.5),
                                          col.regions=colort(100),
                                          at=seq(-a, a,length=100),
                                          scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)),
                                          colorkey=list(labels=list(cex=1.3)))

print(prob_life_cluster_LASSO_graph)

#trait_ocean_4th = as.ggplot(trait_ocean_4th)

ggsave(here("outputs_figures/traitglms/prob_life_cluster_LASSO_graph.pdf"), 
       plot = as.ggplot(prob_life_cluster_LASSO_graph), width=12, height=12, dpi=300)

ggsave(here("outputs_figures/traitglms/prob_life_cluster_LASSO_graph.jpeg"), 
       plot = as.ggplot(prob_life_cluster_LASSO_graph), width=12, height=12, dpi=300)

```

Ocean Basin - Using binomial (logit link) function + glm1path LASSO model

```{r TraitGLM - Ocean + clusters LASSO}

prob_ocean_cluster_LASSO <- traitglm(L = alb_prob_preyPA_mv,
                                     R = prob_ocean,
                                     Q = traits_prob_clust,
                                     family=binomial(link = "logit"),
                                     method="glm1path"
                                     ) #note default is "manyglm"

#Check model output - residuals TEST
#x11()
#qqnorm(residuals(trait_ocean_binom)[which(residuals(trait_ocean_binom)<10000)]); abline(c(0,1),col="red")
#dev.copy(device = x11)
#dev.copy2pdf(file="/Users/tashhardy/Documents/GitHub/albacore-diet-global/outputs_figures/traitglms/trait_ocean_binom_QQ.pdf", width=5, height=5)

#omit non-finite residuals FULL MODEL
#resids.full = residuals(trait_ocean_binom)[is.finite((residuals(trait_ocean_binom)))]
#plot(resids.full); abline(c(0,0),col="red")
#dev.copy(device = x11)
#dev.copy2pdf(file="/Users/tashhardy/Documents/GitHub/albacore-diet-global/outputs_figures/traitglms/trait_ocean_binom_resids.pdf", width=5, height=5)
```

```{r Plot 4th corner - life + cluster LASSO}

a        = max( abs(prob_ocean_cluster_LASSO$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(prob_ocean_cluster_LASSO$fourth.corner))

rownames(temp) = c("Mediterranean",
                   "N Atlantic",
                   "S Atlantic",
                   "N Pacific",
                   "S Pacific",
                   "Indian")

#colnames(temp) = c("Vert. habitat - benthic",
#                   "Vert. habitat - demersal",
#                   "Vert. habitat - epipelagic",
#                   "Vert. habitat - mesopelagic",
#                   "Horz. habitat - coastal",
#                   "Horz. habitat - continental shelf",
#                   "Horz. habitat - oceanic",
#                   "Diel migrant (yes)",
#                   "Seasonal migrant (yes)",
#                   "Gregarious - schooling")

prob_ocean_cluster_LASSO_graph = levelplot(temp, 
                     xlab=list("Ocean Basins", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_ocean_cluster_LASSO_graph)

ggsave(here("outputs_figures/traitglms/prob_ocean_cluster_LASSO_graph.pdf"), 
       plot = as.ggplot(prob_ocean_cluster_LASSO_graph), width=12, height=12, dpi=300)

ggsave(here("outputs_figures/traitglms/prob_ocean_cluster_LASSO_graph.jpeg"), 
       plot = as.ggplot(prob_ocean_cluster_LASSO_graph), width=12, height=12, dpi=300)

```

### Predator Life Stage

ManyGLM traitglm


```{r TraitGLM - predator age binom distribution}

prob_life_many <- traitglm(L = alb_prob_preyPA_mv,
                                    R = prob_pred_life,
                                    Q = traits_prob,
                                    family=binomial(link = "logit")
                                    ) #note default is "manyglm"

#Check model output - residuals TEST
qqnorm(residuals(prob_life_many)[which(residuals(prob_life_many)<10000)]); abline(c(0,1),col="red")

#omit non-finite residuals FULL MODEL
resids.full = residuals(prob_life_many)[is.finite((residuals(prob_life_many)))]
plot(resids.full); abline(c(0,0),col="red")

```

```{r Plot 4th corner - binom}

a        = max( abs(prob_life_many$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(prob_life_many$fourth.corner))

#rownames(temp) = c("Adult", "Juvenile", "Mixed")
#colnames(temp) = c("Vert. habitat - benthic",
#                   "Vert. habitat - demersal",
#                   "Vert. habitat - epipelagic",
#                   "Vert. habitat - mesopelagic",
#                   "Vert. habitat - bathypelagic",
#                   "Horz. habitat - reef-associated",
#                   "Horz. habitat - coastal",
#                   "Horz. habitat - continental shelf",
#                   "Horz. habitat - continental slope",
#                   "Horz. habitat - oceanic",
#                   "Diel migrant (yes)",
#                   "Seasonal migrant (yes)",
#                   "Gregarious - schooling")

prob_life_many_4th = levelplot(temp, 
                     xlab=list("Predator Life Stage", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_life_many_4th)

#trait_life_4th = as.ggplot(trait_life_4th)

ggsave(here("outputs_figures/traitglms/prob_life_many_4th.pdf"), plot = as.ggplot(prob_life_many_4th), width=12, height=12, dpi=300)

#dev.copy2pdf(file=here("./outputs_figures/traitglms/fourth_lifestage.png"), width=12, height=5)

```


Using binomial (logit link) function - glm1path traitglm

```{r TraitGLM - predator age glm LASSO}

prob_life_LASSO <- traitglm(L = alb_prob_preyPA_mv,
                            R = prob_pred_life,
                            Q = traits_prob,
                            family=binomial(link = "logit"),
                            method="glm1path"
                            ) #note default is "manyglm"

```

```{r Plot 4th corner - pred age LASSO}

a        = max( abs(prob_life_LASSO$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(prob_life_LASSO$fourth.corner))

rownames(temp) = c("Mixed", "Adult", "Juvenile")
colnames(temp) = c("Prey life: adult",
                   "Prey life: juvenile",
                   "Prey life: larva",
                   "Vert. habitat - benthic",
                   "Vert. habitat - demersal",
                   "Vert. habitat - epipelagic",
                   "Vert. habitat - mesopelagic",
                   "Horz. habitat - coastal",
                   "Horz. habitat - continental shelf",
                   "Horz. habitat - oceanic",
                   "Diel migrant (yes)",
                   "Seasonal migrant (yes)",
                   "Gregarious - schooling")

prob_life_LASSO_graph = levelplot(temp, 
                     xlab=list("Predator Life Stage", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_life_LASSO_graph)

ggsave(here("outputs_figures/traitglms/prob_life_LASSO_graph.pdf"), 
       plot = as.ggplot(prob_life_LASSO_graph), width=12, height=12, dpi=300)

ggsave(here("outputs_figures/traitglms/prob_life_LASSO_graph.jpeg"), 
       plot = as.ggplot(prob_life_LASSO_graph), width=12, height=12, dpi=300)

```


### Ocean Basin

Using binomial (logit link) function.

```{r TraitGLM - ocean basin binom distribution}

prob_ocean_LASSO <- traitglm(L = alb_prob_preyPA_mv,
                              R = prob_ocean,
                              Q = traits_prob,
                              family=binomial(link = "logit"),
                              method="glm1path"
                              ) #note default is "manyglm"

```

```{r Plot 4th corner - binom}

a        = max( abs(prob_ocean_LASSO$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(prob_ocean_LASSO$fourth.corner))

rownames(temp) = c("Mediterranean",
                   "N Atlantic",
                   "S Atlantic",
                   "N Pacific",
                   "S Pacific",
                   "Indian")

colnames(temp) = c("Prey life: adult",
                   "Prey life: juvenile",
                   "Prey life: larva",
                   "Vert. habitat - benthic",
                   "Vert. habitat - demersal",
                   "Vert. habitat - epipelagic",
                   "Vert. habitat - mesopelagic",
                   "Horz. habitat - coastal",
                   "Horz. habitat - continental shelf",
                   "Horz. habitat - oceanic",
                   "Diel migrant (yes)",
                   "Seasonal migrant (yes)",
                   "Gregarious - schooling")

prob_ocean_LASSO_graph = levelplot(temp, 
                     xlab=list("Ocean Basins", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_ocean_LASSO_graph)

#trait_ocean_4th = as.ggplot(trait_ocean_4th)

ggsave(here("outputs_figures/traitglms/prob_ocean_LASSO_graph.pdf"), 
       plot = as.ggplot(prob_ocean_LASSO_graph), width=12, height=12, dpi=300)

ggsave(here("outputs_figures/traitglms/prob_ocean_LASSO_graph.jpeg"), 
       plot = as.ggplot(prob_ocean_LASSO_graph), width=12, height=12, dpi=300)

```


### Temperate / Tropical

Using binomial (logit link) function.

```{r TraitGLM - latitude binom distribution}

prob_lat_LASSO <-  traitglm(L = alb_prob_preyPA_mv,
                            R = prob_lat,
                            Q = traits_prob,
                            family=binomial(link = "logit"),
                            method="glm1path"
                            ) #note default is "manyglm"

```

```{r Plot 4th corner - binom}

a        = max( abs(prob_lat_LASSO$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
temp = t(as.matrix(prob_lat_LASSO$fourth.corner))

rownames(temp) = c("Tropical")

colnames(temp) = c("Prey life: adult",
                   "Prey life: juvenile",
                   "Prey life: larva",
                   "Vert. habitat - benthic",
                   "Vert. habitat - demersal",
                   "Vert. habitat - epipelagic",
                   "Vert. habitat - mesopelagic",
                   "Horz. habitat - coastal",
                   "Horz. habitat - continental shelf",
                   "Horz. habitat - oceanic",
                   "Diel migrant (yes)",
                   "Seasonal migrant (yes)",
                   "Gregarious - schooling")


prob_lat_LASSO_graph = levelplot(temp, 
                     xlab=list("Temperate vs. Tropical", cex=1.5),
                     ylab=list("Species traits", cex=1.5), 
                     col.regions=colort(100), 
                     at=seq(-a, a,length=100),
                     scales = list(x=list(rot = 45, cex=1.3), y=list(cex=1.3)), 
                     colorkey=list(labels=list(cex=1.3)))

print(prob_lat_LASSO_graph)

#trait_lat_4th = as.ggplot(trait_lat_4th)

ggsave(here("outputs_figures/traitglms/prob_lat_LASSO_graph.pdf"), 
       plot = as.ggplot(prob_lat_LASSO_graph), width=12, height=12, dpi=300)
       
ggsave(here("outputs_figures/traitglms/prob_lat_LASSO_graph.jpeg"), 
       plot = as.ggplot(prob_lat_LASSO_graph), width=12, height=12, dpi=300)

```



### nMDS plots - Ocean & Life Srage

#### Ordination + Scores

```{r NMDS & Clusters ~ Species}
#### nMDS for dissimilarity
ORD_prob_cluster = metaMDS(alb_prob_preyPA, 
                         distance="jaccard", 
                         trymax = 1000, #1000
                         k=4) #could increase to k = 4

ORD_prob_cluster[["stress"]] #stress = 0.1188079 #reasonable

```

Extract NMDS coordinates and associate with co-variates/grouping factors

```{r Data scores for plotting - USE}

#Extract NMDS coordinates and associate with co-variates/grouping factors
#Using the scores function from vegan to extract the site scores and convert to a data.frame
data.scores <- as.data.frame(scores(ORD_prob_cluster))  #, "species"
#create a column of site names, from the rownames of data.scores
data.scores$points <- rownames(data.scores)
#bind treatment labels and score values
treatment.scores <- cbind(alb_prob_covars, data.scores)
#Check
str(treatment.scores)  
#Awesome

```


#### Convex hull calculations
For each ordination and set of grouping variables input to data scores chunk

```{r Convex hulls - Predator Life Stage}
# Taxonomic groups (specific)
#Create convex hulls for the space occupied by each Taxonomic values
unique(treatment.scores$pred_life) #mixed    juvenile adult
#Taxonomic group - hull loop
pred = as.character(unique(treatment.scores$pred_life))
for(i in 1:length(pred)) {
  temp = pred[i]
  df = treatment.scores[treatment.scores$pred_life == temp, ][chull(treatment.scores[treatment.scores$pred_life == temp, c("NMDS1", "NMDS2")]), ]
  assign(paste0('grp.',temp), df)
}

#combine the hull data
hull.data.pred <- rbind(grp.mixed, grp.juvenile, grp.adult)  

str(hull.data.pred)
#Just wondering how do 174 species (obs) become 46???

```

```{r Convex hulls - Predator Life Stage}
# Taxonomic groups (specific)
#Create convex hulls for the space occupied by each Taxonomic values
unique(treatment.scores$OceanBasin) #N Atlantic    Mediterranean N Pacific     S Atlantic    Indian        S Pacific
#Taxonomic group - hull loop
oc = as.character(unique(treatment.scores$OceanBasin))
for(i in 1:length(oc)) {
  temp = oc[i]
  df = treatment.scores[treatment.scores$OceanBasin == temp, ][chull(treatment.scores[treatment.scores$OceanBasin == temp, c("NMDS1", "NMDS2")]), ]
  assign(paste0('grp.',temp), df)
}

#combine the hull data
hull.data.oc <- rbind(grp.Indian, `grp.N Atlantic`, grp.Mediterranean, `grp.N Pacific`, `grp.S Atlantic`, `grp.S Pacific`)  

str(hull.data.oc)

```

NMDS plot

```{r nMDS - Pred Life, echo=TRUE}
#nMDS plot for the assessmenet of global change (yes/no) and the drivers.
#as.integer(unique(treatment.scores$adult.clust.num))

nMDS_prob_life <- ggplot() + 
  geom_polygon(data = hull.data.pred, 
               aes(x = NMDS1, y = NMDS2, fill = pred_life,group = pred_life), alpha=0.30) + # add the convex hulls
  geom_point(data = treatment.scores, 
             aes(x = NMDS1, y = NMDS2, colour = pred_life), size=2) + # add the point markers
  coord_equal() +
  theme_bw()  +
  theme(axis.text.x = element_blank(),  # remove x-axis text
        axis.text.y = element_blank(), # remove y-axis text
        axis.ticks = element_blank(),  # remove axis ticks
        axis.title.x = element_text(size=18), # remove x-axis labels
        axis.title.y = element_text(size=18), # remove y-axis labels
        legend.title = element_text(size = 18), 
        legend.text = element_text(size = 18),
        legend.justification = c(0,0.5),
        #panel.background = element_rect(fill = "lightgrey"), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_blank()) +
  #guides(fill = FALSE, colour = FALSE) +
  #guides(fill = guide_legend(order = 1), colour = guide_legend(order = 2)) +
  scale_colour_viridis(option="magma", discrete = TRUE, begin = 0.8, end = 0.2, name = "Predator Life Stage") + 
  scale_fill_viridis(option="magma", discrete = TRUE, begin = 0.8, end = 0.2, name = "Predator Life Stage") #+
  #geom_text_repel(data = species.scores,
  #                aes(x = NMDS1, y = NMDS2, label = species#, alpha = 0.8, size = 5
  #                    ))

nMDS_prob_life
##Not perfect, some issues to troubleshoot

ggsave(here("outputs_figures/traitglms/prob_life_stage/nMDS_prob_life.jpeg"), plot = nMDS_prob_life, width = 8, height = 8, dpi = 300)

```


```{r nMDS -Ocean Basin, echo=TRUE}

nMDS_prob_ocean <- ggplot() + 
  geom_polygon(data = hull.data.oc, 
               aes(x = NMDS1, y = NMDS2, fill = OceanBasin, group = OceanBasin), alpha=0.30) + # add the convex hulls
  geom_point(data = treatment.scores, 
             aes(x = NMDS1, y = NMDS2, colour = OceanBasin), size=2) + # add the point markers
  coord_equal() +
  theme_bw()  +
  theme(axis.text.x = element_blank(),  # remove x-axis text
        axis.text.y = element_blank(), # remove y-axis text
        axis.ticks = element_blank(),  # remove axis ticks
        axis.title.x = element_text(size=18), # remove x-axis labels
        axis.title.y = element_text(size=18), # remove y-axis labels
        legend.title = element_text(size = 18), 
        legend.text = element_text(size = 18),
        legend.justification = c(0,0.5),
        #panel.background = element_rect(fill = "lightgrey"), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_blank()) +
  #guides(fill = FALSE, colour = FALSE) +
  #guides(fill = guide_legend(order = 1), colour = guide_legend(order = 2)) +
  scale_colour_viridis(option="magma", discrete = TRUE, begin = 0.8, end = 0.2, name = "Ocean Basin") + 
  scale_fill_viridis(option="magma", discrete = TRUE, begin = 0.8, end = 0.2, name = "Ocean Basin") #+

nMDS_prob_ocean

ggsave(here("outputs_figures/traitglms/prob_life_stage/nMDS_prob_ocean.jpeg"), plot = nMDS_prob_ocean, width = 8, height = 8, dpi = 300)
```