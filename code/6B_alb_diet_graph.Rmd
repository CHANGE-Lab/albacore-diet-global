---
title: "Albacore Diet Synthesis Graphs"
author: "Natasha Hardy"
date: '2022-06-07'
output: html_document
---

## About

To produce graphical illustrations of global albacore diet composition in relation to prey clusters/guilds and relative importance of prey trait guilds.

## Workspace

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Packages to load}
library(here)
"%notin%" = Negate('%in%')
here::here()
library(tidyverse)
library(readxl)
library(readr)
library(plyr)
library(dplyr)
library(vegan)
library(mvabund)
library(ggplot2)
library(viridis)
library(RColorBrewer)
library(ggh4x)
#library(wesanderson)

```


## Load Data

```{r Load frequency of occurrence data}

#diet_fo_wide <- read.csv(here("./data/output_data/alb_global_wide_dietfo.csv"))

alb_global = read.csv(here::here("data/2_output_data/alb_global_diet.csv"), check.names = FALSE)

prob.prey.cl = read.csv(here::here("data/2_output_data/prob.prey.clusternum.divis.k7.csv")) %>%
  select(-c(X, dendlabs, maxFO:maxM))

```

```{r Create df for range graph}

alb_diet_clust = alb_global %>%
  left_join(prob.prey.cl) %>%
  filter(prob.clust.num != "NA") %>% #> 0 #, pFOuse > 5
  select(StudyID, rep_ID, OceanBasin, OceanBasinQ, prey_class:prey_sp, pFOuse, pN, pM, prob.clust.num)
#unique(alb_diet_clust$prob.clust.num)
#unique(alb_diet_clust$OceanBasin)

alb_diet_clust$YearEnd = as.integer(alb_diet_clust$YearEnd)
alb_diet_clust$prob.clust.num = as.factor(alb_diet_clust$prob.clust.num)

```

## Total data + manip for diet composition

### DF for range graph

### Total Data Figures

Match the colour palette for clusters in these and other graphs in the MS.

```{r Colour palette for cluster graphs}

fig3.pal <- c("#00496F", "#59A082", "#0A718F", 
              "#EDA417", "#EDD746", 
              "#E7720B", "#DD4124")
library(scales)
show_col(fig3.pal)

```

#### Scatterplots

```{r Try scatterplot pFO}

diet_cluster_scatter = alb_diet_clust %>%
  filter(pFOuse > 5) %>%
  ggplot() +
  geom_point(data = alb_diet_clust, aes(y=pFOuse, x=YearEnd,
                                        group=prob.clust.num,
                                        fill=prob.clust.num),
             
             size=5, shape=23) +
  coord_flip()+
  theme(panel.grid.major = element_blank(),
        axis.title=element_text(size=24),
        axis.text=element_text(size=24),
        legend.text=element_text(size=24),
        legend.title=element_text(size=24),
        legend.position = "none") +
  labs(x="Years sampled", y="Range in frequency of occurrence (%)")+
  scale_fill_manual(values=fig3.pal) + #, name="Prey Trait Guilds"
  #scale_fill_brewer(palette="BrBG", name="Prey Trait Guilds")+
  ylim(0,90)+
  xlim(1900,2019)+
  facet_grid(prob.clust.num~OceanBasin, scales ="free")+
  force_panelsizes(cols = c(0.6, 0.85, 1, 1, 0.4, 0.4),
                   rows = c(0.6, 0.6, 0.6, 1, 1, 0.6, 0.6)) +
  theme(strip.text = element_text(face="bold", size=rel(2)))
diet_cluster_scatter

ggsave(here::here("outputs_figures/diet_comp/diet_cluster_scatterFO.jpeg"), plot = diet_cluster_scatter, width = 24, height = 16, dpi = 300)

```

```{r Try scatterplot pN}

diet_cluster_scatterN = alb_diet_clust %>%
  filter(pN > 5) %>%
  ggplot() +
  geom_point(data = alb_diet_clust, aes(y=pN, x=YearEnd,
                                        group=prob.clust.num,
                                        fill=prob.clust.num),
             
             size=5, shape=23) +
  coord_flip()+
  theme(panel.grid.major = element_blank(),
        axis.title=element_text(size=24),
        axis.text=element_text(size=24),
        legend.text=element_text(size=24),
        legend.title=element_text(size=24),
        legend.position = "none") +
  labs(x="Years sampled", y="Range in numerical abundance (%)")+
  scale_fill_manual(values=fig3.pal) + #, name="Prey Trait Guilds"
  #scale_fill_brewer(palette="BrBG", name="Prey Trait Guilds")+
  ylim(0,90)+
  xlim(1900,2019)+
  facet_grid(prob.clust.num~OceanBasin, scales ="free")+
  theme(strip.text = element_text(face="bold", size=rel(2)))
diet_cluster_scatterN

ggsave(here::here("outputs_figures/diet_comp/diet_cluster_scatterN.jpeg"), plot = diet_cluster_scatterN, width = 24, height = 16, dpi = 300)

```

```{r Try scatterplot pM}

diet_cluster_scatterM = alb_diet_clust %>%
  filter(pN > 5) %>%
  ggplot() +
  geom_point(data = alb_diet_clust, aes(y=pM, x=YearEnd,
                                        group=prob.clust.num,
                                        fill=prob.clust.num),
             size=5, shape=23) +
  coord_flip()+
  theme(panel.grid.major = element_blank(),
        axis.title=element_text(size=24),
        axis.text=element_text(size=24),
        legend.text=element_text(size=24),
        legend.title=element_text(size=24),
        legend.position = "none") +
  labs(x="Years sampled", y="Range in biomass contribution (%)")+
  scale_fill_manual(values=fig3.pal) + #, name="Prey Trait Guilds"
  #scale_fill_brewer(palette="BrBG", name="Prey Trait Guilds")+
  ylim(0,100)+
  xlim(1900,2019)+
  facet_grid(prob.clust.num~OceanBasin, scales ="free")+
  theme(strip.text = element_text(face="bold", size=rel(2)))
diet_cluster_scatterM

ggsave(here::here("outputs_figures/diet_comp/diet_cluster_scatterM.jpeg"), plot = diet_cluster_scatterM, width = 24, height = 16, dpi = 300)

```

#### Boxplots

```{r Try boxplot FO}

diet_cluster_box = alb_diet_clust %>%
  filter(pFOuse > 5) %>%
  ggplot() +
  geom_boxplot(data = alb_diet_clust, 
                      aes(y=pFOuse, x=YearEnd, 
                          group=prob.clust.num, 
                          fill=prob.clust.num
                          ),
              position = "dodge") + #fill #YearEnd 
  #geom_violin()+
  coord_flip()+
  theme(panel.grid.major = element_blank(),
        axis.title=element_text(size=24),
        axis.text=element_text(size=24),
        legend.text=element_text(size=24),
        legend.title=element_text(size=24),
        legend.position = "none") +
  labs(x="Years sampled", y="Range in frequency of occurrence (%)")+
  scale_fill_manual(values=fig3.pal) + #, name="Prey Trait Guilds"
  #scale_fill_brewer(palette="BrBG", name="Prey Trait Guilds")+
  #ylim(0,90)+
  #xlim(1900,2019)+
  facet_grid(prob.clust.num~OceanBasin, scales ="free")+
  force_panelsizes(cols = c(0.6, 0.85, 1, 1, 0.4, 0.4),
                   rows = c(0.6, 0.6, 0.6, 1, 1, 0.6, 0.6)) +
  theme(strip.text = element_text(face="bold", size=rel(2)))
diet_cluster_box

ggsave(here::here("outputs_figures/diet_comp/diet_cluster_boxFO.jpeg"), plot = diet_cluster_box, width = 24, height = 16, dpi = 300)

```

#### Violin plots

```{r Try violin FO}

diet_cluster_violin = alb_diet_clust %>%
  filter(pFOuse > 5) %>%
  ggplot() +
  geom_violin(data = alb_diet_clust, 
                      aes(y=pFOuse, x=YearEnd, 
                          group=prob.clust.num, 
                          fill=prob.clust.num
                          ),
              position = "dodge") + #fill #YearEnd 
  #geom_violin()+
  coord_flip()+
  theme(panel.grid.major = element_blank(),
        axis.title=element_text(size=24),
        axis.text=element_text(size=24),
        legend.text=element_text(size=24),
        legend.title=element_text(size=24),
        legend.position = "none") +
  labs(x="Years sampled", y="Range in frequency of occurrence (%)")+
  scale_fill_manual(values=fig3.pal) + #, name="Prey Trait Guilds"
  #scale_fill_brewer(palette="BrBG", name="Prey Trait Guilds")+
  #ylim(0,90)+
  #xlim(1900,2019)+
  facet_grid(prob.clust.num~OceanBasin, scales ="free")+
  force_panelsizes(cols = c(0.6, 0.85, 1, 1, 0.5, 0.4),
                   rows = c(0.6, 0.6, 0.6, 1, 1, 0.6, 0.6)) +
  theme(strip.text = element_text(face="bold", size=rel(2)))
diet_cluster_violin

ggsave(here::here("outputs_figures/diet_comp/diet_cluster_violinFO.jpeg"), plot = diet_cluster_violin, width = 24, height = 16, dpi = 300)

```

```{r Try violin and scatter FO}

diet_cluster_violin_scatter = alb_diet_clust %>%
  filter(pFOuse > 5) %>%
  ggplot() +
  geom_point(data = alb_diet_clust, aes(y=pFOuse, x=YearEnd,
                                        group=prob.clust.num,
                                        colour=prob.clust.num),
             size=5, shape=23) +
  geom_violin(data = alb_diet_clust, 
                      aes(y=pFOuse, x=YearEnd, 
                          group=prob.clust.num, 
                          fill=prob.clust.num
                          ),
              position = "dodge") + #fill #YearEnd 
  #geom_violin()+
  coord_flip()+
  theme(panel.grid.major = element_blank(),
        axis.title=element_text(size=24),
        axis.text=element_text(size=24),
        legend.text=element_text(size=24),
        legend.title=element_text(size=24),
        legend.position = "none") +
  labs(x="Years sampled", y="Range in frequency of occurrence (%)")+
  scale_fill_manual(values=fig3.pal) + #, name="Prey Trait Guilds"
  scale_colour_manual(values=fig3.pal) + #, name="Prey Trait Guilds"
  #ylim(0,90)+
  #xlim(1900,2019)+
  facet_grid(prob.clust.num~OceanBasin, scales ="free")+
  force_panelsizes(cols = c(0.6, 0.85, 1, 1, 0.5, 0.4),
                   rows = c(0.6, 0.6, 0.6, 1, 1, 0.6, 0.6)) +
  theme(strip.text = element_text(face="bold", size=rel(2)))
diet_cluster_violin_scatter

ggsave(here::here("outputs_figures/diet_comp/diet_cluster_violin_scatterFO.jpeg"), plot = diet_cluster_violin_scatter, width = 24, height = 16, dpi = 300)


```

## Index of relative importance for FO

### DF for FO index of relative importance

```{r Load index data}

index_alb_diet_clust_data = read.csv(here::here("data/2_output_data/index_alb_diet_clust_data.csv")) %>%
  select(-X)

unique(index_alb_diet_clust_data$StudyID)
unique(index_alb_diet_clust_data$rep_ID)

```

```{r Create df for range graph}

index_alb_diet_clust = alb_diet_clust %>%
  group_by(StudyID, rep_ID, YearEnd, OceanBasin, prob.clust.num) %>%
  dplyr::summarize(clustFO = sum(pFOuse, na.rm=TRUE)) 

totals_alb_diet_clust = alb_diet_clust %>%
  group_by(StudyID, rep_ID, YearEnd, OceanBasin) %>%
  dplyr::summarize(totalFO = sum(pFOuse, na.rm=TRUE)) 

index_alb_diet_clust_data = index_alb_diet_clust %>%
  left_join(totals_alb_diet_clust) %>%
  mutate(relFO = clustFO/totalFO) %>%
  dplyr::filter(relFO > 0)

index_alb_diet_clust_data$yearrepID <- paste(index_alb_diet_clust_data$YearEnd, index_alb_diet_clust_data$rep_ID, sep = "_")

table(index_alb_diet_clust_data$rep_ID, index_alb_diet_clust_data$OceanBasin)

write.csv(index_alb_diet_clust_data, here::here("data/2_output_data/index_alb_diet_clust_data.csv"))

```

### Figure for index data - scatter

```{r Try scatterplot relative FO}

index_cluster_scatter = index_alb_diet_clust_data %>%
  #filter(pFOuse > 5) %>%
  ggplot() +
  geom_point(data = index_alb_diet_clust_data, 
             aes(y=relFO, x=YearEnd, group=prob.clust.num, fill=prob.clust.num),
             size=5, shape=23, position = "dodge") +
  #geom_jitter(position = position_jitter(width = 0.1, height = 0.1))+
  theme(panel.grid.major = element_blank(),
        axis.title=element_text(size=24),
        axis.text=element_text(size=24),
        legend.text=element_text(size=24),
        legend.title=element_text(size=24),
        legend.position = "top") +
  labs(x="Years sampled", y="Range in frequency of occurrence (%)")+
  scale_fill_manual(values=fig3.pal, name="Prey Trait Guilds") +
  #ylim(0,90)+
  xlim(1900,2019)+
  facet_grid(OceanBasin~.)+ #, scales ="free"
  #force_panelsizes(cols = c(0.6, 0.85, 1, 1, 0.4, 0.4),
  #                 rows = c(0.6, 0.6, 0.6, 1, 1, 0.6, 0.6)) +
  theme(strip.text = element_text(face="bold", size=rel(2)))
index_cluster_scatter

#ggsave(here::here("outputs_figures/diet_comp/diet_cluster_scatterFO.jpeg"), plot = diet_cluster_scatter, width = 24, height = 16, dpi = 300)

```

### Figure for index data - stacked bar

```{r Try stacked bar chart}

index_cluster_bar = index_alb_diet_clust_data %>%
  ggplot() +
  geom_bar(data = index_alb_diet_clust_data, 
             aes(y=relFO, x=yearrepID, #group=rep_ID, 
                 fill=as.factor(prob.clust.num)),
             width = 1, stat = "identity") + #, position = "jitter", , position="identity"
  #geom_jitter(position = position_jitter(width = 0.1, height = 0.1))+
  theme(panel.grid.major = element_blank(),
        axis.title=element_text(size=34),
        axis.title.x=element_blank(),
        axis.text=element_text(size=26),
        axis.text.x = element_text(angle = 90, vjust = 1, hjust=1),
        legend.text=element_text(size=34),
        legend.title=element_text(size=34),
        legend.position = "top") +
  labs(x="Years sampled", y="Relative %FO")+
  scale_fill_manual(values=fig3.pal, name="Prey Trait Guilds") +
  facet_grid(OceanBasin~.)+ #, scales ="free"
  theme(strip.text = element_text(face="bold", size=rel(3)))
index_cluster_bar

ggsave(here::here("outputs_figures/diet_comp/index_cluster_barFO.jpeg"), plot = index_cluster_bar, width = 30, height = 30, dpi = 300)

```
