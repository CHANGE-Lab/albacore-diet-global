---
title: "Albacore Review Phylo Tree"
author: "Natasha Hardy"
date: "12/08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/Users/tashhardy/Documents/GitHub/albacore-diet-global")
```

## Set-up your working environment

```{r working environment, echo=FALSE}
#eval=FALSE, 
# general
library(tidyverse)
library(readxl)
library(plyr)
library(dplyr)
library(devtools)
library(here)
"%notin%" = Negate('%in%')
here::here()

# graphics
library(ggplot2)
library(lattice)
library(graphics)

remotes::install_github("eliocamp/ggnewscale@dev")

library(ggnewscale)
library(ggimage)
library(reshape2)
library(pander)
library(gridExtra)
library(captioner)
library(unmarked)
library(cowplot)
library(gtable)
library(viridis)
library(PNWColors)
library(RColorBrewer)

# phylogenetic tools

#Install packages if needed
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("Biostrings")

BiocManager::install("ggtree")

library(ape)
library(Biostrings)
library(ggtree)
library(ggstance)
library(geiger)
library(rotl) #for phylogenetic analyses, get all the species? from Hinchliff et al. 2015 PNAS
library(phylobase)
library(phytools)
library(phangorn)
library(stringr)
library(taxize)
library(treeio)

```


## Load Data

Using combination of my trial code and Matt Savoca and co's code to build a phylo tree with associated trait and %FO data. Using adult life stage data.

```{r load prey data}

#data contains sp list, class, order & family although not necessary to have those at the moment.

#Adult life stage data
my_prey_adult = read.csv(here("data/output_data/prey_adults_traits.csv"), header=TRUE) %>%
  dplyr::select(prey_sp, prey_class:prey_family, vert_habitat:maxM, -X) %>%
  filter(prey_sp %notin% c("Lampanyctus mexicanus", "Janthina exigua"))
#306 species parsing to the tree
str(my_prey_adult[,2:ncol(my_prey_adult)])

```

```{r data manip}
sapply(my_prey_adult, class)
## these need to be factors to work on the trees properly
my_prey_adult[,c("diel_migrant","refuge","season_migrant", "phys_defense", "transparent", "col_disrupt", "silver", "countershade")] <- lapply(my_prey_adult[,c("diel_migrant","refuge","season_migrant", "phys_defense", "transparent", "col_disrupt", "silver", "countershade")], factor)

my_prey_adult$maxFO[my_prey_adult$maxFO == 0.00] <- NA
my_prey_adult$maxN[my_prey_adult$maxN == 0.00] <- NA
my_prey_adult$maxM[my_prey_adult$maxM == 0.00] <- NA

```

## Tree Build
```{r building basic tree}
#Building the basic tree

breaks <- c(seq(1,nrow(my_prey_adult),50),nrow(my_prey_adult)+1)  # why are we doing this?
#looking up each of the species in dataset to a phylogeny, doing it by sets of 50
#if there's an NA (species that didn't match a value in known phylogeny), breaks the whole chunk of 50 species

for (i in 1:(length(breaks)-1)){
  taxa <- as.character(my_prey_adult$prey_sp[breaks[i]:(breaks[i+1]-1)])
  taxa <- taxa[taxa != "" & !is.na(taxa)]

  resolved_namest <- tnrs_match_names(taxa)                          # I think this is where all the extra species fall out
  resolved_namest <- resolved_namest[!is.na(resolved_namest$unique_name),]  # ignore an NA
  if (i==1){
    resolved_namess <- resolved_namest
  } else {
    resolved_namess <- rbind(resolved_namess, resolved_namest)
  }
}
resolved_names <- resolved_namess
resolved_names <- resolved_names[resolved_names$flags!="INCERTAE_SEDIS_INHERITED",]

#original tree based on simple taxon datset
my_tree_adult <- tol_induced_subtree(ott_ids = resolved_names$ott_id, label_format = "name")

#Previous error - need to remove Janthina exigua
#Error: HTTP failure: 400
#[/v3/tree_of_life/induced_subtree] Error: node_id 'ott549156' was not found!list(ott549156 = "pruned_ott_id")

my_tree_adult$tip.label<-gsub("_"," ",my_tree_adult$tip.label) # removes underscore between genus and species names
my_tree_adult$tip.label<-str_extract(my_tree_adult$tip.label, "[A-Z][a-z]+ [a-z]+")

my_tree_adult <- compute.brlen(my_tree_adult, method = "Grafen", power = 1/2) #add branch lengths to my tree using the Grafen (1989) method
my_tree_adult <- ladderize(my_tree_adult, right = TRUE)

View(my_tree_adult)

#SAVE TREE
write.tree(my_tree_adult, here("data/output_data/albacore_diet_tree_adult"))
```

``` {r Load tree}
#Reload tree

my_tree_adult <- read.tree(here("data/albacore_diet_tree_adult"))

```

```{r Check base tree}
#Check tree
mycirc <- ggtree(my_tree_adult, layout = "circular")
#one taxon coming out real strange

#checking my_prey data
str(my_tree_adult)
#305 species parsed through tree.

```

## Sort out the tree for graphing

Question: in this chunk we get nrow(my_prey_adult) == length(my_tree_adult$tip.label) #[TRUE]
So why do we then also have a dimension issue?

```{r Prep tree to plot #1}

#Edit tip labels
my_tree_adult$tip.label <- as.factor(sub("_", " ", my_tree_adult$tip.label))


# dataframe dimensions issue? ----
# according to Matt's code dataframe dimension should not be an issue when parsing data to tip labels...
# Try dimension solution
#we have a data frame dimension issue when plotting our data values onto the tree
nrow(my_prey_adult) == length(my_tree_adult$tip.label) #[TRUE]  (nrow() does not work for tip.labels)

nrow(my_prey_adult) #306
length(my_tree_adult$tip.label) #306

```

```{r Prep tree to plot #2}


#my_prey_adult$prey_sp <- gsub(" ", "_", my_prey_adult$prey_sp) #for ease of plotting take away " "

tree_names_adult = data.frame(sort(my_tree_adult$tip.label)) #sort the species names from the phylo tree
## sort brings tree_names_adult from 306 to 305 because of an NA in the tip labels
prey_names_adult = data.frame(sort(my_prey_adult$prey_sp)) #sort the species names from the original list

nrow(tree_names_adult); nrow(prey_names_adult) #one species didn't make it to the tree
#these are the same no??
#ZR: they are not the same before you run this whole chunk, they probably look the same to you is because they go to 306 and 306 after we fix the names in the chunk

## here we check the names that are in the prey data but not on the tip labels of the tree
names_not_in_tree_adult = prey_names_adult %>%
  filter(sort.my_prey_adult.prey_sp. %notin% tree_names_adult$sort.my_tree_adult.tip.label.)

## check names that are in the tree tip labels but not in the prey data
names_not_in_prey_adult =  tree_names_adult %>%
  filter(sort.my_tree_adult.tip.label. %notin% prey_names_adult$sort.my_prey_adult.prey_sp.)

## here we decide to match the names in the prey data to the tip labels, so we create a dataset with the names in the prey data that are in the tree (I see this looks kind of confusing with the double negative, the names not not in the tree). These are the names that do not need to be fixed, which we will bind the fixed names to afterwards so we do not get doubles of the same names (with different spelling).
my_prey_keep_adult = my_prey_adult %>%
  filter(prey_sp %notin% names_not_in_tree_adult$sort.my_prey_adult.prey_sp.)
## these are the names we are going to fix to match the tip labels of the tree, given they are synonyms/misspellings. These are the same names in 'names_not_in_tree_adult', except they now have the columns of data which will allow use to merge it to 'my_prey_keep_adult' after we fix the names.
my_prey_fix_adult = my_prey_adult %>%
  filter(prey_sp %in% names_not_in_tree_adult$sort.my_prey_adult.prey_sp.)
## this step isn't necessary, but it does make it easier in the names are in alphabetical order
my_prey_fix_adult = my_prey_fix_adult[order(my_prey_fix_adult$prey_sp),]
# the names have to be characters for the name reassignment to work, it will give an error if we don't do this (they are factors before this)
my_prey_fix_adult$prey_sp <- as.character(my_prey_fix_adult$prey_sp)
## we make these into x1 and y1 because it makes it much easier to write the next section
x1 = my_prey_fix_adult
y1 = as.vector(names_not_in_prey_adult$sort.my_tree_adult.tip.label.)

#here we look at the names in both of the lists and see if there are misspellings/synonyms in the names that caused the discrepancy between the name lists.
# if you want to see how this works you can run individual pieces of this before running the whole thing. For example x1[4,1] is "Leuroglossus stilbius", and y1[1] is "Bathylagus stilbius". Then after running this code we match the name in the prey data (x1) to the names in the tree (y1), so "Leuroglossus stilbius" becomes "Bathylagus stilbius".
x1[4,1] = y1[1]; x1[1,1] = y1[2]; x1[3,1] = y1[3]; x1[5,1] = y1[4];
x1[6,1] = y1[5]; x1[7,1] = y1[7]; x1[9,1] = y1[8]; x1[8,1] = y1[9]

# we need to do the opposite for one of the names here "Diplodus sargus", which is in the prey data but not in the tip labels. So, we are replacing the NA in the tip labels
tip_labels_adult <- as.vector(my_tree_adult$tip.label)
tip_labels_adult[12] ##this is the NA we want to replace
tip_labels_adult[12] = "Diplodus sargus"
## replacing the tip labels with the additional name
my_tree_adult$tip.label <- tip_labels_adult

# here we bind the fixed names to the names that didnt need to be fixed
my_prey_adult = rbind(my_prey_keep_adult, x1)
#here we get rid of any of the names in the data that didn't have a match in the tree tip labels, which was only 'Diplodus sargus'
my_prey_adult = my_prey_adult %>%
  filter(prey_sp %in% my_tree_adult$tip.label)
nrow(my_prey_adult);length(my_tree_adult$tip.label) ## one of those tip labels is an NA

#the prey names need to be the rownames for the heatmap to work on the tree
rownames(my_prey_adult) <- my_prey_adult$prey_sp

#tip labels need to be characters to pipe onto the tree
my_tree_adult$tip.label <- as.character(my_tree_adult$tip.label)
str(my_tree_adult)

```

## Paper figures - the list

### Basic phylogenies

```{r Figure A Prey species basic}
#Plot without and with species labels

#Phylotree without labels
adult_basic = ggtree(my_tree_adult, layout = 'circular')

#Phylotree with species labels
adult_basic_lab = ggtree(my_tree_adult, layout = 'circular') + 
  geom_tiplab(size = 2)

ggsave(here('./output_figures/diet_phylo/prey_adult/adult_basic.png'), plot=adult_basic, width=8, height=8, dpi=300)

ggsave(here('./output_figures/diet_phylo/prey_adult/adult_basic_lab.png'), plot=adult_basic_lab, width=8, height=8, dpi=300)

```

```{r Figure B Prey Class basic}
#Use basic + prey_sp labels + prey_class

# creating a dataset that splits the species data by class
prey_class_adult_info <- split(x = my_prey_adult$prey_sp, f = my_prey_adult$prey_class)

# splitting the tree species by class
my_tree_adult_class <- groupOTU(my_tree_adult, prey_class_adult_info)
as.character(sort(unique(my_prey_adult$prey_class)))

#creating a palette for the class split
#pal_adult_class = c("grey40", '#0047ab', '#751308', '#4B0082', '#F05E23', '#013220', '#B80F0A', "#66C2A5", "#3288BD") ## the grey40 is needed for a branch between branches, but doesn't assign to a class

pal_adult_class = c("grey40", ## the grey40 is needed for a branch between branches, but doesn't assign to a class
                    '#0047ab', #Actinopterygii
                    '#751308', #Branchiopoda #older teal colour "#66C2A5"
                    '#4B0082', #Cephalopoda
                    "#AD15E2", #Gastropoda #old orange '#F05E23'
                    '#B80F0A', #Hexanauplia
                    "#773405", #Hydrozoa #'#013220'
                    "#E86103", #Malacostraca '
                    "#3288BD"  #Thaliacea
                    )

## plotting the tree without tip labels

adult_class <- ggtree(my_tree_adult_class, aes(color = group), layout = 'circular') +
  scale_colour_manual('Class', aesthetics = c('colour'), values = pal_adult_class,
                      breaks = c("Actinopterygii", "Branchiopoda", "Cephalopoda", "Gastropoda", "Hexanauplia",
                                 "Hydrozoa", "Malacostraca","Thaliacea"),
                      labels = c("Actinopterygii", "Branchiopoda", "Cephalopoda", "Gastropoda", "Hexanauplia",
                                 "Hydrozoa", "Malacostraca","Thaliacea"))

# plotting the tree with tip labels
adult_class_lab = ggtree(my_tree_adult_class, aes(color = group), layout = 'circular') +
  scale_colour_manual('Class', aesthetics = c('colour', 'fill'), values = pal_adult_class,
                      breaks = c("Actinopterygii", "Branchiopoda", "Cephalopoda", "Gastropoda", "Hexanauplia",
                                 "Hydrozoa", "Malacostraca","Thaliacea"),
                      labels = c("Actinopterygii", "Branchiopoda", "Cephalopoda", "Gastropoda", "Hexanauplia",
                                 "Hydrozoa", "Malacostraca","Thaliacea")) +
  geom_tiplab(size = 2)

ggsave(here('./output_figures/diet_phylo/prey_adult/adult_class.png'), plot=adult_class, width=9, height=9, dpi=300)

ggsave(here('./output_figures/diet_phylo/prey_adult/adult_class_lab.png'), plot=adult_class_lab, width=9, height=9, dpi=300)


```

```{r Figure C Prey order basic}
#Use basic + prey_sp labels + prey_order

# creating a dataset that splits the species data by order
prey_order_adult_info <- split(x = my_prey_adult$prey_sp, f = my_prey_adult$prey_order)

# splitting the tree species by order
my_tree_adult_order <- groupOTU(my_tree_adult, prey_order_adult_info)

#checking number of order, in a format easy to copy and paste to scale_color_manual()
as.character(sort(unique(my_prey_adult$prey_order))) ## there are 42 orders, I'm not sure how to make that look good on a tree, so I won't try to assign colors and will leave it as it is plotted

pal_adult_order = pnw_palette("Starfish", 43)

View(my_tree_adult_order)

## plotting the tree (needs a lot of work)
adult_order_lab <- ggtree(my_tree_adult_order, aes(color = group), layout = 'circular')  +
  geom_tiplab(size = 2) +
  #theme(legend.position = 'none') +
  scale_colour_manual('order', aesthetics = c('colour', 'fill'), values = pal_adult_order)

ggsave(here('./output_figures/diet_phylo/prey_adult/adult_order_lab.png'), plot=adult_order_lab, width=12, height=8, dpi=300)


#TO DO:
#1 This graph is currently a lower priority and we may not get to this, however if we do, I there is no way we can have a legend that is so large and colours that are barely differentiated. I suggest not changing the colours as they clearly show different groups just not which ones are which using the legend. Is there any way to plot the "order" names near the branch of the tree or in a ring around the tree?
#2 Also fix legend labels

```

```{r Figure D Prey family basic}
#Use basic + prey_sp labels + prey_family

# creating a dataset that splits the species data by family
prey_family_adult_info <- split(x = my_prey_adult$prey_sp, f = my_prey_adult$prey_family)

# splitting the tree species by family
my_tree_adult_family <- groupOTU(my_tree_adult, prey_family_adult_info)

#checking number of family, in a format easy to copy and paste to scale_color_manual()
as.character(sort(unique(my_prey_adult$prey_family))) ## there are 141 families, I'm not sure how to make that look good on a tree, so I won't try to assign colors and will leave it as it is plotted

pal_adult_fam = pnw_palette("Starfish", 142)

## plotting the tree (needs a lot of work)
adult_fam_lab <- ggtree(my_tree_adult_family, aes(color = group), layout = 'circular')  +
  geom_tiplab(size = 2)+
  #theme(legend.position = 'none') +
  scale_colour_manual('order', aesthetics = c('colour', 'fill'), values = pal_adult_fam)

ggsave(here('./output_figures/diet_phylo/prey_adult/adult_fam_lab.png'), plot=adult_fam_lab, width=20, height=8, dpi=300)

#TO-DO:
#Similar problem as for order, but low priority
```

### Diet use data

```{r Figure E Frequency Occurrence}
#Overlay maxFO (frequency of occurrence data) on a basic prey tree coloured by Class
#Use prey_class, maxFO

adult_maxfo <- gheatmap(adult_class, my_prey_adult[,"maxFO", drop = FALSE], 
                        offset = 0, width = 0.05, colnames = FALSE) +
  scale_fill_viridis_c(name = "Percent frequency of occurrence in diets (% FO)", 
                       na.value = 'grey')

ggsave(here('./output_figures/diet_phylo/prey_adult/adult_maxfo.png'), plot=adult_maxfo, width=10, height=8, dpi=300)

```

```{r Figure F Abundance}
#Overlay maxN (abundance data) on a basic prey tree coloured by Class
#Use prey_class, maxN
adult_maxn <- gheatmap(adult_class, my_prey_adult[,"maxN", drop = FALSE], 
                       offset = 0, width = 0.05, colnames = FALSE) +
  scale_fill_viridis_c(name = "Percent abundance in diets (% N)", na.value = 'grey')

ggsave(here('./output_figures/diet_phylo/prey_adult/adult_maxn.png'), plot=adult_maxn, width=10, height=8, dpi=300)

##PROBLEM:
#Note that there should be way more grey here - there are not that many species for which we have %N data.
#Solved - I replaced the 0.00 values with NA

```

```{r Figure G Mass}
#Overlay maxM (biomass data) on a basic prey tree coloured by Class
#Use prey_class, maxM

adult_maxm <- gheatmap(adult_class, my_prey_adult[,"maxM", drop = FALSE], 
                       offset = 0, width = 0.05, colnames = FALSE) +
  scale_fill_viridis_c(name = "Percent biomass in diets (% kg)", 
                       na.value = 'grey')

ggsave(here('./output_figures/diet_phylo/prey_adult/adult_maxm.png'), plot=adult_maxm, width=10, height=8, dpi=300)

##PROBLEM:
#Note that there should be way more grey here - there are not that many species for which we have %N data.
#Solved - I replaced the 0.00 values with NA
```

### Trait data

For habitat use traits:
We are going to plot multiple rings of data around the phylogenetic trees using vert_habitat, horz_habitat, diel_migrant (change to yes/no), refuge

```{r Figure H Habitat use traits}
#creating this plot one iteration at a time. Adding one layer of the heatmap, then allowing for another legend on the plot, and then another layer of the heatmap
habitat_traits_adult1 <- gheatmap(adult_basic, my_prey_adult[, 'vert_habitat',drop=FALSE], 
                                  offset= 0, width=0.05, colnames = FALSE) +
  scale_fill_viridis_d(name = "Vertical Habitat", 
                       option = 'D', 
                       direction = -1, 
                       breaks = c("benthic", "demersal", "epipelagic", "mesopelagic", "bathypelagic"),
                       limits = c("benthic", "demersal", "epipelagic", "mesopelagic", "bathypelagic"), 
                       na.translate = TRUE, 
                       na.value = 'grey')+
  theme(legend.position = c(1,0.80))+
  scale_y_continuous(expand = c(0,4))+ #this opens up the gap for the Vertical habitat label around the tree
  annotate('text', x = 1.03, y = -7, label = 'Vertical Habitat', angle = -85, size = 3)

habitat_traits_adult1.5 <- habitat_traits_adult1 + new_scale_fill()

habitat_traits_adult2 <- gheatmap(habitat_traits_adult1.5, my_prey_adult[ ,'horz_habitat',drop=FALSE], 
                                  offset=0.05, width=0.05, colnames = F) +
  scale_fill_viridis_d(name = "Horizontal Habitat", 
                       option = "D", 
                       direction = -1,
                       breaks = c("reef-associated", "coastal", "continental shelf","continental slope", "oceanic"),
                       limits = c("reef-associated", "coastal", "continental shelf","continental slope", "oceanic"),
                       na.translate = TRUE, 
                       na.value = 'grey')+
  theme(legend.position = c(1,0.683))+
  scale_y_continuous(expand = c(0,4))+
annotate('text', x = 1.08, y = -7.1, label = 'Horizontal Habitat', angle = -85, size = 3)

habitat_traits_adult2.5 <- habitat_traits_adult2 + new_scale_fill()

habitat_traits_adult3 <- gheatmap(habitat_traits_adult2.5, my_prey_adult[ , 'diel_migrant',drop=FALSE], 
                                  offset=0.10, width=0.05, colnames = F) +
  scale_fill_manual(name = "Diel Migrant",
                    breaks = c("0", "1"),
                    limits = c("0", "1"),
                    labels = c("no","yes"),
                    values = c("0"="#FDE725FF", "1"="#39568CFF"), 
                    na.value = 'grey')+
  theme(legend.position = c(1,0.5985))+
  scale_y_continuous(expand = c(0,4))+
  annotate('text', x = 1.13, y = -7.5, label = 'Diel Migrant', angle = -85, size = 3)

habitat_traits_adult3.5 <- habitat_traits_adult3 + new_scale_fill()

habitat_traits_adult_final <- gheatmap(habitat_traits_adult3.5, my_prey_adult[ ,'refuge',drop=FALSE], 
                                       offset=0.15, width=0.05, colnames = F)+
  scale_fill_manual(name = "Refuge",
                    breaks = c("0", "1"),
                    limits = c("0", "1"),
                    labels = c("no", "yes"),
                    values = c("1"="#FDE725FF", "0"="#39568CFF"), 
                    na.value = 'grey')+
  theme(legend.position = c(1,0.531))+
  scale_y_continuous(expand = c(0,4))+
  annotate('text', x = 1.18, y = -7.5, label = 'Refuge', angle = -85, size = 3)

#Check graph
habitat_traits_adult_final

#Save vertical graph
ggsave(here('./output_figures/diet_phylo/prey_adult/adult_hab1.png'), plot=habitat_traits_adult1, width=12, height=10, dpi=300)
#save vert + horizontal graph
ggsave(here('./output_figures/diet_phylo/prey_adult/adult_hab2.png'), plot=habitat_traits_adult2, width=12, height=10, dpi=300)
##PROBLEM STARTS HERE
#save vert + horizontal + diel graph
ggsave(here('./output_figures/diet_phylo/prey_adult/adult_hab3.png'), plot=habitat_traits_adult3, width=12, height=10, dpi=300)
#save vert + horizontal + diel graph
ggsave(here('./output_figures/diet_phylo/prey_adult/adult_hab4.png'), plot=habitat_traits_adult_final, width=12, height=10, dpi=300)


#Some issues with the legend plotting to the graph?
#Namely the issue is for the vertical and horizontal habitat association values disappear once the diel + refuge use get added.

```

For seasonal, trophic & aggregation behaviour use:
trophic_level, gregarious_primary and season_migrant

```{r Figure I Behaviour}

behav_trophic_adult1 <- gheatmap(adult_basic, my_prey_adult[,'trophic_level', drop=FALSE], 
                                 offset=0, width=0.05, colnames = F) +
  scale_fill_viridis_c(name = "Trophic Level", 
                       na.value = 'grey') +
  #scale_fill_gradientn(name = "Trophic Level", colours = c('grey90', 'purple4'), na.value = 'white')+
  scale_y_continuous(expand = c(0,3.5))+
  annotate('text', x = 1.04, y = -6.5, label = 'Trophic Level', angle = -85, size = 3)

behav_trophic_adult1.5 <- behav_trophic_adult1 + new_scale_fill()

behav_trophic_adult2 <- gheatmap(behav_trophic_adult1.5, my_prey_adult[,"gregarious_primary",drop=FALSE], 
                                 offset=0.05, width=0.05, colnames = F) +
  scale_fill_viridis_d(name = "Gregariousness", direction = -1,
                       breaks = c("solitary", "shoaling","schooling"),
                       limits = c("solitary", "shoaling","schooling"),
                       na.translate = TRUE,
                       option = "D", #'magma',
                       begin = 0.2,end = 0.8,
                       guide = guide_legend(order = 1), 
                       na.value = 'grey')+
  scale_y_continuous(expand = c(0,3.5))+
  annotate('text', x = 1.09, y = -6.5, label = 'Gregariousness', angle = -85, size = 3)

behav_trophic_adult2.5 <- behav_trophic_adult2 + new_scale_fill()

behav_trophic_adult_final <- gheatmap(behav_trophic_adult2.5, my_prey_adult[ ,'season_migrant',drop=FALSE], 
                                      offset=0.10, width=0.05, colnames = F) +
  scale_fill_manual(name = "Seasonal Migrant",
                    breaks = c("0", "1"),
                    limits = c("0", "1"),
                    labels = c("no", "yes"),
                    values = c("0"="#FDE725FF", "1"="#39568CFF"), 
                    na.value = 'grey') +
  theme(legend.position = c(1,0.5985))+
  scale_y_continuous(expand = c(0,4))+
  annotate('text', x = 1.14, y = -6.5, label = 'Seasonal Migrant', angle = -85, size = 3)

#Save graph 1
ggsave(here('./output_figures/diet_phylo/prey_adult/adult_behav1.png'), plot=behav_trophic_adult1, width=12, height=10, dpi=300)
#Save graph 2
ggsave(here('./output_figures/diet_phylo/prey_adult/adult_behav2.png'), plot=behav_trophic_adult2, width=12, height=10, dpi=300)
#Save graph 3
ggsave(here('./output_figures/diet_phylo/prey_adult/adult_behav3.png'), plot=behav_trophic_adult_final, width=12, height=10, dpi=300)


```

For morphological (shape) traits:
Use body_shape, b_shape_r and eye_body_r

```{r Figure J Morpholigical - shape}

morphology_comparison_adult1 <- gheatmap(adult_basic, my_prey_adult[ ,'body_shape',drop=FALSE], 
                                         offset=0, width=0.05,font.size=2, colnames = F) +
  scale_fill_viridis_d(name = "Body Shape", 
                       option = 'C',
                       breaks = c("eel-like", "elongated", "fusiform", "compressiform", "depressiform", 
                                  "globiform", "unique"),
                       limits = c("eel-like", "elongated", "fusiform", "compressiform", "depressiform", 
                                  "globiform", "unique"),
                       guide = guide_legend(order = 1), 
                       na.value = 'grey')+
  theme(legend.position = c(1.05,0.71))+
  scale_y_continuous(expand = c(0,3.5))+
  annotate('text', x = 1.04, y = -6.5, label = 'Body Shape', angle = -85, size = 3)

morphology_comparison_adult1.5 <- morphology_comparison_adult1 + new_scale_fill()

morphology_comparison_adult2 <- gheatmap(morphology_comparison_adult1.5, my_prey_adult[ ,'b_shape_r',drop=FALSE], 
                                         offset=0.05, width=0.05, colnames = F) +
  scale_fill_viridis_c(name = "Body Shape Ratio", 
                       option = 'C', 
                       limits=c(0,15), 
                       oob = scales::squish, 
                       breaks = c(0,5,10,15),
                       labels = c(0,5,10,"15+"), 
                       na.value = 'grey')+
  theme(legend.position = c(1.05,0.605))+
  scale_y_continuous(expand = c(0,3.5))+
  annotate('text', x = 1.095, y = -6.5, label = 'Body Shape Ratio', angle = -85, size = 3)

morphology_comparison_adult2.5 <- morphology_comparison_adult2 + new_scale_fill()

morphology_comparison_adult_final <- gheatmap(morphology_comparison_adult2.5, my_prey_adult[ ,'eye_body_r',drop=FALSE],
                                              offset=0.10, width=0.05, colnames = F)+
  scale_fill_viridis_c(name = "Eye-Body Ratio", 
                       option = 'C',limits=c(0,3), 
                       oob = scales::squish, 
                       breaks = c(0,1,2,3), 
                       labels = c(0,1,2,"3+"), 
                       na.value = 'grey')+
  theme(legend.position = c(1.05,0.499))+
  scale_y_continuous(expand = c(0,3.5))+
annotate('text', x = 1.15, y = -6.5, label = 'Eye-Body Ratio', angle = -85, size = 3)

#Save graph 1
ggsave(here('./output_figures/diet_phylo/prey_adult/adult_morph1.png'), plot=morphology_comparison_adult1, width=13, height=10, dpi=300)
#Save graph 2
ggsave(here('./output_figures/diet_phylo/prey_adult/adult_morph2.png'), plot=morphology_comparison_adult2, width=13, height=10, dpi=300)
#Save graph 3
ggsave(here('./output_figures/diet_phylo/prey_adult/adult_morph3.png'), plot=morphology_comparison_adult_final, width=13, height=10, dpi=300)


```

For morphological (defense/avoidance) traits:
Use phys_defense, countershade, col_disrupt, silver and transparent (in that order)

```{r Figure K Morphological - defense/avoid}

morphology_binary_adult1 <- gheatmap(adult_basic, my_prey_adult[ ,'phys_defense',drop=FALSE], 
                                     offset=0, width=0.05, colnames = F) +
  scale_fill_viridis_d(name = "Physical Defence", #"\nCountershading\nColour disruption\nSilver\nTransparent", 
                       option = 'C',
                       breaks = c("1", "0"),
                       limits = c("1", "0"),
                       labels = c("yes", "no"),
                       begin=0.5, end=0, 
                       na.value = 'grey')+
  scale_y_continuous(expand = c(0,4.5))+
  annotate('text', x = 1.04, y = -8.5, label = 'Physical Defence', angle = -85, size = 3)

morphology_binary_adult2 <- gheatmap(morphology_binary_adult1, my_prey_adult[ ,'countershade',drop=FALSE], offset=0.05, width=0.05, colnames = F) +
  scale_fill_viridis_d(name = "Physical Defence\nCountershading", #"\nColour disruption\nSilver\nTransparent", 
                       option = 'C',
                       breaks = c("1", "0"),
                       limits = c("1", "0"),
                       begin=0.5, end=0.1, 
                       na.value = 'grey')+
  scale_y_continuous(expand = c(0,4.5))+
  annotate('text', x = 1.09, y = -8.5, label = 'Countershading', angle = -85, size = 3)

morphology_binary_adult3 <- gheatmap(morphology_binary_adult2, my_prey_adult[ ,'col_disrupt',drop=FALSE], offset=0.10, width=0.05, colnames = F) +
  scale_fill_viridis_d(name = "Physical Defence\nCountershading\nColour disruption",  #"\nSilver\nTransparent", 
                       option = 'C',
                       breaks = c("1", "0"),
                       limits = c("1", "0"),
                       labels = c("yes", "no"),
                       begin=0.5,end=0.1,
                       na.value = 'grey')+
  scale_y_continuous(expand = c(0,4.5))+
  annotate('text', x = 1.14, y = -8.5, label = 'Colour Disruption', angle = -85, size = 3)

morphology_binary_adult4 <- gheatmap(morphology_binary_adult3, my_prey_adult[ ,'silver',drop=FALSE], offset=0.15, width=0.05, colnames = F) +
  scale_fill_viridis_d(name = "Physical Defence\nCountershading\nColour disruption\nSilver", #"\nTransparent", 
                       option = 'C',
                       breaks = c("1", "0"),
                       limits = c("1", "0"),
                       labels = c("yes", "no"),
                       begin=0.5,end=0.1, 
                       na.value = 'grey')+
  scale_y_continuous(expand = c(0,4.5))+
  annotate('text', x = 1.19, y = -8.5, label = 'Silver', angle = -85, size = 3)

morphology_binary_adult_final <- gheatmap(morphology_binary_adult4, my_prey_adult[ ,'transparent',drop=FALSE], offset=0.20, width=0.05, colnames = F) +
  scale_fill_viridis_d(name = "Physical Defence\nCountershading\nColour disruption\nSilver\nTransparent", 
                       option = 'C',
                       breaks = c("1", "0"),
                       limits = c("1", "0"),
                       labels = c("yes", "no"),
                       begin=0.5,end=0.1, 
                       na.value = 'grey')+
  scale_y_continuous(expand = c(0,4.5))+
  annotate('text', x = 1.24, y = -8.5, label = 'Transparent', angle = -85, size = 3)

#Save graph 1
ggsave(here('./output_figures/diet_phylo/prey_adult/adult_morph_bin1.png'), plot=morphology_binary_adult1, width=12, height=10, dpi=300)
#Save graph 2
ggsave(here('./output_figures/diet_phylo/prey_adult/adult_morph_bin2.png'), plot=morphology_binary_adult2, width=12, height=10, dpi=300)
#Save graph 3
ggsave(here('./output_figures/diet_phylo/prey_adult/adult_morph_bin3.png'), plot=morphology_binary_adult3, width=12, height=10, dpi=300)
#Save graph 4
ggsave(here('./output_figures/diet_phylo/prey_adult/adult_morph_bin4.png'), plot=morphology_binary_adult4, width=12, height=10, dpi=300)
#Save graph 5
ggsave(here('./output_figures/diet_phylo/prey_adult/adult_morph_bin5.png'), plot=morphology_binary_adult_final, width=12, height=10, dpi=300)


```

For Prey nutritional quality
Use energy_density, percent_protein, percent_lipid

```{r Figure L Prey Nutritional Quality}

nutritional_quality_adult1 <- gheatmap(adult_basic, my_prey_adult[,'energy_density',drop=FALSE], 
                                       offset=0, width=0.05, colnames = F) +
  scale_fill_viridis_c(name = "Energy density", na.value = 'grey')+
  scale_y_continuous(expand = c(0,3.5))+
  annotate('text', x = 1.04, y = -6.5, label = 'Energy density (unit)', angle = -85, size = 3)

nutritional_quality_adult1.5 <- nutritional_quality_adult1 + new_scale_fill()

nutritional_quality_adult2 <- gheatmap(nutritional_quality_adult1.5, my_prey_adult[,"percent_protein",drop=FALSE], 
                                       offset=0.05, width=0.05, colnames = F) +
  scale_fill_viridis_c(name = "Percent protein (%)", na.value = 'grey')+
  scale_y_continuous(expand = c(0,3.5))+
  annotate('text', x = 1.09, y = -6.5, label = 'Percent protein (%)', angle = -85, size = 3)

nutritional_quality_adult2.5 <- nutritional_quality_adult2 + new_scale_fill()

nutritional_quality_adult_final <- gheatmap(nutritional_quality_adult2.5, my_prey_adult[ ,'percent_lipid',drop=FALSE], 
                                            offset=0.10, width=0.05, colnames = F) +
  scale_fill_viridis_c(name = "Percent lipid (%)", na.value = 'grey') +
  theme(legend.position = c(1,0.5985))+
  scale_y_continuous(expand = c(0,4))+
  annotate('text', x = 1.14, y = -6.5, label = 'Percent lipid (%)', angle = -85, size = 3)

#Save graph 1
ggsave(here('./output_figures/diet_phylo/prey_adult/adult_nutri_ed.png'), plot=nutritional_quality_adult1, width=12, height=10, dpi=300)
#Save graph 2
ggsave(here('./output_figures/diet_phylo/prey_adult/adult_nutri_protein.png'), plot=nutritional_quality_adult2, width=12, height=10, dpi=300)
#Save graph 3
ggsave(here('./output_figures/diet_phylo/prey_adult/adult_nutri_lipid.png'), plot=nutritional_quality_adult_final, width=12, height=10, dpi=300)

```

For Fisheries status use: fisheries_status
```{r Figure M Fisheries Status}

fishery_adult <- gheatmap(adult_basic, my_prey_adult[ ,'fisheries_status',drop=FALSE], 
                          offset=0, width=0.05,font.size=2, colnames = F) +
  scale_fill_viridis_d(name = "Fisheries status", option = 'C',
                       breaks = c("none","potential", "recreational", "subsistence fisheries",
                                  "minor commercial","commercial", "highly commercial"),
                       limits = c("none","potential", "recreational", "subsistence fisheries",
                                  "minor commercial","commercial", "highly commercial"), na.value = 'grey')+
  scale_y_continuous(expand = c(0,3.5))+
  annotate('text', x = 1.04, y = -6.5, label = 'Fishery status', angle = -85, size = 3)

#Save graph
ggsave(here('./output_figures/diet_phylo/prey_adult/adult_fishery.png'), plot=fishery_adult, width=12, height=10, dpi=300)

```


## Old Code

```{r Plotting basic tree, eval=FALSE, echo=FALSE}
# Tree plot
NH_base <- ggtree(my_tree_adult, layout="fan", open.angle=0) + #can vary width with size=1.5
  #geom_text2(aes(label=label), hjust=-.2, size=4) +
  #geom_tiplab2()+
  ggplot2::xlim(-0.6, 1.3)
NH_base

```

```{r Plotting better basic tree, width=30, height=30, echo=FALSE, eval=FALSE, message=FALSE, warning=FALSE}
#improving the base tree

#checking my tip labels are factors, I believe this is important for parsing tree labels to the tree
my_tree_adult$tip.label <- as.factor(my_tree_adult$tip.label)


p %<+% my_prey_adult$prey_sp +
  geom_tiplab2(aes(label = paste0("italic('", label, "')"), angle = angle), parse = TRUE, align = TRUE, size = 6)

dev.copy2pdf(file="prey_tree_better.pdf", width=30, height=30)

```

```{r More plotting, width=30, height=30, echo=FALSE, eval=FALSE, message=FALSE, warning=FALSE}

# Adding data
p %<+% my_prey +
  aes(color = PreyClass) +
  geom_tiplab2(aes(label = paste0("italic('", label, "')"),
                   color=PreyClass, angle = angle), parse = TRUE,
               align = TRUE, size = 6) #+
  # geom_tiplab2(aes(color=Sp_mean, angle = angle),
  #              align = TRUE, size = 6) +
  # geom_cladelabel()+
  #scale_color_gradientn(colours = c("steelblue4","steelblue3",
  #                                  "coral", "coral1",
  #                                  "firebrick2", "firebrick3", "firebrick4"),
  #                      name = "average %FO") +
  #theme(legend.position = c(0.5,0.5),
  #      legend.key.size = unit(1.75, "cm"),
  #      legend.text = element_text(size = 18),
  #      legend.title = element_text(size = 20))

#geom_tippoint()
#facet_plot()
#geom_facet() --> add %FO as bar plot that is coloured with

#scenario
#colour species by habitat + tippoint size varies by %FO

dev.copy2pdf(file="preyprelim_phylo_ggtree.pdf", width=30, height=30)
#ggsave("Prelim_phylo_ggtree2.jpg", width = 35, height = 35, units = "in")

# Matt second code
p %<+% my_prey +
  aes(color = ave_fo) +
  geom_tiplab2(aes(label = paste0("italic('", label, "')"),
                   color=Sp_mean, angle = angle), parse = TRUE,
               size = 6, align = FALSE, hjust = -0.05) +
  geom_tippoint(aes(color = ave_fo, shape = commercial, size = studies_cat)) +
  scale_color_gradientn(colours = c("steelblue4",
                                    "gray40",
                                    "coral", "coral1",
                                    "firebrick2", "firebrick3", "firebrick4"),
                        name = "Proportion with \ningested plastic") +
  #scale_size(range = c(3, 7)) +
  scale_size_continuous(guide = FALSE, range = c(3, 7)) +
  labs(shape = "Commercial \nstatus") +
  theme(legend.position = c(0.5,0.5),
        legend.key.size = unit(2.5, "cm"),
        legend.text = element_text(size = 24),
        legend.title = element_text(size = 26),
        legend.box = "horizontal") +
  guides(shape = guide_legend(override.aes = list(size = 5)))


p + geom_facet(panel = "Trait", data = bar_data, geom = ggstance::geom_barh,
             aes(x = dummy_bar_value, color = location, fill = location),
             stat = "identity", width = .6) +
  theme_tree2(legend.position=c(.05, .85))
p



# other options

# first plot try, vertical layout with data ----
p_stand <- ggtree(my_tree) +
  #geom_text2(aes(label=label), hjust=-.2, size=4) +
  ggplot2::xlim(0, 1.2)
p_stand

# Adding data
p_stand %<+% d_sp_sum +
  aes(color = Sp_mean) +
  geom_tiplab(aes(color=Sp_mean), align = TRUE, size = 3) +
  scale_color_gradientn(colours = c("#053061" ,"#2166AC", "#4393C3", "#F4A582", "#D6604D", "#B2182B", "#67001F"),
                        name = "Proportion with \nplastic") +
  geom_hilight(node=1, fill="gold") +
  theme(legend.position = c(0.2,0.8))


p2 <- facet_plot(p_stand, panel = 'Prop w plastic', data = d_sp_sum,
                 geom = ggstance::geom_barh,
                 mapping = aes(x = Sp_mean),
                 stat='identity')
p2

geom_facet(

  inset(my_tree, d_sp_sum$Sp_mean, width=0.2, height=0.15, hjust=-1)


  legend.title = element_blank(), # no title
  legend.key = element_blank()) # no keys



geom_tippoint(aes(color=order))



geom_tiplab(aes(color = Sp_mean))


p %<+% d + geom_text(aes(color=, label=label), hjust=-0.5)
```

```{r Troubleshoot ongoing issues, eval=FALSE, echo=FALSE}
# Need to find node labels so that we can colour the tree and clades

```
